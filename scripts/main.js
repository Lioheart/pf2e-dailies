(()=>{var Mt=Object.defineProperty;var l=(t,e)=>Mt(t,"name",{value:e,configurable:!0});var Ut=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var We=(t,e,r)=>(Ut(t,e,"read from private field"),r?r.call(t):e.get(t)),Ge=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)};var v="pf2e-dailies",oe=async function(){}.constructor;function D(t){return game.settings.get(v,t)}l(D,"getSetting");function ae(t,e){return game.settings.set(v,t,e)}l(ae,"setSetting");function B(...t){return`${v}.settings.${t.join(".")}`}l(B,"getSettingLocalizationPath");function X(t){let e=t.name;t.scope=t.scope??"world",t.config=t.config??!1,t.config&&(t.name=B(e,"name"),t.hint=B(e,"hint")),Array.isArray(t.choices)&&(t.choices=t.choices.reduce((r,i)=>(r[i]=B(e,"choices",i),r),{})),game.settings.register(v,e,t)}l(X,"registerSetting");function Be(t){let e=t.name;t.name=B("menus",e,"name"),t.label=B("menus",e,"label"),t.hint=B("menus",e,"hint"),t.restricted=t.restricted??!0,t.icon=t.icon??"fas fa-cogs",game.settings.registerMenu(v,e,t)}l(Be,"registerSettingMenu");function le(...t){return t=t.filter(e=>typeof e=="string"),`modules/${v}/templates/${t.join("/")}`}l(le,"templatePath");function I(t,e,r){return t.getFlag(v,e)??r}l(I,"getFlag");function qe(t,e,r){return t.setFlag(v,e,r)}l(qe,"setFlag");function k(...t){let[e,r]=t;return e=`${v}.${e}`,r?game.i18n.format(e,r):game.i18n.localize(e)}l(k,"localize");function Z(t){return game.i18n.has(`${v}.${t}`,!1)}l(Z,"hasLocalization");function Ie(t){return`${v}.${t}`}l(Ie,"localizePath");function C(t){let e=l((...r)=>k(`${t}.${r[0]}`,r[1]),"fn");return Object.defineProperties(e,{warn:{value:(...r)=>O(`${t}.${r[0]}`,r[1],r[2]),enumerable:!1,configurable:!1},info:{value:(...r)=>jt(`${t}.${r[0]}`,r[1],r[2]),enumerable:!1,configurable:!1},error:{value:(...r)=>F(`${t}.${r[0]}`,r[1],r[2]),enumerable:!1,configurable:!1},has:{value:r=>Z(`${t}.${r}`),enumerable:!1,configurable:!1},path:{value:r=>Ie(`${t}.${r}`),enumerable:!1,configurable:!1},template:{value:(r,{hash:i})=>e(r,i),enumerable:!1,configurable:!1}}),e}l(C,"subLocalize");function Ve(){return CONFIG.ChatMessage.documentClass}l(Ve,"getChatMessageClass");function Ce(t,e,r,i){let s=typeof e=="string"?e:"info",o=typeof e=="object"?e:typeof r=="object"?r:void 0,n=typeof e=="boolean"?e:typeof r=="boolean"?r:i??!1;ui.notifications.notify(k(t,o),s,{permanent:n})}l(Ce,"notify");function O(...t){let[e,r,i]=t;Ce(e,"warning",r,i)}l(O,"warn");function jt(...t){let[e,r,i]=t;Ce(e,"info",r,i)}l(jt,"info");function F(...t){let[e,r,i]=t;Ce(e,"error",r,i)}l(F,"error");function q(t){return t.getFlag("core","sourceId")}l(q,"getSourceId");function zt(t,e){let r=q(t);return r?e.includes(r):!1}l(zt,"includesSourceId");function Wt(t){return Array.isArray(t)?e=>zt(e,t):e=>q(e)===t}l(Wt,"getItemSourceIdCondition");function Gt(t,e){return e?e.flatMap(r=>t.itemTypes[r]):t.items}l(Gt,"getItems");function ce(t,e,r){return Gt(t,r).find(Wt(e))}l(ce,"findItemWithSourceId");function ue(t,e){let r=[];if(t<=e)for(let i=t;i<=e;i++)r.push(i);else for(let i=t;i>=e;i--)r.push(i);return r}l(ue,"sequenceArray");function de(t){return t?t[0].toUpperCase()+t.slice(1):""}l(de,"capitalize");function Q(t,e){return e?`@UUID[${t}]{${e}}`:`@UUID[${t}]`}l(Q,"chatUUID");function He(t){return`<span style="background: #DDD;
    padding: 1px 4px;
    border: 1px solid var(--color-border-dark-tertiary);
    border-radius: 2px;
    white-space: nowrap;
    word-break: break-all;">${t}</span>`}l(He,"fakeChatUUID");function pe(t,e,r={},i,s){return{key:t,label:s,item:{uuid:e},rows:[{type:"drop",slug:"spell",filter:{type:"spell",search:r}}],process:async({addSpell:n,utils:a,fields:c,messages:d})=>{let u=c.spell.uuid,p=await a.createSpellSource(u),b=`${p.name} (Level ${i||p.system.level.value})`;n(p,i),d.add("spells",{uuid:u,label:b})}}}l(pe,"createSpellDaily");function Ye(){let t=pe("ace","Compendium.pf2e.feats-srd.Item.POrE3ZgBRdBL9MsW",{category:["cantrip","spell"],level:4},4),e=t.rows[0];return e.filter.drop=r=>{let i=r.system.time.value;return i.includes("hour")||i.includes("min")&&parseInt(i)>10?{error:Ie("interface.error.drop.wrongSpellTime"),data:{time:"10 min"}}:!0},t}l(Ye,"tricksterAce");var Xe={key:"blade",item:{uuid:"Compendium.pf2e.classfeatures.Item.EtltLdiy9kNfHU0c"},children:[{slug:"good",uuid:"Compendium.pf2e.classfeatures.Item.nxZYP3KGfTSkaW6J"},{slug:"evil",uuid:"Compendium.pf2e.classfeatures.Item.JiY2ZB4FkK8RJm4T"},{slug:"liberator",uuid:"Compendium.pf2e.classfeatures.Item.FCoMFUsth4xB4veC"},{slug:"paladin",uuid:"Compendium.pf2e.classfeatures.Item.peEXunfbSD8WcMFk"},{slug:"antipaladin",uuid:"Compendium.pf2e.classfeatures.Item.EQ6DVIQHAUXUhY6Y"},{slug:"tyrant",uuid:"Compendium.pf2e.classfeatures.Item.HiIvez0TqESbleB5"},{slug:"spirit",uuid:"Compendium.pf2e.feats-srd.Item.h5ksUZlrVGBjq6p4"},{slug:"master",uuid:"Compendium.pf2e.feats-srd.Item.jYEMVfrXJLpXS6aC"}],rows:[{type:"select",slug:"weapon",label:()=>k("label.blade.weapon"),options:({actor:t})=>t.itemTypes.weapon.filter(e=>!e.isAlchemical).map(e=>({value:e.id,label:e.name}))},{type:"select",slug:"rune",label:()=>k("label.blade.rune"),options:({children:t})=>{let e=["returning","shifting"],{antipaladin:r,evil:i,good:s,liberator:o,master:n,paladin:a,spirit:c,tyrant:d}=t;return c&&(e.push("flaming"),s&&e.push("holy"),i&&e.push("unholy"),(o||r)&&e.push("anarchic"),(a||d)&&e.push("axiomatic")),s&&e.push("disrupting","ghost-touch"),n&&e.push("greater-disrupting","keen"),i&&e.push("fearsome"),e.map(u=>({value:u,label:Je(u)}))},condition:({actor:t})=>t.itemTypes.weapon.filter(e=>!e.isAlchemical).length}],process:async({actor:t,fields:e,addRule:r,messages:i})=>{let s=e.weapon.value,o=e.rune.value,n=t.items.get(s);if(!n)return;r({definition:[`item:id:${s}`],key:"AdjustStrike",mode:"add",property:"property-runes",value:o},n),r({key:"CriticalSpecialization",predicate:[{or:[`item:category:${n.category}`,`item:id:${s}`]}]},n);let a=n.name!==n._source.name?`... ${n._source.name}`:n.name;i.addGroup("blade"),i.add("blade",{uuid:n.uuid,label:a,selected:Je(o)})}};function Je(t){let e=t.replace(/-\w/,r=>r[1].toUpperCase());return game.i18n.localize(`PF2E.WeaponPropertyRune.${e}.Name`)}l(Je,"localizeRune");var Bt=["first","second","third","fourth","fifth","sixth","seventh"];function De(t,e,r){return{key:t,label:r,item:{uuid:e[0]},children:[{slug:"expert",uuid:e[1]},{slug:"master",uuid:e[2]}],rows:[U("first",1),U("second",2,8),U("third",3,void 0,"expert"),U("fourth",4,14,"expert"),U("fifth",5,16,"expert"),U("sixth",6,void 0,"master"),U("seventh",7,20,"master")],process:async({utils:s,fields:o,addItem:n,messages:a})=>{for(let c of Object.values(o)){let d=c.uuid,u=Bt.indexOf(c.row)+1,p=await s.createSpellScrollSource({uuid:d,level:u});n(p),a.add("scrolls",{uuid:d,label:p.name})}}}}l(De,"createScrollChain");function U(t,e,r,i){let s={type:"drop",slug:t,label:`PF2E.SpellLevel${e}`,filter:{type:"spell",search:{category:["spell"],level:e}}};return r&&(s.condition=({actor:o})=>o.level>=r),i&&(s.childPredicate=[i]),s}l(U,"createRow");function fe(t,e,r={},i){return{key:t,label:i,item:{uuid:e},rows:[{type:"drop",slug:"feat",filter:{type:"feat",search:r}}],process:async({utils:o,fields:n,addFeat:a,messages:c})=>{let d=n.feat.uuid,u=await o.createFeatSource(d);a(u),c.add("feats",{uuid:d})}}}l(fe,"createFeatDaily");var Qe={key:"flexibility",item:{uuid:"Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8"},children:[{slug:"improved",uuid:"Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX"}],rows:[Ze("flexibility",8),Ze("improved",14,"improved")],process:async({utils:t,fields:e,addFeat:r,messages:i,children:s})=>{let o=e.flexibility.uuid,n=await t.createFeatSource(o);if(r(n),i.add("feats",{uuid:o}),s.improved){let a=e.improved.uuid,c=await t.createFeatSource(a);r(c,s.improved),i.add("feats",{uuid:a})}}};function Ze(t,e,r){let i={type:"drop",label:`PF2E.Level${e}`,slug:t,filter:{type:"feat",search:{category:["class"],traits:["fighter"],level:e}}};return r&&(i.childPredicate=[r]),i}l(Ze,"createRow");function K(t,e,r){return{key:t,label:r,item:{uuid:e},rows:[{type:"select",slug:"language",options:({actor:i,utils:s})=>{let o=i.system.traits.languages.value;return s.languageNames.filter(n=>!o.includes(n)).sort()},labelizer:({utils:i})=>i.languageLabel}],process:({addRule:i,utils:s,fields:o,messages:n})=>{let a=o.language.value,c=s.createLanguageRuleElement({language:a});i(c),n.add("languages",{uuid:e,selected:s.languageLabel(a),label:r})}}}l(K,"createLanguageDaily");var Oe="Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P",Ke="Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky",qt={0:{die:"d4",traits:["finesse","agile"],usage:"held-in-one-hand"},1:{die:"d6",traits:["finesse"],usage:"held-in-one-hand"},2:{die:"d8",traits:[],usage:"held-in-one-hand"},3:{die:"d10",traits:["reach"],usage:"held-in-two-hands"}},tt={slashing:"sword",piercing:"spear",bludgeoning:"club"},et=["grapple","nonlethal","shove","trip","modular"],Vt=Object.keys(tt),Ht=["corrosive","disrupting","flaming","frost","shock","thundering"],Yt=["anarchic","axiomatic","greaterCorrosive","greaterDisrupting","greaterFlaming","greaterFrost","greaterShock","greaterThundering","holy","unholy"],rt={key:"mindsmith",item:{uuid:"Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY"},children:[{slug:"weapon",uuid:Oe},{slug:"mental",uuid:Ke},{slug:"runic",uuid:"Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp"},{slug:"advanced",uuid:"Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD"}],rows:[{type:"alert",slug:"alert",message:()=>k("interface.alert.weapon"),fix:Jt,childPredicate:[{not:"weapon"}]},{type:"select",slug:"smith",label:()=>k("label.mindsmith"),options:Vt,labelizer:({utils:t})=>t.damageLabel,childPredicate:["weapon"]},...[1,2].map(t=>({type:"select",slug:`mental${t}`,label:()=>k("label.mentalforge",{nb:t}),options:et,labelizer:({utils:e})=>e.weaponTraitLabel,childPredicate:["weapon","mental"]})),{type:"select",slug:"runic",label:()=>k("label.runicmind"),options:Ht,labelizer:({utils:t})=>t.weaponPropertyRunesLabel,childPredicate:["weapon","runic",{not:"advanced"}],condition:({children:t,utils:e})=>e.hasFreePropertySlot(t.weapon)},{type:"select",slug:"advanced",label:()=>k("label.runicmind"),options:Yt,labelizer:({utils:t})=>t.weaponPropertyRunesLabel,childPredicate:["weapon","advanced"],condition:({children:t,utils:e})=>e.hasFreePropertySlot(t.weapon)}],process:({children:t,updateItem:e,fields:r,messages:i,item:s,utils:o})=>{let n=t.weapon;if(!n)return;i.addGroup("mindsmith");let a=r.smith.value;if(e({_id:n.id,"system.damage.damageType":a,"system.group":tt[a]}),i.add("mindsmith",{selected:o.damageLabel(a),uuid:s.uuid,label:"mindsmith"}),t.mental){let c=deepClone(n._source.system.traits?.value??[]);for(let d of[1,2]){let u=r[`mental${d}`].value;c.includes(u)||c.push(u),e({_id:n.id,"system.traits.value":c}),i.add("mindsmith",{selected:o.weaponTraitLabel(u),uuid:t.mental.uuid,label:k("label.mentalforge",{nb:d})})}}if((t.advanced||t.runic)&&o.hasFreePropertySlot(n)){let c=t.advanced??t.runic,d=o.getFreePropertyRuneSlot(n),p=(r.advanced??r.runic).value;d&&!n.system.runes.property.includes(p)&&(e({_id:n.id,[`system.${d}.value`]:p,[`flags.${v}.runeSlot`]:d}),i.add("mindsmith",{selected:o.weaponPropertyRunesLabel(p),uuid:c.uuid,label:"runicmind"}))}},rest:({item:t,sourceId:e,updateItem:r,actor:i})=>{if(e!==Oe)return;if(ce(i,Ke)){let n=t._source.system.traits?.value??[];n=n.filter(a=>!et.includes(a)),r({_id:t.id,"system.traits.value":n})}let o=I(t,"runeSlot");o&&r({_id:t.id,[`system.${o}.value`]:null,[`flags.${v}.-=runeSlot`]:!0})}};async function Jt({actor:t}){let e=C("dialog.weapon"),r=e("flavor");for(let s of["0","1","2","3"]){let o=e(`option.${s}`);r+=`<label><input type="radio" name="type" value="${s}">${o}</label>`}let i=await Dialog.wait({title:e("title"),content:r,buttons:{yes:{icon:'<i class="fas fa-save"></i>',label:e("accept"),callback:Xt},no:{icon:'<i class="fas fa-times"></i>',label:e("cancel"),callback:()=>null}},close:()=>null},{},{id:"pf2e-dailies-weapon",width:600});return i?(await t.createEmbeddedDocuments("Item",[i]),!0):!1}l(Jt,"fix");async function Xt(t){let e=C("dialog.weapon"),r=t.find("[name=type]:checked").val();if(!r){e.warn("error.noSelection");return}let i=(await fromUuid(Oe))?.toObject();if(!i){e.warn("error.missing");return}let s=qt[r];return setProperty(i,"system.damage.die",s.die),setProperty(i,"system.traits.value",s.traits.slice()),setProperty(i,"system.usage.value",s.usage),i}l(Xt,"onWeaponSelected");function ee(t,e,r,i,s,o){return{key:t,label:s,item:{uuid:e},rows:[{type:o?"random":"select",slug:"resistance",options:r,labelizer:({utils:a})=>a.resistanceLabel}],process:async({utils:a,fields:c,actor:d,addRule:u,messages:p})=>{let b=o?await a.randomOption(r):c.resistance.value,w=typeof i=="number"?i:i==="half"?a.halfLevelValue(d):d.level,f=a.createResistanceRuleElement({type:b,value:w});u(f),p.add("resistances",{uuid:e,selected:a.resistanceLabel(b,w),label:s,random:o})}}}l(ee,"createResistancelDaily");var Zt="Compendium.pf2e.feat-effects.Item.jO7wMhnjT7yoAtQg",it={key:"root",item:{uuid:"Compendium.pf2e.feats-srd.Item.22P7IFyhrF7Fbw8B"},rows:[{type:"select",slug:"target",options:({actor:t,utils:e})=>e.getPlayersActors(t).map(i=>({value:i.id,label:i.name}))}],process:({fields:t,messages:e})=>{let r=t.target.value,i=game.actors.get(r);i&&(e.addGroup("root"),e.add("root",{uuid:Zt,selected:i.name}))}};var st={key:"savant",item:{uuid:"Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ"},prepare:({actor:t})=>{let{maxSlot:e,maxTradition:r}=Qt(t,"arcane");return{first:{level:e-2,condition:!0},second:{level:e-3,condition:!0},third:{level:e-4,condition:r>=3&&e>=5},fourth:{level:e-5,condition:r>=4&&e>=6}}},rows:["first","second","third","fourth"].map(t=>({type:"drop",slug:t,label:({custom:r})=>`PF2E.SpellLevel${r[t].level}`,filter:{type:"spell",search:({custom:r})=>({category:["spell"],traditions:["arcane"],level:r[t].level})},condition:({custom:r})=>r[t].condition})),process:async({utils:t,fields:e,custom:r,addItem:i,messages:s})=>{for(let o of Object.values(e)){let n=o.uuid,a=await t.createSpellScrollSource({uuid:n,level:r[o.row].level});i(a),s.add("scrolls",{uuid:n,label:a.name})}}};function Qt(t,e){let r=1,i=0;for(let s of t.spellcasting.regular){if(s.flags&&"pf2e-staves"in s.flags)continue;let o=s.system.slots;for(let n in o)o[n].max&&(r=Math.max(r,Number(n.slice(4))));s.tradition===e&&(i=Math.max(i,s.rank))}return{maxSlot:Math.min(r,10),maxTradition:i}}l(Qt,"getSpellcastingTraditionDetails");function j(t,e,r){return{key:t,label:r,item:{uuid:e},rows:[{type:"combo",slug:"skill",options:({actor:s,utils:o})=>{let n=s.skills;return o.skillNames.filter(a=>n[a].rank<1)},labelizer:({utils:s})=>s.skillLabel}],process:({fields:s,addItem:o,addRule:n,utils:a,messages:c})=>{let d=s.skill.value;if(s.skill.input==="true"){let u=a.createLoreSource({name:d,rank:1});o(u)}else{let u=a.createSkillRuleElement({skill:d,value:1});d=a.skillLabel(d),n(u)}c.add("skills",{uuid:e,selected:d,label:r})}}}l(j,"createTrainedSkillDaily");function me(t,e,r){return{key:t,label:r,item:{uuid:e},rows:[{type:"input",slug:"skill"}],process:({addItem:s,utils:o,fields:n,messages:a})=>{let c=n.skill.value,d=o.createLoreSource({name:c,rank:1});s(d),a.add("skills",{uuid:e,selected:c,label:r})}}}l(me,"createTrainedLoreDaily");var nt={key:"tome",item:{uuid:"Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e"},children:[{slug:"adept",uuid:"Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO",condition:Ee("adept")},{slug:"second",uuid:"Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5",condition:Ee("adept")},{slug:"intense",uuid:"Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC"},{slug:"paragon",uuid:"Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI",condition:Ee("paragon")}],prepare:({utils:t,actor:e,children:r})=>{let i=t.skillNames,s=e.level,o=e.skills,n={first:{options:[],rank:1},second:{options:[],rank:1}};if(r.paragon){let a=i.filter(c=>o[c].rank<4);n.first={rank:4,options:a},n.second={rank:4,options:a}}else if(r.intense||r.adept||r.second){let a=i.filter(c=>o[c].rank<3);if(s>=9)n.first={rank:3,options:a},n.second={rank:3,options:a};else{let c=i.filter(d=>o[d].rank<2);n.first={rank:2,options:c},n.second={rank:3,options:a}}}else if(s>=5){let a=i.filter(c=>o[c].rank<2);n.first={rank:2,options:a},n.second={rank:2,options:a}}else if(s>=3){let a=i.filter(d=>o[d].rank<1),c=i.filter(d=>o[d].rank<2);n.first={rank:1,options:a},n.second={rank:2,options:c}}else{let a=i.filter(c=>o[c].rank<1);n.first={rank:1,options:a},n.second={rank:1,options:a}}return n},rows:["first","second"].map(t=>({type:"combo",slug:t,label:({custom:r,utils:i})=>i.proficiencyLabel(r[t].rank),options:({custom:r})=>r[t].options,labelizer:({utils:r})=>r.skillLabel})),process:({custom:t,fields:e,utils:r,messages:i,addItem:s,addRule:o})=>{i.addGroup("tome",65);for(let n of["first","second"]){let a=t[n].rank,c=e[n].value;if(e[n].input==="true"){let d=r.createLoreSource({name:c,rank:a});s(d)}else{let d=r.createSkillRuleElement({skill:c,value:a});c=r.skillLabel(c),o(d)}i.add("tome",{label:r.proficiencyLabel(a),selected:c})}}};function Ee(t){return function({item:e,utils:r}){return r.getChoiSetRuleSelection(e,t)==="tome"}}l(Ee,"createChildCondition");var Kt=["root-magic"],Ae=[nt,j("longevity","Compendium.pf2e.feats-srd.Item.WoLh16gyDp8y9WOZ"),j("ageless","Compendium.pf2e.feats-srd.Item.wylnETwIz32Au46y"),j("memories","Compendium.pf2e.feats-srd.Item.ptEOt3lqjxUnAW62"),j("studies","Compendium.pf2e.feats-srd.Item.9bgl6qYWKHzqWZj0"),me("study","Compendium.pf2e.feats-srd.Item.aLJsBBZzlUK3G8MW"),K("linguistics","Compendium.pf2e.feats-srd.Item.eCWQU16hRLfN1KaX"),K("borts","Compendium.pf2e.equipment-srd.Item.iS7hAQMAaThHYE8g"),ee("elementalist","Compendium.pf2e.feats-srd.Item.tx9pkrpmtqe4FnvS",["air","earth","fire","water"],"half","elementalist"),ee("ganzi","Compendium.pf2e.heritages.Item.3reGfXH0S82hM7Gp",["acid","electricity","sonic"],"half","ganzi",!0),fe("metamagical","Compendium.pf2e.classfeatures.Item.89zWKD2CN7nRu2xp",{category:["class"],traits:{selected:["metamagic","wizard"],conjunction:"and"},level:"half"}),Qe,st,De("esoterica",["Compendium.pf2e.feats-srd.Item.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.Item.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.Item.LHjPTV5vP3MOsPPJ"]),De("trickster",["Compendium.pf2e.feats-srd.Item.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.Item.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.Item.lIg5Gzz7W70jfbk1"]),Ye(),rt,Xe,it],er=ge(Ae,"dailies"),te=new Map;function ge(t,e){let r=new Map;for(let i of t){let s=deepClone(i);try{let o=`${e}.${s.key}`;if(r.set(s.item.uuid,{daily:s,condition:s.item.condition}),s.key=o,s.children)for(let n=0;n<s.children.length;n++){let{uuid:a,condition:c}=s.children[n];r.set(a,{daily:s,index:n,condition:c})}}catch(o){F("error.unexpected"),console.error(o),console.error(`The error occured during data gathering of ${e}.${s.key}`)}}return r}l(ge,"prepareDailies");var re=[];async function Te(){te.clear(),re=[];let t=D("customDailies");for(let{key:r,code:i}of t)try{let o=await new oe(i)();if(!Le(o,!0))continue;re.push(o)}catch(s){F("error.unexpected"),console.error(s),console.error(`The error occured during call of custom function for ${r}`)}for(let[r,i]of er.entries())te.set(r,i);let e=ge(re,"custom");for(let[r,i]of e.entries())te.set(r,i)}l(Te,"parseCustomDailies");function Le(t,e=!1){return Kt.includes(t.key)?(e&&game.user.isGM&&O("deprecated.custom.key",{name:t.label.trim()||t.key},!0),!1):!0}l(Le,"checkCustomDaily");function ot(t){let e={};for(let r of t.items){let i=q(r);if(!i||r.isOfType("physical")&&r.isInvested===!1)continue;let s=te.get(i);if(!s)continue;let{daily:o,index:n,condition:a}=s;try{if(typeof a=="function"&&!a({actor:t,item:r,utils:V}))continue;e[o.key]??=deepClone(o),n===void 0?e[o.key].item=r:e[o.key].children[n].item=r}catch(c){F("error.unexpected"),console.error(c),console.error(`The error occured during data gathering of ${o.key}`)}}return Object.values(e).filter(r=>r.item&&r.item instanceof Item)}l(ot,"getDailies");function at(t){return te.get(t)?.daily}l(at,"getDailyFromSourceId");function ye(){return game.packs.get("pf2e.familiar-abilities")}l(ye,"getFamiliarPack");function lt(t){return`Compendium.pf2e.familiar-abilities.Item.${t}`}l(lt,"familiarUUID");var tr="Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB";function he(t){return ce(t,tr)}l(he,"getRations");function ct(t){return Error(`PF2e System | ${t}`)}l(ct,"ErrorPF2e");function Fe(t){return typeof t=="object"&&t!==null}l(Fe,"isObject");var T=class extends Array{constructor(...e){super(...Array.isArray(e[0])?e[0]:e),this.isValid=T.isValid(this)}static isValid(e){return this.isArray(e)}static isArray(e){return super.isArray(e)&&e.every(r=>z.isStatement(r))}static test(e=[],r){return e instanceof T?e.test(r):new T(...e).test(r)}test(e){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let r=e instanceof Set?e:new Set(e);return this.every(i=>this.#e(i,r))}toObject(){return deepClone([...this])}clone(){return new T(this.toObject())}#e(e,r){return typeof e=="string"&&r.has(e)||z.isBinaryOp(e)&&this.#i(e,r)||z.isCompound(e)&&this.#r(e,r)}#i(e,r){if("eq"in e)return r.has(`${e.eq[0]}:${e.eq[1]}`);{let i=Object.keys(e)[0],[s,o]=Object.values(e)[0],n=Array.from(r),a=l(u=>{let p=Number(u);if(!Number.isNaN(p))return[p];let b=new RegExp(String.raw`^${u}:([^:]+)$`),w=n.map(f=>Number(b.exec(f)?.[1]||NaN)).filter(f=>!Number.isNaN(f));return w.length>0?w:[NaN]},"getValues"),c=a(s),d=a(o);switch(i){case"gt":return c.some(u=>d.every(p=>u>p));case"gte":return c.some(u=>d.every(p=>u>=p));case"lt":return c.some(u=>d.every(p=>u<p));case"lte":return c.some(u=>d.every(p=>u<=p));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}}#r(e,r){return"and"in e&&e.and.every(i=>this.#e(i,r))||"nand"in e&&!e.nand.every(i=>this.#e(i,r))||"or"in e&&e.or.some(i=>this.#e(i,r))||"xor"in e&&e.xor.filter(i=>this.#e(i,r)).length===1||"nor"in e&&!e.nor.some(i=>this.#e(i,r))||"not"in e&&!this.#e(e.not,r)||"if"in e&&!(this.#e(e.if,r)&&!this.#e(e.then,r))}};l(T,"PredicatePF2e");var be,z=class{static isStatement(e){return e instanceof Object?this.isCompound(e)||this.isBinaryOp(e):typeof e=="string"?this.isAtomic(e):!1}static isAtomic(e){return typeof e=="string"&&e.length>0||this.isBinaryOp(e)}static isBinaryOp(e){if(!Fe(e))return!1;let r=Object.entries(e);if(r.length>1)return!1;let[i,s]=r[0];return We(this,be).has(i)&&Array.isArray(s)&&s.length===2&&typeof s[0]=="string"&&["string","number"].includes(typeof s[1])}static isCompound(e){return Fe(e)&&(this.isAnd(e)||this.isOr(e)||this.isNand(e)||this.isXor(e)||this.isNor(e)||this.isNot(e)||this.isIf(e))}static isAnd(e){return Object.keys(e).length===1&&Array.isArray(e.and)&&e.and.every(r=>this.isStatement(r))}static isNand(e){return Object.keys(e).length===1&&Array.isArray(e.nand)&&e.nand.every(r=>this.isStatement(r))}static isOr(e){return Object.keys(e).length===1&&Array.isArray(e.or)&&e.or.every(r=>this.isStatement(r))}static isXor(e){return Object.keys(e).length===1&&Array.isArray(e.xor)&&e.xor.every(r=>this.isStatement(r))}static isNor(e){return Object.keys(e).length===1&&Array.isArray(e.nor)&&e.nor.every(r=>this.isStatement(r))}static isNot(e){return Object.keys(e).length===1&&!!e.not&&this.isStatement(e.not)}static isIf(e){return Object.keys(e).length===2&&this.isStatement(e.if)&&this.isStatement(e.then)}};l(z,"StatementValidator"),be=new WeakMap,Ge(z,be,new Set(["eq","gt","gte","lt","lte"]));var rr={select:100,combo:80,random:60,alert:40,input:20,drop:0};async function dt({children:t=[],key:e,item:r,prepare:i,label:s,rows:o=[]}){let n=this.actor,a=this.saved[e]=I(n,e)??{},c=this.rows[e]={},d=this.children[e]=t.reduce((g,{slug:y,item:S})=>(g[y]=S,g),{}),u={actor:n,item:r,children:d,utils:V},p=this.custom[e]=i&&await i(u)||{},b=this.dailyArgs[e]={...u,custom:p},w=await Re(s,b),f=w?`label.${w}`:e.startsWith("dailies.")?`label.${e.slice(8)}`:void 0;f&&Z(f)&&(w=k(f));let m=this.predicate[e]=t.filter(g=>g.item).map(g=>g.slug),h={label:w?game.i18n.localize(w):r.name,rows:[]};for(let g of o){c[g.slug]=g;let{type:y,slug:S,childPredicate:E=[],condition:_,label:P,save:Nt}=g;if(E.length&&!T.test(E,m)||_&&!await _(b))continue;let N=Nt===!1||y==="random"?void 0:a[S],je=await Re(P,b),$t=N===void 0?"":typeof N!="object"?N:"name"in N?N.name:N.selected,A={label:je?game.i18n.localize(je):"",value:$t,order:rr[y],data:{type:y,daily:e,row:S}};if(ut(g)||ir(g)||sr(g)){let xe=await Re(g.options,b)??[];if(y!=="combo"&&!xe.length)continue;let ze=typeof g.labelizer=="function"&&g.labelizer(b)||(G=>de(G));A.options=xe.map(G=>typeof G=="string"?{value:G,label:ze(G)}:G),ut(g)&&(A.selected=A.value,A.data.input=N?.input??!0,!A.data.input&&xe.includes(A.selected)&&(A.value=ze(A.selected)))}else nr(g)?A.data.uuid=N?.uuid??"":or(g)&&(A.value=typeof g.message=="function"?await g.message(b):g.message);h.rows.push(A)}return h}l(dt,"getTemplate");async function Re(t,e){return typeof t=="function"?await t(e):t}l(Re,"getProcessedValue");function ut(t){return t.type==="combo"}l(ut,"isComboRow");function ir(t){return t.type==="select"}l(ir,"isSelectRow");function sr(t){return t.type==="random"}l(sr,"isRandomRow");function nr(t){return t.type==="drop"}l(nr,"isDropRow");function or(t){return t.type==="alert"}l(or,"isAlerRow");function pt(){return Object.entries(CONFIG.PF2E.skillList).reduce((t,[e,r])=>({...t,[e]:game.i18n.localize(r).toLocaleLowerCase(game.i18n.lang)}),{})}l(pt,"getTranslatedSkills");var we=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,_e=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,ar=new RegExp(_e,"gu"),lr=String.raw`(?:${we})(?=${_e})|(?:${_e})(?=${we})`,cr=String.raw`(?:${we})(?=${we})`,ft=String.raw`\p{Lowercase_Letter}`,mt=String.raw`\p{Uppercase_Letter}`,ur=new RegExp(`(${ft})(${mt}${cr})`,"gu"),dr=/[^-\p{White_Space}\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]/gu,pr=new RegExp(`${mt}|(?:${lr})${ft}`,"gu");function M(t,{camel:e=null}={}){if(typeof t!="string")return console.warn("Non-string argument passed to `sluggify`"),"";switch(e){case null:return t.replace(ur,"$1-$2").toLowerCase().replace(/['’]/g,"").replace(ar," ").trim().replace(/[-\s]+/g,"-");case"bactrian":{let r=M(t,{camel:"dromedary"});return r.charAt(0).toUpperCase()+r.slice(1)}case"dromedary":return t.replace(dr,"").replace(/[-_]+/g," ").replace(pr,(r,i)=>i===0?r.toLowerCase():r.toUpperCase()).replace(/\s+/g,"");default:throw ct("I don't think that's a real camel.")}}l(M,"sluggify");function ve(t,e,r){if(e===void 0)return r;if(typeof e=="number")return e;if(e==="level")return t.level;if(e==="half")return Math.max(1,Math.floor(t.level/2));let i=Number(e);return isNaN(i)?r:i}l(ve,"getSimplifiableValue");async function gt(t){return{type:t.type,search:await(t.type==="feat"?mr(this.actor,t.search):fr(this.actor,t.search)),drop:t.drop}}l(gt,"parseFilter");function L(t,e){t?.length&&(e.selected=t,e.isExpanded=!0,t.forEach(r=>e.options[r].selected=!0))}l(L,"checkFilter");function yt(t,e){let r=Se(t);r?.selected.length&&(e.conjunction=r.conjunction,e.selected=r.selected)}l(yt,"setTraits");function Se(t){if(!t)return;let e=Array.isArray(t)?t:t.selected;if(e?.length)return{selected:e.map(r=>typeof r=="string"?{value:r}:r),conjunction:!Array.isArray(t)&&t.conjunction||"and"}}l(Se,"getFilterTraits");async function fr(t,e){let r=await game.pf2e.compendiumBrowser.tabs.spell.getFilterData();L(e.category,r.checkboxes.category),L(e.school,r.checkboxes.school),L(e.traditions,r.checkboxes.traditions),L(e.rarity,r.checkboxes.rarity),L(e.source,r.checkboxes.source),yt(e.traits,r.multiselects.traits);let i=Pe(t,e.level);return i?.length&&L(i,r.checkboxes.level),r}l(fr,"parseSpellFilter");async function mr(t,e){let r=await game.pf2e.compendiumBrowser.tabs.feat.getFilterData();L(e.category,r.checkboxes.category),L(e.skills,r.checkboxes.skills),L(e.rarity,r.checkboxes.rarity),L(e.source,r.checkboxes.source),yt(e.traits,r.multiselects.traits);let i=Ne(t,e.level);return i&&(r.sliders.level.values.min=i.min,r.sliders.level.values.max=i.max,r.sliders.level.isExpanded=!0),r}l(mr,"parseFeatFilter");function Pe(t,e){if(Array.isArray(e))return e;let r=ve(t,e);if(r)return ue(1,r)}l(Pe,"getSpellFilterLevel");function Ne(t,e){if(e!==void 0)return typeof e=="object"?{min:ve(t,e.min,0),max:ve(t,e.min,20)}:{min:0,max:ve(t,e,20)}}l(Ne,"getFeatFilterLevel");var x=C("interface.error.drop");async function ht(t,e,r){if(!t.isOfType("feat"))return x("notFeat");let{search:i,drop:s}=r;if(i.category?.length&&!i.category.includes(t.category))return x.warn("wrongType",{types:H("featCategories",i.category)});if(i.traits){let n=Se(i.traits);if(n?.selected.length){let a=n.conjunction==="or"?"some":"every";if(!n.selected[a](d=>Number(d.not??!1)-Number(t.traits.has(d.value))))return x.warn("wrongTraits")}}if(i.skills?.length){let n=pt(),a=t.system.prerequisites.value.map(d=>d.value.toLocaleLowerCase());if(!i.skills.some(d=>a.some(u=>u.includes(d)||u.includes(n[d]))))return x.warn("wrongSkill",{skills:H("skillList",i.skills)})}if(i.rarity?.length&&!i.rarity.includes(t.system.traits.rarity))return x.warn("wrongRarity",{rarities:H("rarityTraits",i.rarity)});if(i.source?.length&&!i.source.includes(M(t.system.source.value)))return x.warn("wrongSource",{sources:i.source.join(", ")});let o=Ne(this.actor,i.level);if(o){let n=t.level;if(n<o.min)return x.warn("wrongLevelLow",{level:`min: ${o.min}`});if(n>o.max)return x.warn("wrongLevelHigh",{level:`max: ${o.max}`})}if(s){let n=this.dailyArgs[e.dataset.daily];if(n){let a=await s(t,n);if(typeof a=="object")return a.data?game.i18n.format(a.error,a.data):game.i18n.localize(a.error);if(a===!1)return x.warn("wrongCustom")}}ie(t,e)}l(ht,"onDropFeat");async function bt(t,e,r){if(!t.isOfType("spell"))return x("notSpell");let{search:i,drop:s}=r;if(i.category?.length){let n=i.category.map(a=>game.i18n.localize(a==="cantrip"?"PF2E.SpellCantripLabel":CONFIG.PF2E.spellCategories[a])).join(", ");if(t.isCantrip&&!i.category.includes("cantrip")||t.isFocusSpell&&!i.category.includes("focus")||t.isRitual&&!i.category.includes("ritual")||!t.isCantrip&&!t.isFocusSpell&&!t.isRitual&&!i.category.includes("spell"))return x.warn("wrongCategory",{categories:n})}if(i.traits){let n=Se(i.traits);if(n?.selected.length){let a=n.conjunction==="or"?"some":"every";if(!n.selected[a](d=>Number(d.not??!1)-Number(t.traits.has(d.value))))return x.warn("wrongTraits")}}if(i.traditions?.length&&!i.traditions.some(n=>t.traditions.has(n)))return x.warn("wrongTradition",{traditions:H("magicTraditions",i.traditions)});let o=Pe(this.actor,i.level);if(o?.length&&!o.includes(t.level))return x.warn("wrongLevel",{levels:o.join(", ")});if(i.school?.length&&!i.school.includes(t.school))return x.warn("wrongSchool",{schools:H("magicSchools",i.school)});if(i.rarity?.length&&!i.rarity.includes(t.system.traits.rarity))return x.warn("wrongRarity",{rarities:H("rarityTraits",i.rarity)});if(i.source?.length&&!i.source.includes(M(t.system.source.value)))return x.warn("wrongSource",{sources:i.source.join(", ")});if(s){let n=this.dailyArgs[e.dataset.daily];if(n){let a=await s(t,n);if(typeof a=="object")return a.data?ui.notifications.warn(game.i18n.format(a.error,a.data)):ui.notifications.warn(game.i18n.localize(a.error));if(a===!1)return x.warn("wrongCustom")}}ie(t,e)}l(bt,"onDropSpell");function H(t,e){return e.map(i=>game.i18n.localize(CONFIG.PF2E[t][i])).join(", ")}l(H,"localizeAll");function ie(t,e){e.value=t.name,e.dataset.uuid=t.uuid,e.nextElementSibling.nextElementSibling.classList.remove("disabled")}l(ie,"onDropItem");async function wt(){let t=this.actor,e=this.dailies,r=yr.call(this),i=[],s=new Map,[o,n]=ke(),a={},c=C("message"),d=!1,u="",p=l(f=>{let m=f.id,h=s.get(m);if(h)return h;let g=deepClone(f._source.system.rules);for(let y=g.length-1;y>=0;y--)v in g[y]&&g.splice(y,1);return s.set(m,g),g},"getRules"),b={languages:{order:80,messages:[]},skills:{order:70,messages:[]},resistances:{order:60,messages:[]},feats:{order:50,messages:[]},spells:{order:40,messages:[]},scrolls:{order:30,messages:[]}},w={add:(f,m)=>{b[f]??={order:0,messages:[]},b[f].messages.push(m)},addGroup:(f,m=1,h)=>{b[f]??={label:h,order:m,messages:[]}}};if(t.familiar&&r["dailies.familiar"]){let f=t.familiar,m=ye(),h=[],g=f.itemTypes.action.map(y=>y.id);g.length&&f.deleteEmbeddedDocuments("Item",g),w.addGroup("familiar",20);for(let y of Object.values(r["dailies.familiar"])){let S=y.value,E=S.includes("."),_=await(E?fromUuid(S):m.getDocument(S));if(!_||!_.isOfType("action"))continue;let P=_.toObject();P&&(h.push(P),w.add("familiar",{uuid:E?S:lt(S)}))}h.length&&f.createEmbeddedDocuments("Item",h)}if(r["dailies.rations"]?.rations.value==="true"){let f=he(t);if(f?.uses.value){let m=f.quantity,{value:h,max:g}=f.uses;h<=1?m<=1?f.delete():n({_id:f.id,"system.quantity":Math.max(f.quantity-1,0),"system.charges.value":g}):n({_id:f.id,"system.charges.value":Math.max(h-1,0)});let y=(m-1)*g+h,S=y<=1?He(f.name):Q(f.uuid);y<=1?u+=c("rations.last",{name:S}):y<=3?u+=c("rations.almost",{name:S,nb:y-1}):u+=c("rations.used",{name:S,nb:y-1})}}for(let{item:f,key:m,process:h}of e){if(!r[m])continue;let g=this.dailyArgs[m];try{await h({...g,fields:r[m],messages:w,addItem:y=>i.push(y),updateItem:n,addRule:(y,S)=>{y[v]=!0,p(S??f).push(y)},addFeat:(y,S)=>{if(S??=f,S.isOfType("feat")){let E=S.id;setProperty(y,"flags.pf2e.grantedBy",{id:E,onDelete:"cascade"}),setProperty(y,`flags.${v}.grantedBy`,E)}i.push(y)},addSpell:(y,S)=>{setProperty(y,`flags.${v}.entry`,{level:S}),i.push(y),d=!0}})}catch(y){F("error.unexpected"),console.error(y),console.error(`The error occured during processing of ${m}`)}}for(let[f,m]of Object.entries(r)){let h=this.rows[f];if(h)for(let{row:g,type:y,input:S,value:E,uuid:_}of Object.values(m)){if(y==="random"||h[g]?.save===!1)continue;let P=a[f]??={};y==="combo"?P[g]={input:S==="true",selected:E}:y==="drop"?P[g]={uuid:_,name:E}:P[g]=E}}for(let[f,m]of s)n({_id:f,"system.rules":m});if(d){let f={type:"spellcastingEntry",name:k("spellEntry.name"),system:{prepared:{value:"innate"},showSlotlessLevels:{value:!1},showUnpreparedSpells:{value:!1},proficiency:{value:1,slug:t.classDC?.slug||t.class?.slug||void 0}}};i.push(f)}for(let f of i)getProperty(f,"system.temporary")===!0||setProperty(f,`flags.${v}.temporary`,!0);if(i.length){let f=await t.createEmbeddedDocuments("Item",i);for(let m of f)if(m.isOfType("feat")){let h=I(m,"grantedBy");if(h){let y=`flags.pf2e.itemGrants.${M(m.name,{camel:"dromedary"})}`;n({_id:h,[y]:{id:m.id,onDelete:"detach"}})}}else if(m.isOfType("spellcastingEntry")){let h=f.filter(g=>g.isOfType("spell")&&I(g,"entry"));for(let g of h){let{level:y}=I(g,"entry"),S={_id:g.id,"system.location.value":m.id};y!==void 0&&(S["system.location.heightenedLevel"]=y),n(S)}}}await t.update({[`flags.${v}`]:{...expandObject(a),rested:!1}}),o.size&&await t.updateEmbeddedDocuments("Item",o.contents),u=gr(b,u),u=u?`${c("changes")}<hr />${u}`:c("noChanges"),ChatMessage.create({content:u,speaker:ChatMessage.getSpeaker({actor:t})})}l(wt,"processData");function gr(t,e){let r=C("message"),i=Object.entries(t).map(([s,o])=>(o.label??=r.has(s)?r(s):r("gained",{type:s}),o));i.sort((s,o)=>o.order-s.order);for(let{label:s,messages:o}of i)if(o.length){e&&(e+="<hr />"),s&&(e+=`<p><strong>${s}</strong></p>`);for(let{uuid:n,selected:a,label:c,random:d}of o){let u=`label.${c}`;c=c&&Z(u)?k(u):c||"",e+="<p>",e+=n?`${Q(n,c)}`:`<strong>${c}</strong>`,a&&(e+=` <span>${a}</span>`),d&&(e+=' <i class="fa-solid fa-dice-d20"></i>'),e+="</p>"}}return e}l(gr,"parseMessages");function yr(){let t=this.element.find(".window-content .content").find("input:not(.alert), select[data-type]").toArray(),e={};for(let r of t){let i={...r.dataset,value:r.value};if(i.type==="combo"&&i.input==="false"){let s=r.previousElementSibling;i.value=s.value}e[i.daily]??={},e[i.daily][i.row]=i}return e}l(yr,"getFields");var W=C("interface"),se=class extends Application{constructor(e,r){super(r),this._actor=e,this._dailies=[],this._dailyArgs={},this._saved={},this._children={},this._custom={},this._predicate={},this._rows={}}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"pf2e-dailies-interface",template:le("interface.hbs"),height:"auto",width:400,submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[data-droppable="true"]'}]})}get actor(){return this._actor}get dailies(){return this._dailies}get dailyArgs(){return this._dailyArgs}get saved(){return this._saved}get children(){return this._children}get custom(){return this._custom}get predicate(){return this._predicate}get rows(){return this._rows}async getData(e){let r=[],i=this._actor;if(this._dailies=ot(i),i.familiar){let a="dailies.familiar",c=C("label"),d=i.attributes.familiarAbilities.value,u=ye(),p=I(i,a)??{},b={label:c("familiar"),rows:[]},w=u.index.map(({_id:m,name:h})=>({value:m,label:h})),f=D("familiar").split(",");for(let m of f){m=m.trim();let h=await fromUuid(m);h&&h.isOfType("action")&&w.push({value:m,label:h.name})}w.sort((m,h)=>m.label.localeCompare(h.label));for(let m=0;m<d;m++)b.rows.push({label:c("ability",{nb:m+1}),value:p[`${m}`]??"",order:100,options:w,data:{type:"select",daily:a,row:m.toString()}});b.rows.length&&(this._rows[a]=b.rows.reduce((m,{data:h})=>(m[h.row]={save:!0},m),{}),r.push(b))}let s=he(i);if(s?.uses.value){let a="dailies.rations",c="rations",{value:d,max:u}=s.uses,b=(s.quantity-1)*u+d,w=b<=1,f=[{value:"false",label:W("rations.no")},{value:"true",label:w?W("rations.last"):W("rations.yes",{nb:b})}];r.push({label:s.name,rows:[{label:"",order:200,value:"false",options:f,data:{type:"select",daily:a,row:c}}]}),this._rows[a]={[c]:{save:!1}}}for(let a of this._dailies)try{let c=await dt.call(this,a);r.push(c)}catch(c){W.error("error.unexpected"),console.error(c),console.error(`The error occured during templating of ${a.key}`)}let o=[],n=[];for(let a of r)a.rows.length>1?n.push(a):a.rows.length&&o.push(a);return o.sort((a,c)=>c.rows[0].order-a.rows[0].order),n.sort((a,c)=>a.rows.length-c.rows.length),mergeObject(super.getData(e),{i18n:W,dump:({value:a,placeholder:c,data:d})=>{let u="";return a&&(u+=` value="${a}"`),c&&(u+=` placeholder="${c}"`),Object.entries(d).forEach(([p,b])=>u+=` data-${p}="${b}"`),u&&(u+=" "),u},rows:o,groups:n,hasDailies:o.length||n.length})}render(e,r){return this._randomInterval&&clearInterval(this._randomInterval),this.element.find("select.random")&&(this._randomInterval=setInterval(()=>{this.element.find("select.random").each((s,o)=>{o.selectedIndex=(o.selectedIndex+1)%o.options.length})},2e3)),super.render(e,r)}close(e){return this._randomInterval&&clearInterval(this._randomInterval),super.close(e)}activateListeners(e){super.activateListeners(e),e.find("[data-action=clear]").on("click",this.#c.bind(this)),e.find("[data-action=accept]").on("click",this.#l.bind(this)),e.find("[data-action=cancel]").on("click",this.#u.bind(this)),e.find(".combo select").on("change",this.#s.bind(this)),e.find(".combo input").on("change",this.#n.bind(this)),e.find("[data-action=search]").on("click",this.#i.bind(this)),e.find("[data-action=alert]").on("click",this.#e.bind(this))}_canDragDrop(e){return!0}async _onDrop(e){let r=C("interface.error.drop"),i=e.target;i instanceof HTMLLabelElement&&(i=i.nextElementSibling);try{let s=e.dataTransfer?.getData("text/plain"),o=JSON.parse(s);if(!o||o.type!=="Item"||typeof o.uuid!="string")return r.warn("wrongDataType");let n=await fromUuid(o.uuid);if(!n)return r.warn("wrongDataType");let a=await this.#r(i);if(!a)return ie(n,i);a.type==="feat"?ht.call(this,n,i,a):a.type==="spell"?bt.call(this,n,i,a):ie(n,i)}catch(s){r.error("error.unexpected"),console.error(s),console.error("The error occured during _onDrop")}}async#e(e){e.preventDefault(),this.#t();let r=e.currentTarget.dataset,i=this.rows[r.daily][r.row],s=this.dailyArgs[r.daily],o;try{o=await i.fix(s)}catch(n){W.error("error.unexpected"),console.error(n),console.error(`The error occured during an alert fix of '${r.daily}'`)}this.#o(),o&&this.render()}async#i(e){e.preventDefault();let r=await this.#r(e.currentTarget,!0);r?game.pf2e.compendiumBrowser.openTab(r.type,r.search):game.pf2e.compendiumBrowser.render(!0)}async#r(e,r){let{daily:i,row:s}=e.dataset,o=this.rows[i]?.[s]?.filter,n=this.dailyArgs[i];if(!(!n||!o))return typeof o.search=="function"&&(o.search=await o.search(n)),r?gt.call(this,o):o}#s(e){let r=e.currentTarget,i=r.nextElementSibling;i.dataset.input="false",i.value=r.options[r.selectedIndex].text}#n(e){let r=e.currentTarget,i=r.previousElementSibling,s=r.value.toLowerCase(),n=Array.from(i.options).map(a=>a.value).indexOf(s);n!==-1?(i.value=s,r.value=i.options[n].text,r.dataset.input="false"):(i.value="",r.dataset.input="true")}#t(){this.element.addClass("disabled")}#o(){this.element.removeClass("disabled")}#a(){let e=[],r=this.element.find("input").filter((s,o)=>!o.value),i=this.element.find("input.alert");return r.length&&e.push("error.empty"),i.length&&e.push("error.unattended"),e.forEach(s=>W.warn(s)),!e.length}async#l(e){e.preventDefault(),this.#a()&&(this.#t(),await wt.call(this),this.close())}#c(e){e.preventDefault();let r=$(e.currentTarget),i=r.prevAll("input").first();i.val(""),i.attr("value",""),i.attr("data-uuid",""),r.addClass("disabled")}#u(e){e.preventDefault(),this.close()}};l(se,"DailiesInterface");function vt(t,e){I(t,"isWatch")&&e.find(".message-content button").on("click",()=>Y())}l(vt,"renderChatMessage");function St(){let t=`<div>${k("message.dailiesRequest.content")}</div>`;t+=`<button type="button" style="margin-top: 8px;">${k("message.dailiesRequest.button")}</button>`,Ve().create({content:t,flags:{[v]:{isWatch:!0}}})}l(St,"createWatchChatMessage");var hr={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"},kt=[];async function xt(t,e,r=!1){let i=(await fromUuid(t))?.toObject();if(!i)return null;e===!1&&(e=i.system.level.value);let s=br(e);kt[e]??=await fromUuid(s);let o=kt[e]?.toObject();if(!o)return null;i.system.location.heightenedLevel=e,o.name=`Scroll of ${i.name} (Level ${e})`,o.system.temporary=r,o.system.spell=i,o.system.traits.value.push(...i.system.traditions.value);let n=i.flags.core?.sourceId;return n&&(o.system.description.value=`${Q(n)}
<hr />${o.system.description.value}`),o}l(xt,"createSpellScroll");function br(t){return`Compendium.pf2e.equipment-srd.Item.${hr[t]}`}l(br,"getScrollCompendiumUUID");var It="max(1,floor(@actor.level/2))",wr=["propertyRune1","propertyRune2","propertyRune3","propertyRune4"],Ct,Dt,V={get skillNames(){return Ct??=Object.keys(CONFIG.PF2E.skillList).filter(t=>t!=="lore"),Ct.slice()},skillLabel:t=>game.i18n.localize(CONFIG.PF2E.skillList[t]),createSkillRuleElement:({skill:t,value:e,mode:r="upgrade",predicate:i})=>{let s={key:"ActiveEffectLike",mode:r,path:`system.skills.${t}.rank`,value:e};return i&&i.length&&(s.predicate=i),s},createLoreSource:({name:t,rank:e})=>({type:"lore",img:"systems/pf2e/icons/default-icons/lore.svg",name:t,system:{proficient:{value:e}}}),get languageNames(){return Dt??=Object.keys(CONFIG.PF2E.languages),Dt.slice()},languageLabel:t=>game.i18n.localize(CONFIG.PF2E.languages[t]),createLanguageRuleElement:({language:t,mode:e="add",predicate:r})=>{let i={key:"ActiveEffectLike",mode:e,path:"system.traits.languages.value",value:t};return r&&r.length&&(i.predicate=r),i},resistanceLabel:(t,e)=>{let r=game.i18n.localize(`PF2E.Trait${de(t)}`);return e&&(r+=` ${e}`),r},createResistanceRuleElement:({type:t,value:e,predicate:r})=>{e==="half"&&(e=It);let i={key:"Resistance",type:t,value:e};return r&&r.length&&(i.predicate=r),i},createFeatSource:async t=>{let e=(await fromUuid(t))?.toObject();if(!e)throw new Error(`An error occured while trying to create a feat source with uuid: ${t}`);return e},createSpellScrollSource:async({uuid:t,level:e})=>{let r=await xt(t,e??!1,!0);if(!r)throw new Error(`An error occured while trying to create a spell scroll source with uuid: ${t}`);return r},createSpellSource:async t=>{let e=(await fromUuid(t))?.toObject();if(!e)throw new Error(`An error occured while trying to create a spell source with uuid: ${t}`);return e},get halfLevelString(){return It},getChoiSetRuleSelection:(t,e)=>t._source.system.rules.find(s=>s.key==="ChoiceSet"&&s.rollOption===e)?.selection,proficiencyLabel:t=>game.i18n.localize(CONFIG.PF2E.proficiencyLevels[t]),randomOption:async t=>{let e=(await new Roll(`1d${t.length}`).evaluate({async:!0})).total,r=t[e-1];return typeof r=="string"?r:r.value},halfLevelValue:t=>Math.max(1,Math.floor(t.level/2)),sequenceArray:ue,damageLabel:t=>game.i18n.localize(CONFIG.PF2E.damageTypes[t]),weaponTraitLabel:t=>game.i18n.localize(CONFIG.PF2E.weaponTraits[t]),weaponPropertyRunesLabel:t=>{let e=`PF2E.WeaponPropertyRune.${t}.Name`;return game.i18n.localize(e)},hasFreePropertySlot:t=>{let e=t.system.runes.potency;return e>0&&t.system.runes.property.length<e},getFreePropertyRuneSlot:t=>{let e=t.system.potencyRune.value;if(e===null)return null;for(let r=0;r<e;r++){let i=wr[r];if(!t.system[i].value)return i}return null},getPlayersActors:(t,...e)=>{e.length||(e=["creature"]);let r=game.actors;if(t){let i=D("members")?Array.from(t.parties??[]).flatMap(s=>s.members):null;i?r=i:r=r.filter(s=>s.hasPlayerOwner),t instanceof Actor&&(r=r.filter(s=>s!==t))}else r=r.filter(i=>i.hasPlayerOwner);return r.filter(i=>i.isOfType(...e))}};function Y(t){if((!t||!t.isOfType("character")||!t.isOwner)&&(t=canvas.tokens.controlled.find(r=>r.actor?.isOfType("character")&&r.actor.isOwner)?.actor,t||(t=game.user.character)),!t||!t.isOfType("character")||!t.isOwner)return O("error.noCharacterSelected");if(I(t,"rested")!==!0)return O("error.unrested");new se(t,{title:k("interface.title",{name:t.name})}).render(!0)}l(Y,"openDailiesInterface");function Ot(){if(!game.user.isGM)return O("error.notGM");St()}l(Ot,"requestDailies");function ke(){let t=new Collection;return[t,e=>{let r=e._id;if(!r)return;let i=t.get(r)??{};t.set(r,mergeObject(i,e))}]}l(ke,"createUpdateCollection");async function Et(){let t=(await this.getCraftingEntries()).filter(s=>s.isDailyPrep),r=t.filter(s=>s.isAlchemical).reduce((s,o)=>s+o.reagentCost,0),i=(this.system.resources.crafting.infusedReagents.value||0)-r;if(i<0){ui.notifications.warn(game.i18n.localize("PF2E.CraftingTab.Alerts.MissingReagents"));return}else await this.update({"system.resources.crafting.infusedReagents.value":i});for(let s of t)for(let o of s.preparedCraftingFormulas){let n=o.item.toObject();n.system.quantity=o.quantity,n.system.temporary=!0,n.system.size=this.ancestry?.size==="tiny"?"tiny":"med",s.isAlchemical&&(n.type==="consumable"||n.type==="weapon"||n.type==="equipment")&&n.system.traits.value.push("infused"),await this.addToInventory(n)}}l(Et,"onPerformDailyCrafting");function At(t,e){let r=t.actor;if(!r.isOwner)return;e.find("aside .sidebar .hitpoints .hp-small").append(`<a class="roll-icon dailies" data-tooltip="${k("sheet.title")}"><i class="fas fa-mug-saucer"></i></a>`).find(".dailies").on("click",()=>Y(r))}l(At,"renderCharacterSheetPF2e");var Tt=["/** @typedef {'flexibility' | 'improved'} FlexibilityRow */","/** @typedef {'improved'} FlexibilityChild */","/** @typedef {[FlexibilityRow, {}, FlexibilityChild]} FlexibilityGenerics */","","/**"," * @param {FlexibilityRow} slug"," * @param {number} level"," * @param {FlexibilityChild} [child]"," */","function createRow(slug, level, child) {","    /** @type {DailyRowDrop<FlexibilityGenerics>} */","    const row = {","        type: 'drop',","        label: `PF2E.Level${level}`,","        slug,","        filter: {","            type: 'feat',","            search: {","                category: ['class'],","                traits: {","                    values: ['fighter'],","                },","                level,","            },","        },","    }","    if (child) row.childPredicate = [child]","    return row","}","","/** @type {Daily<FlexibilityGenerics>} */","const combatFlexibility = {","    key: 'flexibility',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8', // Combat Flexibility","    },","    children: [","        {","            slug: 'improved',","            uuid: 'Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX', // Improved Flexibility","        },","    ],","    rows: [","        createRow('flexibility', 8), //","        createRow('improved', 14, 'improved'),","    ],","    process: async ({ utils, fields, addFeat, messages, children }) => {","        const uuid = fields.flexibility.uuid","        const source = await utils.createFeatSource(uuid)","        addFeat(source)","        messages.add('feats', { uuid })","","        if (children.improved) {","            const uuid = fields.improved.uuid","            const source = await utils.createFeatSource(uuid)","            addFeat(source, children.improved)","            messages.add('feats', { uuid })","        }","    },","}","","return combatFlexibility"].join(`
`);var Lt=["/** @typedef {'alert' | 'smith' | 'mental' | 'runic' | 'advanced'} MindRow */","/** @typedef {'weapon' | 'mental' | 'runic' | 'advanced'} MindChild */","/** @typedef {[MindRow, {}, MindChild]} MindGenerics */","","const MIND_WEAPON_UUID = 'Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P'","","const WEAPON_BASE_TYPES = {","    0: { die: 'd4', traits: ['finesse', 'agile'], usage: 'held-in-one-hand' },","    1: { die: 'd6', traits: ['finesse'], usage: 'held-in-one-hand' },","    2: { die: 'd8', traits: [], usage: 'held-in-one-hand' },","    3: { die: 'd10', traits: ['reach'], usage: 'held-in-two-hands' },","}","","const WEAPON_GROUPS = /** @type {Record<WeaponDamage, string>} */ {","    slashing: 'sword',","    piercing: 'spear',","    bludgeoning: 'club',","}","","const WEAPON_TRAITS = ['grapple', 'nonlethal', 'shove', 'trip', 'modular']","","const WEAPON_DAMAGE_TYPES = Object.keys(WEAPON_GROUPS)","","const WEAPON_RUNES = ['corrosive', 'disrupting', 'flaming', 'frost', 'shock', 'thundering']","","const WEAPON_GREATER_RUNES = [","    'anarchic',","    'axiomatic',","    'greaterCorrosive',","    'greaterDisrupting',","    'greaterFlaming',","    'greaterFrost',","    'greaterShock',","    'greaterThundering',","    'holy',","    'unholy',","]","","/** @type {Daily<MindGenerics>} */","const mindSmith = {","    key: 'mindsmith',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY', // Mind Smith Dedication","    },","    children: [","        {","            slug: 'weapon',","            uuid: MIND_WEAPON_UUID, // Mind Weapon","        },","        {","            slug: 'mental',","            uuid: 'Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky', // Malleable Mental Forge","        },","        {","            slug: 'runic',","            uuid: 'Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp', // Runic Mind Smithing","        },","        {","            slug: 'advanced',","            uuid: 'Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD', // Advanced Runic Mind Smithing","        },","    ],","    rows: [","        {","            type: 'alert',","            slug: 'alert',","            message: 'Missing Mind Weapon',","            fix,","            childPredicate: [{ not: 'weapon' }],","        },","        {","            type: 'select',","            slug: 'smith',","            label: 'Mind Smith',","            options: WEAPON_DAMAGE_TYPES,","            labelizer: ({ utils }) => utils.damageLabel,","            childPredicate: ['weapon'],","        },","        {","            type: 'select',","            slug: 'mental',","            label: 'Mental Forge',","            options: WEAPON_TRAITS,","            labelizer: ({ utils }) => utils.weaponTraitLabel,","            childPredicate: ['weapon', 'mental'],","        },","        {","            type: 'select',","            slug: 'runic',","            label: 'Runic Smithing',","            options: WEAPON_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'runic', { not: 'advanced' }],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","        {","            type: 'select',","            slug: 'advanced',","            label: 'Runic Smithing',","            options: WEAPON_GREATER_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'advanced'],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","    ],","    process: ({ children, updateItem, fields, messages, item, utils }) => {","        const weapon = children.weapon","        if (!weapon) return","","        messages.addGroup('mindsmith')","","        const selected = /** @type {WeaponDamage} */ fields.smith.value","        updateItem({ _id: weapon.id, 'system.damage.damageType': selected, 'system.group': WEAPON_GROUPS[selected] })","        messages.add('mindsmith', { selected: utils.damageLabel(selected), uuid: item.uuid, label: 'mindsmith' })","","        if (children.mental) {","            const selected = fields.mental.value","            const traits = deepClone(weapon._source.system.traits?.value ?? [])","            if (!traits.includes(selected)) traits.push(selected)","            updateItem({ _id: weapon.id, 'system.traits.value': traits })","            messages.add('mindsmith', {","                selected: utils.weaponTraitLabel(selected),","                uuid: children.mental.uuid,","                label: 'mentalforge',","            })","        }","","        if ((children.advanced || children.runic) && utils.hasFreePropertySlot(weapon)) {","            const child = children.advanced ?? children.runic","            const freeSlot = utils.getFreePropertyRuneSlot(weapon)","            const field = fields.advanced ?? fields.runic","            const selected = field.value","","            if (!weapon.system.runes.property.includes(selected)) {","                updateItem({ _id: weapon.id, [`system.${freeSlot}.value`]: selected, [`flags.world.runeSlot`]: freeSlot })","                messages.add('mindsmith', {","                    selected: utils.weaponPropertyRunesLabel(selected),","                    uuid: child.uuid,","                    label: 'runicmind',","                })","            }","        }","    },","    rest: ({ item, sourceId, updateItem }) => {","        if (sourceId !== MIND_WEAPON_UUID) return","","        let traits = item._source.system.traits?.value ?? []","        traits = traits.filter(trait => !WEAPON_TRAITS.includes(trait))","        updateItem({ _id: item.id, 'system.traits.value': traits })","","        const runeSlot = item.getFlag('world', 'runeSlot')","        if (runeSlot) {","            updateItem({ _id: item.id, [`system.${runeSlot}.value`]: null, [`flags.world.-=runeSlot`]: true })","        }","    },","}","","const OPTIONS = {","    0: 'A one-handed weapon that deals <strong>1d4</strong> damage and has the <strong>agile</strong> and <strong>finesse</strong> traits',","    1: 'A one-handed weapon that deals <strong>1d6</strong> damage and has the <strong>finesse</strong> trait',","    2: 'A one-handed weapon that deals <strong>1d8</strong> damage',","    3: 'A two-handed weapon that deals <strong>1d10</strong> damage and has the <strong>reach</strong> trait',","}","","/** * @param {DailyValueArgs<MindGenerics>} args */","async function fix({ actor }) {","    let content =","        `<p>This character doesn't have a mind weapon in their inventory.</p><p>Please select one of the following options to create one.</p>`","","    for (const [key, label] of Object.entries(OPTIONS)) {","        content += `<label><input type='radio' name='type' value='${key}'>${label}</label>`","    }","","    const weapon = await Dialog.wait(","        {","            title: 'Mind Weapon',","            content,","            buttons: {","                yes: {","                    icon: `<i class='fas fa-save'></i>`,","                    label: 'Accept',","                    callback: onWeaponSelected,","                },","                no: {","                    icon: `<i class='fas fa-times'></i>`,","                    label: 'Cancel',","                    callback: () => null,","                },","            },","            close: () => null,","        },","        {},","        { id: 'pf2e-dailies-weapon', width: 600 }","    )","","    if (weapon) {","        await actor.createEmbeddedDocuments('Item', [weapon])","        return true","    }","","    return false","}","","/** @params {JQuery} html */","async function onWeaponSelected(html) {","    const selection = html.find('[name=type]:checked').val()","    if (!selection) {","        ui.notifications.warn('You must select one weapon base type.')","        return","    }","","    const weapon = (await fromUuid(MIND_WEAPON_UUID))?.toObject()","    if (!weapon) {","        ui.notifications.warn(`The weapon couldn't be found in the compendium.`)","        return","    }","","    const stats = WEAPON_BASE_TYPES[selection]","","    setProperty(weapon, 'system.damage.die', stats.die)","    setProperty(weapon, 'system.traits.value', stats.traits.slice())","    setProperty(weapon, 'system.usage.value', stats.usage)","","    return weapon","}","","return mindSmith"].join(`
`);var Ft=["/** @typedef {'first' | 'second' | 'third' | 'fourth'} SavantRow */","/** @typedef {Record<SavantRow, { level: number; condition: boolean }>} SavantCustom */","/** @typedef {[SavantRow, SavantCustom, '']} SavantGenerics */","","const ROWS = /** @type {const} */ (['first', 'second', 'third', 'fourth'])","","/**"," * @param {CharacterPF2e} actor"," * @param {MagicTradition} tradition"," */","function getSpellcastingTraditionDetails(actor, tradition) {","    let maxSlot = 1","    let maxTradition = 0","","    for (const entry of actor.spellcasting.regular) {","        if ('pf2e-staves' in entry.flags) continue // we skip staff entries","","        const slots = entry.system.slots","        for (const key in slots) {","            const slot = slots[key]","            if (slot.max) maxSlot = Math.max(maxSlot, Number(key.slice(4)))","        }","","        if (entry.tradition === tradition) maxTradition = Math.max(maxTradition, entry.rank)","    }","","    return { maxSlot: Math.min(maxSlot, 10), maxTradition }","}","","/** @type {Daily<SavantGenerics>} */","const scrollSavant = {","    key: 'savant',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ', // Scroll Savant","    },","    prepare: ({ actor }) => {","        const { maxSlot, maxTradition } = getSpellcastingTraditionDetails(actor, 'arcane')","        return {","            first: { level: maxSlot - 2, condition: true },","            second: { level: maxSlot - 3, condition: true },","            third: { level: maxSlot - 4, condition: maxTradition >= 3 && maxSlot >= 5 },","            fourth: { level: maxSlot - 5, condition: maxTradition >= 4 && maxSlot >= 6 },","        }","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowDrop<SavantGenerics>} */","        const row = {","            type: 'drop',","            slug: rowName,","            label: ({ custom }) => `PF2E.SpellLevel${custom[rowName].level}`,","            filter: {","                type: 'spell',","                search: ({ custom }) => ({","                    category: ['spell'],","                    traditions: ['arcane'],","                    level: custom[rowName].level,","                }),","            },","            condition: ({ custom }) => custom[rowName].condition,","        }","        return row","    }),","    process: async ({ utils, fields, custom, addItem, messages }) => {","        for (const field of Object.values(fields)) {","            const uuid = field.uuid","            const source = await utils.createSpellScrollSource({ uuid, level: custom[field.row].level })","            addItem(source)","            messages.add('scrolls', { uuid, label: source.name })","        }","    },","}","","return scrollSavant"].join(`
`);var Rt=["/** @typedef {typeof ROWS[number]} TomeRow */","/** @typedef {'adept' | 'second' | 'intense' | 'paragon'} TomeChild */","/** @typedef {Record<TomeRow, { rank: OneToFour; options: string[] }>} TomeCustom */","/** @typedef {[TomeRow, TomeCustom, TomeChild]} TomeGenerics */","","const ROWS = /** @type {const} */ (['first', 'second'])","","/** @param {'adept' | 'paragon'} option */","function createChildCondition(option) {","    /** @type { BaseDailyConditionFunction<TomeGenerics>} */","    const condition = ({ item, utils }) => {","        return utils.getChoiSetRuleSelection(item, option) === 'tome'","    }","    return condition","}","","/** @type {Daily<TomeGenerics>} */","const thaumaturgeTome = {","    key: 'tome',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e', // Tome","    },","    children: [","        {","            slug: 'adept',","            uuid: 'Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO', // Implement Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'second',","            uuid: 'Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5', // Second Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'intense',","            uuid: 'Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC', // Intense Implement","        },","        {","            slug: 'paragon',","            uuid: 'Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI', // Implement Paragon","            condition: createChildCondition('paragon'),","        },","    ],","    prepare: ({ utils, actor, children }) => {","        const skillNames = utils.skillNames","        const actorLevel = actor.level","        const actorSkills = /** @type {Record<SkillLongForm, { rank: ZeroToFour }>} */ (actor.skills)","","        /** @type {TomeCustom} */","        const custom = {","            first: { options: [], rank: 1 },","            second: { options: [], rank: 1 },","        }","","        // Implement Paragon","        if (children.paragon) {","            const skills = skillNames.filter(x => actorSkills[x].rank < 4)","            custom.first = { rank: 4, options: skills }","            custom.second = { rank: 4, options: skills }","        }","        // Intense Implement or Second Adept or Implement Adept","        else if (children.intense || children.adept || children.second) {","            const masters = skillNames.filter(x => actorSkills[x].rank < 3)","","            if (actorLevel >= 9) {","                custom.first = { rank: 3, options: masters }","                custom.second = { rank: 3, options: masters }","            } else {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 3, options: masters }","            }","        }","        // Tome","        else {","            if (actorLevel >= 5) {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 2, options: experts }","            } else if (actorLevel >= 3) {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 2, options: experts }","            } else {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 1, options: trained }","            }","        }","","        return custom","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowCombo<TomeGenerics>} */","        const row = {","            type: 'combo',","            slug: rowName,","            label: ({ custom, utils }) => utils.proficiencyLabel(custom[rowName].rank),","            options: ({ custom }) => custom[rowName].options,","            labelizer: ({ utils }) => utils.skillLabel,","        }","        return row","    }),","    process: ({ custom, fields, utils, messages, addItem, addRule }) => {","        messages.addGroup('tome', 65)","","        for (const rowName of ROWS) {","            const rank = custom[rowName].rank","            let value = fields[rowName].value","","            if (fields[rowName].input === 'true') {","                const source = utils.createLoreSource({ name: value, rank })","                addItem(source)","            } else {","                const source = utils.createSkillRuleElement({ skill: value, value: rank })","                value = utils.skillLabel(value)","                addRule(source)","            }","","            messages.add('tome', { label: utils.proficiencyLabel(rank), selected: value })","        }","    },","}","","return thaumaturgeTome"].join(`
`);var R=C("customs"),vr=["default","trainedSkill","trainedLore","language","resistance","feat","spell"],$e=["flexibility","savant","tome","mind"],ne=class extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"pf2e-dailies-customs",title:R("title"),template:le("customs.hbs"),submitOnChange:!1,submitOnClose:!1,closeOnSubmit:!1,scrollY:[".left .list"]})}async _updateObject(e,r){}async getData(e){let r=D("customDailies"),i=r.find(a=>a.key===this._selectedDaily)?.code,s=this._selectedTemplate,o=game.modules.get("pf2e-dailies-ext"),n=o?.active&&isNewerVersion(Ue,o.version)?{version:Ue}:"";return mergeObject(super.getData(e),{i18n:R,template:s,templates:vr,daily:this._selectedDaily,code:i,customs:r,examples:$e,isExample:$e.includes(s),monaco:o?.active,newVersion:n})}activateListeners(e){super.activateListeners(e),this._monaco?.dispose();let r=game.modules.get("pf2e-dailies-ext")?.api,i=e.find(".code")[0];if(r&&i){let s=e.find(".monaco .placeholder")[0];this._monaco=r.createEditor(s,i.value),this._monaco.onDidChangeModelContent(debounce(()=>i.value=this._monaco.getValue(),200))}else this._monaco=null;e.find("[data-action=select-template]").on("change",this.#o.bind(this)),e.find("[data-action=create-template]").on("click",this.#n.bind(this)),e.find("[data-action=create-daily]").on("click",this.#r.bind(this)),e.find(".row[data-key]").on("click",this.#s.bind(this)),e.find("[data-action=delete-daily]").on("click",this.#i.bind(this)),e.find("[data-action=save-code]").on("click",this.#e.bind(this))}get code(){return this.form.querySelector(".window-content .code")?.value}async#e(e){e.preventDefault();let r=this.code,i=this._selectedDaily;if(!i||!r)return;let s=D("customDailies"),o=s.filter(n=>n.key!==i);try{let c=(await new oe(r)()).key;if(typeof c!="string")return O("invalidKey");if(o.find(u=>u.key===c))return O("duplicate");let d=s.findIndex(u=>u.key===i);if(d<0)return;s.splice(d,1,{key:c,code:r}),await ae("customDailies",s),R.info("saved",{daily:c}),this._selectedDaily=c,this.render()}catch(n){F("error.unexpected"),console.error(n),console.error(`The error occured while testing the custom daily ${i}`)}}async#i(e){if(e.preventDefault(),e.stopPropagation(),!await Dialog.confirm({title:R("delete.title"),content:R("delete.content")}))return;let i=e.currentTarget.dataset.key,s=D("customDailies").filter(o=>o.key!==i);await ae("customDailies",s),R.info("deleted",{daily:i}),this.#r()}#r(){this._selectedDaily="",this._selectedTemplate="default",this.render()}#s(e){e.preventDefault(),this._selectedDaily=e.currentTarget.dataset.key,this.render()}async#n(e){e.preventDefault();let r=this._selectedTemplate,i=D("customDailies"),s=new FormData(this.form),o=Object.fromEntries(s),n=$e.includes(r),{key:a,uuid:c,label:d}=o;if(n)a=r;else if(!a||!c)return R.warn("template.noEmpty");if(i.find(p=>p.key===a))return O("error.duplicate");let u;if(r==="trainedSkill"){let p=j(a,c,d);u=this.#t(p,{key:a,uuid:c,label:d},"SkillGenerics")}else if(r==="trainedLore"){let p=me(a,c,d);u=this.#t(p,{key:a,uuid:c,label:d},"SkillGenerics")}else if(r==="language"){let p=K(a,c,d);u=this.#t(p,{key:a,uuid:c,label:d},"LanguageGenerics")}else if(r==="resistance"){let p=Me(o.resistance),b=J(o.resistances);if(p===""||!b.length)return R.warn("template.noEmpty");if(typeof p=="number"&&p<1)return R.warn("template.badResistance");let w=ee(a,c,b,p,d);u=this.#t(w,{key:a,uuid:c,label:d,resistance:p,resistances:b},"ResistanceGenerics")}else if(r==="feat"){let p=J(o.traits),b={category:J(o.category),level:Me(o.level)||{min:0,max:20}};p.length&&(b.traits=p);let w=fe(a,c,b,d);u=this.#t(w,{key:a,uuid:c,label:d},"FeatGenerics")}else if(r==="spell"){let p=Number(o.level)||void 0,b=J(o.traits),w=o.levels.split(",").map(h=>h.trim());w.length===1?w=Me(w[0]):w=w.filter(h=>h).map(h=>Number(h)).filter(h=>!isNaN(h));let f={category:J(o.category),traditions:J(o.traditions),level:w||[]};b.length&&(f.traits=b);let m=pe(a,c,f,p,d);u=this.#t(m,{key:a,uuid:c,label:d,level:p},"SpellGenerics")}else if(r==="tome")u=Rt;else if(r==="flexibility")u=Tt;else if(r==="savant")u=Ft;else if(r==="mind")u=Lt;else{let p={key:a,label:d,item:{uuid:c},rows:[],process:()=>{}};u=this.#t(p,{key:a,uuid:c,label:d})}i.push({key:a,code:u}),await ae("customDailies",i),this._selectedDaily=a,this.render()}#t(e,r,i){let s="____PLACEHOLDER____",o=[],n=JSON.stringify(e,(d,u)=>typeof u=="function"?(o.push(u),s):u,4);n=n.replace(new RegExp('"'+s+'"',"g"),()=>o.shift()?.toString()?.replace(/( {5,})/g,u=>u.slice(4))??"");let a="";for(let[d,u]of Object.entries(r))typeof u=="string"?a+=`const ${d} = '${u}';
`:typeof u=="object"?a+=`const ${d} = ${JSON.stringify(u)};
`:a+=`const ${d} = ${u};
`;let c=i?`Daily<${i}>`:"Daily";return`${a}
/** @type {${c}} */
const daily = ${n};

return daily;`}#o(e){e.preventDefault(),this._selectedDaily="",this._selectedTemplate=e.currentTarget.value,this.render()}};l(ne,"DailyCustoms");function J(t){return t.split(",").map(e=>e.trim()).filter(e=>e)}l(J,"splitList");function Me(t){if(typeof t=="number"||(t=t.trim(),t==="level"||t==="half"))return t;let e=Number(t);return isNaN(e)?"":e}l(Me,"simplyfiable");async function _t(t){let e=[],[r,i]=ke();for(let s of t.items){if(I(s,"temporary")){if(e.push(s.id),s.isOfType("feat")){let c=I(s,"grantedBy");if(c){let u=`flags.pf2e.itemGrants.-=${M(s.name,{camel:"dromedary"})}`;i({_id:c,[u]:!0})}}continue}let o=q(s);if(o){let c=at(o);c?.rest&&await c.rest({item:s,sourceId:o,updateItem:i,actor:t})}let n=deepClone(s._source.system.rules),a=!1;for(let c=n.length-1;c>=0;c--)v in n[c]&&(n.splice(c,1),a=!0);a&&i({_id:s.id,"system.rules":n})}r.size&&await t.updateEmbeddedDocuments("Item",r.contents),e.length&&await t.deleteEmbeddedDocuments("Item",e),await qe(t,"rested",!0)}l(_t,"restForTheNight");var Ue="1.3.0",Sr="CONFIG.PF2E.Actor.documentClasses.character.prototype.performDailyCrafting";Hooks.once("setup",()=>{X({name:"customDailies",type:Array,default:[],onChange:Te}),X({name:"familiar",type:String,default:"",config:!0}),X({name:"watch",type:Boolean,default:!1,config:!0,onChange:Pt}),X({name:"members",type:Boolean,default:!0,config:!0,scope:"user"}),Be({name:"customs",type:ne}),game.modules.get(v).api={openDailiesInterface:t=>Y(t),requestDailies:Ot,getBuiltinDailies:()=>deepClone(Ae),getCustomDailies:()=>deepClone(re),prepareDailies:ge,checkCustomDaily:Le,getUtils:()=>deepClone(V)},D("watch")&&Pt(!0)});Hooks.once("ready",async()=>{if(await Te(),!game.modules.get("lib-wrapper")?.active&&game.user.isGM){O("error.noLibwrapper",!0);return}libWrapper.register(v,Sr,Et,"OVERRIDE")});Hooks.on("pf2e.restForTheNight",_t);Hooks.on("renderCharacterSheetPF2e",At);function Pt(t){Hooks[t?"on":"off"]("renderChatMessage",vt)}l(Pt,"enableWatchHook");})();
//# sourceMappingURL=main.js.map
