(()=>{var fs=Object.defineProperty;var l=(t,e)=>fs(t,"name",{value:e,configurable:!0});var k="pf2e-dailies",ke=(async()=>{}).constructor;function L(t){return game.settings.get(k,t)}l(L,"getSetting");function xe(t,e){return game.settings.set(k,t,e)}l(xe,"setSetting");function ee(...t){return`${k}.settings.${t.join(".")}`}l(ee,"getSettingLocalizationPath");function X(t){let e=t.name;t.scope=t.scope??"world",t.config=t.config??!0,t.config&&(t.name=ee(e,"name"),t.hint=ee(e,"hint")),Array.isArray(t.choices)&&(t.choices=t.choices.reduce((s,r)=>(s[r]=ee(e,"choices",r),s),{})),game.settings.register(k,e,t)}l(X,"registerSetting");function ut(t){let e=t.name;t.name=ee("menus",e,"name"),t.label=ee("menus",e,"label"),t.hint=ee("menus",e,"hint"),t.restricted=t.restricted??!0,t.icon=t.icon??"fas fa-cogs",game.settings.registerMenu(k,e,t)}l(ut,"registerSettingMenu");function te(...t){let e=t.filter(s=>typeof s=="string").join("/");return`modules/${k}/templates/${e}`}l(te,"templatePath");function C(t,e,s){return t.getFlag(k,e)??s}l(C,"getFlag");function Z(t,e,s){return t.setFlag(k,e,s)}l(Z,"setFlag");function S(...t){let[e,s]=t;return e=`${k}.${e}`,s?game.i18n.format(e,s):game.i18n.localize(e)}l(S,"localize");function le(t){return game.i18n.has(`${k}.${t}`,!1)}l(le,"hasLocalization");function We(t){return`${k}.${t}`}l(We,"localizePath");function _(t){let e=l((...s)=>S(`${t}.${s[0]}`,s[1]),"fn");return Object.defineProperties(e,{warn:{value:(...s)=>P(`${t}.${s[0]}`,s[1],s[2]),enumerable:!1,configurable:!1},info:{value:(...s)=>ms(`${t}.${s[0]}`,s[1],s[2]),enumerable:!1,configurable:!1},error:{value:(...s)=>N(`${t}.${s[0]}`,s[1],s[2]),enumerable:!1,configurable:!1},has:{value:s=>le(`${t}.${s}`),enumerable:!1,configurable:!1},path:{value:s=>We(`${t}.${s}`),enumerable:!1,configurable:!1},template:{value:(s,{hash:r})=>e(s,r),enumerable:!1,configurable:!1}}),e}l(_,"subLocalize");function qe(t,e,s,r){let n=typeof e=="string"?e:"info",i=typeof e=="object"?e:typeof s=="object"?s:void 0,a=typeof e=="boolean"?e:typeof s=="boolean"?s:r??!1;ui.notifications.notify(S(t,i),n,{permanent:a})}l(qe,"notify");function P(...t){let[e,s,r]=t;qe(e,"warning",s,r)}l(P,"warn");function ms(...t){let[e,s,r]=t;qe(e,"info",s,r)}l(ms,"info");function N(...t){let[e,s,r]=t;qe(e,"error",s,r)}l(N,"error");function Ie(t){return t.getFlag("core","sourceId")}l(Ie,"getSourceId");function W(t,e,s=[]){let r=typeof s=="string"?[s]:s;for(let n of r){let i=t.itemTypes[n].find(a=>a.sourceId===e);if(i)return i}}l(W,"findItemWithSourceId");function Ce(t,e){let s=[];if(t<=e)for(let r=t;r<=e;r++)s.push(r);else for(let r=t;r>=e;r--)s.push(r);return s}l(Ce,"sequenceArray");function Ee(t){return t?t[0].toUpperCase()+t.slice(1):""}l(Ee,"capitalize");function De(t,e){return e?`@UUID[${t}]{${e}}`:`@UUID[${t}]`}l(De,"chatUUID");function dt(t){return`<span style="background: #DDD;
    padding: 1px 4px;
    border: 1px solid var(--color-border-dark-tertiary);
    border-radius: 2px;
    white-space: nowrap;
    word-break: break-all;">${t}</span>`}l(dt,"fakeChatUUID");function pt(t,e){if(typeof t!="object")return!1;let s=Reflect.getPrototypeOf(t);for(;s;){if(s.constructor.name===e)return!0;s=Reflect.getPrototypeOf(s)}return!1}l(pt,"isInstanceOf");function ft(t,e,s){return t.updateSource({[`flags.${k}.${e}`]:s})}l(ft,"updateSourceFlag");function Fe(t,e,s="WRAPPER"){return libWrapper.register(k,t,e,s)}l(Fe,"registerWrapper");function Ae(t,e,s,r,n){return{key:t,label:n,item:{uuid:e},rows:[{type:"drop",slug:"spell",filter:{type:"spell",search:s??{}}}],process:async({addSpell:a,utils:o,fields:u,messages:c})=>{let d=u.spell.uuid,p=await o.createSpellSource(d),f=r??p.system.level.value,m=`${p.name} (Level ${f})`;a(p,r),c.add("spells",{uuid:d,label:m})}}}l(Ae,"createSpellDaily");function mt(){let t=Ae("ace","Compendium.pf2e.feats-srd.Item.POrE3ZgBRdBL9MsW",{category:[],level:4},4),e=t.rows[0];return e.filter.drop=s=>{let r=s.system.time.value;return r.includes("hour")||r.includes("min")&&parseInt(r)>10?{error:We("interface.error.drop.wrongSpellTime"),data:{time:"10 min"}}:!0},t}l(mt,"tricksterAce");var yt={key:"blade",item:{uuid:"Compendium.pf2e.classfeatures.Item.EtltLdiy9kNfHU0c"},children:[{slug:"good",uuid:"Compendium.pf2e.classfeatures.Item.nxZYP3KGfTSkaW6J"},{slug:"evil",uuid:"Compendium.pf2e.classfeatures.Item.JiY2ZB4FkK8RJm4T"},{slug:"liberator",uuid:"Compendium.pf2e.classfeatures.Item.FCoMFUsth4xB4veC"},{slug:"paladin",uuid:"Compendium.pf2e.classfeatures.Item.peEXunfbSD8WcMFk"},{slug:"antipaladin",uuid:"Compendium.pf2e.classfeatures.Item.EQ6DVIQHAUXUhY6Y"},{slug:"tyrant",uuid:"Compendium.pf2e.classfeatures.Item.HiIvez0TqESbleB5"},{slug:"spirit",uuid:"Compendium.pf2e.feats-srd.Item.h5ksUZlrVGBjq6p4"},{slug:"master",uuid:"Compendium.pf2e.feats-srd.Item.jYEMVfrXJLpXS6aC"}],rows:[{type:"select",slug:"weapon",label:()=>S("label.blade.weapon"),options:({actor:t})=>t.itemTypes.weapon.filter(e=>!e.isAlchemical).map(e=>({value:e.id,label:e.name}))},{type:"select",slug:"rune",label:()=>S("label.blade.rune"),options:({children:t})=>{let e=["returning","shifting"],{antipaladin:s,evil:r,good:n,liberator:i,master:a,paladin:o,spirit:u,tyrant:c}=t;return u&&(e.push("flaming"),n&&e.push("holy"),r&&e.push("unholy"),(i||s)&&e.push("anarchic"),(o||c)&&e.push("axiomatic")),n&&e.push("disrupting","ghost-touch"),a&&e.push("greater-disrupting","keen"),r&&e.push("fearsome"),e.map(d=>({value:d,label:gt(d)}))},condition:({actor:t})=>t.itemTypes.weapon.filter(e=>!e.isAlchemical).length}],process:async({actor:t,fields:e,addRule:s,messages:r})=>{let n=e.weapon.value,i=e.rune.value,a=t.items.get(n);if(!a)return;s({definition:[`item:id:${n}`],key:"AdjustStrike",mode:"add",property:"property-runes",value:i},a),s({key:"CriticalSpecialization",predicate:[{or:[`item:category:${a.category}`,`item:id:${n}`]}]},a);let o=a.name!==a._source.name?`... ${a._source.name}`:a.name;r.addGroup("blade"),r.add("blade",{uuid:a.uuid,label:o,selected:gt(i)})}};function gt(t){let e=t.replace(/-\w/,s=>s[1].toUpperCase());return game.i18n.localize(`PF2E.WeaponPropertyRune.${e}.Name`)}l(gt,"localizeRune");var gs="systems/pf2e/icons/equipment/weapons/wish-knife.webp",ht={key:"ceremonial",item:{uuid:"Compendium.pf2e.feats-srd.Item.78pkCdFaY8hI07Lj",condition:({actor:t})=>t.itemTypes.weapon.some(e=>e.group==="knife")},rows:[{type:"drop",slug:"spell",label:({utils:t,actor:e})=>t.spellRankLabel(Be(e)),filter:{type:"spell",search:({actor:t})=>({category:["spell"],level:Be(t)})}}],process:async({actor:t,fields:e,utils:s,item:r,addItem:n,messages:i})=>{let a=e.spell.uuid,o=Be(t),u=await s.createWandSource({uuid:a,level:o,itemName:r.name,itemImg:gs});n(u),i.addGroup("ceremonial"),i.add("ceremonial",{uuid:a,label:u.name})}};function Be(t){return Math.ceil((t.level-5)/2)}l(Be,"calculateRank");var ys=["first","second","third","fourth","fifth","sixth","seventh"];function Ve(t,e,s){return{key:t,label:s,item:{uuid:e[0]},children:[{slug:"expert",uuid:e[1]},{slug:"master",uuid:e[2]}],rows:[K("first",1),K("second",2,8),K("third",3,void 0,"expert"),K("fourth",4,14,"expert"),K("fifth",5,16,"expert"),K("sixth",6,void 0,"master"),K("seventh",7,20,"master")],process:async({utils:n,fields:i,addItem:a,messages:o})=>{for(let u of Object.values(i)){let c=u.uuid,d=ys.indexOf(u.row)+1,p=await n.createSpellScrollSource({uuid:c,level:d});a(p),o.add("scrolls",{uuid:c,label:p.name})}}}}l(Ve,"createScrollChain");function K(t,e,s,r){let n={type:"drop",slug:t,label:({utils:i})=>i.spellRankLabel(e),filter:{type:"spell",search:{category:["spell"],level:e}}};return s&&(n.condition=({actor:i})=>i.level>=s),r&&(n.childPredicate=[r]),n}l(K,"createRow");var vt={key:"flexibility",item:{uuid:"Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8"},children:[{slug:"improved",uuid:"Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX"}],rows:[bt("flexibility",8),bt("improved",14,"improved")],process:async({utils:t,fields:e,addFeat:s,messages:r,children:n})=>{let i=e.flexibility.uuid,a=await t.createFeatSource(i);if(s(a),r.add("feats",{uuid:i}),n.improved){let o=e.improved.uuid,u=await t.createFeatSource(o);s(u,n.improved),r.add("feats",{uuid:o})}}};function bt(t,e,s){let r={type:"drop",label:`PF2E.Level${e}`,slug:t,filter:{type:"feat",search:{category:["class"],traits:["fighter"],level:e}}};return s&&(r.childPredicate=[s]),r}l(bt,"createRow");function ce(t,e,s){return{key:t,label:s,item:{uuid:e},rows:[{type:"select",slug:"language",options:({actor:r,utils:n})=>{let i=r.system.details.languages.value;return n.languageNames.filter(a=>!i.includes(a)).sort()},labelizer:({utils:r})=>r.languageLabel}],process:({addRule:r,utils:n,fields:i,messages:a})=>{let o=i.language.value,u=n.createLanguageRuleElement({language:o});r(u),a.add("languages",{uuid:e,selected:n.languageLabel(o),label:s})}}}l(ce,"createLanguageDaily");function se(t,e,s){return{key:t,label:s,item:{uuid:e},rows:[Te("skill",0)],process:n=>{Ye(n,{uuid:e,label:s})}}}l(se,"createTrainedSkillDaily");function Ye({fields:t,addItem:e,addRule:s,utils:r,messages:n,removeRule:i},{field:a="skill",uuid:o,label:u,rank:c=1,parent:d}){i(f=>f.key==="ActiveEffectLike"&&f.mode==="upgrade"&&f.phase==="beforeDerived"&&f.path?.startsWith("system.skills."),d),i(f=>f.key==="RollOption"&&f.toggleable&&f.alwaysActive&&f.phase==="beforeDerived"&&f.suboptions.some(m=>m.label==="PF2E.SkillAcr"),d);let p=t[a].value;if(t[a].input==="true"){let f=r.createLoreSource({name:p,rank:c});e(f)}else{let f=r.createSkillRuleElement({skill:p,value:c});p=r.skillLabel(p),s(f,d)}n.add("skills",{uuid:o,selected:p,label:u})}l(Ye,"processComboSkill");function Te(t,e,s={}){return{type:"combo",slug:t,options:({actor:r,utils:n})=>{let i=r.skills;return n.skillNames.filter(a=>i[a].rank===e)},labelizer:({utils:r})=>r.skillLabel,...s}}l(Te,"createComboSkillRow");function Pe(t,e,s){return{key:t,label:s,item:{uuid:e},rows:[{type:"input",slug:"skill"}],process:({addItem:n,utils:i,fields:a,messages:o})=>{let u=a.skill.value,c=i.createLoreSource({name:u,rank:1});n(c),o.add("skills",{uuid:e,selected:u,label:s})}}}l(Pe,"createTrainedLoreDaily");var wt={key:"longevities",item:{uuid:"Compendium.pf2e.feats-srd.Item.WoLh16gyDp8y9WOZ"},children:[{slug:"expert",uuid:"Compendium.pf2e.feats-srd.Item.vfuHVSuExvtyajkW"}],rows:[Te("ancestral",0,{label:({item:t})=>t.name}),Te("expert",1,{label:({children:t})=>t.expert?.name,childPredicate:["expert"]})],process:async t=>{let e=[{field:"ancestral",rank:1,item:t.item},{field:"expert",rank:2,item:t.children.expert}];for(let{field:s,rank:r,item:n}of e)t.fields[s]&&Ye(t,{label:n.name,uuid:n.uuid,field:s,rank:r,parent:n})}};var He="Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P",St="Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky",hs={0:{die:"d4",traits:["finesse","agile"],usage:"held-in-one-hand"},1:{die:"d6",traits:["finesse"],usage:"held-in-one-hand"},2:{die:"d8",traits:[],usage:"held-in-one-hand"},3:{die:"d10",traits:["reach"],usage:"held-in-two-hands"}},xt={slashing:"sword",piercing:"spear",bludgeoning:"club"},kt=["grapple","nonlethal","shove","trip","modular"],bs=Object.keys(xt),vs=["corrosive","disrupting","flaming","frost","shock","thundering"],ws=["greaterCorrosive","greaterDisrupting","greaterFlaming","greaterFrost","greaterShock","greaterThundering","holy","unholy"],It={key:"mindsmith",item:{uuid:"Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY"},children:[{slug:"weapon",uuid:He},{slug:"mental",uuid:St},{slug:"runic",uuid:"Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp"},{slug:"advanced",uuid:"Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD"}],rows:[{type:"alert",slug:"alert",message:()=>S("interface.alert.weapon"),fix:Ss,childPredicate:[{not:"weapon"}]},{type:"select",slug:"smith",label:()=>S("label.mindsmith"),options:bs,labelizer:({utils:t})=>t.damageLabel,childPredicate:["weapon"]},...[1,2].map(t=>({type:"select",slug:`mental${t}`,label:()=>S("label.mentalforge",{nb:t}),options:kt,labelizer:({utils:e})=>e.weaponTraitLabel,unique:"mental",childPredicate:["weapon","mental"]})),{type:"select",slug:"runic",label:()=>S("label.runicmind"),options:vs,labelizer:({utils:t})=>t.weaponPropertyRunesLabel,childPredicate:["weapon","runic",{not:"advanced"}],condition:({children:t,utils:e})=>e.hasFreePropertySlot(t.weapon)},{type:"select",slug:"advanced",label:()=>S("label.runicmind"),options:ws,labelizer:({utils:t})=>t.weaponPropertyRunesLabel,childPredicate:["weapon","advanced"],condition:({children:t,utils:e})=>e.hasFreePropertySlot(t.weapon)}],process:({children:t,updateItem:e,fields:s,messages:r,item:n,utils:i})=>{let a=t.weapon;if(!a)return;r.addGroup("mindsmith");let o=s.smith.value;if(e({_id:a.id,"system.damage.damageType":o,"system.group":xt[o]}),r.add("mindsmith",{selected:i.damageLabel(o),uuid:n.uuid,label:"mindsmith"}),t.mental){let u=deepClone(a._source.system.traits?.value??[]);for(let c of[1,2]){let d=s[`mental${c}`].value;u.includes(d)||u.push(d),e({_id:a.id,"system.traits.value":u}),r.add("mindsmith",{selected:i.weaponTraitLabel(d),uuid:t.mental.uuid,label:S("label.mentalforge",{nb:c})})}}if((t.advanced||t.runic)&&i.hasFreePropertySlot(a)){let u=t.advanced??t.runic,c=i.getFreePropertyRuneSlot(a),p=(s.advanced??s.runic).value;c&&!a.system.runes.property.includes(p)&&(e({_id:a.id,[`system.${c}.value`]:p,[`flags.${k}.runeSlot`]:c}),r.add("mindsmith",{selected:i.weaponPropertyRunesLabel(p),uuid:u.uuid,label:"runicmind"}))}},rest:({item:t,sourceId:e,updateItem:s,actor:r})=>{if(e!==He)return;if(W(r,St)){let a=t._source.system.traits?.value??[];a=a.filter(o=>!kt.includes(o)),s({_id:t.id,"system.traits.value":a})}let i=C(t,"runeSlot");i&&s({_id:t.id,[`system.${i}.value`]:null,[`flags.${k}.-=runeSlot`]:!0})}};async function Ss({actor:t}){let e=_("dialog.weapon"),s=e("flavor");for(let n of["0","1","2","3"]){let i=e(`option.${n}`);s+=`<label><input type="radio" name="type" value="${n}">${i}</label>`}let r=await Dialog.wait({title:e("title"),content:s,buttons:{yes:{icon:'<i class="fas fa-save"></i>',label:e("accept"),callback:ks},no:{icon:'<i class="fas fa-times"></i>',label:e("cancel"),callback:()=>null}},close:()=>null},{},{id:"pf2e-dailies-weapon",width:600});return r?(await t.createEmbeddedDocuments("Item",[r]),!0):!1}l(Ss,"fix");async function ks(t){let e=_("dialog.weapon"),s=t.find("[name=type]:checked").val();if(!s){e.warn("error.noSelection");return}let r=(await fromUuid(He))?.toObject();if(!r){e.warn("error.missing");return}let n=hs[s];return setProperty(r,"system.damage.die",n.die),setProperty(r,"system.traits.value",n.traits.slice()),setProperty(r,"system.usage.value",n.usage),r}l(ks,"onWeaponSelected");var xs="Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB";function Ct(t){return W(t,xs,"consumable")}l(Ct,"getRations");var Et={key:"rations",item:{uuid:"Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB"},rows:[{type:"select",slug:"rations",save:!1,order:200,options:({actor:t})=>{let e=Ct(t),{value:s,max:r}=e.uses,i=(e.quantity-1)*r+s,a=i<=1;return[{value:"false",label:S("interface.rations.no")},{value:"true",label:a?S("interface.rations.last"):S("interface.rations.yes",{nb:i})}]}}],process:({fields:t,updateItem:e,messages:s,actor:r})=>{if(t.rations.value!=="true")return;let n=Ct(r);if(!n?.uses.value)return;let i=n.quantity,{value:a,max:o}=n.uses;a<=1?i<=1?n.delete():e({_id:n.id,"system.quantity":Math.max(n.quantity-1,0),"system.uses.value":o}):e({_id:n.id,"system.uses.value":Math.max(a-1,0)});let u=(i-1)*o+a,c=u<=1?dt(n.name):De(n.uuid),d=u<=1?S("message.rations.last",{name:c}):u<=3?S("message.rations.almost",{name:c,nb:u-1}):S("message.rations.used",{name:c,nb:u-1});s.addRaw(d,200)}};function ue(t,e,s,r,n,i){return{key:t,label:n,item:{uuid:e},rows:[{type:i?"random":"select",slug:"resistance",options:s,labelizer:({utils:o})=>o.resistanceLabel}],process:async({utils:o,fields:u,actor:c,addRule:d,messages:p})=>{let f=i?await o.randomOption(s):u.resistance.value,m=typeof r=="number"?r:r==="half"?o.halfLevelValue(c):c.level,y=o.createResistanceRuleElement({type:f,value:m});d(y),p.add("resistances",{uuid:e,selected:o.resistanceLabel(f,m),label:n,random:i})}}}l(ue,"createResistancelDaily");var Is="Compendium.pf2e.feat-effects.Item.jO7wMhnjT7yoAtQg",Dt={key:"root",item:{uuid:"Compendium.pf2e.feats-srd.Item.22P7IFyhrF7Fbw8B"},rows:[{type:"select",slug:"target",options:({actor:t,utils:e})=>e.getPlayersActors(t).map(r=>({value:r.id,label:r.name}))}],process:({fields:t,messages:e})=>{let s=t.target.value,r=game.actors.get(s);r&&(e.addGroup("root"),e.add("root",{uuid:Is,selected:r.name}))}};var Oe=["cantrips?","1st","2nd","3rd","4th","5th","6th","7th","8th","9th","10th"].join("|"),Ft="Compendium.pf2e.feats-srd.Item.NV9H39kbkbjhAK6X";function q(){return game.modules.get("pf2e-staves")?.active}l(q,"isPF2eStavesActive");function de(t){if(!t)return;let e=C(t,"staff")??getProperty(t,"flags.pf2e-staves");if(e)return delete e.prevDescription,deepClone(e)}l(de,"getSpellcastingEntryStaffFlags");function pe(t){let e=de(t);if(!e)return;e.overcharge??=0,e.max=me(t.actor)+e.overcharge;let s=(()=>{let r=t.actor;return!e.charges||e.overcharge||e.makeshift||!r?{}:r.spellcasting.filter(n=>n.isSpontaneous).reduce((n,i)=>{for(let a=1;a<=10;a++){let o=i.system.slots[`slot${a}`];o.max&&o.value&&(n[a]=!0)}return n},{})})();return e.canPayCost=r=>!!e.charges&&(r<=e.charges||s[r]),e}l(pe,"getSpellcastingEntryStaffData");async function fe(t,e){let s=pe(t);if(!s)return;let r=Math.clamped(e,0,s.max);if(r!==s.charges)return s.charges=r,Z(t,"staff",s)}l(fe,"updateEntryCharges");function At(t){return[{type:"weapon",trait:"magical"},{type:"equipment",trait:"coda"}].flatMap(({type:e,trait:s})=>t.itemTypes[e].filter(r=>{let n=r.system.traits?.value;return n?.includes("staff")&&n.includes(s)}))}l(At,"getStaves");function me(t){let e=0,s=ge(t);for(let n of s){let i=Re(n);i>e&&(e=i)}if(W(t,Ft,"feat")){let n=Math.ceil(t.level/2);n>e&&(e=n)}return e}l(me,"getMaxSlotRankForStaves");function Tt(t){let e=Ot(t);if(W(t,Ft,"feat")){let r=e?.mod??0,n=t.classDCs.kineticist??t.classDCs.find(a=>a.mod>=r),i=n.mod;if(i>=r)return{ability:{value:n.attribute},tradition:{value:"primal"},proficiency:{value:n.rank,slug:n.slug},mod:i}}return e}l(Tt,"getBestSpellcastingEntryForStaves");function Pt(t){let e={};for(let s of t.spellcasting.filter(r=>r.isPrepared)){let r=s.id,n=s.isFlexible;for(let i=1;i<=10;i++){let a=s.system.slots[`slot${i}`];if(!(a.max<1))if(n){if(a.value<1)continue;e[r]??={id:r,name:s.name,slots:[]},e[r].slots.push({rank:i,value:a.value,max:a.max})}else for(let[o,{id:u,prepared:c,expended:d}]of Object.entries(a.prepared)){if(c===!1||d)continue;let p=s.spells.get(u);p&&(e[r]??={id:r,name:s.name,spells:[]},e[r].spells.push({id:p.id,name:p.name,rank:i,index:o}))}}e[r]?.spells?.sort((i,a)=>i.rank===a.rank?i.name.localeCompare(a.name):i.rank-a.rank)}return Object.values(e)}l(Pt,"getPreparedSpellcastingEntriesForStaves");async function Rt(t,...e){let[s,{rank:r}]=e;if(s.isCantrip)return t(...e);let n=de(this);if(!n)return t(...e);let i=this.actor;if(!i.items.get(n.staveID)?.isEquipped){P("staves.noStaff");return}let o=s.computeCastRank(r);if(!r||r==="0")return s.toMessage(void 0,{data:{castRank:o}});if(n.charges<1||n.charges<o&&n.overcharge){P("staves.noCharge");return}let u=[];if(!n.overcharge){let c=i.spellcasting.filter(f=>f.isSpontaneous&&f.system.slots[`slot${o}`].value),d=!1,p=l(f=>f.system.slots[`slot${o}`].value,"entryRankValue");if(c.length===1){let f=c[0],m=S("staves.spontaneous.one",{rank:O.spellRankLabel(o),entry:f.name,remaining:p(f)});d=await Dialog.confirm({title:S("staves.spontaneous.title"),defaultYes:!1,content:`<div class="pf2e-dailies-spontaneous">${m}</div>`}),d&&(d=0)}else if(c.length>1){let f=c.map((y,g)=>({index:g,name:y.name,remaining:p(y)})),m=await renderTemplate(te("staves-spontaneous.hbs"),{entries:f,castRank:O.spellRankLabel(o),i18n:(y,{hash:g})=>S(`staves.spontaneous.${y}`,g)});d=await Dialog.wait({title:S("staves.spontaneous.title"),content:m,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Yes"),callback:y=>{let g=y.find("input[name=entry]:checked").val();return Number(g)}},no:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("No"),callback:()=>!1}},close:()=>null})}if(d===null)return;if(typeof d=="number"){let f=c[d],m=f.system.slots[`slot${o}`].value;u.push({_id:f.id,[`system.slots.slot${o}.value`]:m-1}),n.charges-=1}}if(!u.length){if(n.charges<o){P("staves.noCharge");return}n.charges-=o}u.push({_id:this.id,[`flags.${k}.staff`]:n}),await i.updateEmbeddedDocuments("Item",u),await s.toMessage(void 0,{data:{castRank:o}})}l(Rt,"onSpellcastingEntryCast");function ge(t,{itemOnly:e,innate:s,focus:r}={}){return t.spellcasting.regular.filter(n=>!(n.flags?.["pf2e-staves"]||C(n,"staff")||!s&&n.isInnate||!r&&n.isFocusPool||n.system.prepared.value==="items"&&(!e||e==="scroll"&&n.system.prepared.validItems!=="scroll")))}l(ge,"getValidSpellcastingList");function Re(t){let e=0;if(t.system.prepared.value==="items"){let s=Math.ceil(t.actor.level/2);s>e&&(e=s)}else for(let s=0;s<=10;s++)t.system.slots[`slot${s}`].max&&(e=Math.max(e,s));return e}l(Re,"getSpellcastingEntryMaxSlotRank");function Lt(t,e){let s=t.spellcasting,n=Object.entries(s.system.slots[`slot${e??t.rank}`].prepared).find(([i,{id:a,expended:o}])=>a===t.id&&o!==!0);if(n)return{slotIndex:n[0],entry:s}}l(Lt,"getNotExpendedPreparedSpellSlot");function Ot(t){let e=ge(t),s=0,r=[];for(let c of e){let d=c.statistic.mod;d>s?(r=[c],s=d):d===s&&r.push(c)}if(r.length===0)return;let n=l(c=>{let{ability:d,tradition:p,proficiency:f}=c.system;return{ability:d,tradition:p,proficiency:f,mod:s}},"returnedEntry");if(r.length===1)return n(r[0]);let i=t.classDC.attribute,a=r.filter(c=>c.attribute===i);if(a===1)return n(a[0]);let o=0,u;for(let c of r){let d=Cs(c);d>o&&(o=d,u=c)}return n(u)}l(Ot,"getBestSpellcastingEntry");function Cs(t){return t.isSpontaneous?t.spells.size:t.isPrepared?Object.values(t.system.slots).flatMap(r=>Object.values(r.prepared)).filter(r=>r.id).length:0}l(Cs,"getPreparedCount");function _t(t){let e=0,s=0;for(let r of t.spellcasting)r.sort>s?s=r.sort:r.sort<e&&(e=r.sort);return{min:e,max:s}}l(_t,"getSpellcastingEntriesSortBounds");var $t={key:"savant",item:{uuid:"Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ"},prepare:({actor:t})=>{let{maxSlot:e,maxTradition:s}=Es(t,"arcane");return{first:{level:e-2,condition:!0},second:{level:e-3,condition:!0},third:{level:e-4,condition:s>=3&&e>=5},fourth:{level:e-5,condition:s>=4&&e>=6}}},rows:["first","second","third","fourth"].map(t=>({type:"drop",slug:t,label:({custom:s,utils:r})=>r.spellRankLabel(s[t].level),filter:{type:"spell",search:({custom:s})=>({category:["spell"],traditions:["arcane"],level:s[t].level})},condition:({custom:s})=>s[t].condition})),process:async({utils:t,fields:e,custom:s,addItem:r,messages:n})=>{for(let i of Object.values(e)){let a=i.uuid,o=await t.createSpellScrollSource({uuid:a,level:s[i.row].level});r(o),n.add("scrolls",{uuid:a,label:o.name})}}};function Es(t,e){let s=1,r=0,n=ge(t);for(let i of n){let a=Re(i);a>s&&(s=a),i.tradition===e&&(r=Math.max(r,i.rank))}return{maxSlot:Math.min(s,10),maxTradition:r}}l(Es,"getSpellcastingTraditionDetails");var Nt={key:"metamagical",item:{uuid:"Compendium.pf2e.classfeatures.Item.89zWKD2CN7nRu2xp",condition:({actor:t})=>t.level>=4},rows:[{type:"drop",slug:"feat",filter:{type:"feat",search:{category:["class"],traits:{selected:["spellshape","wizard"],conjunction:"and"},level:"half"}}}],process:async({utils:t,fields:e,addFeat:s,messages:r})=>{let n=e.feat.uuid,i=await t.createFeatSource(n);s(i),r.add("feats",{uuid:n})}};var Mt={key:"tome",item:{uuid:"Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e"},children:[{slug:"adept",uuid:"Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO",condition:Xe("adept")},{slug:"second",uuid:"Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5",condition:Xe("adept")},{slug:"intense",uuid:"Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC"},{slug:"paragon",uuid:"Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI",condition:Xe("paragon")}],prepare:({utils:t,actor:e,children:s})=>{let r=t.skillNames,n=e.level,i=e.skills,a={first:{options:[],rank:1},second:{options:[],rank:1}};if(s.paragon){let o=r.filter(u=>i[u].rank<4);a.first={rank:4,options:o},a.second={rank:4,options:o}}else if(s.intense||s.adept||s.second){let o=r.filter(u=>i[u].rank<3);if(n>=9)a.first={rank:3,options:o},a.second={rank:3,options:o};else{let u=r.filter(c=>i[c].rank<2);a.first={rank:2,options:u},a.second={rank:3,options:o}}}else if(n>=5){let o=r.filter(u=>i[u].rank<2);a.first={rank:2,options:o},a.second={rank:2,options:o}}else if(n>=3){let o=r.filter(c=>i[c].rank<1),u=r.filter(c=>i[c].rank<2);a.first={rank:1,options:o},a.second={rank:2,options:u}}else{let o=r.filter(u=>i[u].rank<1);a.first={rank:1,options:o},a.second={rank:1,options:o}}return a},rows:["first","second"].map(t=>({type:"combo",slug:t,label:({custom:s,utils:r})=>r.proficiencyLabel(s[t].rank),options:({custom:s})=>s[t].options,labelizer:({utils:s})=>s.skillLabel})),process:({custom:t,fields:e,utils:s,messages:r,addItem:n,addRule:i})=>{r.addGroup("tome",65);for(let a of["first","second"]){let o=t[a].rank,u=e[a].value;if(e[a].input==="true"){let c=s.createLoreSource({name:u,rank:o});n(c)}else{let c=s.createSkillRuleElement({skill:u,value:o});u=s.skillLabel(u),i(c)}r.add("tome",{label:s.proficiencyLabel(o),selected:u})}}};function Xe(t){return({item:e,utils:s,actor:r})=>{let n=s.getChoiSetRuleSelection(e);return r.items.get(n)?.slug==="tome"}}l(Xe,"createChildCondition");var Ds=["root-magic"],Ut=["familiar","staves"],be=[Mt,wt,se("ageless","Compendium.pf2e.feats-srd.Item.wylnETwIz32Au46y"),se("memories","Compendium.pf2e.feats-srd.Item.ptEOt3lqjxUnAW62"),se("studies","Compendium.pf2e.feats-srd.Item.9bgl6qYWKHzqWZj0"),Pe("study","Compendium.pf2e.feats-srd.Item.aLJsBBZzlUK3G8MW"),ce("linguistics","Compendium.pf2e.feats-srd.Item.eCWQU16hRLfN1KaX"),ce("borts","Compendium.pf2e.equipment-srd.Item.iS7hAQMAaThHYE8g"),ue("elementalist","Compendium.pf2e.feats-srd.Item.tx9pkrpmtqe4FnvS",["air","earth","fire","water"],"half","elementalist"),ue("ganzi","Compendium.pf2e.heritages.Item.3reGfXH0S82hM7Gp",["acid","electricity","sonic"],"half","ganzi",!0),Nt,vt,$t,Ve("esoterica",["Compendium.pf2e.feats-srd.Item.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.Item.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.Item.LHjPTV5vP3MOsPPJ"]),Ve("trickster",["Compendium.pf2e.feats-srd.Item.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.Item.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.Item.lIg5Gzz7W70jfbk1"]),mt(),It,yt,Dt,ht,Et],re=[],jt,ye=new Map;function Le(t,e){let s=new Map;for(let r of t){let n=deepClone(r);try{let i=`${e}.${n.key}`;if(re.includes(i))continue;if(s.set(n.item.uuid,{daily:n,condition:n.item.condition}),n.key=i,n.children)for(let a=0;a<n.children.length;a++){let{uuid:o,condition:u}=n.children[a];s.set(o,{daily:n,index:a,condition:u})}}catch(i){N("error.unexpected"),console.error(i),console.error(`The error occured during data gathering of ${e}.${n.key}`)}}return s}l(Le,"prepareDailies");function Fs(){jt=Le(be,"dailies")}l(Fs,"prepareBaseDailies");var he=[];async function Ze(){ye.clear(),he=[];let t=L("customDailies");for(let{key:s,code:r}of t)try{let i=await new ke(r)();if(!Je(i,!0))continue;he.push(i)}catch(n){N("error.unexpected"),console.error(n),console.error(`The error occured during call of custom function for ${s}`)}for(let[s,r]of jt.entries())ye.set(s,r);let e=Le(he,"custom");for(let[s,r]of e.entries())ye.set(s,r)}l(Ze,"parseCustomDailies");function As(){let t=L("filters").trim();t||(re=[]);try{re=t.split(",").map(e=>e.trim()).filter(Boolean)}catch(e){N("error.unexpected"),console.error(e),console.error("The error occured while trying to parse the daily filters")}}l(As,"prepareDailyFilters");async function Ke(){As(),Fs(),await Ze()}l(Ke,"prepareAllDailies");function Je(t,e=!1){return Ds.includes(t.key)?(e&&game.user.isGM&&P("deprecated.custom.key",{name:t.label.trim()||t.key},!0),!1):!0}l(Je,"checkCustomDaily");function zt(t){let e={};for(let s of t.items){let r=Ie(s);if(!r||s.isOfType("physical")&&s.isInvested===!1)continue;let n=ye.get(r);if(!n)continue;let{daily:i,index:a,condition:o}=n;try{if(typeof o=="function"&&!o({actor:t,item:s,utils:O}))continue;e[i.key]??=deepClone(i),a===void 0?e[i.key].item=s:e[i.key].children[a].item=s}catch(u){N("error.unexpected"),console.error(u),console.error(`The error occured during data gathering of ${i.key}`)}}return Object.values(e).filter(s=>s.item&&s.item instanceof Item)}l(zt,"getDailies");function Gt(t){return ye.get(t)?.daily}l(Gt,"getDailyFromSourceId");function _e(){return game.packs.get("pf2e.familiar-abilities")}l(_e,"getFamiliarPack");function Wt(t){return`Compendium.pf2e.familiar-abilities.Item.${t}`}l(Wt,"familiarUUID");var Ts=new Set(["armor","backpack","book","consumable","equipment","shield","treasure","weapon"]);function Qe(t){return typeof t=="object"&&t!==null}l(Qe,"isObject");function J(t,e){return game.pf2e.system.sluggify(t,e)}l(J,"sluggify");function Ps(t,e){return t.has(e)}l(Ps,"setHasElement");function qt(t,...e){return e.some(s=>s==="physical"?Ps(Ts,t.type):t.type===s)}l(qt,"itemIsOfType");var $e=class t extends Array{static{l(this,"PredicatePF2e")}constructor(...e){super(...Array.isArray(e[0])?e[0]:e),this.isValid=t.isValid(this)}static isValid(e){return t.isArray(e)}static isArray(e){return Array.isArray(e)&&e.every(s=>B(s))}static test(e=[],s=[]){return e instanceof t?e.test(s):new t(...e).test(s)}test(e){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let s=e instanceof Set?e:new Set(e);return this.every(r=>this.#e(r,s))}toObject(){return deepClone([...this])}clone(){return new t(this.toObject())}#e(e,s){return typeof e=="string"&&s.has(e)||et(e)&&this.#r(e,s)||Bt(e)&&this.#s(e,s)}#r(e,s){if("eq"in e)return s.has(`${e.eq[0]}:${e.eq[1]}`);let r=Object.keys(e)[0],[n,i]=Object.values(e)[0],a=Array.from(s),o=l(d=>{let p=Number(d);if(!Number.isNaN(p))return[p];let f=new RegExp(String.raw`^${d}:([^:]+)$`),m=a.map(y=>Number(f.exec(y)?.[1]||NaN)).filter(y=>!Number.isNaN(y));return m.length>0?m:[NaN]},"getValues"),u=o(n),c=o(i);switch(r){case"gt":return u.some(d=>c.every(p=>d>p));case"gte":return u.some(d=>c.every(p=>d>=p));case"lt":return u.some(d=>c.every(p=>d<p));case"lte":return u.some(d=>c.every(p=>d<=p));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}#s(e,s){return"and"in e&&e.and.every(r=>this.#e(r,s))||"nand"in e&&!e.nand.every(r=>this.#e(r,s))||"or"in e&&e.or.some(r=>this.#e(r,s))||"xor"in e&&e.xor.filter(r=>this.#e(r,s)).length===1||"nor"in e&&!e.nor.some(r=>this.#e(r,s))||"not"in e&&!this.#e(e.not,s)||"if"in e&&!(this.#e(e.if,s)&&!this.#e(e.then,s))}},Os=new Set(["eq","gt","gte","lt","lte"]);function B(t){return t instanceof Object?Bt(t)||et(t):typeof t=="string"?Rs(t):!1}l(B,"isStatement");function Rs(t){return typeof t=="string"&&t.length>0||et(t)}l(Rs,"isAtomic");function et(t){if(!Qe(t))return!1;let e=Object.entries(t);if(e.length>1)return!1;let[s,r]=e[0];return Os.has(s)&&Array.isArray(r)&&r.length===2&&typeof r[0]=="string"&&["string","number"].includes(typeof r[1])}l(et,"isBinaryOp");function Bt(t){return Qe(t)&&(Ls(t)||$s(t)||_s(t)||Ns(t)||Ms(t)||Us(t)||js(t))}l(Bt,"isCompound");function Ls(t){return Object.keys(t).length===1&&Array.isArray(t.and)&&t.and.every(e=>B(e))}l(Ls,"isAnd");function _s(t){return Object.keys(t).length===1&&Array.isArray(t.nand)&&t.nand.every(e=>B(e))}l(_s,"isNand");function $s(t){return Object.keys(t).length===1&&Array.isArray(t.or)&&t.or.every(e=>B(e))}l($s,"isOr");function Ns(t){return Object.keys(t).length===1&&Array.isArray(t.xor)&&t.xor.every(e=>B(e))}l(Ns,"isXor");function Ms(t){return Object.keys(t).length===1&&Array.isArray(t.nor)&&t.nor.every(e=>B(e))}l(Ms,"isNor");function Us(t){return Object.keys(t).length===1&&!!t.not&&B(t.not)}l(Us,"isNot");function js(t){return Object.keys(t).length===2&&B(t.if)&&B(t.then)}l(js,"isIf");var zs={select:100,combo:80,random:60,alert:40,input:20,drop:0};async function Yt({children:t=[],key:e,item:s,prepare:r,label:n,rows:i=[]}){let a=this.actor;this.saved[e]=C(a,e)??{},this.rows[e]={},this.children[e]=t.reduce((m,{slug:y,item:g})=>(m[y]=g,m),{});let o={actor:a,item:s,children:this.children[e],utils:O};this.custom[e]=await r?.(o)||{};let u=this.custom[e];this.dailyArgs[e]={...o,custom:u};let c=this.dailyArgs[e],d=await tt(n,c),p=d?`label.${d}`:e.startsWith("dailies.")?`label.${e.slice(8)}`:void 0;p&&le(p)&&(d=S(p)),this.predicate[e]=t.filter(m=>m.item).map(m=>m.slug);let f={label:d?game.i18n.localize(d):s.name,rows:[]};for(let m of i){this.rows[e][m.slug]=m;let{type:y,slug:g,childPredicate:h=[],condition:x,label:w,save:b,unique:v,order:E}=m;if(h.length&&!$e.test(h,this.predicate[e])||x&&!await x(c))continue;let I=b===!1||y==="random"?void 0:this.saved[e][g],A=await tt(w,c),U=I===void 0?"":typeof I!="object"?I:"name"in I?I.name:I.selected,T={label:A?game.i18n.localize(A):"",value:U,order:E??zs[y],data:{type:y,daily:e,row:g,...v?{unique:v}:""}};if(Vt(m)||Gs(m)||Ws(m)){let Y=await tt(m.options,c)??[];if(y!=="combo"&&!Y.length)continue;let j=typeof m.labelizer=="function"&&m.labelizer(c)||(R=>Ee(R));T.options=Y.map(R=>typeof R=="string"?{value:R,label:j(R)}:R),Vt(m)&&(T.selected=T.value,T.data.input=I?.input??!0,!T.data.input&&Y.includes(T.selected)&&(T.value=j(T.selected)))}else qs(m)?T.data.uuid=I?.uuid??"":Bs(m)&&(T.value=typeof m.message=="function"?await m.message(c):m.message);f.rows.push(T)}return f}l(Yt,"getTemplate");async function tt(t,e){return typeof t=="function"?await t(e):t}l(tt,"getProcessedValue");function Vt(t){return t.type==="combo"}l(Vt,"isComboRow");function Gs(t){return t.type==="select"}l(Gs,"isSelectRow");function Ws(t){return t.type==="random"}l(Ws,"isRandomRow");function qs(t){return t.type==="drop"}l(qs,"isDropRow");function Bs(t){return t.type==="alert"}l(Bs,"isAlerRow");function Ne(t,e,s){if(e===void 0)return s;if(typeof e=="number")return e;if(e==="level")return t.level;if(e==="half")return Math.max(1,Math.floor(t.level/2));let r=Number(e);return Number.isNaN(r)?s:r}l(Ne,"getSimplifiableValue");async function Ht(t){return{type:t.type,search:await(t.type==="feat"?Ys(this.actor,t.search):Vs(this.actor,t.search)),drop:t.drop}}l(Ht,"parseFilter");function M(t,e){if(t?.length){e.selected=t,e.isExpanded=!0;for(let s of t)e.options[s].selected=!0}}l(M,"checkFilter");function Xt(t,e){let s=Me(t);s?.selected.length&&(e.conjunction=s.conjunction,e.selected=s.selected)}l(Xt,"setTraits");function Me(t){if(!t)return;let e=Array.isArray(t)?t:t.selected;if(e?.length)return{selected:e.map(s=>typeof s=="string"?{value:s}:s),conjunction:!Array.isArray(t)&&t.conjunction||"and"}}l(Me,"getFilterTraits");async function Vs(t,e){let s=await game.pf2e.compendiumBrowser.tabs.spell.getFilterData();M(e.category,s.checkboxes.category),M(e.school,s.checkboxes.school),M(e.traditions,s.checkboxes.traditions),M(e.rarity,s.checkboxes.rarity),M(e.source,s.checkboxes.source),Xt(e.traits,s.multiselects.traits);let r=st(t,e.level);return r?.length&&M(r,s.checkboxes.rank),s}l(Vs,"parseSpellFilter");async function Ys(t,e){let s=await game.pf2e.compendiumBrowser.tabs.feat.getFilterData();M(e.category,s.checkboxes.category),M(e.skills,s.checkboxes.skills),M(e.rarity,s.checkboxes.rarity),M(e.source,s.checkboxes.source),Xt(e.traits,s.multiselects.traits);let r=rt(t,e.level);return r&&(s.sliders.level.values.min=r.min,s.sliders.level.values.max=r.max,s.sliders.level.isExpanded=!0),s}l(Ys,"parseFeatFilter");function st(t,e){if(Array.isArray(e))return e;let s=Ne(t,e);if(s)return Ce(1,s)}l(st,"getSpellFilterLevel");function rt(t,e){if(e!==void 0)return typeof e=="object"?{min:Ne(t,e.min,0),max:Ne(t,e.min,20)}:{min:0,max:Ne(t,e,20)}}l(rt,"getFeatFilterLevel");var F=_("interface.error.drop");async function Zt(t,e,s){if(!t.isOfType("feat"))return F("notFeat");let{search:r,drop:n}=s;if(r.category?.length&&!r.category.includes(t.category))return F.warn("wrongType",{types:ne("featCategories",r.category)});if(r.traits){let a=Me(r.traits);if(a?.selected.length){let o=a.conjunction==="or"?"some":"every";if(!a.selected[o](c=>Number(c.not??!1)-Number(t.traits.has(c.value))))return F.warn("wrongTraits")}}if(r.skills?.length){let a=O.getTranslatedSkills(!0),o=t.system.prerequisites.value.map(c=>c.value.toLocaleLowerCase());if(!r.skills.some(c=>o.some(d=>d.includes(c)||d.includes(a[c]))))return F.warn("wrongSkill",{skills:ne("skillList",r.skills)})}if(r.rarity?.length&&!r.rarity.includes(t.system.traits.rarity))return F.warn("wrongRarity",{rarities:ne("rarityTraits",r.rarity)});if(r.source?.length&&!r.source.includes(J(t.system.source.value)))return F.warn("wrongSource",{sources:r.source.join(", ")});let i=rt(this.actor,r.level);if(i){let a=t.level;if(a<i.min)return F.warn("wrongLevelLow",{level:`min: ${i.min}`});if(a>i.max)return F.warn("wrongLevelHigh",{level:`max: ${i.max}`})}if(n){let a=this.dailyArgs[e.dataset.daily];if(a){let o=await n(t,a);if(typeof o=="object")return o.data?game.i18n.format(o.error,o.data):game.i18n.localize(o.error);if(o===!1)return F.warn("wrongCustom")}}ve(t,e)}l(Zt,"onDropFeat");async function Kt(t,e,s){if(!t.isOfType("spell"))return F("notSpell");let{search:r,drop:n}=s;if(r.category?.length){let a=r.category.map(o=>game.i18n.localize(o==="cantrip"?"PF2E.SpellCantripLabel":CONFIG.PF2E.preparationType[o])).join(", ");if(t.isCantrip&&!r.category.includes("cantrip")||t.isFocusSpell&&!r.category.includes("focus")||t.isRitual&&!r.category.includes("ritual")||!t.isCantrip&&!t.isFocusSpell&&!t.isRitual&&!r.category.includes("spell"))return F.warn("wrongCategory",{categories:a})}if(r.traits){let a=Me(r.traits);if(a?.selected.length){let o=a.conjunction==="or"?"some":"every";if(!a.selected[o](c=>Number(c.not??!1)-Number(t.traits.has(c.value))))return F.warn("wrongTraits")}}if(r.traditions?.length&&!r.traditions.some(a=>t.traditions.has(a)))return F.warn("wrongTradition",{traditions:ne("magicTraditions",r.traditions)});let i=st(this.actor,r.level);if(i?.length&&!i.includes(t.level))return F.warn("wrongLevel",{levels:i.join(", ")});if(r.school?.length&&!r.school.includes(t.school))return F.warn("wrongSchool",{schools:ne("magicSchools",r.school)});if(r.rarity?.length&&!r.rarity.includes(t.system.traits.rarity))return F.warn("wrongRarity",{rarities:ne("rarityTraits",r.rarity)});if(r.source?.length&&!r.source.includes(J(t.system.source.value)))return F.warn("wrongSource",{sources:r.source.join(", ")});if(n){let a=this.dailyArgs[e.dataset.daily];if(a){let o=await n(t,a);if(typeof o=="object")return o.data?ui.notifications.warn(game.i18n.format(o.error,o.data)):ui.notifications.warn(game.i18n.localize(o.error));if(o===!1)return F.warn("wrongCustom")}}ve(t,e)}l(Kt,"onDropSpell");function ne(t,e){return e.map(r=>game.i18n.localize(CONFIG.PF2E[t][r])).join(", ")}l(ne,"localizeAll");function ve(t,e){e.value=t.name,e.dataset.uuid=t.uuid,e.nextElementSibling.nextElementSibling.classList.remove("disabled")}l(ve,"onDropItem");async function Jt(){let t=this.actor,e=this.dailies,s=Xs.call(this),r=[],n=new Map,[i,a]=Ue(),o={},u=_("message"),c=!1,d="",p=l(g=>{let h=g.id,x=n.get(h);if(x)return x;let w=deepClone(g._source.system.rules);for(let b=w.length-1;b>=0;b--)k in w[b]&&w.splice(b,1);return n.set(h,w),w},"getRules"),f={languages:{order:80,messages:[]},skills:{order:70,messages:[]},resistances:{order:60,messages:[]},feats:{order:50,messages:[]},spells:{order:40,messages:[]},scrolls:{order:30,messages:[]}},m=[],y={add:(g,h)=>{f[g]??={order:0,messages:[]},f[g].messages.push(h)},addGroup:(g,h,x)=>{f[g]??={label:x,order:h??1,messages:[]}},addRaw:(g,h=1)=>{m.push({order:h,message:g})}};if(t.familiar&&s["dailies.familiar"]){let g=t.familiar,h=_e(),x=[],w=g.itemTypes.action.map(b=>b.id);w.length&&g.deleteEmbeddedDocuments("Item",w),y.addGroup("familiar",20);for(let b of Object.values(s["dailies.familiar"])){let v=b.value,E=v.includes("."),I=await(E?fromUuid(v):h.getDocument(v));if(!I||!I.isOfType("action"))continue;let A=I.toObject();A&&(x.push(A),y.add("familiar",{uuid:E?v:Wt(v)}))}x.length&&g.createEmbeddedDocuments("Item",x)}if(s["dailies.staff"]){let g=s["dailies.staff"],h=g.staffID.value,x=t.items.get(h),w=g.staffID.makeshift==="true",b=me(t);if(x&&(b||w)){let v=[],E=L("staff-regex").trim()||Oe,I=new RegExp(`<strong>\\s*(?<rank>(?:${E}))\\s*</strong>.+?(?<uuids>@(?:UUID|Compendium)[[a-zA-Z0-9-.]+].+?)
`,"gi"),A=I.exec(x.description);for(;A!==null;){let U=A.groups.rank.trim().replace(/\D+/,"")||"0",T=Math.clamped(parseInt(U),0,10),Y=/@(?<protocole>UUID|Compendium)\[(?<uuid>[a-zA-Z0-9-.]+)\]/g,j=Y.exec(A.groups.uuids);for(;j!==null;){let R=j.groups.uuid;j.groups.protocole==="Compendium"&&(R.startsWith("Compendium.")||(R=`Compendium.${R}`)),v.push({rank:T,uuid:R}),j=Y.exec(A.groups.uuids)}A=I.exec(x.description)}if(v.length){let U=0,T=[],Y=w?[1,2,3]:[1],j=game.i18n.localize("PF2E.SpellFlexibleLabel"),R={};for(let Ge of Y){let D=g[`expend${Ge}`]?.optionData;if(D)if(D.type==="spell"){let z=t.items.get(D.spell);if(!z)continue;let G=Lt(z,D.rank);if(!G)continue;U+=+D.rank,a({_id:G.entry.id,[`system.slots.slot${D.rank}.prepared.${G.slotIndex}.expended`]:!0}),T.push({uuid:z.uuid,name:z.name,rank:D.rank})}else{let z=t.items.get(D.entry);if(!z)continue;let G=z.system.slots[`slot${D.rank}`];if(G.max<1||G.value<1)continue;R[D.entry]??={},R[D.entry][D.rank]??=G.value;let H=R[D.entry][D.rank];if(H<1)continue;U+=+D.rank,a({_id:D.entry,[`system.slots.slot${D.rank}.value`]:H-1}),R[D.entry][D.rank]-=1,T.push({name:j,rank:D.rank})}}let lt=Tt(t);if(lt){let{ability:Ge,tradition:ct,proficiency:D}=lt,z=(()=>{let{min:H,max:oe}=_t(t);return L("staff-sort")==="bottom"?oe+1e4:H-1e4})(),G={type:"spellcastingEntry",name:x.name,sort:z,system:{ability:Ge,prepared:{value:"charge"},showSlotlessLevels:{value:!1},showUnpreparedSpells:{value:!1},proficiency:D,tradition:ct},flags:{[k]:{type:"staff",staff:{charges:b+U,staveID:h,overcharge:U,makeshift:w}}}};r.push(G),await Promise.all(v.map(async({rank:H,uuid:oe})=>{let Se=await O.createSpellSource(oe);setProperty(Se,`flags.${k}.entry`,{level:H,type:"staff"}),r.push(Se)})),y.addGroup("staff",45,S(`staves.message.${U?"withExpend":"noExpend"}`,{makeshift:w?S("staves.makeshift"):""})),y.add("staff",{uuid:x.uuid});for(let{uuid:H,name:oe,rank:Se}of T)y.add("staff",{uuid:H,label:`${oe} (${O.spellRankLabel(Se)})`})}}}}for(let{item:g,key:h,process:x}of e){if(!s[h])continue;let w=this.dailyArgs[h];try{await x({...w,fields:s[h],messages:y,addItem:b=>r.push(b),updateItem:a,removeRule:(b,v)=>{let E=p(v??g);for(let I=E.length-1;I>=0;I--){let A=E[I];b(A)&&E.splice(I,1)}},addRule:(b,v)=>{b[k]=!0,p(v??g).push(b)},addFeat:(b,v)=>{let E=v??g;if(E.isOfType("feat")){let I=E.id;setProperty(b,"flags.pf2e.grantedBy",{id:I,onDelete:"cascade"}),setProperty(b,`flags.${k}.grantedBy`,I)}r.push(b)},addSpell:(b,v)=>{setProperty(b,`flags.${k}.entry`,{level:v,type:"fallback"}),r.push(b),c=!0}})}catch(b){N("error.unexpected"),console.error(b),console.error(`The error occured during processing of ${h}`)}}for(let[g,h]of Object.entries(s)){let x=this.rows[g];if(x)for(let{row:w,type:b,input:v,value:E,uuid:I}of Object.values(h)){if(b==="random"||x[w]?.save===!1)continue;o[g]??={};let A=o[g];b==="combo"?A[w]={input:v==="true",selected:E}:b==="drop"?A[w]={uuid:I,name:E}:A[w]=E}}for(let[g,h]of n)a({_id:g,"system.rules":h});if(c){let g={type:"spellcastingEntry",name:S("spellEntry.name"),system:{prepared:{value:"innate"},showSlotlessLevels:{value:!1},showUnpreparedSpells:{value:!1},proficiency:{value:1,slug:t.classDC?.slug||t.class?.slug||void 0}},flags:{[k]:{type:"fallback"}}};r.push(g)}for(let g of r)getProperty(g,"system.temporary")===!0||setProperty(g,`flags.${k}.temporary`,!0);if(r.length){let g=await t.createEmbeddedDocuments("Item",r);for(let h of g)if(h.isOfType("feat")){let x=C(h,"grantedBy");if(x){let b=`flags.pf2e.itemGrants.${J(h.name,{camel:"dromedary"})}`;a({_id:x,[b]:{id:h.id,onDelete:"detach"}})}}else if(h.isOfType("spellcastingEntry")){let x=C(h,"type"),w=g.filter(b=>b.isOfType("spell")&&C(b,"entry")?.type===x);for(let b of w){let{level:v}=C(b,"entry"),E={_id:b.id,"system.location.value":h.id};v!==void 0&&(E["system.location.heightenedLevel"]=v),a(E)}}}await t.update({[`flags.${k}`]:{...expandObject(o),rested:!1}}),i.size&&await t.updateEmbeddedDocuments("Item",i.contents),m.sort((g,h)=>h.order-g.order);for(let{message:g}of m)d+=`${g}<hr />`;d+=Hs(f,d),d=d?`${u("changes")}<hr />${d}`:u("noChanges"),ChatMessage.create({content:d,speaker:ChatMessage.getSpeaker({actor:t})})}l(Jt,"processData");function Hs(t){let e=_("message"),s=Object.entries(t).map(([n,i])=>(i.label??=e.has(n)?e(n):e("gained",{type:n}),i));s.sort((n,i)=>i.order-n.order);let r="";for(let{label:n,messages:i}of s)if(i.length){r&&(r+="<hr />"),n&&(r+=`<p><strong>${n}</strong></p>`);for(let{uuid:a,selected:o,label:u,random:c}of i){let d=`label.${u}`;u=u&&le(d)?S(d):u||"",r+="<p>",r+=a?`${De(a,u)}`:`<strong>${u}</strong>`,o&&(r+=` <span>${o}</span>`),c&&(r+=' <i class="fa-solid fa-dice-d20"></i>'),r+="</p>"}}return r}l(Hs,"parseMessages");function Xs(){let t=this.element.find(".window-content .content").find("input:not(.alert), select[data-type]").toArray(),e={};for(let s of t){let r={...s.dataset,value:s.value};if(r.type==="combo"&&r.input==="false"){let n=s.previousElementSibling;r.value=n.value,r.optionData=n.selectedOptions[0].dataset}r.type==="select"&&(r.optionData=s.selectedOptions[0].dataset),e[r.daily]??={},e[r.daily][r.row]=r}return e}l(Xs,"getFields");var Q=_("interface"),Zs="Compendium.pf2e.classfeatures.Item.Klb35AwlkNrq1gpB",je=class extends Application{static{l(this,"DailiesInterface")}constructor(e,s,r){super(s),this._actor=e,this._dailies=[],this._dailyArgs={},this._saved={},this._children={},this._custom={},this._predicate={},this._rows={},this._message=r}static get defaultOptions(){return mergeObject(Application.defaultOptions,{id:"pf2e-dailies-interface",template:te("interface.hbs"),height:"auto",width:400,submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[data-droppable="true"]'}]})}get actor(){return this._actor}get dailies(){return this._dailies}get dailyArgs(){return this._dailyArgs}get saved(){return this._saved}get children(){return this._children}get custom(){return this._custom}get predicate(){return this._predicate}get rows(){return this._rows}async getData(e){let s=[],r=this._actor;if(this._dailies=zt(r),r.familiar&&!re.includes("dailies.familiar")){let a="dailies.familiar",o=_("label"),u=r.attributes.familiarAbilities.value,c=_e(),d=C(r,a)??{},p={label:o("familiar"),rows:[]},f=c.index.map(({_id:y,name:g})=>({value:y,label:g})),m=L("familiar").split(",");for(let y of m){y=y.trim();let g=await fromUuid(y);g?.isOfType("action")&&f.push({value:y,label:g.name})}f.sort((y,g)=>y.label.localeCompare(g.label));for(let y=0;y<u;y++)p.rows.push({label:o("ability",{nb:y+1}),value:d[`${y}`]??"",order:100,options:f,data:{type:"select",daily:a,row:y.toString(),unique:"ability"}});p.rows.length&&(this._rows[a]=p.rows.reduce((y,{data:g})=>(y[g.row]={save:!0},y),{}),s.push(p))}if(!re.includes("dailies.staves")&&!q()){let a=At(r);if(a.length&&me(r)){let u="dailies.staff",c=C(r,u)??{},d=a.map(y=>({value:y.id,label:y.name}));d.sort((y,g)=>y.label.localeCompare(g.label));let p={label:Q("staves.staff"),value:c.staffID??"",order:100,options:d,data:{type:"select",daily:u,row:"staffID"}},f={label:Q("staves.prepare"),rows:[p]};this._rows[u]={staffID:{save:!0}};let m=Pt(r);if(m.length){m.sort((w,b)=>!!w.slot==!!b.slot?w.name.localeCompare(b.name):w.slot?-1:b.slot?1:0);let y=[{value:"",label:""}],g=game.i18n.localize("PF2E.SpellFlexibleLabel");for(let w of m){let b=w.id;y.push({groupStart:!0,label:w.name});for(let v of w.spells??[])y.push({value:v.id,label:`${v.name} (${O.spellRankLabel(v.rank)})`,data:{type:"spell",rank:v.rank,spell:v.id,unique:`${v.id}.${v.rank}.${v.index}`}});for(let v of w.slots??[]){let E=O.spellRankLabel(v.rank),I={type:"slot",rank:v.rank,entry:b};v.value>1?I.skipUnique=!0:I.unique=`${b}.${v.rank}`,y.push({value:v.rank,label:`${g} ${v.value}/${v.max} (${E})`,data:I})}y.push({groupEnd:!0})}let h=W(r,Zs,"feat"),x=h&&r.level>=8?r.level>=16?3:2:1;h&&(p.data.makeshift=!0);for(let w=1;w<=x;w++)f.rows.push({label:Q("staves.expend"),value:"",order:100,options:y,data:{type:"select",daily:u,row:`expend${w}`,unique:"expend"}}),this._rows[u][`expend${w}`]={save:!1}}s.push(f)}}for(let a of this._dailies)try{let o=await Yt.call(this,a);s.push(o)}catch(o){Q.error("error.unexpected"),console.error(o),console.error(`The error occured during templating of ${a.key}`)}let n=[],i=[];for(let a of s)a.rows.length>1?i.push(a):a.rows.length&&n.push(a);return n.sort((a,o)=>o.rows[0].order-a.rows[0].order),i.sort((a,o)=>a.rows.length-o.rows.length),mergeObject(super.getData(e),{i18n:Q,dump:({value:a,placeholder:o,data:u})=>{let c="";if(a&&(c+=` value="${a}"`),o&&(c+=` placeholder="${o}"`),typeof u=="object")for(let[d,p]of Object.entries(u)){let f=d.replace(/[A-Z]/g,m=>`-${m}`);c+=` data-${f}="${p}"`}return c&&(c+=" "),c},rows:n,groups:i,hasDailies:n.length||i.length})}render(e,s){return this._randomInterval&&clearInterval(this._randomInterval),this.element.find("select.random")&&(this._randomInterval=setInterval(()=>{this.element.find("select.random").each((n,i)=>{i.selectedIndex=(i.selectedIndex+1)%i.options.length})},2e3)),super.render(e,s)}close(e){return this._randomInterval&&clearInterval(this._randomInterval),super.close(e)}activateListeners(e){super.activateListeners(e),e.find("[data-action=clear]").on("click",this.#u.bind(this)),e.find("[data-action=accept]").on("click",this.#c.bind(this)),e.find("[data-action=cancel]").on("click",this.#d.bind(this)),e.find(".combo select").on("change",this.#n.bind(this)),e.find(".combo input").on("change",this.#i.bind(this)),e.find("[data-action=search]").on("click",this.#r.bind(this)),e.find("[data-action=alert]").on("click",this.#e.bind(this));let s=e.find("select[data-unique]");s.on("change",r=>this.#o(r.currentTarget,!0));{let r=[];for(let n of s){let{unique:i,daily:a}=n.dataset,o=`${a}.${i}`;r.includes(o)||(r.push(o),this.#o(n,!1))}}}_canDragDrop(e){return!0}async _onDrop(e){let s=_("interface.error.drop"),r=e.target;r instanceof HTMLLabelElement&&(r=r.nextElementSibling);try{let n=e.dataTransfer?.getData("text/plain"),i=JSON.parse(n);if(!i||i.type!=="Item"||typeof i.uuid!="string")return s.warn("wrongDataType");let a=await fromUuid(i.uuid);if(!a)return s.warn("wrongDataType");let o=await this.#s(r);if(!o)return ve(a,r);o.type==="feat"?Zt.call(this,a,r,o):o.type==="spell"?Kt.call(this,a,r,o):ve(a,r)}catch(n){s.error("error.unexpected"),console.error(n),console.error("The error occured during _onDrop")}}async#e(e){e.preventDefault(),this.#t();let s=e.currentTarget.dataset,r=this.rows[s.daily][s.row],n=this.dailyArgs[s.daily],i;try{i=await r.fix(n)}catch(a){Q.error("error.unexpected"),console.error(a),console.error(`The error occured during an alert fix of '${s.daily}'`)}this.#a(),i&&this.render()}async#r(e){e.preventDefault();let s=await this.#s(e.currentTarget,!0);s?game.pf2e.compendiumBrowser.openTab(s.type,s.search):game.pf2e.compendiumBrowser.render(!0)}async#s(e,s){let{daily:r,row:n}=e.dataset,i=this.rows[r]?.[n]?.filter,a=this.dailyArgs[r];if(!(!a||!i))return typeof i.search=="function"&&(i.search=await i.search(a)),s?Ht.call(this,i):i}#n(e){let s=e.currentTarget,r=s.nextElementSibling;r.dataset.input="false",r.value=s.options[s.selectedIndex].text}#i(e){let s=e.currentTarget,r=s.previousElementSibling,n=s.value.toLowerCase(),a=Array.from(r.options).map(o=>o.value).indexOf(n);a!==-1?(r.value=n,s.value=r.options[a].text,s.dataset.input="false"):(r.value="",s.dataset.input="true")}#t(){this.element.addClass("disabled")}#a(){this.element.removeClass("disabled")}#l(){let e=[],s=this.element,r=s.find("input").filter((i,a)=>!a.value),n=s.find("input.alert");r.length&&e.push("error.empty"),n.length&&e.push("error.unattended"),s.find("label").removeClass("empty");for(let i of r){let a=i.parentElement;(a.classList.contains("combo")?a:i).previousElementSibling.classList.add("empty")}for(let i of e)Q.warn(i);return!e.length}async#c(e){e.preventDefault(),this.#l()&&(this.#t(),await Jt.call(this),this._message&&Z(this._message,"prepared",!0),this.close())}#u(e){e.preventDefault();let s=$(e.currentTarget),r=s.prevAll("input").first();r.val(""),r.attr("value",""),r.attr("data-uuid",""),s.addClass("disabled")}#d(e){e.preventDefault(),this.close()}#o(e,s){let r=e.dataset.unique,n=s?[e,...Ks(e,`select[data-unique="${r}"]`)]:e.parentElement.querySelectorAll(`:scope > select[data-unique="${r}"]`),i=new Set;for(let a of n){let o=a.selectedIndex,u=a.options,c=l(()=>{let m=u[o];return m.dataset.skipUnique?void 0:m.dataset.unique??m.value},"optionUniqueValue"),d=l(()=>{let m=c();return m&&i.has(m)},"optionExists");for(;d()&&o>0;)o-=1;let p=a.options.length-1;for(;d()&&o<p;)o+=1;if(d())continue;let f=c();f&&i.add(f),a.selectedIndex!==o&&(a.selectedIndex=o)}for(let a of n){let o=a.selectedIndex,u=a.options;for(let c=0;c<u.length;c++){if(c===o)continue;let d=u[c];d.disabled=i.has(d.dataset.unique??d.value)}}}};function Ks(t,e){let s=[],r=t.parentElement;if(!r)return s;let n=e?r.querySelectorAll(`:scope > ${e}`):r.children;for(let i of n)i!==t&&s.push(i);return s}l(Ks,"getSiblings");var Js="tLa4bewBhyqzi6Ow",Qs={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"},er={1:"UJWiN0K3jqVjxvKk",2:"vJZ49cgi8szuQXAD",3:"wrDmWkGxmwzYtfiA",4:"Sn7v9SsbEDMUIwrO",5:"5BF7zMnrPYzyigCs",6:"kiXh4SUWKr166ZeM",7:"nmXPj9zuMRQBNT60",8:"Qs8RgNH6thRPv2jt",9:"Fgv722039TVM5JTc"},tr={cantripDeck5:"PF2E.Item.Physical.FromSpell.CantripDeck5",scroll:"PF2E.Item.Physical.FromSpell.Scroll",wand:"PF2E.Item.Physical.FromSpell.Wand"},sr=new Set(["arcane","divine","occult","primal"]);async function nt(t,e,{heightenedLevel:s,mystified:r=!1,temp:n=!1,itemName:i,itemImg:a}){let o=await fromUuid(t);if(!o)return null;s??=o.baseRank,(!i||typeof i!="string")&&(i??=e);let u=game.packs.find(y=>y.collection==="pf2e.equipment-srd"),c=rr(e,s),d=await u?.getDocument(c??"");if(!pt(d,"ConsumablePF2e"))return null;let p={...d.toObject(),_id:null},f=p.system.traits;f.value=Array.from(new Set([...f.value,...o.traits])),f.rarity=o.rarity,f.value.includes("magical")&&f.value.some(y=>sr.has(y))&&f.value.splice(f.value.indexOf("magical"),1),f.value.sort(),p.name=nr(i,o.name,s);let m=p.system.description.value;return p.system.description.value=(()=>{let y=document.createElement("p");y.append(o.sourceId?`@UUID[${o.sourceId}]{${o.name}}`:o.description);let g=document.createElement("div"),h=document.createElement("hr");return g.append(y,h),h.insertAdjacentHTML("afterend",m),g.innerHTML})(),e!=="cantripDeck5"&&(p.system.spell=o.clone({_id:randomID(),"system.location.heightenedLevel":s},{keepId:!0}).toObject()),r&&(p.system.identification.status="unidentified"),typeof a=="string"&&(p.img=a),p.system.temporary=n,p}l(nt,"createConsumableFromSpell");function rr(t,e){switch(t){case"cantripDeck5":return Js;case"scroll":return Qs[e]??null;default:return er[e]??null}}l(rr,"getIdForSpellConsumable");function nr(t,e,s){let r=tr[t]||`${t} of {name} (Level {level})`;return game.i18n.format(r,{name:e,level:s})}l(nr,"getNameForSpellConsumable");var Qt="max(1,floor(@actor.level/2))",ir=["propertyRune1","propertyRune2","propertyRune3","propertyRune4"],es,ts,O={get skillNames(){return es??=Object.keys(CONFIG.PF2E.skillList).filter(t=>t!=="lore"),es.slice()},skillLabel:t=>game.i18n.localize(CONFIG.PF2E.skillList[t]),createSkillRuleElement:({skill:t,value:e,mode:s="upgrade",predicate:r})=>{let n={key:"ActiveEffectLike",mode:s,path:`system.skills.${t}.rank`,value:e};return r?.length&&(n.predicate=r),n},createLoreSource:({name:t,rank:e})=>({type:"lore",img:"systems/pf2e/icons/default-icons/lore.svg",name:t,system:{proficient:{value:e}}}),getTranslatedSkills:(t=!1)=>Object.entries(CONFIG.PF2E.skillList).reduce((e,[s,r])=>{let n=game.i18n.localize(r);return e[s]=t?n.toLocaleLowerCase(game.i18n.lang):n,e},{}),get languageNames(){return ts??=Object.keys(CONFIG.PF2E.languages),ts.slice()},languageLabel:t=>game.i18n.localize(CONFIG.PF2E.languages[t]),createLanguageRuleElement:({language:t,mode:e="add",predicate:s})=>{let r={key:"ActiveEffectLike",mode:e,path:"system.details.languages.value",value:t};return s?.length&&(r.predicate=s),r},resistanceLabel:(t,e)=>{let s=game.i18n.localize(`PF2E.Trait${Ee(t)}`);return e&&(s+=` ${e}`),s},createResistanceRuleElement:({type:t,value:e,predicate:s})=>{e==="half"&&(e=Qt);let r={key:"Resistance",type:t,value:e};return s?.length&&(r.predicate=s),r},createFeatSource:async t=>{let e=(await fromUuid(t))?.toObject();if(!e)throw new Error(`An error occured while trying to create a feat source with uuid: ${t}`);return e},createSpellScrollSource:async({uuid:t,level:e,itemName:s,itemImg:r})=>{let n=await nt(t,"scroll",{heightenedLevel:e,temp:!0,itemName:s,itemImg:r});if(!n)throw new Error(`An error occured while trying to create a spell scroll source with uuid: ${t}`);return n},createWandSource:async({uuid:t,level:e,itemName:s,itemImg:r})=>{let n=await nt(t,"wand",{heightenedLevel:e,temp:!0,itemName:s,itemImg:r});if(!n)throw new Error(`An error occured while trying to create a wand source with uuid: ${t}`);return n},createSpellSource:async t=>{let e=(await fromUuid(t))?.toObject();if(!e)throw new Error(`An error occured while trying to create a spell source with uuid: ${t}`);return e},spellRankLabel:t=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ar(t)}),get halfLevelString(){return Qt},getChoiSetRuleSelection:(t,e)=>t._source.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.rollOption===e))?.selection,proficiencyLabel:t=>game.i18n.localize(CONFIG.PF2E.proficiencyLevels[t]),randomOption:async t=>{let e=(await new Roll(`1d${t.length}`).evaluate({async:!0})).total,s=t[e-1];return typeof s=="string"?s:s.value},halfLevelValue:t=>Math.max(1,Math.floor(t.level/2)),sequenceArray:Ce,damageLabel:t=>game.i18n.localize(CONFIG.PF2E.damageTypes[t]),weaponTraitLabel:t=>game.i18n.localize(CONFIG.PF2E.weaponTraits[t]),weaponPropertyRunesLabel:t=>{let e=`PF2E.WeaponPropertyRune.${t}.Name`;return game.i18n.localize(e)},hasFreePropertySlot:t=>{let e=t.system.runes.potency;return e>0&&t.system.runes.property.length<e},getFreePropertyRuneSlot:t=>{let e=t.system.potencyRune.value;if(e===null)return null;for(let s=0;s<e;s++){let r=ir[s];if(!t.system[r].value)return r}return null},getPlayersActors:(t,...e)=>{let s=e.length?e:["creature"],r=t instanceof Actor,n=game.actors;return r&&t.parties.size&&L("members")?(n=Array.from(t.parties??[]).flatMap(i=>i.members),n=Array.from(new Set(n))):n=n.filter(i=>i.hasPlayerOwner),n.filter(i=>i.isOfType(...s)&&(!r||i!==t))}};function ar(t){let e=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),s=game.i18n.localize(`PF2E.OrdinalSuffixes.${e.select(t)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:t,suffix:s})}l(ar,"ordinalString");function ie(t,e){let s=t;if((!s||!s.isOfType("character")||!s.isOwner)&&(s=canvas.tokens.controlled.find(n=>n.actor?.isOfType("character")&&n.actor.isOwner)?.actor,s||(s=game.user.character)),!s||!s.isOfType("character")||!s.isOwner)return P("error.noCharacterSelected");if(!we(s))return P("error.unrested");new je(s,{title:S("interface.title",{name:s.name})},e).render(!0)}l(ie,"openDailiesInterface");function Ue(){let t=new Collection;return[t,e=>{let s=e._id;if(!s)return;let r=t.get(s)??{};t.set(s,mergeObject(r,e))}]}l(Ue,"createUpdateCollection");async function ss(){let t=(await this.getCraftingEntries()).filter(i=>i.isDailyPrep),s=t.filter(i=>i.isAlchemical).reduce((i,a)=>i+a.reagentCost,0),r=(this.system.resources.crafting.infusedReagents.value||0)-s;if(r<0){ui.notifications.warn(game.i18n.localize("PF2E.CraftingTab.Alerts.MissingReagents"));return}await this.update({"system.resources.crafting.infusedReagents.value":r});let n=s===0?"ZeroConsumed":s===1?"OneConsumed":"NConsumed";ui.notifications.info(game.i18n.format(`PF2E.Actor.Character.Crafting.Daily.Complete.${n}`,{quantity:s}));for(let i of t)for(let a of i.preparedCraftingFormulas){let o=a.item.toObject();o.system.quantity=a.quantity,o.system.temporary=!0,o.system.size=this.ancestry?.size==="tiny"?"tiny":"med",i.isAlchemical&&qt(o,"consumable","equipment","weapon")&&o.system.traits.value.push("infused"),await this.addToInventory(o)}}l(ss,"performDailyCrafting");function rs(t,e){let s=t.actor;if(!s.isOwner)return;let r=we(s),n=r?"":" disabled",i=S(r?"sheet.title":"sheet.unrested"),a=`<a class="roll-icon dailies${n}" data-tooltip="${i}">
	<i class="fas fa-mug-saucer"></i>
</a>`,o=e.find("aside .sidebar .hitpoints .hp-small");o.append(a),r&&o.find(".dailies").on("click",()=>ie(s)),q()||or(e,s)}l(rs,"renderCharacterSheetPF2e");function or(t,e){let r=t.find(".sheet-body .sheet-content [data-tab=spellcasting] [data-tab=known-spells] .spellcastingEntry-list").find("[data-container-type=spellcastingEntry]");for(let n of r){let i=n.dataset.containerId,a=e.spellcasting.get(i),o=pe(a);if(!o)continue;let u=S("staves.label"),c=$(`<div class="pf2e-dailies-charges"><label>${u}</label></div>`),d=$(`<input type="number" min="0" max="${o.max}" value="${o.charges}">`);d.on("change",m=>cr(m,e));let p=$('<a><i class="fas fa-redo"></i></a>');p.on("click",m=>lr(m,e)),c.append(d),c.append(p),n.querySelector(".spell-ability-data .statistic-values").after(c[0]);let f=n.querySelectorAll('.spell-list .spell:not([data-group-id="cantrips"]');for(let m of f){let y=m.dataset.castRank;o.canPayCost(y)||(m.dataset.slotExpended="")}}}l(or,"renderStavesEntries");function ns(t,e){let{itemId:s}=t.currentTarget.closest(".spellcasting-entry").dataset;return e.spellcasting.get(s)}l(ns,"getEntryDataFromEvent");async function lr(t,e){let s=ns(t,e);fe(s,9999)}l(lr,"onStaffChargesReset");async function cr(t,e){let s=ns(t,e);fe(s,t.currentTarget.valueAsNumber)}l(cr,"onStaffChargesChange");function we(t){return C(t,"rested")!==!1}l(we,"canPrepDailies");function is(t,e,s,r){return{key:t,label:r,item:{uuid:e},rows:[{type:"drop",slug:"feat",filter:{type:"feat",search:s??{}}}],process:async({utils:i,fields:a,addFeat:o,messages:u})=>{let c=a.feat.uuid,d=await i.createFeatSource(c);o(d),u.add("feats",{uuid:c})}}}l(is,"createFeatDaily");var as=["/** @typedef {'flexibility' | 'improved'} FlexibilityRow */","/** @typedef {'improved'} FlexibilityChild */","/** @typedef {[FlexibilityRow, {}, FlexibilityChild]} FlexibilityGenerics */","","/**"," * @param {FlexibilityRow} slug"," * @param {number} level"," * @param {FlexibilityChild} [child]"," */","function createRow(slug, level, child) {","    /** @type {DailyRowDrop<FlexibilityGenerics>} */","    const row = {","        type: 'drop',","        label: `PF2E.Level${level}`,","        slug,","        filter: {","            type: 'feat',","            search: {","                category: ['class'],","                traits: {","                    values: ['fighter'],","                },","                level,","            },","        },","    }","    if (child) row.childPredicate = [child]","    return row","}","","/** @type {Daily<FlexibilityGenerics>} */","const combatFlexibility = {","    key: 'flexibility',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8', // Combat Flexibility","    },","    children: [","        {","            slug: 'improved',","            uuid: 'Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX', // Improved Flexibility","        },","    ],","    rows: [","        createRow('flexibility', 8), //","        createRow('improved', 14, 'improved'),","    ],","    process: async ({ utils, fields, addFeat, messages, children }) => {","        const uuid = fields.flexibility.uuid","        const source = await utils.createFeatSource(uuid)","        addFeat(source)","        messages.add('feats', { uuid })","","        if (children.improved) {","            const uuid = fields.improved.uuid","            const source = await utils.createFeatSource(uuid)","            addFeat(source, children.improved)","            messages.add('feats', { uuid })","        }","    },","}","","return combatFlexibility"].join(`
`);var os=["/** @typedef {'alert' | 'smith' | 'mental' | 'runic' | 'advanced'} MindRow */","/** @typedef {'weapon' | 'mental' | 'runic' | 'advanced'} MindChild */","/** @typedef {[MindRow, {}, MindChild]} MindGenerics */","","const MIND_WEAPON_UUID = 'Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P'","","const WEAPON_BASE_TYPES = {","    0: { die: 'd4', traits: ['finesse', 'agile'], usage: 'held-in-one-hand' },","    1: { die: 'd6', traits: ['finesse'], usage: 'held-in-one-hand' },","    2: { die: 'd8', traits: [], usage: 'held-in-one-hand' },","    3: { die: 'd10', traits: ['reach'], usage: 'held-in-two-hands' },","}","","const WEAPON_GROUPS = /** @type {Record<WeaponDamage, string>} */ {","    slashing: 'sword',","    piercing: 'spear',","    bludgeoning: 'club',","}","","const WEAPON_TRAITS = ['grapple', 'nonlethal', 'shove', 'trip', 'modular']","","const WEAPON_DAMAGE_TYPES = Object.keys(WEAPON_GROUPS)","","const WEAPON_RUNES = ['corrosive', 'disrupting', 'flaming', 'frost', 'shock', 'thundering']","","const WEAPON_GREATER_RUNES = [","    'anarchic',","    'axiomatic',","    'greaterCorrosive',","    'greaterDisrupting',","    'greaterFlaming',","    'greaterFrost',","    'greaterShock',","    'greaterThundering',","    'holy',","    'unholy',","]","","/** @type {Daily<MindGenerics>} */","const mindSmith = {","    key: 'mindsmith',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY', // Mind Smith Dedication","    },","    children: [","        {","            slug: 'weapon',","            uuid: MIND_WEAPON_UUID, // Mind Weapon","        },","        {","            slug: 'mental',","            uuid: 'Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky', // Malleable Mental Forge","        },","        {","            slug: 'runic',","            uuid: 'Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp', // Runic Mind Smithing","        },","        {","            slug: 'advanced',","            uuid: 'Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD', // Advanced Runic Mind Smithing","        },","    ],","    rows: [","        {","            type: 'alert',","            slug: 'alert',","            message: 'Missing Mind Weapon',","            fix,","            childPredicate: [{ not: 'weapon' }],","        },","        {","            type: 'select',","            slug: 'smith',","            label: 'Mind Smith',","            options: WEAPON_DAMAGE_TYPES,","            labelizer: ({ utils }) => utils.damageLabel,","            childPredicate: ['weapon'],","        },","        {","            type: 'select',","            slug: 'mental',","            label: 'Mental Forge',","            options: WEAPON_TRAITS,","            labelizer: ({ utils }) => utils.weaponTraitLabel,","            childPredicate: ['weapon', 'mental'],","        },","        {","            type: 'select',","            slug: 'runic',","            label: 'Runic Smithing',","            options: WEAPON_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'runic', { not: 'advanced' }],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","        {","            type: 'select',","            slug: 'advanced',","            label: 'Runic Smithing',","            options: WEAPON_GREATER_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'advanced'],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","    ],","    process: ({ children, updateItem, fields, messages, item, utils }) => {","        const weapon = children.weapon","        if (!weapon) return","","        messages.addGroup('mindsmith')","","        const selected = /** @type {WeaponDamage} */ fields.smith.value","        updateItem({ _id: weapon.id, 'system.damage.damageType': selected, 'system.group': WEAPON_GROUPS[selected] })","        messages.add('mindsmith', { selected: utils.damageLabel(selected), uuid: item.uuid, label: 'mindsmith' })","","        if (children.mental) {","            const selected = fields.mental.value","            const traits = deepClone(weapon._source.system.traits?.value ?? [])","            if (!traits.includes(selected)) traits.push(selected)","            updateItem({ _id: weapon.id, 'system.traits.value': traits })","            messages.add('mindsmith', {","                selected: utils.weaponTraitLabel(selected),","                uuid: children.mental.uuid,","                label: 'mentalforge',","            })","        }","","        if ((children.advanced || children.runic) && utils.hasFreePropertySlot(weapon)) {","            const child = children.advanced ?? children.runic","            const freeSlot = utils.getFreePropertyRuneSlot(weapon)","            const field = fields.advanced ?? fields.runic","            const selected = field.value","","            if (!weapon.system.runes.property.includes(selected)) {","                updateItem({ _id: weapon.id, [`system.${freeSlot}.value`]: selected, [`flags.world.runeSlot`]: freeSlot })","                messages.add('mindsmith', {","                    selected: utils.weaponPropertyRunesLabel(selected),","                    uuid: child.uuid,","                    label: 'runicmind',","                })","            }","        }","    },","    rest: ({ item, sourceId, updateItem }) => {","        if (sourceId !== MIND_WEAPON_UUID) return","","        let traits = item._source.system.traits?.value ?? []","        traits = traits.filter(trait => !WEAPON_TRAITS.includes(trait))","        updateItem({ _id: item.id, 'system.traits.value': traits })","","        const runeSlot = item.getFlag('world', 'runeSlot')","        if (runeSlot) {","            updateItem({ _id: item.id, [`system.${runeSlot}.value`]: null, [`flags.world.-=runeSlot`]: true })","        }","    },","}","","const OPTIONS = {","    0: 'A one-handed weapon that deals <strong>1d4</strong> damage and has the <strong>agile</strong> and <strong>finesse</strong> traits',","    1: 'A one-handed weapon that deals <strong>1d6</strong> damage and has the <strong>finesse</strong> trait',","    2: 'A one-handed weapon that deals <strong>1d8</strong> damage',","    3: 'A two-handed weapon that deals <strong>1d10</strong> damage and has the <strong>reach</strong> trait',","}","","/** * @param {DailyValueArgs<MindGenerics>} args */","async function fix({ actor }) {","    let content =","        `<p>This character doesn't have a mind weapon in their inventory.</p><p>Please select one of the following options to create one.</p>`","","    for (const [key, label] of Object.entries(OPTIONS)) {","        content += `<label><input type='radio' name='type' value='${key}'>${label}</label>`","    }","","    const weapon = await Dialog.wait(","        {","            title: 'Mind Weapon',","            content,","            buttons: {","                yes: {","                    icon: `<i class='fas fa-save'></i>`,","                    label: 'Accept',","                    callback: onWeaponSelected,","                },","                no: {","                    icon: `<i class='fas fa-times'></i>`,","                    label: 'Cancel',","                    callback: () => null,","                },","            },","            close: () => null,","        },","        {},","        { id: 'pf2e-dailies-weapon', width: 600 }","    )","","    if (weapon) {","        await actor.createEmbeddedDocuments('Item', [weapon])","        return true","    }","","    return false","}","","/** @params {JQuery} html */","async function onWeaponSelected(html) {","    const selection = html.find('[name=type]:checked').val()","    if (!selection) {","        ui.notifications.warn('You must select one weapon base type.')","        return","    }","","    const weapon = (await fromUuid(MIND_WEAPON_UUID))?.toObject()","    if (!weapon) {","        ui.notifications.warn(`The weapon couldn't be found in the compendium.`)","        return","    }","","    const stats = WEAPON_BASE_TYPES[selection]","","    setProperty(weapon, 'system.damage.die', stats.die)","    setProperty(weapon, 'system.traits.value', stats.traits.slice())","    setProperty(weapon, 'system.usage.value', stats.usage)","","    return weapon","}","","return mindSmith"].join(`
`);var ls=["/** @typedef {'first' | 'second' | 'third' | 'fourth'} SavantRow */","/** @typedef {Record<SavantRow, { level: number; condition: boolean }>} SavantCustom */","/** @typedef {[SavantRow, SavantCustom, '']} SavantGenerics */","","const ROWS = /** @type {const} */ (['first', 'second', 'third', 'fourth'])","","/**"," * @param {CharacterPF2e} actor"," * @param {MagicTradition} tradition"," */","function getSpellcastingTraditionDetails(actor, tradition) {","    let maxSlot = 1","    let maxTradition = 0","","    for (const entry of actor.spellcasting.regular) {","        if ('pf2e-staves' in entry.flags) continue // we skip staff entries","","        const slots = entry.system.slots","        for (const key in slots) {","            const slot = slots[key]","            if (slot.max) maxSlot = Math.max(maxSlot, Number(key.slice(4)))","        }","","        if (entry.tradition === tradition) maxTradition = Math.max(maxTradition, entry.rank)","    }","","    return { maxSlot: Math.min(maxSlot, 10), maxTradition }","}","","/** @type {Daily<SavantGenerics>} */","const scrollSavant = {","    key: 'savant',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ', // Scroll Savant","    },","    prepare: ({ actor }) => {","        const { maxSlot, maxTradition } = getSpellcastingTraditionDetails(actor, 'arcane')","        return {","            first: { level: maxSlot - 2, condition: true },","            second: { level: maxSlot - 3, condition: true },","            third: { level: maxSlot - 4, condition: maxTradition >= 3 && maxSlot >= 5 },","            fourth: { level: maxSlot - 5, condition: maxTradition >= 4 && maxSlot >= 6 },","        }","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowDrop<SavantGenerics>} */","        const row = {","            type: 'drop',","            slug: rowName,","            label: ({ custom }) => `PF2E.SpellLevel${custom[rowName].level}`,","            filter: {","                type: 'spell',","                search: ({ custom }) => ({","                    category: ['spell'],","                    traditions: ['arcane'],","                    level: custom[rowName].level,","                }),","            },","            condition: ({ custom }) => custom[rowName].condition,","        }","        return row","    }),","    process: async ({ utils, fields, custom, addItem, messages }) => {","        for (const field of Object.values(fields)) {","            const uuid = field.uuid","            const source = await utils.createSpellScrollSource({ uuid, level: custom[field.row].level })","            addItem(source)","            messages.add('scrolls', { uuid, label: source.name })","        }","    },","}","","return scrollSavant"].join(`
`);var cs=["/** @typedef {typeof ROWS[number]} TomeRow */","/** @typedef {'adept' | 'second' | 'intense' | 'paragon'} TomeChild */","/** @typedef {Record<TomeRow, { rank: OneToFour; options: string[] }>} TomeCustom */","/** @typedef {[TomeRow, TomeCustom, TomeChild]} TomeGenerics */","","const ROWS = /** @type {const} */ (['first', 'second'])","","/** @param {'adept' | 'paragon'} option */","function createChildCondition(option) {","    /** @type { BaseDailyConditionFunction<TomeGenerics>} */","    const condition = ({ item, utils }) => {","        return utils.getChoiSetRuleSelection(item, option) === 'tome'","    }","    return condition","}","","/** @type {Daily<TomeGenerics>} */","const thaumaturgeTome = {","    key: 'tome',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e', // Tome","    },","    children: [","        {","            slug: 'adept',","            uuid: 'Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO', // Implement Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'second',","            uuid: 'Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5', // Second Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'intense',","            uuid: 'Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC', // Intense Implement","        },","        {","            slug: 'paragon',","            uuid: 'Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI', // Implement Paragon","            condition: createChildCondition('paragon'),","        },","    ],","    prepare: ({ utils, actor, children }) => {","        const skillNames = utils.skillNames","        const actorLevel = actor.level","        const actorSkills = /** @type {Record<SkillLongForm, { rank: ZeroToFour }>} */ (actor.skills)","","        /** @type {TomeCustom} */","        const custom = {","            first: { options: [], rank: 1 },","            second: { options: [], rank: 1 },","        }","","        // Implement Paragon","        if (children.paragon) {","            const skills = skillNames.filter(x => actorSkills[x].rank < 4)","            custom.first = { rank: 4, options: skills }","            custom.second = { rank: 4, options: skills }","        }","        // Intense Implement or Second Adept or Implement Adept","        else if (children.intense || children.adept || children.second) {","            const masters = skillNames.filter(x => actorSkills[x].rank < 3)","","            if (actorLevel >= 9) {","                custom.first = { rank: 3, options: masters }","                custom.second = { rank: 3, options: masters }","            } else {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 3, options: masters }","            }","        }","        // Tome","        else {","            if (actorLevel >= 5) {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 2, options: experts }","            } else if (actorLevel >= 3) {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 2, options: experts }","            } else {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 1, options: trained }","            }","        }","","        return custom","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowCombo<TomeGenerics>} */","        const row = {","            type: 'combo',","            slug: rowName,","            label: ({ custom, utils }) => utils.proficiencyLabel(custom[rowName].rank),","            options: ({ custom }) => custom[rowName].options,","            labelizer: ({ utils }) => utils.skillLabel,","        }","        return row","    }),","    process: ({ custom, fields, utils, messages, addItem, addRule }) => {","        messages.addGroup('tome', 65)","","        for (const rowName of ROWS) {","            const rank = custom[rowName].rank","            let value = fields[rowName].value","","            if (fields[rowName].input === 'true') {","                const source = utils.createLoreSource({ name: value, rank })","                addItem(source)","            } else {","                const source = utils.createSkillRuleElement({ skill: value, value: rank })","                value = utils.skillLabel(value)","                addRule(source)","            }","","            messages.add('tome', { label: utils.proficiencyLabel(rank), selected: value })","        }","    },","}","","return thaumaturgeTome"].join(`
`);var V=_("customs"),ur=["default","trainedSkill","trainedLore","language","resistance","feat","spell"],it=["flexibility","savant","tome","mind"],ze=class extends FormApplication{static{l(this,"DailyCustoms")}static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{id:"pf2e-dailies-customs",title:V("title"),template:te("customs.hbs"),submitOnChange:!1,submitOnClose:!1,closeOnSubmit:!1,scrollY:[".left .list"]})}async _updateObject(e,s){}async getData(e){let s=L("customDailies"),r=s.find(o=>o.key===this._selectedDaily)?.code,n=this._selectedTemplate,i=game.modules.get("pf2e-dailies-ext"),a=i?.active&&isNewerVersion(ot,i.version)?{version:ot}:"";return mergeObject(super.getData(e),{i18n:V,template:n,templates:ur,daily:this._selectedDaily,code:r,customs:s,examples:it,isExample:it.includes(n),monaco:i?.active,newVersion:a})}activateListeners(e){super.activateListeners(e),this._monaco?.dispose();let s=game.modules.get("pf2e-dailies-ext")?.api,r=e.find(".code")[0];if(s&&r){let n=e.find(".monaco .placeholder")[0];this._monaco=s.createEditor(n,r.value),this._monaco.onDidChangeModelContent(debounce(()=>{r.value=this._monaco.getValue()},200))}else this._monaco=null;e.find("[data-action=select-template]").on("change",this.#a.bind(this)),e.find("[data-action=create-template]").on("click",this.#i.bind(this)),e.find("[data-action=create-daily]").on("click",this.#s.bind(this)),e.find(".row[data-key]").on("click",this.#n.bind(this)),e.find("[data-action=delete-daily]").on("click",this.#r.bind(this)),e.find("[data-action=save-code]").on("click",this.#e.bind(this))}get code(){return this.form.querySelector(".window-content .code")?.value}async#e(e){e.preventDefault();let s=this.code,r=this._selectedDaily;if(!r||!s)return;let n=L("customDailies"),i=n.filter(a=>a.key!==r);try{let u=(await new ke(s)()).key;if(typeof u!="string")return P("invalidKey");if(i.find(d=>d.key===u))return P("duplicate");let c=n.findIndex(d=>d.key===r);if(c<0)return;n.splice(c,1,{key:u,code:s}),await xe("customDailies",n),V.info("saved",{daily:u}),this._selectedDaily=u,this.render()}catch(a){N("error.unexpected"),console.error(a),console.error(`The error occured while testing the custom daily ${r}`)}}async#r(e){if(e.preventDefault(),e.stopPropagation(),!await Dialog.confirm({title:V("delete.title"),content:V("delete.content")}))return;let r=e.currentTarget.dataset.key,n=L("customDailies").filter(i=>i.key!==r);await xe("customDailies",n),V.info("deleted",{daily:r}),this.#s()}#s(){this._selectedDaily="",this._selectedTemplate="default",this.render()}#n(e){e.preventDefault(),this._selectedDaily=e.currentTarget.dataset.key,this.render()}async#i(e){e.preventDefault();let s=this._selectedTemplate,r=L("customDailies"),n=new FormData(this.form),i=Object.fromEntries(n),a=it.includes(s),{key:o,uuid:u,label:c}=i;if(a)o=s;else if(!o||!u)return V.warn("template.noEmpty");if(r.find(p=>p.key===o))return P("error.duplicate");let d;if(s==="trainedSkill"){let p=se(o,u,c);d=this.#t(p,{key:o,uuid:u,label:c},"SkillGenerics")}else if(s==="trainedLore"){let p=Pe(o,u,c);d=this.#t(p,{key:o,uuid:u,label:c},"SkillGenerics")}else if(s==="language"){let p=ce(o,u,c);d=this.#t(p,{key:o,uuid:u,label:c},"LanguageGenerics")}else if(s==="resistance"){let p=at(i.resistance),f=ae(i.resistances);if(p===""||!f.length)return V.warn("template.noEmpty");if(typeof p=="number"&&p<1)return V.warn("template.badResistance");let m=ue(o,u,f,p,c);d=this.#t(m,{key:o,uuid:u,label:c,resistance:p,resistances:f},"ResistanceGenerics")}else if(s==="feat"){let p=ae(i.traits),f={category:ae(i.category),level:at(i.level)||{min:0,max:20}};p.length&&(f.traits=p);let m=is(o,u,f,c);d=this.#t(m,{key:o,uuid:u,label:c},"FeatGenerics")}else if(s==="spell"){let p=Number(i.level)||void 0,f=ae(i.traits),m=i.levels.split(",").map(h=>h.trim());m.length===1?m=at(m[0]):m=m.filter(h=>h).map(h=>Number(h)).filter(h=>!Number.isNaN(h));let y={category:ae(i.category),traditions:ae(i.traditions),level:m||[]};f.length&&(y.traits=f);let g=Ae(o,u,y,p,c);d=this.#t(g,{key:o,uuid:u,label:c,level:p},"SpellGenerics")}else if(s==="tome")d=cs;else if(s==="flexibility")d=as;else if(s==="savant")d=ls;else if(s==="mind")d=os;else{let p={key:o,label:c,item:{uuid:u},rows:[],process:()=>{}};d=this.#t(p,{key:o,uuid:u,label:c})}r.push({key:o,code:d}),await xe("customDailies",r),this._selectedDaily=o,this.render()}#t(e,s,r){let n="____PLACEHOLDER____",i=[],a=JSON.stringify(e,(c,d)=>typeof d=="function"?(i.push(d),n):d,4);a=a.replace(new RegExp(`"${n}"`,"g"),()=>i.shift()?.toString()?.replace(/( {5,})/g,d=>d.slice(4))??"");let o="";for(let[c,d]of Object.entries(s))typeof d=="string"?o+=`const ${c} = '${d}';
`:typeof d=="object"?o+=`const ${c} = ${JSON.stringify(d)};
`:o+=`const ${c} = ${d};
`;let u=r?`Daily<${r}>`:"Daily";return`${o}
/** @type {${u}} */
const daily = ${a};

return daily;`}#a(e){e.preventDefault(),this._selectedDaily="",this._selectedTemplate=e.currentTarget.value,this.render()}};function ae(t){return t.split(",").map(e=>e.trim()).filter(e=>e)}l(ae,"splitList");function at(t){if(typeof t=="number")return t;let e=t.trim();if(e==="level"||e==="half")return e;let s=Number(e);return Number.isNaN(s)?"":s}l(at,"simplyfiable");function us(t,e,s){s.restForTheNight&&ft(t,"restForTheNight",!0)}l(us,"preCreateChatMessage");function ds(t,e){C(t,"restForTheNight")&&dr(t,e)}l(ds,"renderChatMessage");function dr(t,e){let s=t.actor;if(!s.isOwner)return;let r=we(s),n=C(t,"prepared"),i=S(`message.dailiesRequest.${!r&&n===void 0?"cleaning":r?"button":"prepared"}`),a=$(`<button type="button">${i}</button>`);e.find(".message-content").append(a),r?a.on("click",()=>ie(s,t)):a.prop("disabled",!0)}l(dr,"renderRestMessage");async function ps(t,...e){let s=await t(...e);return await Promise.all(s.map(async r=>{let n=r.actor;n?.isOwner&&(await pr(n),await Z(n,"rested",!0),await Z(r,"prepared",!1))})),s}l(ps,"restForTheNightAll");async function pr(t){let e=[],[s,r]=Ue(),n=q();for(let i of t.items){if(C(i,"temporary")){if(e.push(i.id),i.isOfType("feat")){let c=C(i,"grantedBy");if(c){let p=`flags.pf2e.itemGrants.-=${J(i.name,{camel:"dromedary"})}`;r({_id:c,[p]:!0})}}continue}if(!n&&i.isOfType("spellcastingEntry")&&i.system.prepared.value==="charge"){e.push(i.id);continue}let a=Ie(i);if(a){let c=Gt(a);c?.rest&&await c.rest({item:i,sourceId:a,updateItem:r,actor:t})}let o=deepClone(i._source.system.rules),u=!1;for(let c=o.length-1;c>=0;c--)k in o[c]&&(o.splice(c,1),u=!0);u&&r({_id:i.id,"system.rules":o})}s.size&&await t.updateEmbeddedDocuments("Item",s.contents),e.length&&await t.deleteEmbeddedDocuments("Item",e)}l(pr,"restForTheNight");var ot="1.3.0",fr="CONFIG.PF2E.Item.documentClasses.spellcastingEntry.prototype.cast",mr="CONFIG.PF2E.Actor.documentClasses.character.prototype.performDailyCrafting",gr="game.pf2e.actions.restForTheNight";Hooks.once("setup",()=>{X({name:"customDailies",type:Array,default:[],config:!1,onChange:Ze}),X({name:"familiar",type:String,default:""}),X({name:"members",type:Boolean,default:!0,scope:"client"}),X({name:"staff-sort",type:String,default:"top",choices:["top","bottom"],scope:"client"}),X({name:"staff-regex",type:String,default:Oe}),X({name:"filters",type:String,default:"",scope:"client",onChange:Ke}),ut({name:"customs",type:ze}),game.modules.get(k).api={openDailiesInterface:t=>ie(t),getBuiltinDailies:()=>deepClone(be),getCustomDailies:()=>deepClone(he),getBuiltinDailyKeys:()=>[Ut.map(t=>`dailies.${t}`),be.map(t=>`dailies.${t.key}`)].flat(),getBuiltinDailyKey:t=>{let e=be.find(s=>s.item.uuid===t||s.children?.some(r=>r.uuid===t));if(e)return`dailies.${e.key}`},prepareDailies:Le,checkCustomDaily:Je,getUtils:()=>deepClone(O),getSpellcastingEntryStaffFlags:de,getSpellcastingEntryStaffData:pe,updateEntryCharges:fe},q()||(CONFIG.PF2E.preparationType.charge="Charge",Fe(fr,Rt,"MIXED"))});Hooks.once("ready",async()=>{if(q()&&P("staves.conflict",!0),await Ke(),!game.modules.get("lib-wrapper")?.active&&game.user.isGM){P("error.noLibwrapper",!0);return}Fe(mr,ss,"OVERRIDE"),Fe(gr,ps)});Hooks.on("renderCharacterSheetPF2e",rs);Hooks.on("preCreateChatMessage",us);Hooks.on("renderChatMessage",ds);})();
//# sourceMappingURL=main.js.map
