(()=>{"use strict";let e="";const t=["longevity","ageless","memories","studies"],n={scroll:["Compendium.pf2e.feats-srd.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.LHjPTV5vP3MOsPPJ"],trickster:["Compendium.pf2e.feats-srd.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.lIg5Gzz7W70jfbk1"],longevity:["Compendium.pf2e.feats-srd.WoLh16gyDp8y9WOZ"],ageless:["Compendium.pf2e.feats-srd.wylnETwIz32Au46y"],memories:["Compendium.pf2e.feats-srd.ptEOt3lqjxUnAW62"],studies:["Compendium.pf2e.feats-srd.9bgl6qYWKHzqWZj0"]},s=(()=>{const e={};for(const[t,s]of Object.entries(n))for(let n=0;n<s.length;n++)e[s[n]]={group:t,index:n};return e})(),a=Object.keys(s);function i(e,t,s=0){const a=n[t][s];return e.itemTypes.feat.find((e=>e.getFlag("core","sourceId")===a))}function r(e,t,n,s){const a="string"==typeof t?t:"info",i="object"==typeof t?t:"object"==typeof n?n:void 0,r="boolean"==typeof t?t:"boolean"==typeof n?n:s??!1;ui.notifications.notify(o(e,i),a,{permanent:r})}function o(...t){let[n,s]=t;return n=`${e}.${n}`,s?game.i18n.format(n,s):game.i18n.localize(n)}function c(...t){return t=t.filter((e=>"string"==typeof e)),`modules/${e}/templates/${t.join("/")}`}const l={acr:"acrobatics",arc:"arcana",ath:"athletics",cra:"crafting",dec:"deception",dip:"diplomacy",itm:"intimidation",med:"medicine",nat:"nature",occ:"occultism",prf:"performance",rel:"religion",soc:"society",ste:"stealth",sur:"survival",thi:"thievery"},u=(Object.keys(l),Object.values(l));function d(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}new Set(["arcane","divine","occult","primal"]);const f=[];async function p(e,t,n=!1){const s=(await fromUuid(e))?.toObject();if(!s)return null;!1===t&&(t=s.system.level.value);const a=function(e){return`Compendium.pf2e.equipment-srd.${m[e]}`}(t);f[t]??=await fromUuid(a);const i=f[t]?.toObject();if(!i)return null;s.system.location.heightenedLevel=t,i.name=`Scroll of ${s.name} (Level ${t})`,i.system.temporary=n,i.system.spell=s,i.system.traits.value.push(...s.system.traditions.value);const r=s.flags.core?.sourceId;return r&&(i.system.description.value=`${d(r)}\n<hr />${i.system.description.value}`),i}const m={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"},g=function(e){const t=(...t)=>o(`${e}.${t[0]}`,t[1]);return Object.defineProperties(t,{warn:{value:(...t)=>function(...e){const[t,n,s]=e;r(t,"warning",n,s)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},info:{value:(...t)=>function(...e){const[t,n,s]=e;r(t,"info",n,s)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},error:{value:(...t)=>function(...e){const[t,n,s]=e;r(t,"error",n,s)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1}}),t}("interface");class h extends Application{_actor;constructor(e,t){super(t),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:g("title"),template:c("interface.hbs"),height:"auto",submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[name="spell"]'}]})}getData(t){const n=this._actor,a=("saved",n.getFlag(e,"saved")??undefined??{});const i=function(e){const t={};for(const n of e.itemTypes.feat){const e=n.getFlag("core","sourceId"),a=s[e];a&&(t[a.group]??=[],t[a.group][a.index]=!0)}return t}(n),r=u.filter((e=>n.skills[e].rank<1)).map((e=>({skill:e})));return mergeObject(super.getData(t),{feats:i,saved:a,skills:r,i18n:g,level:n.level,getSpellValue:(e,t,n)=>e?.[t-1]?.[n]??""})}activateListeners(e){super.activateListeners(e),e.find("[data-type=spell] [data-action=search]").on("click",this.#e.bind(this)),e.find("[data-action=clear]").on("click",this.#t.bind(this)),e.find("[data-action=accept]").on("click",this.#n.bind(this)),e.find("[data-action=cancel]").on("click",this.#s.bind(this))}async _onDrop(e){const t=e.dataTransfer?.getData("text/plain");try{const n=$(e.target),s=()=>g.warn("spells.error.wrongType"),a=JSON.parse(t);if(!a||"Item"!==a.type||"string"!=typeof a.uuid)return s();const i=await fromUuid(a.uuid);if(!i?.isOfType("spell")||i.isCantrip||i.isRitual)return s();if(i.level>Number(n.attr("data-level")))return g.warn("spells.error.wrongLevel");n.attr("value",i.name),n.attr("data-uuid",i.uuid),n.nextAll('[data-action="clear"]').first().removeClass("disabled")}catch{}}#a(){this.element.find("button").attr("disabled","true"),this.element.find("a").addClass("disabled")}#i(){const e=[];return this.element.find('input[value=""]').length&&e.push("error.empty"),e.forEach((e=>g.warn(e))),!e.length}async#n(n){if(n.preventDefault(),!this.#i())return;this.#a();const s=this._actor,a={},r=[],o=[];let c=`${g("message.changes")}<hr>`;for(const n of t){const t=i(s,n);if(!t)continue;const r=deepClone(t._source.system.rules),c=this.element.find(`[name=${n}]`).val(),l=r.findIndex((e=>"pf2e-dailies"in e));l>=0&&r.splice(l,1),r.push({key:"ActiveEffectLike",mode:"upgrade",path:`system.skills.${c}.rank`,value:1,[e]:!0}),o.push({uuid:t.uuid,choice:c,update:{_id:t.id,"system.rules":r}}),a[n]=c}const l=this.element.find(".window-content .groups .group").toArray();for(const e of l){const t=$(e),n=t.attr("data-category"),s=t.find('[name="spell"]').toArray();for(let e=0;e<s.length;e++){const t=$(s[e]),i=t.attr("data-uuid"),o=Number(t.attr("data-level")),c={name:t.attr("value"),uuid:i};if(i){const e=await p(i,o,!0);e&&r.push(e)}a[n]??=[],a[n][e]=c}}if(o.length){const e=[];c+=`<p><strong>${g("message.choices")}</strong></p>`;for(const t of o)c+=`<p>${d(t.uuid)} <span style="text-transform: capitalize;">${t.choice}</span></p>`,e.push(t.update);s.updateEmbeddedDocuments("Item",e)}var u;r.length&&(o.length&&(c+="<hr />"),c+=`<p><strong>${g("message.items")}</strong></p>`,(await s.createEmbeddedDocuments("Item",r)).map((e=>c+=`<p>${d(e.uuid)}</p>`))),u=a,s.setFlag(e,"saved",u),ChatMessage.create({content:c,speaker:ChatMessage.getSpeaker({actor:s})}),this.close()}#e(e){e.preventDefault();const t=Number(e.currentTarget.dataset.level),n=[];for(let e=0;e<t;e++)n[e]=e+1;const s={category:["spell"],classes:[],level:n,rarity:[],school:[],source:[],traditions:[],traits:[]};game.pf2e.compendiumBrowser.openTab("spell",s)}#t(e){e.preventDefault();const t=$(e.currentTarget),n=t.prevAll('[name="spell"]').first();n.attr("value",""),n.attr("data-uuid",""),t.addClass("disabled")}#s(e){e.preventDefault(),this.close()}}e||(e="pf2e-dailies"),Hooks.once("ready",(()=>{!function(){const e=game.pf2e.actions.restForTheNight;game.pf2e.actions.restForTheNight=async n=>{const s=await e(n);return s.length&&n.actors&&function(e){const n=(e=Array.isArray(e)?e:[e]).filter((e=>e.isOfType("character")));for(const e of n){const n=[];for(const s of t){const t=i(e,s);if(!t)continue;const a=deepClone(t._source.system.rules),r=a.findIndex((e=>"pf2e-dailies"in e));r>=0&&(a.splice(r,1),n.push({_id:t.id,"system.rules":a}))}n.length&&e.updateEmbeddedDocuments("Item",n)}}(n.actors),s}}()})),Hooks.on("renderCharacterSheetPF2e",(function(e,t){const n=e.actor;if(!function(e){return!!e.itemTypes.feat.find((e=>a.includes(e.getFlag("core","sourceId"))))}(n))return;const s=t.find("aside .sidebar .hitpoints .hp-small");s.append(`<a class="roll-icon dailies" title="${o("sheet.title")}"><i class="fas fa-mug-saucer"></i></a>`).find(".dailies").on("click",(()=>new h(n).render(!0,{id:`pf2e-dailies-interface-${n.id}`}))),s.find("[data-action=rest]").off("click").on("click",(e=>game.pf2e.actions.restForTheNight({event:e,actors:n})))}))})();
//# sourceMappingURL=main.js.map