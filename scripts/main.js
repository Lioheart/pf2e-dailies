(()=>{"use strict";let e="";const t={scroll:["Compendium.pf2e.feats-srd.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.LHjPTV5vP3MOsPPJ"],trickster:["Compendium.pf2e.feats-srd.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.lIg5Gzz7W70jfbk1"],longevity:["Compendium.pf2e.feats-srd.WoLh16gyDp8y9WOZ"]},n=(()=>{const e={};for(const[n,a]of Object.entries(t))for(let t=0;t<a.length;t++)e[a[t]]={group:n,index:t};return e})(),a=Object.keys(n);function s(e,t,n,a){const s="string"==typeof t?t:"info",r="object"==typeof t?t:"object"==typeof n?n:void 0,o="boolean"==typeof t?t:"boolean"==typeof n?n:a??!1;ui.notifications.notify(i(e,r),s,{permanent:o})}function i(...t){let[n,a]=t;return n=`${e}.${n}`,a?game.i18n.format(n,a):game.i18n.localize(n)}function r(...t){return t=t.filter((e=>"string"==typeof e)),`modules/${e}/templates/${t.join("/")}`}const o={acr:"acrobatics",arc:"arcana",ath:"athletics",cra:"crafting",dec:"deception",dip:"diplomacy",itm:"intimidation",med:"medicine",nat:"nature",occ:"occultism",prf:"performance",rel:"religion",soc:"society",ste:"stealth",sur:"survival",thi:"thievery"},l=(Object.keys(o),Object.values(o));function c(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}new Set(["arcane","divine","occult","primal"]);const u=[];async function d(e,t,n=!1){const a=(await fromUuid(e))?.toObject();if(!a)return null;!1===t&&(t=a.system.level.value);const s=function(e){return`Compendium.pf2e.equipment-srd.${f[e]}`}(t);u[t]??=await fromUuid(s);const i=u[t]?.toObject();if(!i)return null;a.system.location.heightenedLevel=t,i.name=`Scroll of ${a.name} (Level ${t})`,i.system.temporary=n,i.system.spell=a,i.system.traits.value.push(...a.system.traditions.value);const r=a.flags.core?.sourceId;return r&&(i.system.description.value=`${c(r)}\n<hr />${i.system.description.value}`),i}const f={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"},p=function(e){const t=(...t)=>i(`${e}.${t[0]}`,t[1]);return Object.defineProperties(t,{warn:{value:(...t)=>function(...e){const[t,n,a]=e;s(t,"warning",n,a)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},info:{value:(...t)=>function(...e){const[t,n,a]=e;s(t,"info",n,a)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},error:{value:(...t)=>function(...e){const[t,n,a]=e;s(t,"error",n,a)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1}}),t}("interface");class m extends Application{_actor;constructor(e,t){super(t),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:p("title"),template:r("interface.hbs"),height:"auto",submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[name="spell"]'}]})}getData(t){const a=this._actor,s=("saved",a.getFlag(e,"saved")??undefined??{});const i=function(e){const t={};for(const a of e.itemTypes.feat){const e=a.getFlag("core","sourceId"),s=n[e];s&&(t[s.group]??=[],t[s.group][s.index]=!0)}return t}(a),r=(()=>{if(!i.longevity)return;let e=l.filter((e=>a.skills[e].rank<1));const t=s.longevity??"";return t&&(e=e.filter((e=>e!==t)),e.unshift(t)),{skills:e.map((e=>({skill:e}))),selected:t}})();return mergeObject(super.getData(t),{i18n:p,feats:i,saved:s,level:a.level,longevity:r,getSpellValue:(e,t,n)=>e?.[t-1]?.[n]??""})}activateListeners(e){super.activateListeners(e),e.find("[data-type=spell] [data-action=search]").on("click",this.#e.bind(this)),e.find("[data-action=clear]").on("click",this.#t.bind(this)),e.find("[data-action=accept]").on("click",this.#n.bind(this)),e.find("[data-action=cancel]").on("click",this.#a.bind(this))}async _onDrop(e){const t=e.dataTransfer?.getData("text/plain");try{const n=$(e.target),a=()=>p.warn("spells.error.wrongType"),s=JSON.parse(t);if(!s||"Item"!==s.type||"string"!=typeof s.uuid)return a();const i=await fromUuid(s.uuid);if(!i?.isOfType("spell")||i.isCantrip||i.isRitual)return a();if(i.level>Number(n.attr("data-level")))return p.warn("spells.error.wrongLevel");n.attr("value",i.name),n.attr("data-uuid",i.uuid),n.nextAll('[data-action="clear"]').first().removeClass("disabled")}catch{}}#s(){this.element.find("button").attr("disabled","true"),this.element.find("a").addClass("disabled")}#i(){const e=[];return this.element.find('input[value=""]').length&&e.push("error.empty"),e.forEach((e=>p.warn(e))),!e.length}async#n(n){if(n.preventDefault(),!this.#i())return;this.#s();const a=this._actor,s={},i=[],r=[];let o=`${p("message.changes")}<hr>`;const l=function(e,n,a=0){const s=t["longevity"][a];return e.itemTypes.feat.find((e=>e.getFlag("core","sourceId")===s))}(a);if(l){const t=deepClone(l._source.system.rules),n=t.findIndex((e=>"pf2e-dailies"in e)),a=this.element.find("[name=longevity]").val();n>=0&&t.splice(n,1),a&&t.push({key:"ActiveEffectLike",mode:"upgrade",path:`system.skills.${a}.rank`,value:1,[e]:!0}),r.push({uuid:l.uuid,choice:a,update:{_id:l.id,"system.rules":t}}),s.longevity=a}const u=this.element.find(".window-content .groups .group").toArray();for(const e of u){const t=$(e),n=t.attr("data-category"),a=t.find('[name="spell"]').toArray();for(let e=0;e<a.length;e++){const t=$(a[e]),r=t.attr("data-uuid"),o=Number(t.attr("data-level")),l={name:t.attr("value"),uuid:r};if(r){const e=await d(r,o,!0);e&&i.push(e)}s[n]??=[],s[n][e]=l}}if(r.length){const e=[];o+=`<p><strong>${p("message.choices")}</strong></p>`;for(const t of r)o+=`<p>${c(t.uuid)} <span style="text-transform: capitalize;">${t.choice}</span></p>`,e.push(t.update);a.updateEmbeddedDocuments("Item",e)}var f;i.length&&(r.length&&(o+="<hr />"),o+=`<p><strong>${p("message.items")}</strong></p>`,(await a.createEmbeddedDocuments("Item",i)).map((e=>o+=`<p>${c(e.uuid)}</p>`))),f=s,a.setFlag(e,"saved",f),ChatMessage.create({content:o,speaker:ChatMessage.getSpeaker({actor:a})}),this.close()}#e(e){e.preventDefault();const t=Number(e.currentTarget.dataset.level),n=[];for(let e=0;e<t;e++)n[e]=e+1;const a={category:["spell"],classes:[],level:n,rarity:[],school:[],source:[],traditions:[],traits:[]};game.pf2e.compendiumBrowser.openTab("spell",a)}#t(e){e.preventDefault();const t=$(e.currentTarget),n=t.prevAll('[name="spell"]').first();n.attr("value",""),n.attr("data-uuid",""),t.addClass("disabled")}#a(e){e.preventDefault(),this.close()}}e||(e="pf2e-dailies"),Hooks.on("renderCharacterSheetPF2e",(function(e,t){const n=e.actor;if(!function(e){return!!e.itemTypes.feat.find((e=>a.includes(e.getFlag("core","sourceId"))))}(n))return;const s=`<a class="roll-icon dailies" title="${i("sheet.title")}"><i class="fas fa-mug-saucer"></i></a>`;t.find("aside .sidebar .hitpoints .hp-small").append(s).find(".dailies").on("click",(()=>new m(n).render(!0,{id:`pf2e-dailies-interface-${n.id}`})))}))})();
//# sourceMappingURL=main.js.map