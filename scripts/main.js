(()=>{"use strict";let e="";function t(e){return e.getFlag("core","sourceId")}function a(e,a){const n=t(e);return!!n&&a.includes(n)}function n(e){return Array.isArray(e)?t=>a(t,e):a=>t(a)===e}function i(e,t){return t?t.flatMap((t=>e.itemTypes[t])):e.items}const s=["ageless","longevity","memories","studies","linguistics","borts"],r=[{type:"trainedSkill",category:"ageless",uuids:["Compendium.pf2e.feats-srd.wylnETwIz32Au46y"]},{type:"trainedSkill",category:"longevity",uuids:["Compendium.pf2e.feats-srd.WoLh16gyDp8y9WOZ"]},{type:"trainedSkill",category:"memories",uuids:["Compendium.pf2e.feats-srd.ptEOt3lqjxUnAW62"]},{type:"trainedSkill",category:"studies",uuids:["Compendium.pf2e.feats-srd.9bgl6qYWKHzqWZj0"]},{type:"addedLanguage",category:"linguistics",uuids:["Compendium.pf2e.feats-srd.eCWQU16hRLfN1KaX"]},{type:"addedLanguage",category:"borts",uuids:["Compendium.pf2e.equipment-srd.iS7hAQMAaThHYE8g"],isItem:!0},{type:"scrollChain",category:"esoterica",uuids:["Compendium.pf2e.feats-srd.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.LHjPTV5vP3MOsPPJ"]},{type:"scrollChain",category:"trickster",label:"Scroll Trickster",uuids:["Compendium.pf2e.feats-srd.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.lIg5Gzz7W70jfbk1"]}],[o,l,c,u,d]=(()=>{const e=new Map,t=[],a=[],n=[],i={};for(const{type:o,category:l,label:c,uuids:u,isItem:d=!1}of r)i[l]??=[],u.forEach(((t,a)=>{i[l].push(t),e.set(t,{type:o,category:l,label:c,index:a,isItem:d})})),s.includes(l)&&n.push(...u),d?a.push(u[0]):t.push(u[0]);return[e,a,t,n,i]})();function p(e){return d[e]}function f(e){return function(e,t,a){return i(e,["feat","equipment"]).filter(n(t))}(e,u)}function m(e){return"addedLanguage"===e.type}function g(e,t,a,n){const i="string"==typeof t?t:"info",s="object"==typeof t?t:"object"==typeof a?a:void 0,r="boolean"==typeof t?t:"boolean"==typeof a?a:n??!1;ui.notifications.notify(h(e,s),i,{permanent:r})}function h(...t){let[a,n]=t;return a=`${e}.${a}`,n?game.i18n.format(a,n):game.i18n.localize(a)}function y(...t){return t=t.filter((e=>"string"==typeof e)),`modules/${e}/templates/${t.join("/")}`}function v(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}const b=["common","draconic","dwarven","elven","gnomish","goblin","halfling","jotun","orcish","sylvan","undercommon","ysoki","abyssal","adlet","aklo","akitonian","alghollthu","amurrun","anadi","ancient-osiriani","anugobu","arcadian","aquan","arboreal","auran","boggard","calda","caligni","celestial","cyclops","daemonic","destrachan","drooni","dziriak","ekujae","erutaki","formian","garundi","girtablilu","gnoll","goloma","grippli","hallit","hwan","iblydan","ignan","ikeshti","immolis","infernal","iruxi","jistkan","jyoti","kaava","kashrishi","kibwani","kitsune","kelish","lirgeni","mahwek","minaten","minkaian","mwangi","mzunu","nagaji","necril","ocotan","okaiyan","osiriani","protean","rasu","ratajin","razatlani","requian","russian","senzar","shadowtongue","shobhad","shisk","shoanti","shoony","skald","sphinx","strix","taldane","tekritanin","tengu","terran","thassilonian","tien","utopian","vanara","varisian","varki","vishkanyan","vudrani","wyrwood","xanmba","androffan","azlanti","grioth","kovintal","migo","munavri","samsaran","sasquatch","shae","yithian","druidic"],k={acr:"acrobatics",arc:"arcana",ath:"athletics",cra:"crafting",dec:"deception",dip:"diplomacy",itm:"intimidation",med:"medicine",nat:"nature",occ:"occultism",prf:"performance",rel:"religion",soc:"society",ste:"stealth",sur:"survival",thi:"thievery"},C=(Object.keys(k),Object.values(k)),w=(new Set(["arcane","divine","occult","primal"]),[]);async function j(e,t,a=!1){const n=(await fromUuid(e))?.toObject();if(!n)return null;!1===t&&(t=n.system.level.value);const i=function(e){return`Compendium.pf2e.equipment-srd.${O[e]}`}(t);w[t]??=await fromUuid(i);const s=w[t]?.toObject();if(!s)return null;n.system.location.heightenedLevel=t,s.name=`Scroll of ${n.name} (Level ${t})`,s.system.temporary=a,s.system.spell=n,s.system.traits.value.push(...n.system.traditions.value);const r=n.flags.core?.sourceId;return r&&(s.system.description.value=`${v(r)}\n<hr />${s.system.description.value}`),s}const O={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"},S=function(e){const t=(...t)=>h(`${e}.${t[0]}`,t[1]);return Object.defineProperties(t,{warn:{value:(...t)=>function(...e){const[t,a,n]=e;g(t,"warning",a,n)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},info:{value:(...t)=>function(...e){const[t,a,n]=e;g(t,"info",a,n)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},error:{value:(...t)=>function(...e){const[t,a,n]=e;g(t,"error",a,n)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1}}),t}("interface");class D extends Application{_actor;constructor(e,t){super(t),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:S("title"),template:y("interface.hbs"),height:"auto",submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[data-droppable="true"]'}]})}getData(a){const n=this._actor,i=n.level,s=("saved",n.getFlag(e,"saved")??undefined??{});const r=function(e){const a={},n=[...e.itemTypes.feat,...e.itemTypes.equipment];for(const e of n){const n=t(e);if(!n||e.isOfType("equipment")&&!e.isInvested)continue;const i=o.get(n);if(!i)continue;const{category:s,index:r,type:l,label:c=""}=i;a[s]??={category:s,type:l,label:c,items:[]},a[s].items[r]=!0,0!==r||c||(a[s].label=e.name)}return Object.values(a).filter((e=>e.items[0]))}(n),l=[],c=[];for(const e of r)if("scrollChain"===e.type){const{type:t,category:a,label:n,items:r}=e,o=[],l=e=>{const{name:t,uuid:n}=s[a]?.[e-1]??{name:"",uuid:""};return{spellLevel:e,name:t,uuid:n}};o.push(l(1)),i>=8&&o.push(l(2)),r[1]&&(o.push(l(3)),i>=14&&o.push(l(4)),i>=16&&o.push(l(5))),r[2]&&(o.push(l(6)),i>=20&&o.push(l(7)));const u={type:t,category:a,label:n,rows:o};c.push(u)}else if("trainedSkill"===e.type){const{type:t,category:a,label:i}=e,r=s[a]??"",o={type:t,category:a,label:i,skills:C.filter((e=>n.skills[e].rank<1)).map((e=>({skill:e}))),selected:r};l.push(o)}else if(m(e)){const{type:t,category:a,label:i}=e,r=s[a]??"",o=n.system.traits.languages.value,c={type:t,category:a,label:i,languages:b.filter((e=>!o.includes(e))).sort().map((e=>({language:e}))),selected:r};l.push(c)}return l.sort(((e,t)=>e.type.localeCompare(t.type))),c.sort(((e,t)=>e.rows.length-t.rows.length)),mergeObject(super.getData(a),{i18n:S,groups:c,rows:l})}activateListeners(e){super.activateListeners(e),e.find("[data-action=searchSpell]").on("click",this.#e.bind(this)),e.find("[data-action=clear]").on("click",this.#t.bind(this)),e.find("[data-action=accept]").on("click",this.#a.bind(this)),e.find("[data-action=cancel]").on("click",this.#n.bind(this))}async _onDrop(e){let t=$(e.target);t.is("label")&&(t=t.next());const a=t.attr("data-type");if(a)try{const n=e.dataTransfer?.getData("text/plain"),i=()=>S.warn("error.drop.wrongType"),s=JSON.parse(n);if(!s||"Item"!==s.type||"string"!=typeof s.uuid)return i();const r=await fromUuid(s.uuid);if(!r)return i();"scrollChain"===a&&this.#i(t,r)}catch(e){}}#i(e,t){return!t.isOfType("spell")||t.isCantrip||t.isRitual?S.warn("error.drop.spell.wrongType"):t.level>Number(e.attr("data-level"))?S.warn("error.drop.spell.wrongLevel"):(e.attr("value",t.name),e.attr("data-uuid",t.uuid),void e.nextAll('[data-action="clear"]').first().removeClass("disabled"))}#s(){this.element.find("button").attr("disabled","true"),this.element.find("a").addClass("disabled")}#r(){const e=[];return this.element.find('input[value=""]').length&&e.push("error.empty"),e.forEach((e=>S.warn(e))),!e.length}async#a(a){if(a.preventDefault(),!this.#r())return;this.#s();let n="";const i=this._actor,r={},o=[],l=[],c=[],u=this.element.find(".window-content .content").find("input, select").toArray(),d=u.some((e=>{const t=e.dataset.category;return s.includes(t)}))?f(i):[];for(const a of u){const n=a.dataset.type;if("scrollChain"===n){const e=a.dataset.uuid,t=Number(a.dataset.level),n=a.dataset.category,i=a.value;if(e){const a=await j(e,t,!0);a&&o.push(a)}r[n]??=[],r[n][t-1]={name:i,uuid:e}}else if("addedLanguage"===n||"trainedSkill"===n){const i=a.dataset.category,s=p(i)[0],o=d.find((e=>{return a=s,t(e)===a;var a}));if(!o)continue;const u=deepClone(o._source.system.rules),f=u.findIndex((e=>"pf2e-dailies"in e)),m=a.value;f>=0&&u.splice(f,1);const g={uuid:s,selected:m,update:{_id:o.id,"system.rules":u}};"addedLanguage"===n?(u.push({key:"ActiveEffectLike",mode:"add",path:"system.traits.languages.value",value:m,[e]:!0}),l.push(g)):(u.push({key:"ActiveEffectLike",mode:"upgrade",path:`system.skills.${m}.rank`,value:1,[e]:!0}),c.push(g)),r[i]=m}}const m=[],g=(e,t,a=!1)=>{if(!t.length)return;a&&n&&(n+="<hr />");const i=S(`message.${e}`);n+=`<p><strong>${i}</strong></p>`;for(const{uuid:e,selected:a,update:i}of t)n+=`<p>${v(e)} <span style="text-transform: capitalize;">${a}</span></p>`,m.push(i)};var h,y;g("languages",l),g("skills",c,!0),m.length&&await i.updateEmbeddedDocuments("Item",m),o.length&&(n&&(n+="<hr />"),n+=`<p><strong>${S("message.items")}</strong></p>`,(await i.createEmbeddedDocuments("Item",o)).map((e=>n+=`<p>${v(e.uuid)}</p>`))),await(h=i,"saved",y=r,h.setFlag(e,"saved",y)),n=`${S("message.changes")}<hr>${n}`,ChatMessage.create({content:n,speaker:ChatMessage.getSpeaker({actor:i})}),this.close()}#e(e){e.preventDefault();const t=Number(e.currentTarget.dataset.level),a=[];for(let e=0;e<t;e++)a[e]=e+1;const n={category:["spell"],classes:[],level:a,rarity:[],school:[],source:[],traditions:[],traits:[]};console.log(n),game.pf2e.compendiumBrowser.openTab("spell",n)}#t(e){e.preventDefault();const t=$(e.currentTarget),a=t.prevAll("input").first();a.attr("value",""),a.attr("data-uuid",""),t.addClass("disabled")}#n(e){e.preventDefault(),this.close()}}e||(e="pf2e-dailies"),Hooks.once("ready",(()=>{!function(){const e=game.pf2e.actions.restForTheNight;game.pf2e.actions.restForTheNight=async t=>{const a=await e(t);return a.length&&t.actors&&function(e){const t=(e=Array.isArray(e)?e:[e]).filter((e=>e.isOfType("character")));for(const e of t){const t=[],a=f(e);for(const e of a){const a=deepClone(e._source.system.rules),n=a.findIndex((e=>"pf2e-dailies"in e));n>=0&&(a.splice(n,1),t.push({_id:e.id,"system.rules":a}))}t.length&&e.updateEmbeddedDocuments("Item",t)}}(t.actors),a}}()})),Hooks.on("renderCharacterSheetPF2e",(function(e,t){const s=e.actor;if(!function(e){return function(e,t,a){return i(e,["feat"]).some(n(t))}(e,c)||e.itemTypes.equipment.some((e=>a(e,l)&&e.isInvested))}(s))return;const r=t.find("aside .sidebar .hitpoints .hp-small");r.append(`<a class="roll-icon dailies" title="${h("sheet.title")}"><i class="fas fa-mug-saucer"></i></a>`).find(".dailies").on("click",(()=>new D(s).render(!0,{id:`pf2e-dailies-interface-${s.id}`}))),r.find("[data-action=rest]").off("click").on("click",(e=>game.pf2e.actions.restForTheNight({event:e,actors:s})))}))})();
//# sourceMappingURL=main.js.map