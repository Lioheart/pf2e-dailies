(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};function t(e,t,i={},s){const a={key:e,label:s,item:{uuid:t},rows:[{type:"drop",slug:"feat",filter:{type:"feat",search:i}}],process:async({utils:e,fields:t,addFeat:i,messages:s})=>{const a=t.feat.uuid;i(await e.createFeatSource(a)),s.add("feats",{uuid:a})}};return a}function i(e,t,i){const s={key:e,label:i,item:{uuid:t},rows:[{type:"select",slug:"language",options:({actor:e,utils:t})=>{const i=e.system.traits.languages.value;return t.languageNames.filter((e=>!i.includes(e))).sort()},labelizer:({utils:e})=>e.languageLabel}],process:({addRule:e,utils:s,fields:a,messages:n})=>{const r=a.language.value;e(s.createLanguageRuleElement({language:r})),n.add("languages",{uuid:t,selected:s.languageLabel(r),label:i})}};return s}function s(e,t,i,s,a,n){const r={key:e,label:a,item:{uuid:t},rows:[{type:n?"random":"select",slug:"resistance",options:i,labelizer:({utils:e})=>e.resistanceLabel}],process:async({utils:e,fields:r,actor:o,addRule:l,messages:c})=>{const u=n?await e.randomOption(i):r.resistance.value,d="number"==typeof s?s:"half"===s?e.halfLevelValue(o):o.level;l(e.createResistanceRuleElement({type:u,value:d})),c.add("resistances",{uuid:t,selected:e.resistanceLabel(u,d),label:a,random:n})}};return r}function a(e,t,i){const s={key:e,label:i,item:{uuid:t},rows:[{type:"combo",slug:"skill",options:({actor:e,utils:t})=>{const i=e.skills;return t.skillNames.filter((e=>i[e].rank<1))},labelizer:({utils:e})=>e.skillLabel}],process:({fields:e,addItem:s,addRule:a,utils:n,messages:r})=>{let o=e.skill.value;if("true"===e.skill.input)s(n.createLoreSource({name:o,rank:1}));else{const e=n.createSkillRuleElement({skill:o,value:1});o=n.skillLabel(o),a(e)}r.add("skills",{uuid:t,selected:o,label:i})}};return s}function n(e,t,i){const s={key:e,label:i,item:{uuid:t},rows:[{type:"input",slug:"skill"}],process:({addItem:e,utils:s,fields:a,messages:n})=>{const r=a.skill.value;e(s.createLoreSource({name:r,rank:1})),n.add("skills",{uuid:t,selected:r,label:i})}};return s}function r(e,t,i={},s,a){const n={key:e,label:a,item:{uuid:t},rows:[{type:"drop",slug:"spell",filter:{type:"spell",search:i}}],process:async({addSpell:e,utils:t,fields:i,messages:a})=>{const n=i.spell.uuid,r=await t.createSpellSource(n),o=`${r.name} (Level ${s||r.system.level.value})`;e(r,s),a.add("spells",{uuid:n,label:o})}};return n}e.d({},{w:()=>ot,c:()=>rt});let o="",l="module";function c(e,t,i,s){const a="string"==typeof t?t:"info",n="object"==typeof t?t:"object"==typeof i?i:void 0,r="boolean"==typeof t?t:"boolean"==typeof i?i:s??!1;ui.notifications.notify(m(e,n),a,{permanent:r})}function u(...e){const[t,i,s]=e;c(t,"warning",i,s)}function d(...e){const[t,i,s]=e;c(t,"error",i,s)}function m(...e){let[t,i]=e;return t=`${o}.${t}`,i?game.i18n.format(t,i):game.i18n.localize(t)}function p(e){return game.i18n.has(`${o}.${e}`,!1)}function f(e){return`${o}.${e}`}function y(e){const t=(...t)=>m(`${e}.${t[0]}`,t[1]);return Object.defineProperties(t,{warn:{value:(...t)=>u(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},info:{value:(...t)=>function(...e){const[t,i,s]=e;c(t,"info",i,s)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},error:{value:(...t)=>d(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},has:{value:t=>p(`${e}.${t}`),enumerable:!1,configurable:!1},path:{value:t=>f(`${e}.${t}`),enumerable:!1,configurable:!1},template:{value:(e,{hash:i})=>t(e,i),enumerable:!1,configurable:!1}}),t}function g(...e){return`${o}.settings.${e.join(".")}`}function h(...e){return e=e.filter((e=>"string"==typeof e)),`${l}s/${o}/templates/${e.join("/")}`}function b(e){return game.settings.get(o,e)}function v(e,t){return game.settings.set(o,e,t)}function w(e){const t=e.name;e.scope=e.scope??"world",e.config=e.config??!1,e.config&&(e.name=g(t,"name"),e.hint=g(t,"hint")),Array.isArray(e.choices)&&(e.choices=e.choices.reduce(((e,i)=>(e[i]=g(t,"choices",i),e)),{})),game.settings.register(o,t,e)}function k(e){return game.modules.get(e)}const S=async function(){}.constructor,C=["/** @typedef {typeof ROWS[number]} TomeRow */","/** @typedef {'adept' | 'second' | 'intense' | 'paragon'} TomeChild */","/** @typedef {Record<TomeRow, { rank: OneToFour; options: string[] }>} TomeCustom */","/** @typedef {[TomeRow, TomeCustom, TomeChild]} TomeGenerics */","","const ROWS = /** @type {const} */ (['first', 'second'])","","/** @param {'adept' | 'paragon'} option */","function createChildCondition(option) {","    /** @type { BaseDailyConditionFunction<TomeGenerics>} */","    const condition = ({ item, utils }) => {","        return utils.getChoiSetRuleSelection(item, option) === 'tome'","    }","    return condition","}","","/** @type {Daily<TomeGenerics>} */","const thaumaturgeTome = {","    key: 'tome',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e', // Tome","    },","    children: [","        {","            slug: 'adept',","            uuid: 'Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO', // Implement Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'second',","            uuid: 'Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5', // Second Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'intense',","            uuid: 'Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC', // Intense Implement","        },","        {","            slug: 'paragon',","            uuid: 'Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI', // Implement Paragon","            condition: createChildCondition('paragon'),","        },","    ],","    prepare: ({ utils, actor, children }) => {","        const skillNames = utils.skillNames","        const actorLevel = actor.level","        const actorSkills = /** @type {Record<SkillLongForm, { rank: ZeroToFour }>} */ (actor.skills)","","        /** @type {TomeCustom} */","        const custom = {","            first: { options: [], rank: 1 },","            second: { options: [], rank: 1 },","        }","","        // Implement Paragon","        if (children.paragon) {","            const skills = skillNames.filter(x => actorSkills[x].rank < 4)","            custom.first = { rank: 4, options: skills }","            custom.second = { rank: 4, options: skills }","        }","        // Intense Implement or Second Adept or Implement Adept","        else if (children.intense || children.adept || children.second) {","            const masters = skillNames.filter(x => actorSkills[x].rank < 3)","","            if (actorLevel >= 9) {","                custom.first = { rank: 3, options: masters }","                custom.second = { rank: 3, options: masters }","            } else {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 3, options: masters }","            }","        }","        // Tome","        else {","            if (actorLevel >= 5) {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 2, options: experts }","            } else if (actorLevel >= 3) {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 2, options: experts }","            } else {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 1, options: trained }","            }","        }","","        return custom","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowCombo<TomeGenerics>} */","        const row = {","            type: 'combo',","            slug: rowName,","            label: ({ custom, utils }) => utils.proficiencyLabel(custom[rowName].rank),","            options: ({ custom }) => custom[rowName].options,","            labelizer: ({ utils }) => utils.skillLabel,","        }","        return row","    }),","    process: ({ custom, fields, utils, messages, addItem, addRule }) => {","        messages.addGroup('tome', 65)","","        for (const rowName of ROWS) {","            const rank = custom[rowName].rank","            let value = fields[rowName].value","","            if (fields[rowName].input === 'true') {","                const source = utils.createLoreSource({ name: value, rank })","                addItem(source)","            } else {","                const source = utils.createSkillRuleElement({ skill: value, value: rank })","                value = utils.skillLabel(value)","                addRule(source)","            }","","            messages.add('tome', { label: utils.proficiencyLabel(rank), selected: value })","        }","    },","}","","return thaumaturgeTome"].join("\n"),x=["/** @typedef {'flexibility' | 'improved'} FlexibilityRow */","/** @typedef {'improved'} FlexibilityChild */","/** @typedef {[FlexibilityRow, {}, FlexibilityChild]} FlexibilityGenerics */","","/**"," * @param {FlexibilityRow} slug"," * @param {number} level"," * @param {FlexibilityChild} [child]"," */","function createRow(slug, level, child) {","    /** @type {DailyRowDrop<FlexibilityGenerics>} */","    const row = {","        type: 'drop',","        label: `PF2E.Level${level}`,","        slug,","        filter: {","            type: 'feat',","            search: {","                category: ['class'],","                traits: {","                    values: ['fighter'],","                },","                level,","            },","        },","    }","    if (child) row.childPredicate = [child]","    return row","}","","/** @type {Daily<FlexibilityGenerics>} */","const combatFlexibility = {","    key: 'flexibility',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8', // Combat Flexibility","    },","    children: [","        {","            slug: 'improved',","            uuid: 'Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX', // Improved Flexibility","        },","    ],","    rows: [","        createRow('flexibility', 8), //","        createRow('improved', 14, 'improved'),","    ],","    process: async ({ utils, fields, addFeat, messages, children }) => {","        const uuid = fields.flexibility.uuid","        const source = await utils.createFeatSource(uuid)","        addFeat(source)","        messages.add('feats', { uuid })","","        if (children.improved) {","            const uuid = fields.improved.uuid","            const source = await utils.createFeatSource(uuid)","            addFeat(source, children.improved)","            messages.add('feats', { uuid })","        }","    },","}","","return combatFlexibility"].join("\n"),I=["/** @typedef {'first' | 'second' | 'third' | 'fourth'} SavantRow */","/** @typedef {Record<SavantRow, { level: number; condition: boolean }>} SavantCustom */","/** @typedef {[SavantRow, SavantCustom, '']} SavantGenerics */","","const ROWS = /** @type {const} */ (['first', 'second', 'third', 'fourth'])","","/**"," * @param {CharacterPF2e} actor"," * @param {MagicTradition} tradition"," */","function getSpellcastingTraditionDetails(actor, tradition) {","    let maxSlot = 1","    let maxTradition = 0","","    for (const entry of actor.spellcasting.regular) {","        if ('pf2e-staves' in entry.flags) continue // we skip staff entries","","        const slots = entry.system.slots","        for (const key in slots) {","            const slot = slots[key]","            if (slot.max) maxSlot = Math.max(maxSlot, Number(key.slice(4)))","        }","","        if (entry.tradition === tradition) maxTradition = Math.max(maxTradition, entry.rank)","    }","","    return { maxSlot: Math.min(maxSlot, 10), maxTradition }","}","","/** @type {Daily<SavantGenerics>} */","const scrollSavant = {","    key: 'savant',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ', // Scroll Savant","    },","    prepare: ({ actor }) => {","        const { maxSlot, maxTradition } = getSpellcastingTraditionDetails(actor, 'arcane')","        return {","            first: { level: maxSlot - 2, condition: true },","            second: { level: maxSlot - 3, condition: true },","            third: { level: maxSlot - 4, condition: maxTradition >= 3 && maxSlot >= 5 },","            fourth: { level: maxSlot - 5, condition: maxTradition >= 4 && maxSlot >= 6 },","        }","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowDrop<SavantGenerics>} */","        const row = {","            type: 'drop',","            slug: rowName,","            label: ({ custom }) => `PF2E.SpellLevel${custom[rowName].level}`,","            filter: {","                type: 'spell',","                search: ({ custom }) => ({","                    category: ['spell'],","                    traditions: ['arcane'],","                    level: custom[rowName].level,","                }),","            },","            condition: ({ custom }) => custom[rowName].condition,","        }","        return row","    }),","    process: async ({ utils, fields, custom, addItem, messages }) => {","        for (const field of Object.values(fields)) {","            const uuid = field.uuid","            const source = await utils.createSpellScrollSource({ uuid, level: custom[field.row].level })","            addItem(source)","            messages.add('scrolls', { uuid, label: source.name })","        }","    },","}","","return scrollSavant"].join("\n"),O=["/** @typedef {'alert' | 'smith' | 'mental' | 'runic' | 'advanced'} MindRow */","/** @typedef {'weapon' | 'mental' | 'runic' | 'advanced'} MindChild */","/** @typedef {[MindRow, {}, MindChild]} MindGenerics */","","const MIND_WEAPON_UUID = 'Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P'","","const WEAPON_BASE_TYPES = {","    0: { die: 'd4', traits: ['finesse', 'agile'], usage: 'held-in-one-hand' },","    1: { die: 'd6', traits: ['finesse'], usage: 'held-in-one-hand' },","    2: { die: 'd8', traits: [], usage: 'held-in-one-hand' },","    3: { die: 'd10', traits: ['reach'], usage: 'held-in-two-hands' },","}","","const WEAPON_GROUPS = /** @type {Record<WeaponDamage, string>} */ {","    slashing: 'sword',","    piercing: 'spear',","    bludgeoning: 'club',","}","","const WEAPON_TRAITS = ['grapple', 'nonlethal', 'shove', 'trip', 'modular']","","const WEAPON_DAMAGE_TYPES = Object.keys(WEAPON_GROUPS)","","const WEAPON_RUNES = ['corrosive', 'disrupting', 'flaming', 'frost', 'shock', 'thundering']","","const WEAPON_GREATER_RUNES = [","    'anarchic',","    'axiomatic',","    'greaterCorrosive',","    'greaterDisrupting',","    'greaterFlaming',","    'greaterFrost',","    'greaterShock',","    'greaterThundering',","    'holy',","    'unholy',","]","","/** @type {Daily<MindGenerics>} */","const mindSmith = {","    key: 'mindsmith',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY', // Mind Smith Dedication","    },","    children: [","        {","            slug: 'weapon',","            uuid: MIND_WEAPON_UUID, // Mind Weapon","        },","        {","            slug: 'mental',","            uuid: 'Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky', // Malleable Mental Forge","        },","        {","            slug: 'runic',","            uuid: 'Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp', // Runic Mind Smithing","        },","        {","            slug: 'advanced',","            uuid: 'Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD', // Advanced Runic Mind Smithing","        },","    ],","    rows: [","        {","            type: 'alert',","            slug: 'alert',","            message: 'Missing Mind Weapon',","            fix,","            childPredicate: [{ not: 'weapon' }],","        },","        {","            type: 'select',","            slug: 'smith',","            label: 'Mind Smith',","            options: WEAPON_DAMAGE_TYPES,","            labelizer: ({ utils }) => utils.damageLabel,","            childPredicate: ['weapon'],","        },","        {","            type: 'select',","            slug: 'mental',","            label: 'Mental Forge',","            options: WEAPON_TRAITS,","            labelizer: ({ utils }) => utils.weaponTraitLabel,","            childPredicate: ['weapon', 'mental'],","        },","        {","            type: 'select',","            slug: 'runic',","            label: 'Runic Smithing',","            options: WEAPON_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'runic', { not: 'advanced' }],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","        {","            type: 'select',","            slug: 'advanced',","            label: 'Runic Smithing',","            options: WEAPON_GREATER_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'advanced'],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","    ],","    process: ({ children, updateItem, fields, messages, item, utils }) => {","        const weapon = children.weapon","        if (!weapon) return","","        messages.addGroup('mindsmith')","","        const selected = /** @type {WeaponDamage} */ fields.smith.value","        updateItem({ _id: weapon.id, 'system.damage.damageType': selected, 'system.group': WEAPON_GROUPS[selected] })","        messages.add('mindsmith', { selected: utils.damageLabel(selected), uuid: item.uuid, label: 'mindsmith' })","","        if (children.mental) {","            const selected = fields.mental.value","            const traits = deepClone(weapon._source.system.traits?.value ?? [])","            if (!traits.includes(selected)) traits.push(selected)","            updateItem({ _id: weapon.id, 'system.traits.value': traits })","            messages.add('mindsmith', {","                selected: utils.weaponTraitLabel(selected),","                uuid: children.mental.uuid,","                label: 'mentalforge',","            })","        }","","        if ((children.advanced || children.runic) && utils.hasFreePropertySlot(weapon)) {","            const child = children.advanced ?? children.runic","            const freeSlot = utils.getFreePropertyRuneSlot(weapon)","            const field = fields.advanced ?? fields.runic","            const selected = field.value","","            if (!weapon.system.runes.property.includes(selected)) {","                updateItem({ _id: weapon.id, [`system.${freeSlot}.value`]: selected, [`flags.world.runeSlot`]: freeSlot })","                messages.add('mindsmith', {","                    selected: utils.weaponPropertyRunesLabel(selected),","                    uuid: child.uuid,","                    label: 'runicmind',","                })","            }","        }","    },","    rest: ({ item, sourceId, updateItem }) => {","        if (sourceId !== MIND_WEAPON_UUID) return","","        let traits = item._source.system.traits?.value ?? []","        traits = traits.filter(trait => !WEAPON_TRAITS.includes(trait))","        updateItem({ _id: item.id, 'system.traits.value': traits })","","        const runeSlot = item.getFlag('world', 'runeSlot')","        if (runeSlot) {","            updateItem({ _id: item.id, [`system.${runeSlot}.value`]: null, [`flags.world.-=runeSlot`]: true })","        }","    },","}","","const OPTIONS = {","    0: 'A one-handed weapon that deals <strong>1d4</strong> damage and has the <strong>agile</strong> and <strong>finesse</strong> traits',","    1: 'A one-handed weapon that deals <strong>1d6</strong> damage and has the <strong>finesse</strong> trait',","    2: 'A one-handed weapon that deals <strong>1d8</strong> damage',","    3: 'A two-handed weapon that deals <strong>1d10</strong> damage and has the <strong>reach</strong> trait',","}","","/** * @param {DailyValueArgs<MindGenerics>} args */","async function fix({ actor }) {","    let content =","        `<p>This character doesn't have a mind weapon in their inventory.</p><p>Please select one of the following options to create one.</p>`","","    for (const [key, label] of Object.entries(OPTIONS)) {","        content += `<label><input type='radio' name='type' value='${key}'>${label}</label>`","    }","","    const weapon = await Dialog.wait(","        {","            title: 'Mind Weapon',","            content,","            buttons: {","                yes: {","                    icon: `<i class='fas fa-save'></i>`,","                    label: 'Accept',","                    callback: onWeaponSelected,","                },","                no: {","                    icon: `<i class='fas fa-times'></i>`,","                    label: 'Cancel',","                    callback: () => null,","                },","            },","            close: () => null,","        },","        {},","        { id: 'pf2e-dailies-weapon', width: 600 }","    )","","    if (weapon) {","        await actor.createEmbeddedDocuments('Item', [weapon])","        return true","    }","","    return false","}","","/** @params {JQuery} html */","async function onWeaponSelected(html) {","    const selection = html.find('[name=type]:checked').val()","    if (!selection) {","        ui.notifications.warn('You must select one weapon base type.')","        return","    }","","    const weapon = (await fromUuid(MIND_WEAPON_UUID))?.toObject()","    if (!weapon) {","        ui.notifications.warn(`The weapon couldn't be found in the compendium.`)","        return","    }","","    const stats = WEAPON_BASE_TYPES[selection]","","    setProperty(weapon, 'system.damage.die', stats.die)","    setProperty(weapon, 'system.traits.value', stats.traits.slice())","    setProperty(weapon, 'system.usage.value', stats.usage)","","    return weapon","}","","return mindSmith"].join("\n"),P=y("customs"),D=["default","trainedSkill","trainedLore","language","resistance","feat","spell"],A=["flexibility","savant","tome","mind"];class DailyCustoms extends FormApplication{_selectedTemplate="default";_selectedDaily="";_monaco=null;constructor(){super()}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"pf2e-dailies-customs",title:P("title"),template:h("customs.hbs"),submitOnChange:!1,submitOnClose:!1,closeOnSubmit:!1,scrollY:[".left .list"]})}async _updateObject(e,t){}async getData(e){const t=b("customDailies"),i=t.find((e=>e.key===this._selectedDaily))?.code,s=this._selectedTemplate,a=k("pf2e-dailies-ext"),n=a?.active&&isNewerVersion(ot,a.version)?{version:ot}:"";return mergeObject(super.getData(e),{i18n:P,template:s,templates:D,daily:this._selectedDaily,code:i,customs:t,examples:A,isExample:A.includes(s),monaco:a?.active,newVersion:n})}activateListeners(e){super.activateListeners(e),this._monaco?.dispose();const t=k("pf2e-dailies-ext")?.api,i=e.find(".code")[0];if(t&&i){const s=e.find(".monaco .placeholder")[0];this._monaco=t.createEditor(s,i.value),this._monaco.onDidChangeModelContent(debounce((()=>i.value=this._monaco.getValue()),200))}else this._monaco=null;e.find("[data-action=select-template]").on("change",this.#e.bind(this)),e.find("[data-action=create-template]").on("click",this.#t.bind(this)),e.find("[data-action=create-daily]").on("click",this.#i.bind(this)),e.find(".row[data-key]").on("click",this.#s.bind(this)),e.find("[data-action=delete-daily]").on("click",this.#a.bind(this)),e.find("[data-action=save-code]").on("click",this.#n.bind(this))}get code(){return this.form.querySelector(".window-content .code")?.value}async#n(e){e.preventDefault();const t=this.code,i=this._selectedDaily;if(!i||!t)return;const s=b("customDailies"),a=s.filter((e=>e.key!==i));try{const e=new S(t),n=(await e()).key;if("string"!=typeof n)return u("invalidKey");if(a.find((e=>e.key===n)))return u("duplicate");const r=s.findIndex((e=>e.key===i));if(r<0)return;s.splice(r,1,{key:n,code:t}),await v("customDailies",s),P.info("saved",{daily:n}),this._selectedDaily=n,this.render()}catch(e){d("error.unexpected"),console.error(e),console.error(`The error occured while testing the custom daily ${i}`)}}async#a(e){if(e.preventDefault(),e.stopPropagation(),!await Dialog.confirm({title:P("delete.title"),content:P("delete.content")}))return;const t=e.currentTarget.dataset.key,i=b("customDailies").filter((e=>e.key!==t));await v("customDailies",i),P.info("deleted",{daily:t}),this.#i()}#i(){this._selectedDaily="",this._selectedTemplate="default",this.render()}#s(e){e.preventDefault(),this._selectedDaily=e.currentTarget.dataset.key,this.render()}async#t(e){e.preventDefault();const o=this._selectedTemplate,l=b("customDailies"),c=new FormData(this.form),d=Object.fromEntries(c),m=A.includes(o);let p,{key:f,uuid:y,label:g}=d;if(m)f=o;else if(!f||!y)return P.warn("template.noEmpty");if(l.find((e=>e.key===f)))return u("error.duplicate");if("trainedSkill"===o){const e=a(f,y,g);p=this.#r(e,{key:f,uuid:y,label:g},"SkillGenerics")}else if("trainedLore"===o){const e=n(f,y,g);p=this.#r(e,{key:f,uuid:y,label:g},"SkillGenerics")}else if("language"===o){const e=i(f,y,g);p=this.#r(e,{key:f,uuid:y,label:g},"LanguageGenerics")}else if("resistance"===o){const e=E(d.resistance),t=T(d.resistances);if(""===e||!t.length)return P.warn("template.noEmpty");if("number"==typeof e&&e<1)return P.warn("template.badResistance");const i=s(f,y,t,e,g);p=this.#r(i,{key:f,uuid:y,label:g,resistance:e,resistances:t},"ResistanceGenerics")}else if("feat"===o){const e=T(d.traits),i={category:T(d.category),level:E(d.level)||{min:0,max:20}};e.length&&(i.traits=e);const s=t(f,y,i,g);p=this.#r(s,{key:f,uuid:y,label:g},"FeatGenerics")}else if("spell"===o){const e=Number(d.level)||void 0,t=T(d.traits);let i=d.levels.split(",").map((e=>e.trim()));i=1===i.length?E(i[0]):i.filter((e=>e)).map((e=>Number(e))).filter((e=>!isNaN(e)));const s={category:T(d.category),traditions:T(d.traditions),level:i||[]};t.length&&(s.traits=t);const a=r(f,y,s,e,g);p=this.#r(a,{key:f,uuid:y,label:g,level:e},"SpellGenerics")}else if("tome"===o)p=C;else if("flexibility"===o)p=x;else if("savant"===o)p=I;else if("mind"===o)p=O;else{const e={key:f,label:g,item:{uuid:y},rows:[],process:()=>{}};p=this.#r(e,{key:f,uuid:y,label:g})}l.push({key:f,code:p}),await v("customDailies",l),this._selectedDaily=f,this.render()}#r(e,t,i){const s="____PLACEHOLDER____",a=[];let n=JSON.stringify(e,((e,t)=>"function"==typeof t?(a.push(t),s):t),4);n=n.replace(new RegExp('"'+s+'"',"g"),(()=>{const e=a.shift()?.toString();return e?.replace(/( {5,})/g,(e=>e.slice(4)))??""}));let r="";for(const[e,i]of Object.entries(t))r+="string"==typeof i?`const ${e} = '${i}';\n`:"object"==typeof i?`const ${e} = ${JSON.stringify(i)};\n`:`const ${e} = ${i};\n`;return`${r}\n/** @type {${i?`Daily<${i}>`:"Daily"}} */\nconst daily = ${n};\n\nreturn daily;`}#e(e){e.preventDefault(),this._selectedDaily="",this._selectedTemplate=e.currentTarget.value,this.render()}}function T(e){return e.split(",").map((e=>e.trim())).filter((e=>e))}function E(e){if("number"==typeof e)return e;if("level"===(e=e.trim())||"half"===e)return e;const t=Number(e);return isNaN(t)?"":t}function R(){return game.packs.get("pf2e.familiar-abilities")}function _(e,t,i){return e.getFlag(o,t)??i}function F(e){return e.getFlag("core","sourceId")}const N="Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB";function L(e){return function(e,t,i){return function(e,t){return t?t.flatMap((t=>e.itemTypes[t])):e.items}(e,void 0).find(function(e){return Array.isArray(e)?t=>function(e,t){const i=F(e);return!!i&&t.includes(i)}(t,e):t=>F(t)===e}(t))}(e,N)}const j=(()=>{const e=r("ace","Compendium.pf2e.feats-srd.Item.POrE3ZgBRdBL9MsW",{category:["cantrip","spell"],level:4},4);return e.rows[0].filter.drop=e=>{const t=e.system.time.value;return!(t.includes("hour")||t.includes("min")&&parseInt(t)>10)||{error:f("interface.error.drop.wrongSpellTime"),data:{time:"10 min"}}},e})(),M=["first","second","third","fourth","fifth","sixth","seventh"];function G(e,t,i){const s={key:e,label:i,item:{uuid:t[0]},children:[{slug:"expert",uuid:t[1]},{slug:"master",uuid:t[2]}],rows:[W("first",1),W("second",2,8),W("third",3,void 0,"expert"),W("fourth",4,14,"expert"),W("fifth",5,16,"expert"),W("sixth",6,void 0,"master"),W("seventh",7,20,"master")],process:async({utils:e,fields:t,addItem:i,messages:s})=>{for(const a of Object.values(t)){const t=a.uuid,n=M.indexOf(a.row)+1,r=await e.createSpellScrollSource({uuid:t,level:n});i(r),s.add("scrolls",{uuid:t,label:r.name})}}};return s}function W(e,t,i,s){const a={type:"drop",slug:e,label:`PF2E.SpellLevel${t}`,filter:{type:"spell",search:{category:["spell"],level:t}}};return i&&(a.condition=({actor:e})=>e.level>=i),s&&(a.childPredicate=[s]),a}const z={key:"flexibility",item:{uuid:"Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8"},children:[{slug:"improved",uuid:"Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX"}],rows:[U("flexibility",8),U("improved",14,"improved")],process:async({utils:e,fields:t,addFeat:i,messages:s,children:a})=>{const n=t.flexibility.uuid;if(i(await e.createFeatSource(n)),s.add("feats",{uuid:n}),a.improved){const n=t.improved.uuid;i(await e.createFeatSource(n),a.improved),s.add("feats",{uuid:n})}}};function U(e,t,i){const s={type:"drop",label:`PF2E.Level${t}`,slug:e,filter:{type:"feat",search:{category:["class"],traits:["fighter"],level:t}}};return i&&(s.childPredicate=[i]),s}const q="Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P",B={0:{die:"d4",traits:["finesse","agile"],usage:"held-in-one-hand"},1:{die:"d6",traits:["finesse"],usage:"held-in-one-hand"},2:{die:"d8",traits:[],usage:"held-in-one-hand"},3:{die:"d10",traits:["reach"],usage:"held-in-two-hands"}},V={slashing:"sword",piercing:"spear",bludgeoning:"club"},H=["grapple","nonlethal","shove","trip","modular"],J=Object.keys(V),Y={key:"mindsmith",item:{uuid:"Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY"},children:[{slug:"weapon",uuid:q},{slug:"mental",uuid:"Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky"},{slug:"runic",uuid:"Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp"},{slug:"advanced",uuid:"Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD"}],rows:[{type:"alert",slug:"alert",message:()=>m("interface.alert.weapon"),fix:async function({actor:e}){const t=y("dialog.weapon");let i=t("flavor");for(const e of["0","1","2","3"])i+=`<label><input type="radio" name="type" value="${e}">${t(`option.${e}`)}</label>`;const s=await Dialog.wait({title:t("title"),content:i,buttons:{yes:{icon:'<i class="fas fa-save"></i>',label:t("accept"),callback:Z},no:{icon:'<i class="fas fa-times"></i>',label:t("cancel"),callback:()=>null}},close:()=>null},{},{id:"pf2e-dailies-weapon",width:600});return!!s&&(await e.createEmbeddedDocuments("Item",[s]),!0)},childPredicate:[{not:"weapon"}]},{type:"select",slug:"smith",label:()=>m("label.mindsmith"),options:J,labelizer:({utils:e})=>e.damageLabel,childPredicate:["weapon"]},{type:"select",slug:"mental",label:()=>m("label.mentalforge"),options:H,labelizer:({utils:e})=>e.weaponTraitLabel,childPredicate:["weapon","mental"]},{type:"select",slug:"runic",label:()=>m("label.runicmind"),options:["corrosive","disrupting","flaming","frost","shock","thundering"],labelizer:({utils:e})=>e.weaponPropertyRunesLabel,childPredicate:["weapon","runic",{not:"advanced"}],condition:({children:e,utils:t})=>t.hasFreePropertySlot(e.weapon)},{type:"select",slug:"advanced",label:()=>m("label.runicmind"),options:["anarchic","axiomatic","greaterCorrosive","greaterDisrupting","greaterFlaming","greaterFrost","greaterShock","greaterThundering","holy","unholy"],labelizer:({utils:e})=>e.weaponPropertyRunesLabel,childPredicate:["weapon","advanced"],condition:({children:e,utils:t})=>t.hasFreePropertySlot(e.weapon)}],process:({children:e,updateItem:t,fields:i,messages:s,item:a,utils:n})=>{const r=e.weapon;if(!r)return;s.addGroup("mindsmith");const o=i.smith.value;if(t({_id:r.id,"system.damage.damageType":o,"system.group":V[o]}),s.add("mindsmith",{selected:n.damageLabel(o),uuid:a.uuid,label:"mindsmith"}),e.mental){const a=i.mental.value,o=deepClone(r._source.system.traits?.value??[]);o.includes(a)||o.push(a),t({_id:r.id,"system.traits.value":o}),s.add("mindsmith",{selected:n.weaponTraitLabel(a),uuid:e.mental.uuid,label:"mentalforge"})}if((e.advanced||e.runic)&&n.hasFreePropertySlot(r)){const a=e.advanced??e.runic,o=n.getFreePropertyRuneSlot(r),l=(i.advanced??i.runic).value;o&&!r.system.runes.property.includes(l)&&(t({_id:r.id,[`system.${o}.value`]:l,[`flags.${rt}.runeSlot`]:o}),s.add("mindsmith",{selected:n.weaponPropertyRunesLabel(l),uuid:a.uuid,label:"runicmind"}))}},rest:({item:e,sourceId:t,updateItem:i})=>{if(t!==q)return;let s=e._source.system.traits?.value??[];s=s.filter((e=>!H.includes(e))),i({_id:e.id,"system.traits.value":s});const a=_(e,"runeSlot");a&&i({_id:e.id,[`system.${a}.value`]:null,[`flags.${rt}.-=runeSlot`]:!0})}};async function Z(e){const t=y("dialog.weapon"),i=e.find("[name=type]:checked").val();if(!i)return void t.warn("error.noSelection");const s=(await fromUuid(q))?.toObject();if(!s)return void t.warn("error.missing");const a=B[i];return setProperty(s,"system.damage.die",a.die),setProperty(s,"system.traits.value",a.traits.slice()),setProperty(s,"system.usage.value",a.usage),s}const Q={key:"savant",item:{uuid:"Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ"},prepare:({actor:e})=>{const{maxSlot:t,maxTradition:i}=function(e,t){let i=1,s=0;for(const t of e.spellcasting.regular){if(t.flags&&"pf2e-staves"in t.flags)continue;const e=t.system.slots;for(const t in e)e[t].max&&(i=Math.max(i,Number(t.slice(4))));"arcane"===t.tradition&&(s=Math.max(s,t.rank))}return{maxSlot:Math.min(i,10),maxTradition:s}}(e);return{first:{level:t-2,condition:!0},second:{level:t-3,condition:!0},third:{level:t-4,condition:i>=3&&t>=5},fourth:{level:t-5,condition:i>=4&&t>=6}}},rows:["first","second","third","fourth"].map((e=>({type:"drop",slug:e,label:({custom:t})=>`PF2E.SpellLevel${t[e].level}`,filter:{type:"spell",search:({custom:t})=>({category:["spell"],traditions:["arcane"],level:t[e].level})},condition:({custom:t})=>t[e].condition}))),process:async({utils:e,fields:t,custom:i,addItem:s,messages:a})=>{for(const n of Object.values(t)){const t=n.uuid,r=await e.createSpellScrollSource({uuid:t,level:i[n.row].level});s(r),a.add("scrolls",{uuid:t,label:r.name})}}},X={key:"tome",item:{uuid:"Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e"},children:[{slug:"adept",uuid:"Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO",condition:K("adept")},{slug:"second",uuid:"Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5",condition:K("adept")},{slug:"intense",uuid:"Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC"},{slug:"paragon",uuid:"Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI",condition:K("paragon")}],prepare:({utils:e,actor:t,children:i})=>{const s=e.skillNames,a=t.level,n=t.skills,r={first:{options:[],rank:1},second:{options:[],rank:1}};if(i.paragon){const e=s.filter((e=>n[e].rank<4));r.first={rank:4,options:e},r.second={rank:4,options:e}}else if(i.intense||i.adept||i.second){const e=s.filter((e=>n[e].rank<3));if(a>=9)r.first={rank:3,options:e},r.second={rank:3,options:e};else{const t=s.filter((e=>n[e].rank<2));r.first={rank:2,options:t},r.second={rank:3,options:e}}}else if(a>=5){const e=s.filter((e=>n[e].rank<2));r.first={rank:2,options:e},r.second={rank:2,options:e}}else if(a>=3){const e=s.filter((e=>n[e].rank<1)),t=s.filter((e=>n[e].rank<2));r.first={rank:1,options:e},r.second={rank:2,options:t}}else{const e=s.filter((e=>n[e].rank<1));r.first={rank:1,options:e},r.second={rank:1,options:e}}return r},rows:["first","second"].map((e=>{const t={type:"combo",slug:e,label:({custom:t,utils:i})=>i.proficiencyLabel(t[e].rank),options:({custom:t})=>t[e].options,labelizer:({utils:e})=>e.skillLabel};return t})),process:({custom:e,fields:t,utils:i,messages:s,addItem:a,addRule:n})=>{s.addGroup("tome",65);for(const r of["first","second"]){const o=e[r].rank;let l=t[r].value;if("true"===t[r].input)a(i.createLoreSource({name:l,rank:o}));else{const e=i.createSkillRuleElement({skill:l,value:o});l=i.skillLabel(l),n(e)}s.add("tome",{label:i.proficiencyLabel(o),selected:l})}}};function K(e){return function({item:t,utils:i}){return"tome"===i.getChoiSetRuleSelection(t,e)}}const ee=ie([X,a("longevity","Compendium.pf2e.feats-srd.Item.WoLh16gyDp8y9WOZ"),a("ageless","Compendium.pf2e.feats-srd.Item.wylnETwIz32Au46y"),a("memories","Compendium.pf2e.feats-srd.Item.ptEOt3lqjxUnAW62"),a("studies","Compendium.pf2e.feats-srd.Item.9bgl6qYWKHzqWZj0"),n("study","Compendium.pf2e.feats-srd.Item.aLJsBBZzlUK3G8MW"),i("linguistics","Compendium.pf2e.feats-srd.Item.eCWQU16hRLfN1KaX"),i("borts","Compendium.pf2e.equipment-srd.Item.iS7hAQMAaThHYE8g"),s("elementalist","Compendium.pf2e.feats-srd.Item.tx9pkrpmtqe4FnvS",["air","earth","fire","water"],"half","elementalist"),s("ganzi","Compendium.pf2e.heritages.Item.3reGfXH0S82hM7Gp",["acid","electricity","sonic"],"half","ganzi",!0),t("metamagical","Compendium.pf2e.classfeatures.Item.89zWKD2CN7nRu2xp",{category:["class"],traits:{selected:["metamagic","wizard"],conjunction:"and"},level:"half"}),z,Q,G("esoterica",["Compendium.pf2e.feats-srd.Item.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.Item.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.Item.LHjPTV5vP3MOsPPJ"]),G("trickster",["Compendium.pf2e.feats-srd.Item.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.Item.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.Item.lIg5Gzz7W70jfbk1"]),j,Y],"dailies"),te=new Map;function ie(e,t){const i=new Map;for(const s of e){const e=deepClone(s);try{const s=`${t}.${e.key}`;if(i.set(e.item.uuid,{daily:e,condition:e.item.condition}),e.key=s,e.children)for(let t=0;t<e.children.length;t++){const{uuid:s,condition:a}=e.children[t];i.set(s,{daily:e,index:t,condition:a})}}catch(i){d("error.unexpected"),console.error(i),console.error(`The error occured during data gathering of ${t}.${e.key}`)}}return i}async function se(){te.clear();const e=[],t=b("customDailies");for(const{key:i,code:s}of t)try{const t=new S(s),i=await t();e.push(i)}catch(e){d("error.unexpected"),console.error(e),console.error(`The error occured during call of custom function for ${i}`)}for(const[e,t]of ee.entries())te.set(e,t);const i=ie(e,"custom");for(const[e,t]of i.entries())te.set(e,t)}function ae(e){const t={};for(const i of e.items){const s=F(i);if(!s||i.isOfType("physical")&&!1===i.isInvested)continue;const a=te.get(s);if(!a)continue;const{daily:n,index:r,condition:o}=a;try{if("function"==typeof o&&!o({actor:e,item:i,utils:st}))continue;t[n.key]??=deepClone(n),void 0===r?t[n.key].item=i:t[n.key].children[r].item=i}catch(e){d("error.unexpected"),console.error(e),console.error(`The error occured during data gathering of ${n.key}`)}}return Object.values(t).filter((e=>e.item&&e.item instanceof Item))}function ne(e){return te.get(e)?.daily}function re(e){return e.familiar||L(e)?.uses.value||ae(e).length}function oe(e){return"object"==typeof e&&null!==e}class PredicatePF2e extends Array{isValid;constructor(...e){Array.isArray(e[0])?super(...e[0]):super(...e),this.isValid=PredicatePF2e.isValid(this)}static isValid(e){return this.isArray(e)}static isArray(e){return super.isArray(e)&&e.every((e=>StatementValidator.isStatement(e)))}static test(e=[],t){return e instanceof PredicatePF2e?e.test(t):new PredicatePF2e(...e).test(t)}static create(e,t=!1){return e instanceof PredicatePF2e?e.clone():Array.isArray(e)?new PredicatePF2e(e):oe(e)?(t&&foundry.utils.logCompatibilityWarning("Predicate data must be an array",{mode:CONST.COMPATIBILITY_MODES.WARNING,since:"4.2.0",until:"4.5.0"}),new PredicatePF2e(function(e){const t=Object.keys(e);return 0===t.length?[]:1===t.length&&Array.isArray(e.all)?deepClone(e.all):1===t.length&&Array.isArray(e.any)&&1===e.any.length?deepClone(e.any):deepClone([e.all??[],Array.isArray(e.any)?{or:e.any}:[],Array.isArray(e.not)?1===e.not.length?{not:e.not[0]}:{nor:e.not}:[]].flat())}(e))):new PredicatePF2e}test(e){if(0===this.length)return!0;if(!this.isValid)return console.error("PF2e System | The provided predicate set is malformed."),!1;const t=e instanceof Set?e:new Set(e);return this.every((e=>this.isTrue(e,t)))}toObject(){return deepClone([...this])}clone(){return new PredicatePF2e(this.toObject())}isTrue(e,t){return"string"==typeof e&&t.has(e)||StatementValidator.isBinaryOp(e)&&this.testBinaryOp(e,t)||StatementValidator.isCompound(e)&&this.testCompound(e,t)}testBinaryOp(e,t){if("eq"in e)return t.has(`${e.eq[0]}:${e.eq[1]}`);{const i=Object.keys(e)[0],[s,a]=Object.values(e)[0],n=Array.from(t),r="number"!=typeof s&&Number.isNaN(Number(s))?n.flatMap((e=>e.startsWith(s)?Number(/:(-?\d+)$/.exec(e)?.[1]):[])):[Number(s)],o="number"!=typeof a&&Number.isNaN(Number(a))?n.flatMap((e=>e.startsWith(a)?Number(/:(-?\d+)$/.exec(e)?.[1]):[])):[Number(a)];switch(i){case"gt":return r.some((e=>o.every((t=>e>t))));case"gte":return r.some((e=>o.every((t=>e>=t))));case"lt":return r.some((e=>o.every((t=>e<t))));case"lte":return r.some((e=>o.every((t=>e<=t))));default:return console.warn("PF2e System | Malformed binary operation encounter"),!1}}}testCompound(e,t){return"and"in e&&e.and.every((e=>this.isTrue(e,t)))||"nand"in e&&!e.nand.every((e=>this.isTrue(e,t)))||"or"in e&&e.or.some((e=>this.isTrue(e,t)))||"nor"in e&&!e.nor.some((e=>this.isTrue(e,t)))||"not"in e&&!this.isTrue(e.not,t)||"if"in e&&!(this.isTrue(e.if,t)&&!this.isTrue(e.then,t))}}class StatementValidator{static isStatement(e){return e instanceof Object?this.isCompound(e)||this.isBinaryOp(e):"string"==typeof e&&this.isAtomic(e)}static isAtomic(e){return"string"==typeof e&&e.length>0||this.isBinaryOp(e)}static binaryOperators=new Set(["eq","gt","gte","lt","lte"]);static isBinaryOp(e){if(!oe(e))return!1;const t=Object.entries(e);if(t.length>1)return!1;const[i,s]=t[0];return this.binaryOperators.has(i)&&Array.isArray(s)&&2===s.length&&"string"==typeof s[0]&&["string","number"].includes(typeof s[1])}static isCompound(e){return oe(e)&&(this.isAnd(e)||this.isOr(e)||this.isNand(e)||this.isNor(e)||this.isNot(e)||this.isIf(e))}static isAnd(e){return 1===Object.keys(e).length&&Array.isArray(e.and)&&e.and.every((e=>this.isStatement(e)))}static isNand(e){return 1===Object.keys(e).length&&Array.isArray(e.nand)&&e.nand.every((e=>this.isStatement(e)))}static isOr(e){return 1===Object.keys(e).length&&Array.isArray(e.or)&&e.or.every((e=>this.isStatement(e)))}static isNor(e){return 1===Object.keys(e).length&&Array.isArray(e.nor)&&e.nor.every((e=>this.isStatement(e)))}static isNot(e){return 1===Object.keys(e).length&&!!e.not&&this.isStatement(e.not)}static isIf(e){return 2===Object.keys(e).length&&this.isStatement(e.if)&&this.isStatement(e.then)}}function le(e){return e?e[0].toUpperCase()+e.slice(1):""}const ce={select:100,combo:80,random:60,alert:40,input:20,drop:0};async function ue({children:e=[],key:t,item:i,prepare:s,label:a,rows:n=[]}){const r=this.actor,o=this.saved[t]=_(r,t)??{},l=this.rows[t]={},c=this.children[t]=e.reduce(((e,{slug:t,item:i})=>(e[t]=i,e)),{}),u={actor:r,item:i,children:c,utils:st},d=this.custom[t]=s&&await s(u)||{},f=this.dailyArgs[t]={...u,custom:d};let y=await de(a,f);const g=y?`label.${y}`:t.startsWith("dailies.")?`label.${t.slice(8)}`:void 0;g&&p(g)&&(y=m(g));const h=this.predicate[t]=e.filter((e=>e.item)).map((e=>e.slug)),b={label:y?game.i18n.localize(y):i.name,rows:[]};for(const e of n){l[e.slug]=e;const{type:i,slug:s,childPredicate:a=[],condition:n,label:r,save:c}=e;if(a.length&&!PredicatePF2e.test(a,h))continue;if(n&&!await n(f))continue;const u=!1===c||"random"===i?void 0:o[s],d=await de(r,f),m=void 0===u?"":"object"!=typeof u?u:"name"in u?u.name:u.selected,p={label:d?game.i18n.localize(d):"",value:m,order:ce[i],data:{type:i,daily:t,row:s}};if(me(e)||pe(e)||fe(e)){const t=await de(e.options,f)??[];if("combo"!==i&&!t.length)continue;const s="function"==typeof e.labelizer&&e.labelizer(f)||(e=>le(e));p.options=t.map((e=>"string"==typeof e?{value:e,label:s(e)}:e)),me(e)&&(p.selected=p.value,p.data.input=u?.input??!0,!p.data.input&&t.includes(p.selected)&&(p.value=s(p.selected)))}else ye(e)?p.data.uuid=u?.uuid??"":ge(e)&&(p.value="function"==typeof e.message?await e.message(f):e.message);b.rows.push(p)}return b}async function de(e,t){return"function"==typeof e?await e(t):e}function me(e){return"combo"===e.type}function pe(e){return"select"===e.type}function fe(e){return"random"===e.type}function ye(e){return"drop"===e.type}function ge(e){return"alert"===e.type}const he={acr:"acrobatics",arc:"arcana",ath:"athletics",cra:"crafting",dec:"deception",dip:"diplomacy",itm:"intimidation",med:"medicine",nat:"nature",occ:"occultism",prf:"performance",rel:"religion",soc:"society",ste:"stealth",sur:"survival",thi:"thievery"},be=(Object.keys(he),Object.values(he)),ve=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,we=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,ke=new RegExp(we,"gu"),Se=String.raw`(?:${ve})(?=${we})|(?:${we})(?=${ve})`,Ce=String.raw`(?:${ve})(?=${ve})`,xe=String.raw`\p{Lowercase_Letter}`,Ie=String.raw`\p{Uppercase_Letter}`,Oe=new RegExp(`(${xe})(${Ie}${Ce})`,"gu"),Pe=/[^-\p{White_Space}\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]/gu,De=new RegExp(`${Ie}|(?:${Se})${xe}`,"gu");function Ae(e,{camel:t=null}={}){if("string"!=typeof e)return console.warn("Non-string argument passed to `sluggify`"),"";switch(t){case null:return e.replace(Oe,"$1-$2").toLowerCase().replace(/['’]/g,"").replace(ke," ").trim().replace(/[-\s]+/g,"-");case"bactrian":{const t=Ae(e,{camel:"dromedary"});return t.charAt(0).toUpperCase()+t.slice(1)}case"dromedary":return e.replace(Pe,"").replace(/[-_]+/g," ").replace(De,((e,t)=>0===t?e.toLowerCase():e.toUpperCase())).replace(/\s+/g,"");default:throw Error("PF2e System | I don't think that's a real camel.")}}function Te(e,t){const i=[];if(e<=t)for(let s=e;s<=t;s++)i.push(s);else for(let s=e;s>=t;s--)i.push(s);return i}function Ee(e,t,i){if(void 0===t)return i;if("number"==typeof t)return t;if("level"===t)return e.level;if("half"===t)return Math.max(1,Math.floor(e.level/2));const s=Number(t);return isNaN(s)?i:s}async function Re(e){return{type:e.type,search:await("feat"===e.type?Le(this.actor,e.search):Ne(this.actor,e.search)),drop:e.drop}}function _e(e,t){e?.length&&(t.selected=e,t.isExpanded=!0,e.forEach((e=>t.options[e].selected=!0)))}function $e(e,t){const i=Fe(e);i?.selected.length&&(t.conjunction=i.conjunction,t.selected=i.selected)}function Fe(e){if(!e)return;const t=Array.isArray(e)?e:e.selected;return t?.length?{selected:t.map((e=>"string"==typeof e?{value:e}:e)),conjunction:!Array.isArray(e)&&e.conjunction||"and"}:void 0}async function Ne(e,t){const i=await game.pf2e.compendiumBrowser.tabs.spell.getFilterData();_e(t.category,i.checkboxes.category),_e(t.school,i.checkboxes.school),_e(t.traditions,i.checkboxes.traditions),_e(t.rarity,i.checkboxes.rarity),_e(t.source,i.checkboxes.source),$e(t.traits,i.multiselects.traits);const s=je(e,t.level);return s?.length&&_e(s,i.checkboxes.level),i}async function Le(e,t){const i=await game.pf2e.compendiumBrowser.tabs.feat.getFilterData();_e(t.category,i.checkboxes.category),_e(t.skills,i.checkboxes.skills),_e(t.rarity,i.checkboxes.rarity),_e(t.source,i.checkboxes.source),$e(t.traits,i.multiselects.traits);const s=Me(e,t.level);return s&&(i.sliders.level.values.min=s.min,i.sliders.level.values.max=s.max,i.sliders.level.isExpanded=!0),i}function je(e,t){if(Array.isArray(t))return t;const i=Ee(e,t);return i?Te(1,i):void 0}function Me(e,t){if(void 0!==t)return"object"==typeof t?{min:Ee(e,t.min,0),max:Ee(e,t.min,20)}:{min:0,max:Ee(e,t,20)}}const Ge=y("interface.error.drop");async function We(e,t,i){if(!e.isOfType("feat"))return Ge("notFeat");const{search:s,drop:a}=i;if(s.category?.length&&!s.category.includes(e.category))return Ge.warn("wrongType",{types:Ue("featCategories",s.category)});if(s.traits){const t=Fe(s.traits);if(t?.selected.length){const i="or"===t.conjunction?"some":"every";if(!t.selected[i]((t=>Number(t.not??!1)-Number(e.traits.has(t.value)))))return Ge.warn("wrongTraits")}}if(s.skills?.length){const t=function(){const e=CONFIG.PF2E.skillList;return Object.entries(e).reduce(((e,[t,i])=>({...e,[t]:game.i18n.localize(i).toLocaleLowerCase(game.i18n.lang)})),{})}(),i=e.system.prerequisites.value.map((e=>e.value.toLocaleLowerCase()));if(!s.skills.some((e=>i.some((i=>i.includes(e)||i.includes(t[e]))))))return Ge.warn("wrongSkill",{skills:Ue("skillList",s.skills)})}if(s.rarity?.length&&!s.rarity.includes(e.system.traits.rarity))return Ge.warn("wrongRarity",{rarities:Ue("rarityTraits",s.rarity)});if(s.source?.length&&!s.source.includes(Ae(e.system.source.value)))return Ge.warn("wrongSource",{sources:s.source.join(", ")});const n=Me(this.actor,s.level);if(n){const t=e.level;if(t<n.min)return Ge.warn("wrongLevelLow",{level:`min: ${n.min}`});if(t>n.max)return Ge.warn("wrongLevelHigh",{level:`max: ${n.max}`})}if(a){const i=this.dailyArgs[t.dataset.daily];if(i){const t=await a(e,i);if("object"==typeof t)return t.data?game.i18n.format(t.error,t.data):game.i18n.localize(t.error);if(!1===t)return Ge.warn("wrongCustom")}}qe(e,t)}async function ze(e,t,i){if(!e.isOfType("spell"))return Ge("notSpell");const{search:s,drop:a}=i;if(s.category?.length){const t=s.category.map((e=>game.i18n.localize("cantrip"===e?"PF2E.SpellCantripLabel":CONFIG.PF2E.spellCategories[e]))).join(", ");if(e.isCantrip&&!s.category.includes("cantrip")||e.isFocusSpell&&!s.category.includes("focus")||e.isRitual&&!s.category.includes("ritual")||!e.isCantrip&&!e.isFocusSpell&&!e.isRitual&&!s.category.includes("spell"))return Ge.warn("wrongCategory",{categories:t})}if(s.traits){const t=Fe(s.traits);if(t?.selected.length){const i="or"===t.conjunction?"some":"every";if(!t.selected[i]((t=>Number(t.not??!1)-Number(e.traits.has(t.value)))))return Ge.warn("wrongTraits")}}if(s.traditions?.length&&!s.traditions.some((t=>e.traditions.has(t))))return Ge.warn("wrongTradition",{traditions:Ue("magicTraditions",s.traditions)});const n=je(this.actor,s.level);if(n?.length&&!n.includes(e.level))return Ge.warn("wrongLevel",{levels:n.join(", ")});if(s.school?.length&&!s.school.includes(e.school))return Ge.warn("wrongSchool",{schools:Ue("magicSchools",s.school)});if(s.rarity?.length&&!s.rarity.includes(e.system.traits.rarity))return Ge.warn("wrongRarity",{rarities:Ue("rarityTraits",s.rarity)});if(s.source?.length&&!s.source.includes(Ae(e.system.source.value)))return Ge.warn("wrongSource",{sources:s.source.join(", ")});if(a){const i=this.dailyArgs[t.dataset.daily];if(i){const t=await a(e,i);if("object"==typeof t)return t.data?ui.notifications.warn(game.i18n.format(t.error,t.data)):ui.notifications.warn(game.i18n.localize(t.error));if(!1===t)return Ge.warn("wrongCustom")}}qe(e,t)}function Ue(e,t){return t.map((t=>game.i18n.localize(CONFIG.PF2E[e][t]))).join(", ")}function qe(e,t){t.value=e.name,t.dataset.uuid=e.uuid,t.nextElementSibling.nextElementSibling.classList.remove("disabled")}function Be(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}async function Ve(){const e=this.actor,t=this.dailies,i=He.call(this),s=[],a=new Map,n=[],r={},o=y("message");let l=!1,c="";const u=e=>{const t=e.id,i=a.get(t);if(i)return i;const s=deepClone(e._source.system.rules);for(let e=s.length-1;e>=0;e--)rt in s[e]&&s.splice(e,1);return a.set(t,s),s},f={languages:{order:80,messages:[]},skills:{order:70,messages:[]},resistances:{order:60,messages:[]},feats:{order:50,messages:[]},spells:{order:40,messages:[]},scrolls:{order:30,messages:[]}},g={add:(e,t)=>{f[e]??={order:0,messages:[]},f[e].messages.push(t)},addGroup:(e,t=1,i)=>{f[e]??={label:i,order:t,messages:[]}}};if(e.familiar&&i["dailies.familiar"]){const t=e.familiar,s=R(),a=[],n=t.itemTypes.action.map((e=>e.id));n.length&&t.deleteEmbeddedDocuments("Item",n),g.addGroup("familiar",20);for(const e of Object.values(i["dailies.familiar"])){const t=e.value,i=t.includes("."),n=await(i?fromUuid(t):s.getDocument(t));if(!n||!n.isOfType("action"))continue;const r=n.toObject();r&&(a.push(r),g.add("familiar",{uuid:i?t:(h=t,`Compendium.pf2e.familiar-abilities.Item.${h}`)}))}a.length&&t.createEmbeddedDocuments("Item",a)}var h;if("true"===i["dailies.rations"]?.rations.value){const t=L(e);if(t?.uses.value){const e=t.quantity,{value:i,max:s}=t.uses;i<=1?e<=1?t.delete():n.push({_id:t.id,"system.quantity":Math.max(t.quantity-1,0),"system.charges.value":s}):n.push({_id:t.id,"system.charges.value":Math.max(i-1,0)});const a=(e-1)*s+i,r=a<=1?function(e){return`<span style="background: #DDD;\n    padding: 1px 4px;\n    border: 1px solid var(--color-border-dark-tertiary);\n    border-radius: 2px;\n    white-space: nowrap;\n    word-break: break-all;">${e}</span>`}(t.name):Be(t.uuid);c+=a<=1?o("rations.last",{name:r}):o(a<=3?"rations.almost":"rations.used",{name:r,nb:a-1})}}for(const{item:e,key:a,process:r}of t){if(!i[a])continue;const t=this.dailyArgs[a];try{await r({...t,fields:i[a],messages:g,addItem:e=>s.push(e),updateItem:e=>n.push(e),addRule:(t,i)=>{t[rt]=!0,u(i??e).push(t)},addFeat:(t,i)=>{if(i??=e,i.isOfType("feat")){const e=i.id;setProperty(t,"flags.pf2e.grantedBy",{id:e,onDelete:"cascade"}),setProperty(t,`flags.${rt}.grantedBy`,e)}s.push(t)},addSpell:(e,t)=>{setProperty(e,`flags.${rt}.entry`,{level:t}),s.push(e),l=!0}})}catch(e){d("error.unexpected"),console.error(e),console.error(`The error occured during processing of ${a}`)}}for(const[e,t]of Object.entries(i)){const i=this.rows[e];if(i)for(const{row:s,type:a,input:n,value:o,uuid:l}of Object.values(t)){if("random"===a||!1===i[s]?.save)continue;(r[e]??={})[s]="combo"===a?{input:"true"===n,selected:o}:"drop"===a?{uuid:l,name:o}:o}}for(const[e,t]of a)n.push({_id:e,"system.rules":t});if(l){const t={type:"spellcastingEntry",name:m("spellEntry.name"),system:{prepared:{value:"innate"},showSlotlessLevels:{value:!1},showUnpreparedSpells:{value:!1},proficiency:{value:1,slug:e.classDC?.slug||e.class?.slug||void 0}}};s.push(t)}for(const e of s)!0===getProperty(e,"system.temporary")||setProperty(e,`flags.${rt}.temporary`,!0);if(s.length){const t=await e.createEmbeddedDocuments("Item",s);for(const e of t)if(e.isOfType("feat")){const t=_(e,"grantedBy");if(t){const i=`flags.pf2e.itemGrants.${Ae(e.name,{camel:"dromedary"})}`;n.push({_id:t,[i]:{id:e.id,onDelete:"detach"}})}}else if(e.isOfType("spellcastingEntry")){const i=t.filter((e=>e.isOfType("spell")&&_(e,"entry")));for(const t of i){const{level:i}=_(t,"entry"),s={_id:t.id,"system.location.value":e.id};void 0!==i&&(s["system.location.heightenedLevel"]=i),n.push(s)}}}await e.update({[`flags.${rt}`]:{...expandObject(r),rested:!1}}),n.length&&await e.updateEmbeddedDocuments("Item",n),c=function(e,t){const i=y("message"),s=Object.entries(e).map((([e,t])=>(t.label??=i.has(e)?i(e):i("gained",{type:e}),t)));s.sort(((e,t)=>t.order-e.order));for(const{label:e,messages:i}of s)if(i.length){t&&(t+="<hr />"),e&&(t+=`<p><strong>${e}</strong></p>`);for(let{uuid:e,selected:s,label:a,random:n}of i){const i=`label.${a}`;a=a&&p(i)?m(i):a||"",t+="<p>",t+=e?`${Be(e,a)}`:`<strong>${a}</strong>`,s&&(t+=` <span>${s}</span>`),n&&(t+=' <i class="fa-solid fa-dice-d20"></i>'),t+="</p>"}}return t}(f,c),c=c?`${o("changes")}<hr />${c}`:o("noChanges"),ChatMessage.create({content:c,speaker:ChatMessage.getSpeaker({actor:e})})}function He(){const e=this.element.find(".window-content .content").find("input:not(.alert), select[data-type]").toArray(),t={};for(const i of e){const e={...i.dataset,value:i.value};if("combo"===e.type&&"false"===e.input){const t=i.previousElementSibling;e.value=t.value}t[e.daily]??={},t[e.daily][e.row]=e}return t}const Je=y("interface");class DailiesInterface extends Application{_actor;_randomInterval;_dailies=[];_dailyArgs={};_saved={};_children={};_custom={};_predicate={};_rows={};constructor(e,t){super(t),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"pf2e-dailies-interface",template:h("interface.hbs"),height:"auto",width:400,submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[data-droppable="true"]'}]})}get actor(){return this._actor}get dailies(){return this._dailies}get dailyArgs(){return this._dailyArgs}get saved(){return this._saved}get children(){return this._children}get custom(){return this._custom}get predicate(){return this._predicate}get rows(){return this._rows}async getData(e){const t=[],i=this._actor;if(this._dailies=ae(i),i.familiar){const e="dailies.familiar",s=y("label"),a=i.attributes.familiarAbilities.value,n=R(),r=_(i,e)??{},o={label:s("familiar"),rows:[]},l=n.index.map((({_id:e,name:t})=>({value:e,label:t}))),c=b("familiar").split(",");for(let e of c){e=e.trim();const t=await fromUuid(e);t&&t.isOfType("action")&&l.push({value:e,label:t.name})}l.sort(((e,t)=>e.label<t.label?-1:t.label<e.label?1:0));for(let t=0;t<a;t++)o.rows.push({label:s("ability",{nb:t+1}),value:r[`${t}`]??"",order:100,options:l,data:{type:"select",daily:e,row:t.toString()}});o.rows.length&&(this._rows[e]=o.rows.reduce(((e,{data:t})=>(e[t.row]={save:!0},e)),{}),t.push(o))}const s=L(i);if(s?.uses.value){const e="dailies.rations",i="rations",{value:a,max:n}=s.uses,r=(s.quantity-1)*n+a,o=r<=1,l=[{value:"false",label:Je("rations.no")},{value:"true",label:o?Je("rations.last"):Je("rations.yes",{nb:r})}];t.push({label:s.name,rows:[{label:"",order:200,value:"false",options:l,data:{type:"select",daily:e,row:i}}]}),this._rows[e]={[i]:{save:!1}}}for(const e of this._dailies)try{const i=await ue.call(this,e);t.push(i)}catch(t){Je.error("error.unexpected"),console.error(t),console.error(`The error occured during templating of ${e.key}`)}const a=[],n=[];for(const e of t)e.rows.length>1?n.push(e):e.rows.length&&a.push(e);return a.sort(((e,t)=>t.rows[0].order-e.rows[0].order)),n.sort(((e,t)=>e.rows.length-t.rows.length)),mergeObject(super.getData(e),{i18n:Je,dump:({value:e,placeholder:t,data:i})=>{let s="";return e&&(s+=` value="${e}"`),t&&(s+=` placeholder="${t}"`),Object.entries(i).forEach((([e,t])=>s+=` data-${e}="${t}"`)),s&&(s+=" "),s},rows:a,groups:n})}render(e,t){return this._randomInterval&&clearInterval(this._randomInterval),this.element.find("select.random")&&(this._randomInterval=setInterval((()=>{this.element.find("select.random").each(((e,t)=>{t.selectedIndex=(t.selectedIndex+1)%t.options.length}))}),2e3)),super.render(e,t)}close(e){return this._randomInterval&&clearInterval(this._randomInterval),super.close(e)}activateListeners(e){super.activateListeners(e),e.find("[data-action=clear]").on("click",this.#o.bind(this)),e.find("[data-action=accept]").on("click",this.#l.bind(this)),e.find("[data-action=cancel]").on("click",this.#c.bind(this)),e.find(".combo select").on("change",this.#u.bind(this)),e.find(".combo input").on("change",this.#d.bind(this)),e.find("[data-action=search]").on("click",this.#m.bind(this)),e.find("[data-action=alert]").on("click",this.#p.bind(this))}_canDragDrop(e){return!0}async _onDrop(e){const t=y("interface.error.drop");let i=e.target;i instanceof HTMLLabelElement&&(i=i.nextElementSibling);try{const s=e.dataTransfer?.getData("text/plain"),a=JSON.parse(s);if(!a||"Item"!==a.type||"string"!=typeof a.uuid)return t.warn("wrongDataType");const n=await fromUuid(a.uuid);if(!n)return t.warn("wrongDataType");const r=await this.#f(i);if(!r)return qe(n,i);"feat"===r.type?We.call(this,n,i,r):"spell"===r.type?ze.call(this,n,i,r):qe(n,i)}catch(e){t.error("error.unexpected"),console.error(e),console.error("The error occured during _onDrop")}}async#p(e){e.preventDefault(),this.#y();const t=e.currentTarget.dataset,i=this.rows[t.daily][t.row],s=this.dailyArgs[t.daily];let a;try{a=await i.fix(s)}catch(e){Je.error("error.unexpected"),console.error(e),console.error(`The error occured during an alert fix of '${t.daily}'`)}this.#g(),a&&this.render()}async#m(e){e.preventDefault();const t=await this.#f(e.currentTarget,!0);t?game.pf2e.compendiumBrowser.openTab(t.type,t.search):game.pf2e.compendiumBrowser.render(!0)}async#f(e,t){const{daily:i,row:s}=e.dataset,a=this.rows[i]?.[s]?.filter,n=this.dailyArgs[i];if(n&&a)return"function"==typeof a.search&&(a.search=await a.search(n)),t?Re.call(this,a):a}#u(e){const t=e.currentTarget,i=t.nextElementSibling;i.dataset.input="false",i.value=t.options[t.selectedIndex].text}#d(e){const t=e.currentTarget,i=t.previousElementSibling,s=t.value.toLowerCase(),a=Array.from(i.options).map((e=>e.value)).indexOf(s);-1!==a?(i.value=s,t.value=i.options[a].text,t.dataset.input="false"):(i.value="",t.dataset.input="true")}#y(){this.element.addClass("disabled")}#g(){this.element.removeClass("disabled")}#h(){const e=[],t=this.element.find("input").filter(((e,t)=>!t.value)),i=this.element.find("input.alert");return t.length&&e.push("error.empty"),i.length&&e.push("error.unattended"),e.forEach((e=>Je.warn(e))),!e.length}async#l(e){e.preventDefault(),this.#h()&&(this.#y(),await Ve.call(this),this.close())}#o(e){e.preventDefault();const t=$(e.currentTarget),i=t.prevAll("input").first();i.val(""),i.attr("value",""),i.attr("data-uuid",""),t.addClass("disabled")}#c(e){e.preventDefault(),this.close()}}new Set(["arcane","divine","occult","primal"]);const Ye=[];const Ze={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"},Qe=new Map;Qe.set(-1,13),Qe.set(0,14),Qe.set(1,15),Qe.set(2,16),Qe.set(3,18),Qe.set(4,19),Qe.set(5,20),Qe.set(6,22),Qe.set(7,23),Qe.set(8,24),Qe.set(9,26),Qe.set(10,27),Qe.set(11,28),Qe.set(12,30),Qe.set(13,31),Qe.set(14,32),Qe.set(15,34),Qe.set(16,35),Qe.set(17,36),Qe.set(18,38),Qe.set(19,39),Qe.set(20,40),Qe.set(21,42),Qe.set(22,44),Qe.set(23,46),Qe.set(24,48),Qe.set(25,50);const Xe=new Map;Xe.set("incredibly easy",-10),Xe.set("very easy",-5),Xe.set("easy",-2),Xe.set("normal",0),Xe.set("hard",2),Xe.set("very hard",5),Xe.set("incredibly hard",10);const Ke=["propertyRune1","propertyRune2","propertyRune3","propertyRune4"];new Set(["armor","backpack","book","consumable","equipment","treasure","weapon"]);const et=["common","draconic","dwarven","elven","gnomish","goblin","halfling","jotun","orcish","sylvan","undercommon","ysoki","abyssal","adlet","aklo","akitonian","alghollthu","amurrun","anadi","ancient-osiriani","anugobu","arcadian","aquan","arboreal","auran","boggard","calda","caligni","celestial","cyclops","daemonic","destrachan","drooni","dziriak","ekujae","erutaki","formian","garundi","girtablilu","gnoll","goloma","grippli","hallit","hwan","iblydan","ignan","ikeshti","immolis","infernal","iruxi","jistkan","jyoti","kaava","kashrishi","kibwani","kitsune","kelish","lirgeni","mahwek","minaten","minkaian","mwangi","mzunu","nagaji","necril","ocotan","okaiyan","osiriani","protean","rasu","ratajin","razatlani","requian","russian","senzar","shadowtongue","shobhad","shisk","shoanti","shoony","skald","sphinx","strix","taldane","tekritanin","tengu","terran","thassilonian","tien","utopian","vanara","varisian","varki","vishkanyan","vudrani","wyrwood","xanmba","androffan","azlanti","grioth","kovintal","migo","munavri","samsaran","sasquatch","shae","yithian","druidic"];function tt(e,t){_(e,"isWatch")&&t.find(".message-content button").on("click",(()=>at()))}const it="max(1,floor(@actor.level/2))",st={get skillNames(){return be.slice()},skillLabel:e=>game.i18n.localize(CONFIG.PF2E.skillList[e]),createSkillRuleElement:({skill:e,value:t,mode:i="upgrade",predicate:s})=>{const a={key:"ActiveEffectLike",mode:i,path:`system.skills.${e}.rank`,value:t};return s&&s.length&&(a.predicate=s),a},createLoreSource:({name:e,rank:t})=>({type:"lore",img:"systems/pf2e/icons/default-icons/lore.svg",name:e,system:{proficient:{value:t}}}),get languageNames(){return et.slice()},languageLabel:e=>game.i18n.localize(CONFIG.PF2E.languages[e]),createLanguageRuleElement:({language:e,mode:t="add",predicate:i})=>{const s={key:"ActiveEffectLike",mode:t,path:"system.traits.languages.value",value:e};return i&&i.length&&(s.predicate=i),s},resistanceLabel:(e,t)=>{let i=game.i18n.localize(`PF2E.Trait${le(e)}`);return t&&(i+=` ${t}`),i},createResistanceRuleElement:({type:e,value:t,predicate:i})=>{"half"===t&&(t=it);const s={key:"Resistance",type:e,value:t};return i&&i.length&&(s.predicate=i),s},createFeatSource:async e=>{const t=(await fromUuid(e))?.toObject();if(!t)throw new Error(`An error occured while trying to create a feat source with uuid: ${e}`);return t},createSpellScrollSource:async({uuid:e,level:t})=>{const i=await async function(e,t,i=!1){const s=(await fromUuid(e))?.toObject();if(!s)return null;!1===t&&(t=s.system.level.value);const a=function(e){return`Compendium.pf2e.equipment-srd.Item.${Ze[e]}`}(t);Ye[t]??=await fromUuid(a);const n=Ye[t]?.toObject();if(!n)return null;s.system.location.heightenedLevel=t,n.name=`Scroll of ${s.name} (Level ${t})`,n.system.temporary=i,n.system.spell=s,n.system.traits.value.push(...s.system.traditions.value);const r=s.flags.core?.sourceId;return r&&(n.system.description.value=`${Be(r)}\n<hr />${n.system.description.value}`),n}(e,t??!1,!0);if(!i)throw new Error(`An error occured while trying to create a spell scroll source with uuid: ${e}`);return i},createSpellSource:async e=>{const t=(await fromUuid(e))?.toObject();if(!t)throw new Error(`An error occured while trying to create a spell source with uuid: ${e}`);return t},get halfLevelString(){return it},getChoiSetRuleSelection:function(e,t){return e._source.system.rules.find((e=>"ChoiceSet"===e.key&&e.rollOption===t))?.selection},proficiencyLabel:e=>game.i18n.localize(CONFIG.PF2E.proficiencyLevels[e]),randomOption:async e=>{const t=e[(await new Roll(`1d${e.length}`).evaluate({async:!0})).total-1];return"string"==typeof t?t:t.value},halfLevelValue:e=>Math.max(1,Math.floor(e.level/2)),sequenceArray:Te,damageLabel:e=>game.i18n.localize(CONFIG.PF2E.weaponDamage[e]),weaponTraitLabel:e=>game.i18n.localize(CONFIG.PF2E.weaponTraits[e]),weaponPropertyRunesLabel:e=>game.i18n.localize(CONFIG.PF2E.weaponPropertyRunes[e]),hasFreePropertySlot:e=>{const t=e.system.runes.potency;return t>0&&e.system.runes.property.length<t},getFreePropertyRuneSlot:function(e){const t=e.system.potencyRune.value;if(null===t)return null;for(let i=0;i<t;i++){const t=Ke[i];if(!e.system[t].value)return t}return null}};function at(e,t){return e&&e.isOfType("character")&&e.isOwner||(e=canvas.tokens.controlled.find((e=>e.actor?.isOfType("character")&&e.actor.isOwner))?.actor,e||(e=game.user.character)),e&&e.isOfType("character")&&e.isOwner?!0!==_(e,"rested")?u("error.unrested"):t||re(e)?void new DailiesInterface(e,{title:m("interface.title",{name:e.name})}).render(!0):u("error.noDailies"):u("error.noCharacterSelected")}function nt(){if(!game.user.isGM)return u("error.notGM");!function(){let e=`<div>${m("message.dailiesRequest.content")}</div>`;e+=`<button type="button" style="margin-top: 8px;">${m("message.dailiesRequest.button")}</button>`,ChatMessage.create({content:e,flags:{[rt]:{isWatch:!0}}})}()}const rt="pf2e-dailies";!function(e,t=!1){o||(o=e),l=t?"system":"module"}(rt);const ot="1.3.0";function lt(e){Hooks[e?"on":"off"]("renderChatMessage",tt)}async function ct(){const e=(await this.getCraftingEntries()).filter((e=>e.isDailyPrep)),t=e.filter((e=>e.isAlchemical)).reduce(((e,t)=>e+t.reagentCost),0),i=(this.system.resources.crafting.infusedReagents.value||0)-t;if(i<0)ui.notifications.warn(game.i18n.localize("PF2E.CraftingTab.Alerts.MissingReagents"));else{await this.update({"system.resources.crafting.infusedReagents.value":i});for(const t of e)for(const e of t.preparedCraftingFormulas){const i=e.item.toObject();i.system.quantity=e.quantity,i.system.temporary=!0,i.system.size="tiny"===this.ancestry?.size?"tiny":"med",!t.isAlchemical||"consumable"!==i.type&&"weapon"!==i.type&&"equipment"!==i.type||i.system.traits.value.push("infused"),await this.addToInventory(i)}}}Hooks.on("pf2e.restForTheNight",(async function(e){const t=[],i=[];for(const s of e.items){if(_(s,"temporary")){if(i.push(s.id),s.isOfType("feat")){const e=_(s,"grantedBy");if(e){const i=`flags.pf2e.itemGrants.-=${Ae(s.name,{camel:"dromedary"})}`;t.push({_id:e,[i]:!0})}}continue}const e=F(s);if(e){const i=ne(e);i?.rest&&await i.rest({item:s,sourceId:e,updateItem:e=>t.push(e)})}const a=deepClone(s._source.system.rules);let n=!1;for(let e=a.length-1;e>=0;e--)rt in a[e]&&(a.splice(e,1),n=!0);n&&t.push({_id:s.id,"system.rules":a})}var s;t.length&&await e.updateEmbeddedDocuments("Item",t),i.length&&await e.deleteEmbeddedDocuments("Item",i),await(s=e,"rested",!0,s.setFlag(o,"rested",true))})),Hooks.on("renderCharacterSheetPF2e",(function(e,t){const i=e.actor;i.isOwner&&re(i)&&t.find("aside .sidebar .hitpoints .hp-small").append(`<a class="roll-icon dailies" data-tooltip="${m("sheet.title")}"><i class="fas fa-mug-saucer"></i></a>`).find(".dailies").on("click",(()=>at(i,!0)))})),Hooks.once("setup",(()=>{w({name:"customDailies",type:Array,default:[],onChange:se}),w({name:"familiar",type:String,default:"",config:!0}),w({name:"watch",type:Boolean,default:!1,config:!0,onChange:lt}),function(e){const t=e.name;e.name=g("menus",t,"name"),e.label=g("menus",t,"label"),e.hint=g("menus",t,"hint"),e.restricted=e.restricted??!0,e.icon=e.icon??"fas fa-cogs",game.settings.registerMenu(o,t,e)}({name:"customs",type:DailyCustoms}),k(o).api={openDailiesInterface:e=>at(e),requestDailies:nt},b("watch")&&lt(!0)})),Hooks.once("ready",(async()=>{await se(),game.modules.get("lib-wrapper")?.active||!game.user.isGM?function(e,t,i="WRAPPER"){libWrapper.register(o,e,t,i)}("CONFIG.PF2E.Actor.documentClasses.character.prototype.performDailyCrafting",ct,"OVERRIDE"):u("error.noLibwrapper",!0)}))})();
//# sourceMappingURL=main.js.map