(()=>{"use strict";let e="";const t=["esoterica","trickster"],a=["longevity","ageless","memories","studies"],n=["linguistics","borts"],s=[...a,...n],i={esoterica:["Compendium.pf2e.feats-srd.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.LHjPTV5vP3MOsPPJ"],trickster:["Compendium.pf2e.feats-srd.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.lIg5Gzz7W70jfbk1"],longevity:["Compendium.pf2e.feats-srd.WoLh16gyDp8y9WOZ"],ageless:["Compendium.pf2e.feats-srd.wylnETwIz32Au46y"],memories:["Compendium.pf2e.feats-srd.ptEOt3lqjxUnAW62"],studies:["Compendium.pf2e.feats-srd.9bgl6qYWKHzqWZj0"],linguistics:["Compendium.pf2e.feats-srd.eCWQU16hRLfN1KaX"],borts:["Compendium.pf2e.equipment-srd.iS7hAQMAaThHYE8g"]},r=(()=>{const e=new Map;for(const[t,a]of Object.entries(i))for(let n=0;n<a.length;n++){const s=a[n];e.set(s,{category:t,index:n})}return e})(),o=Array.from(r.keys()),c=s.map((e=>i[e][0]));function l(e){return e.items.filter((e=>c.includes(e.getFlag("core","sourceId")))).filter((e=>!e.isOfType("equipment")||e.isInvested))}function u(e){return a.includes(e)}function d(e){return n.includes(e)}function f(e){return t.includes(e)}function p(e,t,a,n){const s="string"==typeof t?t:"info",i="object"==typeof t?t:"object"==typeof a?a:void 0,r="boolean"==typeof t?t:"boolean"==typeof a?a:n??!1;ui.notifications.notify(m(e,i),s,{permanent:r})}function m(...t){let[a,n]=t;return a=`${e}.${a}`,n?game.i18n.format(a,n):game.i18n.localize(a)}function g(...t){return t=t.filter((e=>"string"==typeof e)),`modules/${e}/templates/${t.join("/")}`}function h(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}const y={acr:"acrobatics",arc:"arcana",ath:"athletics",cra:"crafting",dec:"deception",dip:"diplomacy",itm:"intimidation",med:"medicine",nat:"nature",occ:"occultism",prf:"performance",rel:"religion",soc:"society",ste:"stealth",sur:"survival",thi:"thievery"},v=(Object.keys(y),Object.values(y)),b=(new Set(["arcane","divine","occult","primal"]),[]);async function k(e,t,a=!1){const n=(await fromUuid(e))?.toObject();if(!n)return null;!1===t&&(t=n.system.level.value);const s=function(e){return`Compendium.pf2e.equipment-srd.${C[e]}`}(t);b[t]??=await fromUuid(s);const i=b[t]?.toObject();if(!i)return null;n.system.location.heightenedLevel=t,i.name=`Scroll of ${n.name} (Level ${t})`,i.system.temporary=a,i.system.spell=n,i.system.traits.value.push(...n.system.traditions.value);const r=n.flags.core?.sourceId;return r&&(i.system.description.value=`${h(r)}\n<hr />${i.system.description.value}`),i}const C={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"},w=["common","draconic","dwarven","elven","gnomish","goblin","halfling","jotun","orcish","sylvan","undercommon","ysoki","abyssal","adlet","aklo","akitonian","alghollthu","amurrun","anadi","ancient-osiriani","anugobu","arcadian","aquan","arboreal","auran","boggard","calda","caligni","celestial","cyclops","daemonic","destrachan","drooni","dziriak","ekujae","erutaki","formian","garundi","girtablilu","gnoll","goloma","grippli","hallit","hwan","iblydan","ignan","ikeshti","immolis","infernal","iruxi","jistkan","jyoti","kaava","kashrishi","kibwani","kitsune","kelish","lirgeni","mahwek","minaten","minkaian","mwangi","mzunu","nagaji","necril","ocotan","okaiyan","osiriani","protean","rasu","ratajin","razatlani","requian","russian","senzar","shadowtongue","shobhad","shisk","shoanti","shoony","skald","sphinx","strix","taldane","tekritanin","tengu","terran","thassilonian","tien","utopian","vanara","varisian","varki","vishkanyan","vudrani","wyrwood","xanmba","androffan","azlanti","grioth","kovintal","migo","munavri","samsaran","sasquatch","shae","yithian","druidic"],O=function(e){const t=(...t)=>m(`${e}.${t[0]}`,t[1]);return Object.defineProperties(t,{warn:{value:(...t)=>function(...e){const[t,a,n]=e;p(t,"warning",a,n)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},info:{value:(...t)=>function(...e){const[t,a,n]=e;p(t,"info",a,n)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},error:{value:(...t)=>function(...e){const[t,a,n]=e;p(t,"error",a,n)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1}}),t}("interface");class j extends Application{_actor;constructor(e,t){super(t),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:O("title"),template:g("interface.hbs"),height:"auto",submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[name="spell"]'}]})}getData(t){const a=this._actor,n=a.level,s=("saved",a.getFlag(e,"saved")??undefined??{});const i=function(e){const t={};for(const a of e.items){const e=a.getFlag("core","sourceId"),n=r.get(e);n&&(t[n.category]??=[],t[n.category][n.index]=a)}return t}(a),o=v.filter((e=>a.skills[e].rank<1)).map((e=>({skill:e}))),c=a.system.traits.languages.value,l=w.filter((e=>!c.includes(e))).sort().map((e=>({language:e}))),p=[],m=[],g=[];for(const e in i){const t=i[e];if(!t[0])continue;const a=(t,a)=>{t.isOfType("equipment")&&!t.isInvested||a.push({category:e,name:t.name,selected:s[e]??""})};if(u(e)&&a(t[0],p),d(e)&&a(t[0],m),f(e)){const a=[],i=t=>{const{name:a,uuid:n}=s[e]?.[t-1]??{name:"",uuid:""};return{spellLevel:t,name:a,uuid:n}};a.push(i(1)),n>=8&&a.push(i(2)),t[1]&&(a.push(i(3)),n>=14&&a.push(i(4)),n>=16&&a.push(i(5))),t[2]&&(a.push(i(6)),n>=20&&a.push(i(7))),g.push({category:e,name:t[0].name,slots:a})}}return mergeObject(super.getData(t),{i18n:O,skillItems:p,skills:o,scrollItems:g,languages:l,languageItems:m})}activateListeners(e){super.activateListeners(e),e.find("[data-type=spell] [data-action=search]").on("click",this.#e.bind(this)),e.find("[data-action=clear]").on("click",this.#t.bind(this)),e.find("[data-action=accept]").on("click",this.#a.bind(this)),e.find("[data-action=cancel]").on("click",this.#n.bind(this))}async _onDrop(e){const t=e.dataTransfer?.getData("text/plain");try{const a=$(e.target),n=()=>O.warn("spells.error.wrongType"),s=JSON.parse(t);if(!s||"Item"!==s.type||"string"!=typeof s.uuid)return n();const i=await fromUuid(s.uuid);if(!i?.isOfType("spell")||i.isCantrip||i.isRitual)return n();if(i.level>Number(a.attr("data-level")))return O.warn("spells.error.wrongLevel");a.attr("value",i.name),a.attr("data-uuid",i.uuid),a.nextAll('[data-action="clear"]').first().removeClass("disabled")}catch{}}#s(){this.element.find("button").attr("disabled","true"),this.element.find("a").addClass("disabled")}#i(){const e=[];return this.element.find('input[value=""]').length&&e.push("error.empty"),e.forEach((e=>O.warn(e))),!e.length}async#a(t){if(t.preventDefault(),!this.#i())return;this.#s();const a=this._actor,n=l(a),s={},i=[],o=[],c=[];let f="";for(const t of n){const a=t.getFlag("core","sourceId"),n=r.get(a).category,i=deepClone(t._source.system.rules),l=this.element.find(`[name=${n}]`).val(),f=i.findIndex((e=>"pf2e-dailies"in e));f>=0&&i.splice(f,1);const p={uuid:t.uuid,choice:l,update:{_id:t.id,"system.rules":i}};u(n)?(i.push({key:"ActiveEffectLike",mode:"upgrade",path:`system.skills.${l}.rank`,value:1,[e]:!0}),o.push(p)):d(n)&&(i.push({key:"ActiveEffectLike",mode:"add",path:"system.traits.languages.value",value:l,[e]:!0}),c.push(p)),s[n]=l}const p=this.element.find(".window-content .groups .group").toArray();for(const e of p){const t=$(e),a=t.attr("data-category"),n=t.find('[name="spell"]').toArray();for(let e=0;e<n.length;e++){const t=$(n[e]),r=t.attr("data-uuid"),o=Number(t.attr("data-level")),c=t.attr("value");if(r){const e=await k(r,o,!0);e&&i.push(e)}s[a]??=[],s[a][e]={name:c,uuid:r}}}const m=[],g=(e,t,a=!1)=>{if(!t.length)return;a&&f&&(f+="<hr />");const n=O(`message.${e}`);f+=`<p><strong>${n}</strong></p>`;for(const e of t)f+=`<p>${h(e.uuid)} <span style="text-transform: capitalize;">${e.choice}</span></p>`,m.push(e.update)};var y,v;g("skills",o),g("languages",c,!0),m.length&&await a.updateEmbeddedDocuments("Item",m),i.length&&(f&&(f+="<hr />"),f+=`<p><strong>${O("message.items")}</strong></p>`,(await a.createEmbeddedDocuments("Item",i)).map((e=>f+=`<p>${h(e.uuid)}</p>`))),await(y=a,"saved",v=s,y.setFlag(e,"saved",v)),f=`${O("message.changes")}<hr>${f}`,ChatMessage.create({content:f,speaker:ChatMessage.getSpeaker({actor:a})}),this.close()}#e(e){e.preventDefault();const t=Number(e.currentTarget.dataset.level),a=[];for(let e=0;e<t;e++)a[e]=e+1;const n={category:["spell"],classes:[],level:a,rarity:[],school:[],source:[],traditions:[],traits:[]};game.pf2e.compendiumBrowser.openTab("spell",n)}#t(e){e.preventDefault();const t=$(e.currentTarget),a=t.prevAll('[name="spell"]').first();a.attr("value",""),a.attr("data-uuid",""),t.addClass("disabled")}#n(e){e.preventDefault(),this.close()}}e||(e="pf2e-dailies"),Hooks.once("ready",(()=>{!function(){const e=game.pf2e.actions.restForTheNight;game.pf2e.actions.restForTheNight=async t=>{const a=await e(t);return a.length&&t.actors&&function(e){const t=(e=Array.isArray(e)?e:[e]).filter((e=>e.isOfType("character")));for(const e of t){const t=[],a=l(e);for(const e of a){const a=deepClone(e._source.system.rules),n=a.findIndex((e=>"pf2e-dailies"in e));n>=0&&(a.splice(n,1),t.push({_id:e.id,"system.rules":a}))}t.length&&e.updateEmbeddedDocuments("Item",t)}}(t.actors),a}}()})),Hooks.on("renderCharacterSheetPF2e",(function(e,t){const a=e.actor;if(!function(e){return!!e.items.find((e=>o.includes(e.getFlag("core","sourceId"))))}(a))return;const n=t.find("aside .sidebar .hitpoints .hp-small");n.append(`<a class="roll-icon dailies" title="${m("sheet.title")}"><i class="fas fa-mug-saucer"></i></a>`).find(".dailies").on("click",(()=>new j(a).render(!0,{id:`pf2e-dailies-interface-${a.id}`}))),n.find("[data-action=rest]").off("click").on("click",(e=>game.pf2e.actions.restForTheNight({event:e,actors:a})))}))})();
//# sourceMappingURL=main.js.map