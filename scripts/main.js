(()=>{"use strict";let e="";function t(t,a,n){return t.getFlag(e,a)??n}function a(t,a,n){return t.setFlag(e,a,n)}function n(e){return e.getFlag("core","sourceId")}function s(e,t){return n(e)===t}function i(e,t){const a=n(e);return!!a&&t.includes(a)}function r(e){return Array.isArray(e)?t=>i(t,e):t=>n(t)===e}function o(e,t){return t?t.flatMap((t=>e.itemTypes[t])):e.items}function l(e,t,a){return o(e,a).find(r(t))}const c=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,u=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,d=new RegExp(u,"gu"),p=String.raw`(?:${c})(?=${u})|(?:${u})(?=${c})`,f=String.raw`(?:${c})(?=${c})`,m=String.raw`\p{Lowercase_Letter}`,g=String.raw`\p{Uppercase_Letter}`,y=new RegExp(`(${m})(${g}${f})`,"gu"),h=/[^-\p{White_Space}\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]/gu,b=new RegExp(`${g}|(?:${p})${m}`,"gu");function v(e,{camel:t=null}={}){if("string"!=typeof e)return console.warn("Non-string argument passed to `sluggify`"),"";switch(t){case null:return e.replace(y,"$1-$2").toLowerCase().replace(/['â€™]/g,"").replace(d," ").trim().replace(/[-\s]+/g,"-");case"bactrian":{const t=v(e,{camel:"dromedary"});return t.charAt(0).toUpperCase()+t.slice(1)}case"dromedary":return e.replace(h,"").replace(/[-_]+/g," ").replace(b,((e,t)=>0===t?e.toLowerCase():e.toUpperCase())).replace(/\s+/g,"");default:throw Error("PF2e System | I don't think that's a real camel.")}}function w(e,t,a,n){const s="string"==typeof t?t:"info",i="object"==typeof t?t:"object"==typeof a?a:void 0,r="boolean"==typeof t?t:"boolean"==typeof a?a:n??!1;ui.notifications.notify(k(e,i),s,{permanent:r})}function k(...t){let[a,n]=t;return a=`${e}.${a}`,n?game.i18n.format(a,n):game.i18n.localize(a)}function C(t){return game.i18n.has(`${e}.${t}`,!1)}function T(e){const t=(...t)=>k(`${e}.${t[0]}`,t[1]);return Object.defineProperties(t,{warn:{value:(...t)=>function(...e){const[t,a,n]=e;w(t,"warning",a,n)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},info:{value:(...t)=>function(...e){const[t,a,n]=e;w(t,"info",a,n)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},error:{value:(...t)=>function(...e){const[t,a,n]=e;w(t,"error",a,n)}(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},has:{value:t=>C(`${e}.${t}`),enumerable:!1,configurable:!1}}),t}const S=["addedLanguage","trainedSkill","addedResistance","ganziHeritage","thaumaturgeTome"],I="Compendium.pf2e-dailies.equipment.VpmEozw21aRxX15P",F=[{type:"addedFeat",category:"metamagical",uuids:["Compendium.pf2e.classfeatures.89zWKD2CN7nRu2xp"]},{type:"mindSmith",category:"mindsmith",uuids:["Compendium.pf2e.feats-srd.juikoiIA0Jy8PboY",I,"Compendium.pf2e.feats-srd.PccekOihIbRWdDky","Compendium.pf2e.feats-srd.2uQbQgz1AbjzcFSp","Compendium.pf2e.feats-srd.fgnfXwFcn9jZlXGD"]},{type:"tricksterAce",category:"ace",uuids:["Compendium.pf2e.feats-srd.POrE3ZgBRdBL9MsW"]},{type:"thaumaturgeTome",category:"tome",uuids:["Compendium.pf2e.classfeatures.MyN1cQgE0HsLF20e","Compendium.pf2e.classfeatures.Obm4ItMIIr0whYeO","Compendium.pf2e.classfeatures.ZEUxZ4Ta1kDPHiq5","Compendium.pf2e.feats-srd.yRRM1dsY6jakEMaC","Compendium.pf2e.classfeatures.QEtgbY8N2V4wTbsI"]},{type:"addedResistance",category:"elementalist",uuids:["Compendium.pf2e.feats-srd.tx9pkrpmtqe4FnvS"]},{type:"ganziHeritage",category:"ganzi",uuids:["Compendium.pf2e.heritages.3reGfXH0S82hM7Gp"]},{type:"trainedLore",category:"study",uuids:["Compendium.pf2e.feats-srd.aLJsBBZzlUK3G8MW"]},{type:"trainedSkill",category:"ageless",uuids:["Compendium.pf2e.feats-srd.wylnETwIz32Au46y"]},{type:"trainedSkill",category:"longevity",uuids:["Compendium.pf2e.feats-srd.WoLh16gyDp8y9WOZ"]},{type:"trainedSkill",category:"memories",uuids:["Compendium.pf2e.feats-srd.ptEOt3lqjxUnAW62"]},{type:"trainedSkill",category:"studies",uuids:["Compendium.pf2e.feats-srd.9bgl6qYWKHzqWZj0"]},{type:"addedLanguage",category:"linguistics",uuids:["Compendium.pf2e.feats-srd.eCWQU16hRLfN1KaX"]},{type:"addedLanguage",category:"borts",uuids:["Compendium.pf2e.equipment-srd.iS7hAQMAaThHYE8g"]},{type:"combatFlexibility",category:"flexibility",uuids:["Compendium.pf2e.classfeatures.8g6HzARbhfcgilP8","Compendium.pf2e.classfeatures.W2rwudMNcAxs8VoX"]},{type:"scrollSavant",category:"savant",uuids:["Compendium.pf2e.feats-srd.u5DBg0LrBUKP0JsJ"]},{type:"scrollChain",category:"esoterica",uuids:["Compendium.pf2e.feats-srd.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.LHjPTV5vP3MOsPPJ"]},{type:"scrollChain",category:"trickster",uuids:["Compendium.pf2e.feats-srd.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.lIg5Gzz7W70jfbk1"]}],{CATEGORIES:x,UUIDS:E,FIRST_FEATS:A,FIRST_EQUIPMENTS:D,FIRST_HERITAGES:R,RULES:_}=(()=>{const e={},t=new Map,a=[],n=[],s=[],i=[];for(const{type:r,category:o,uuids:l}of F){const c=S.includes(r);e[o]??=[];for(let n=0;n<l.length;n++){const s=l[n];e[o].push(s),t.set(s,{type:r,category:o,index:n}),c&&a.push(s)}const u=l[0];u.includes("equipment-srd")?s.push(u):u.includes("heritages")?i.push(u):n.push(u)}return{CATEGORIES:e,UUIDS:t,FIRST_FEATS:n,FIRST_EQUIPMENTS:s,FIRST_HERITAGES:i,RULES:a}})();function L(e){return x[e]}function O(e){return i(e,_)}function j(e,t){return"string"==typeof t?e.type===t:t.includes(e.type)}const P={slashing:"sword",piercing:"spear",bludgeoning:"club"},U=Object.keys(P),M={0:{die:"d4",traits:["finesse","agile"],usage:"held-in-one-hand"},1:{die:"d6",traits:["finesse"],usage:"held-in-one-hand"},2:{die:"d8",traits:[],usage:"held-in-one-hand"},3:{die:"d10",traits:["reach"],usage:"held-in-two-hands"}},z=["grapple","nonlethal","shove","trip","modular"],N=["corrosive","disrupting","flaming","frost","shock","thundering"],H=["anarchic","axiomatic","greaterCorrosive","greaterDisrupting","greaterFlaming","greaterFrost","greaterShock","greaterThundering","holy","unholy"],B=["propertyRune1","propertyRune2","propertyRune3","propertyRune4"];function q(e){const t=e.system.potencyRune.value;if(null===t)return null;for(let a=0;a<t;a++){const t=B[a];if(!e.system[t].value)return t}return null}function W(...t){return t=t.filter((e=>"string"==typeof e)),`modules/${e}/templates/${t.join("/")}`}const G=["untrained","trained","expert","master","legendary"],J={acr:"acrobatics",arc:"arcana",ath:"athletics",cra:"crafting",dec:"deception",dip:"diplomacy",itm:"intimidation",med:"medicine",nat:"nature",occ:"occultism",prf:"performance",rel:"religion",soc:"society",ste:"stealth",sur:"survival",thi:"thievery"},Q=(Object.keys(J),Object.values(J));function Z(e){return e?e[0].toUpperCase()+e.slice(1):""}function V(){return game.packs.get("pf2e.familiar-abilities")}function X(e){return`Compendium.pf2e.familiar-abilities.${e}`}function K(e,t){return t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`}new Set(["arcane","divine","occult","primal"]);const Y=[];async function ee(e,t,a=!1){const n=(await fromUuid(e))?.toObject();if(!n)return null;!1===t&&(t=n.system.level.value);const s=function(e){return`Compendium.pf2e.equipment-srd.${te[e]}`}(t);Y[t]??=await fromUuid(s);const i=Y[t]?.toObject();if(!i)return null;n.system.location.heightenedLevel=t,i.name=`Scroll of ${n.name} (Level ${t})`,i.system.temporary=a,i.system.spell=n,i.system.traits.value.push(...n.system.traditions.value);const r=n.flags.core?.sourceId;return r&&(i.system.description.value=`${K(r)}\n<hr />${i.system.description.value}`),i}const te={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"},ae=T("interface.message");async function ne(e){return e[(await new Roll(`1d${e.length}`).evaluate({async:!0})).total-1]}function se(t,a){const n={type:"lore",img:"systems/pf2e/icons/default-icons/lore.svg",name:t,flags:{[e]:{temporary:!0}}};return setProperty(n,"system.proficient.value",a),n}async function ie(t,a){const n=(await fromUuid(t))?.toObject();if(n)return setProperty(n,"flags.pf2e.grantedBy",{id:a.id,onDelete:"cascade"}),setProperty(n,`flags.${e}.temporary`,!0),n}function re(t,a){return{key:"ActiveEffectLike",mode:"upgrade",path:`system.skills.${t}.rank`,value:Number(a),[e]:!0}}function oe(t,a){return"half"===a&&(a="max(1,floor(@actor.level/2))"),{key:"Resistance",type:t,value:a,[e]:!0}}async function le(t,a,n){const s=(await fromUuid(t))?.toObject();if(s)return setProperty(s,`flags.${e}`,{parent:n,level:a}),s}function ce(t,a,n){const s={type:"spellcastingEntry",img:"systems/pf2e/icons/default-icons/spellcastingEntry.svg",name:t,flags:{[e]:{temporary:!0}}};return setProperty(s,"system",{slug:a,prepared:{value:"innate"},showSlotlessLevels:{value:!1},showUnpreparedSpells:{value:!1},proficiency:{value:1,slug:n}}),s}const ue=T("dialog");async function de(e){e.preventDefault();const t=e.currentTarget.previousElementSibling,{type:a}=t.dataset;"mindSmith"===a&&pe.call(this)}async function pe(){let e=ue("weapon.flavor");e+="<hr />";for(const t of["0","1","2","3"])e+=`<label><input type="radio" name="type" value="${t}">${ue(`weapon.option.${t}`)}</label>`;await Dialog.wait({title:ue("weapon.title"),content:e,buttons:{yes:{icon:'<i class="fas fa-save"></i>',label:ue("weapon.accept"),callback:fe.bind(this)},no:{icon:'<i class="fas fa-times"></i>',label:ue("weapon.cancel")}},close:()=>!1},{},{id:"pf2e-dailies-weapon",width:600})}async function fe(e){const t=e.find("[name=type]:checked").val();if(!t)return ue.warn("weapon.error.noSelection");const a=(await fromUuid(I))?.toObject();if(!a)return ue.warn("weapon.error.missing");const n=M[t];setProperty(a,"system.damage.die",n.die),setProperty(a,"system.traits.value",n.traits.slice()),setProperty(a,"system.usage.value",n.usage),await this.actor.createEmbeddedDocuments("Item",[a]),this.render()}const me=new Map;me.set(-1,13),me.set(0,14),me.set(1,15),me.set(2,16),me.set(3,18),me.set(4,19),me.set(5,20),me.set(6,22),me.set(7,23),me.set(8,24),me.set(9,26),me.set(10,27),me.set(11,28),me.set(12,30),me.set(13,31),me.set(14,32),me.set(15,34),me.set(16,35),me.set(17,36),me.set(18,38),me.set(19,39),me.set(20,40),me.set(21,42),me.set(22,44),me.set(23,46),me.set(24,48),me.set(25,50);const ge=new Map;function ye(e,t){return e._source.system.rules.find((e=>"ChoiceSet"===e.key&&e.rollOption===t))?.selection}ge.set("incredibly easy",-10),ge.set("very easy",-5),ge.set("easy",-2),ge.set("normal",0),ge.set("hard",2),ge.set("very hard",5),ge.set("incredibly hard",10);const he=["common","draconic","dwarven","elven","gnomish","goblin","halfling","jotun","orcish","sylvan","undercommon","ysoki","abyssal","adlet","aklo","akitonian","alghollthu","amurrun","anadi","ancient-osiriani","anugobu","arcadian","aquan","arboreal","auran","boggard","calda","caligni","celestial","cyclops","daemonic","destrachan","drooni","dziriak","ekujae","erutaki","formian","garundi","girtablilu","gnoll","goloma","grippli","hallit","hwan","iblydan","ignan","ikeshti","immolis","infernal","iruxi","jistkan","jyoti","kaava","kashrishi","kibwani","kitsune","kelish","lirgeni","mahwek","minaten","minkaian","mwangi","mzunu","nagaji","necril","ocotan","okaiyan","osiriani","protean","rasu","ratajin","razatlani","requian","russian","senzar","shadowtongue","shobhad","shisk","shoanti","shoony","skald","sphinx","strix","taldane","tekritanin","tengu","terran","thassilonian","tien","utopian","vanara","varisian","varki","vishkanyan","vudrani","wyrwood","xanmba","androffan","azlanti","grioth","kovintal","migo","munavri","samsaran","sasquatch","shae","yithian","druidic"],be=["air","earth","fire","water"],ve=["acid","electricity","sonic"],we=new Proxy({addedLanguage:0,trainedSkill:1,addedResistance:2,trainedLore:3},{get:(e,t)=>t in e?e[t]:99});function ke(e){const a=e.level,s=t(e,"saved")??{},i=function(e){const t={},a=o(e,["heritage","feat","equipment","weapon"]);for(const e of a){const a=n(e);if(!a||e.isOfType("equipment")&&!1===e.isInvested)continue;const s=E.get(a);if(!s)continue;const{category:i,index:r,type:o}=s;if(t[i]??={category:i,type:o,label:"",items:[]},t[i].items[r]=e,0===r){const a=`label.${i}`,n=C(a)?k(a):e.name;t[i].label=n}}return Object.values(t).filter((e=>e.items[0]))}(e),r=[];if(e.familiar){const t="familiar",a=[],n=e.attributes.familiarAbilities.value,i=[],o=V().index;for(const e of o)i.push({value:e._id,label:e.name});for(let e=0;e<n;e++)a.push({rowType:"select",value:s[t]?.[e]??"",options:i,label:k("label.ability",{nb:e+1})});a.length&&r.push({type:"familiarAbility",category:t,label:k("label.familiar"),rows:a})}for(const t of i)if(j(t,["scrollChain","scrollSavant"])){const{type:n,category:i,label:o,items:l}=t,c=[],u=(e,t=e-1)=>{const{name:a="",uuid:n=""}=s[i]?.[t]??{};c.push({rowType:"drop",value:a,label:game.i18n.localize(`PF2E.SpellLevel${e}`),dataset:{uuid:n,level:e}})};if("scrollChain"===n)u(1),a>=8&&u(2),l[1]&&(u(3),a>=14&&u(4),a>=16&&u(5)),l[2]&&(u(6),a>=20&&u(7));else{const{maxSlot:t,maxTradition:a}=Te(e,"arcane");a>=4&&t>=6&&u(t-5,3),a>=3&&t>=5&&u(t-4,2),u(t-3,1),u(t-2,0)}r.push({type:n,category:i,label:o,rows:c})}else if(j(t,"trainedSkill")){const a=Q.filter((t=>e.skills[t].rank<1));if(!a.length)continue;const{type:n,category:i,label:o}=t;let{selected:l="",input:c=!0}=s[i]??{};!l||c||a.includes(l)||(l="",c=!0);const u={rowType:"combo",options:Ce(a),value:c?l:Z(l),dataset:{input:c}};r.push({type:n,category:i,label:o,rows:[u]})}else if(j(t,"thaumaturgeTome")){const{type:n,category:i,label:o,items:l}=t,c=[],u=e.skills,d=(e,t,a)=>{let{selected:n="",input:r=!0}=s[i]?.[e]??{};!n||r||a.includes(n)||(n="",r=!0),c.push({rowType:"combo",label:G[t],options:Ce(a),value:r?n:Z(n),dataset:{input:r,rank:t}})},p=(e,t="adept")=>{const a=l[e];return!!a&&"tome"===ye(a,t)};if(p(4,"paragon")){const e=Q.filter((e=>u[e].rank<4));if(!e.length)continue;d(0,4,e),d(1,4,e)}else if(l[3]||p(2)||p(1)){const e=Q.filter((e=>u[e].rank<3));if(a>=9){if(!e.length)continue;d(0,3,e),d(1,3,e)}else{const t=Q.filter((e=>u[e].rank<2));if(!t.length)continue;d(0,2,t),e.length&&d(1,3,e)}}else if(a>=5){const e=Q.filter((e=>u[e].rank<2));if(!e.length)continue;d(0,2,e),d(1,2,e)}else if(a>=3){const e=Q.filter((e=>u[e].rank<1));if(!e.length)continue;d(0,1,e);const t=Q.filter((e=>u[e].rank<2));t.length&&d(1,2,t)}else{const e=Q.filter((e=>u[e].rank<1));if(!e.length)continue;d(0,1,e),d(1,1,e)}r.push({type:n,category:i,label:o,rows:c})}else if(j(t,"trainedLore")){const{type:e,category:a,label:n}=t,i={rowType:"input",placeholder:game.i18n.localize("PF2E.NewPlaceholders.Lore"),value:s[a]??""};r.push({type:e,category:a,label:n,rows:[i]})}else if(j(t,"addedLanguage")){const a=e.system.traits.languages.value,n=he.filter((e=>!a.includes(e))).sort();if(!n.length)continue;const{type:i,category:o,label:l}=t,c={rowType:"select",options:Ce(n),value:s[o]??""};r.push({type:i,category:o,label:l,rows:[c]})}else if(j(t,"addedResistance")){const{type:e,category:a,label:n}=t,i={rowType:"select",options:Ce(be),value:s[a]??""};r.push({type:e,category:a,label:n,rows:[i]})}else if(j(t,"combatFlexibility")){const{type:e,category:a,label:n,items:i}=t,o=s[a]??[],l=[];l.push({rowType:"drop",value:o[0]?.name??"",label:game.i18n.localize("PF2E.Level8"),dataset:{uuid:o[0]?.uuid??"",level:8}}),i[1]&&l.push({rowType:"drop",label:game.i18n.localize("PF2E.Level14"),value:o[1]?.name??"",dataset:{uuid:o[1]?.uuid??"",level:14}}),r.push({type:e,category:a,label:n,rows:l})}else if(j(t,"tricksterAce")){const{type:e,category:a,label:n}=t,{name:i="",uuid:o=""}=s[a]??{},l={rowType:"drop",value:i,dataset:{uuid:o,level:4}};r.push({type:e,category:a,label:n,rows:[l]})}else if(j(t,"ganziHeritage")){const{type:e,category:a,label:n}=t,s={rowType:"random",options:Ce(ve)};r.push({type:e,category:a,label:n,rows:[s]})}else if(j(t,"mindSmith")){const{type:e,category:a,label:n,items:i}=t,o=i[1],l={type:e,category:a,label:n,rows:[{rowType:"alert",value:k("interface.alert.weapon")}]};if(r.push(l),!o)continue;if(l.rows[0]={rowType:"select",options:Ce(U),value:s[a]?.damage??"",label:n,dataset:{subcategory:"damage"}},i[2]&&(l.rows[1]={rowType:"select",options:Ce(z),value:s[a]?.trait??"",label:k("label.mentalforge"),dataset:{subcategory:"trait"}}),!i[3]&&!i[4])continue;if(!q(o))continue;const c=i[4]?H:N,u=s[a]?.rune??"";l.rows[2]={rowType:"select",options:c.map((e=>{return{value:e,label:(t=e,t.replace("greater","greater "))};var t})),value:u&&c.includes(u)?u:"",label:k("label.runicmind"),dataset:{subcategory:"rune"}}}else if(j(t,"addedFeat")){const{type:e,category:n,label:i}=t,o={rowType:"drop",value:s[n]?.name??"",dataset:{uuid:s[n]?.uuid??"",level:Math.floor(a/2)}};r.push({type:e,category:n,label:k("label.metamagical"),rows:[o]})}const l=[],c=[];for(const e of r)e.rows.length>1?c.push(e):l.push(e);return l.sort(((e,t)=>we[e.type]-we[t.type])),c.sort(((e,t)=>e.rows.length-t.rows.length)),{rows:l,groups:c}}function Ce(e){return e.map((e=>({value:e,label:e})))}function Te(e,t){let a=1,n=0;for(const s of e.spellcasting){if("pf2e-staves"in s.flags)continue;const e=s.system.slots;for(const t in e)e[t].max&&(a=Math.max(a,Number(t.slice(4))));s.tradition===t&&(n=Math.max(n,s.rank))}return{maxSlot:Math.min(a,10),maxTradition:n}}function Se(e,t){const a=[];if(e<=t)for(let n=e;n<=t;n++)a.push(n);else for(let n=e;n>=t;n--)a.push(n);return a}const $e={scrollChain:{category:["spell"]},combatFlexibility:{feattype:["class"],traits:["fighter"]},scrollSavant:{category:["spell"],traditions:["arcane"]},tricksterAce:{category:["cantrip","spell"]},addedFeat:{metamagical:{feattype:["class"],traits:["metamagic"]}}};function Ie(e){e.preventDefault();const t=e.currentTarget.dataset,a=Number(t.level);switch(t.type){case"scrollChain":Fe({...$e.scrollChain,level:Se(1,a)});break;case"combatFlexibility":xe({...$e.combatFlexibility,level:{min:1,max:a}});break;case"scrollSavant":Fe({...$e.scrollSavant,level:Se(1,a)});break;case"tricksterAce":Fe({...$e.tricksterAce,level:Se(1,a)});break;case"addedFeat":!function(e,t){"metamagical"===e&&xe({...$e.addedFeat.metamagical,level:{min:1,max:t}})}(t.category,a)}}function Fe({category:e=[],level:t=[],traditions:a=[]}={}){const n={category:e,classes:[],level:t,rarity:[],school:[],source:[],traditions:a,traits:[]};game.pf2e.compendiumBrowser.openTab("spell",n)}function xe({feattype:e=[],level:t={},traits:a=[]}={}){const n={feattype:e,skills:[],rarity:[],source:[],traits:a,level:t};game.pf2e.compendiumBrowser.openTab("feat",n)}const Ee=T("interface.error.drop");function Ae(e){const t=e.system.time.value;return!(t.includes("hour")||t.includes("min")&&parseInt(t)>10)||(Ee.warn("wrongSpellTime",{time:"10 min"}),!1)}function De(e,t,{category:a=[],traditions:n=[]}={},s){if(!t.isOfType("spell"))return Ee.warn("wrongType",{type:"spell"});if(t.isCantrip&&!a.includes("cantrip"))return Ee.warn("cannotBe",{type:"spell",not:"cantrip"});if(t.isRitual&&!a.includes("ritual"))return Ee.warn("cannotBe",{type:"spell",not:"ritual"});if(t.isFocusSpell&&!a.includes("focus"))return Ee.warn("cannotBe",{type:"spell",not:"focus"});if(n.length){const e=t.system.traditions.value;for(const t of n)if(!e.includes(t))return Ee.warn("wrongTrait",{type:"spell",trait:t,category:"tradition"})}if(t.level>Number(e.attr("data-level")))return Ee.warn("wrongLevel",{type:"spell"});s&&!s(t)||_e(e,t)}function Re(e,t,{feattype:a=[],traits:n=[]}){if(!t.isOfType("feat")||t.isFeature)return Ee.warn("wrongType",{type:"feat"});if(!a.includes(t.featType))return Ee.warn("cannotBe",{type:"feat",not:t.featType});if(n.length){const e=t.system.traits.value;for(const t of n)if(!e.includes(t))return Ee.warn("wrongTrait",{type:"feat",trait:t,category:"trait"})}if(t.level>Number(e.attr("data-level")))return Ee.warn("wrongLevel",{type:"feat"});_e(e,t)}function _e(e,t){e.val(t.name),e.attr("value",t.name),e.attr("data-uuid",t.uuid),e.nextAll('[data-action="clear"]').first().removeClass("disabled")}const Le=T("interface");class DailiesInterface extends Application{_actor;_randomInterval;constructor(e,t){super(t),this._actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"pf2e-dailies-interface",title:Le("title"),template:W("interface.hbs"),height:"auto",submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[data-droppable="true"]'}]})}get actor(){return this._actor}getData(e){return mergeObject(super.getData(e),{i18n:Le,dump:({dataset:e,value:t,placeholder:a})=>{let n="";return t&&(n+=` value="${t}"`),a&&(n+=` placeholder="${a}"`),e&&Object.entries(e).forEach((([e,t])=>n+=` data-${e}="${t}"`)),n&&(n+=" "),n},...ke(this._actor)})}render(e,t){return this._randomInterval&&clearInterval(this._randomInterval),this.element.find("select.random")&&(this._randomInterval=setInterval((()=>{this.element.find("select.random").each(((e,t)=>{t.selectedIndex=(t.selectedIndex+1)%t.options.length}))}),2e3)),super.render(e,t)}close(e){return this._randomInterval&&clearInterval(this._randomInterval),super.close(e)}activateListeners(e){super.activateListeners(e),e.find("[data-action=alert]").on("click",de.bind(this)),e.find(".combo select").on("change",this.#e.bind(this)),e.find(".combo input").on("change",this.#t.bind(this)),e.find("[data-action=search]").on("click",Ie),e.find("[data-action=clear]").on("click",this.#a.bind(this)),e.find("[data-action=accept]").on("click",this.#n.bind(this)),e.find("[data-action=cancel]").on("click",this.#s.bind(this))}async _onDrop(e){!async function(e){let t=$(e.target);t.is("label")&&(t=t.next());const a=t.attr("data-type");if(a)try{const n=e.dataTransfer?.getData("text/plain"),s=()=>Ee.warn("wrongDataType"),i=JSON.parse(n);if(console.log(i),!i||"Item"!==i.type||"string"!=typeof i.uuid)return s();const r=await fromUuid(i.uuid);if(!r)return s();switch(a){case"scrollChain":De(t,r,$e.scrollChain);break;case"combatFlexibility":Re(t,r,$e.combatFlexibility);break;case"scrollSavant":De(t,r,$e.scrollSavant);break;case"tricksterAce":De(t,r,$e.tricksterAce,Ae);break;case"addedFeat":!function(e,t){if("metamagical"===e.attr("data-category")){const a=$e.addedFeat.metamagical;a.traits??=[],a.traits.push("wizard"),Re(e,t,a)}}(t,r)}}catch(e){}}(e)}#e(e){const t=e.currentTarget,a=t.nextElementSibling;a.dataset.input="false",a.value=Z(t.value)}#t(e){const t=e.currentTarget,a=t.previousElementSibling,n=t.value.toLowerCase(),s=t.dataset.type,i=Q;if(Array.from(a.options).map((e=>e.value)).includes(n))a.value=n,t.value=Z(n),t.dataset.input="false";else if(i.includes(n)){if("thaumaturgeTome"===s||"trainedSkill"===s){const e="thaumaturgeTome"===s?Number(t.dataset.rank):1;Le.warn("error.input.proficiency",{rank:G[e],proficiency:n})}a.value="",t.value="",t.dataset.input="true"}else a.value="",t.dataset.input="true"}#i(){this.element.addClass("disabled")}#r(){const e=[],t=this.element.find("input").filter(((e,t)=>!t.value)),a=this.element.find("input.alert");return t.length&&e.push("error.empty"),a.length&&e.push("error.unattended"),e.forEach((e=>Le.warn(e))),!e.length}async#n(n){if(n.preventDefault(),this.#r()){this.#i();try{await async function(n,i){let c="";const u={},d=n.find(".window-content .content").find("input:not(.alert), select[data-type]").toArray(),p=d.some((e=>S.includes(e.dataset.type)))?function(e){return function(e,t,a){return o(e,["feat","equipment","heritage"]).filter(r(t))}(e,_)}(i):[],f=[],m=[],g=new Map,y=[],h=t=>{const a=t.id,n=g.get(a);if(n)return n;const s=deepClone(t._source.system.rules);for(let t=s.length-1;t>=0;t--){const a=s[t];e in a&&s.splice(t,1)}return g.set(a,s),s},b={languages:[],skills:[],tome:[],resistances:[],feats:[],scrolls:[],spells:[],mind:[],familiar:[]};for(const t of d){const n=t.dataset.type;if("scrollChain"===n||"scrollSavant"===n){const{uuid:e,category:a}=t.dataset,n=Number(t.dataset.level),s=await ee(e,n,!0);s&&f.push(s),u[a]??=[],u[a].push({name:t.value,uuid:e})}else if("addedFeat"===n||"combatFlexibility"===n){const{category:e,uuid:a,level:s}=t.dataset,r="combatFlexibility"===n?"8"===s?0:1:0,o=L(e)[r];if(o){const e=l(i,o,["feat"]);if(e){const t=await ie(a,e);t&&f.push(t)}}"combatFlexibility"===n?(u[t.dataset.category]??=[],u[t.dataset.category].push({name:t.value,uuid:a})):u[t.dataset.category]={uuid:a,name:t.value}}else if("trainedLore"===n){const e=t.dataset.category,a=L(e)[0],n=t.value,s=se(n,1);f.push(s),b.skills.push({uuid:a,selected:n,label:e}),u[e]=n}else if("tricksterAce"===n){const{category:e,uuid:a}=t.dataset,n=t.value,s=v("Trickster's Ace",{camel:"dromedary"}),r=await le(a,4,s);if(r){const e=ce("Trickster's Ace",s,i.classDC?.slug||i.class?.slug);f.push(r),f.push(e)}u[e]={name:n,uuid:a}}else if("trainedSkill"===n||"thaumaturgeTome"===n){const{input:e,category:a}=t.dataset,i=t.value,r=L(a)[0],o="thaumaturgeTome"===n?Number(t.dataset.rank):1,l="true"===e;if(l){const e=se(i,o);f.push(e)}else{const e=p.find((e=>s(e,r)));if(!e)continue;h(e).push(re(i.toLowerCase(),o))}const c={selected:l?i:i.toLowerCase(),input:l};if("trainedSkill"===n)b.skills.push({uuid:r,selected:i,label:a}),u[t.dataset.category]=c;else if("thaumaturgeTome"===n){const e=t.dataset.category;b.tome.push({selected:i,label:G[o]}),u[e]??=[],u[e].push(c)}}else if("mindSmith"===n){const{category:e,subcategory:n}=t.dataset,s=L(e),r=l(i,s[1],["weapon"]);if(!r)continue;if(u[e]??={},"damage"===n){const a=t.value;m.push({_id:r.id,"system.damage.damageType":a,"system.group":P[a]}),b.mind.push({selected:a,uuid:s[0],label:"mindsmith"}),u[e][n]=a}else if("trait"===n){const a=t.value,i=deepClone(r._source.system.traits?.value??[]);i.includes(a)||i.push(a),m.push({_id:r.id,"system.traits.value":i}),b.mind.push({selected:a,uuid:s[2],label:"mentalforge"}),u[e][n]=a}else if("rune"===n){const o=q(r);if(!o)continue;const l=t.value;m.push({_id:r.id,[`system.${o}.value`]:l}),b.mind.push({selected:l,uuid:s[3],label:"runicmind"}),u[e][n]=l,a(i,"weapon.runeProperty",o)}}else if("familiarAbility"===n){const e=t.dataset.category,a=t.value;i.familiar&&(y.push(t.value),b.familiar.push({uuid:X(a)})),u[e]??=[],u[e].push(a)}else{const a=t.dataset.category,i=L(a)[0],r=p.find((e=>s(e,i)));if(!r)continue;const o=h(r);if("addedLanguage"===n){const n=t.value;o.push({key:"ActiveEffectLike",mode:"add",path:"system.traits.languages.value",value:n,[e]:!0}),b.languages.push({uuid:i,selected:n,label:a}),u[t.dataset.category]=n}else if("addedResistance"===n){const e=t.value;o.push(oe(e,"half")),b.resistances.push({uuid:i,selected:e,label:a}),u[t.dataset.category]=e}else if("ganziHeritage"===n){const e=Array.from(t.options).map((e=>e.value)),n=await ne(e);o.push(oe(n,"half")),b.resistances.push({uuid:i,selected:n,label:a,random:!0}),u[t.dataset.category]=n}}}for(const[e,t]of g)m.push({_id:e,"system.rules":t});const w=(e,t)=>{if(!t.length)return;c&&(c+="<hr />");const a=ae.has(e)?ae(e):ae("gained",{type:e});c+=`<p><strong>${a}</strong></p>`;for(let{uuid:e,selected:a,label:n,random:s=!1}of t)n=n&&C(`label.${n}`)?k(`label.${n}`):n,n=Z(n),c+="<p>",c+=e?`${K(e,n)}`:`<strong>${n}</strong>`,a&&(c+=` <span style="text-transform: capitalize;">${a}</span>`),s&&(c+=' <i class="fa-solid fa-dice-d20"></i>'),c+="</p>"};if(i.familiar){const e=i.familiar,t=e.itemTypes.effect.map((e=>e.id));if(t.length&&e.deleteEmbeddedDocuments("Item",t),y.length){const t=V(),a=[];for(const e of y){const n=(await t.getDocument(e))?.toObject();n&&a.push(n)}a.length&&e.createEmbeddedDocuments("Item",a)}}if(f.length){const e=await i.createEmbeddedDocuments("Item",f);for(const a of e){const n=a.uuid;if("feat"===a.type)b.feats.push({uuid:n});else if("consumable"===a.type)b.scrolls.push({uuid:n});else if("spellcastingEntry"===a.type){const n=a.slug,s=e.filter((e=>"spell"===e.type&&t(e,"parent")===n));for(const e of s){const n=t(e,"level");m.push({_id:e.id,"system.location.value":a.id,"system.location.heightenedLevel":n}),b.spells.push({uuid:e.uuid})}}const s=a.getFlag("pf2e","grantedBy.id");if(s){const e=`flags.pf2e.itemGrants.${v(a.name,{camel:"dromedary"})}`;m.push({_id:s,[e]:{id:a.id,onDelete:"detach"}})}}}w("languages",b.languages),w("skills",b.skills),w("tome",b.tome),w("mindsmith",b.mind),w("resistances",b.resistances),w("feats",b.feats),w("spells",b.spells),w("scrolls",b.scrolls),w("familiar",b.familiar),m.length&&await i.updateEmbeddedDocuments("Item",m),await a(i,"saved",u),c=`${ae("changes")}<hr>${c}`,ChatMessage.create({content:c,speaker:ChatMessage.getSpeaker({actor:i})})}(this.element,this._actor)}catch(e){Le.error("error.unexpected"),console.error(e)}this.close()}}#a(e){e.preventDefault();const t=$(e.currentTarget),a=t.prevAll("input").first();a.val(""),a.attr("value",""),a.attr("data-uuid",""),t.addClass("disabled")}#s(e){e.preventDefault(),this.close()}}e||(e="pf2e-dailies"),Hooks.once("ready",(()=>{!function(){const n=game.pf2e.actions.restForTheNight;game.pf2e.actions.restForTheNight=async s=>{const i=await n(s);return i.length&&s.actors&&async function(n){const s=(n=Array.isArray(n)?n:[n]).filter((e=>e.isOfType("character")));for(const n of s){const s=[],i=[],r=n.itemTypes,o=t=>{const a=deepClone(t._source.system.rules);let n=!1;for(let t=a.length-1;t>=0;t--)e in a[t]&&(a.splice(t,1),n=!0);n&&s.push({_id:t.id,"system.rules":a})};for(const e of r.feat)if(O(e)&&o(e),t(e,"temporary")){const t=e.getFlag("pf2e","grantedBy.id");if(t){const a=`flags.pf2e.itemGrants.-=${v(e.name,{camel:"dromedary"})}`;s.push({_id:t,[a]:!0})}i.push(e.id)}for(const e of r.lore)t(e,"temporary")&&i.push(e.id);for(const e of r.equipment)O(e)&&o(e);for(const e of r.heritage)O(e)&&o(e);for(const e of r.spellcastingEntry)t(e,"temporary")&&i.push(e.id);const c=l(n,I,["weapon"]);if(c){let e=c._source.system.traits?.value??[];e=e.filter((e=>!z.includes(e))),s.push({_id:c.id,"system.traits.value":e});const a=t(n,"weapon.runeProperty");a&&s.push({_id:c.id,[`system.${a}.value`]:null})}a(n,"weapon.runeProperty",""),s.length&&n.updateEmbeddedDocuments("Item",s),i.length&&n.deleteEmbeddedDocuments("Item",i)}}(s.actors),i}}()})),Hooks.on("renderCharacterSheetPF2e",(function(e,t){const a=e.actor;if(!a.isOwner||!function(e){const t=e.itemTypes;return e.familiar||t.heritage.some((e=>i(e,R)))||t.feat.some((e=>i(e,A)))||t.equipment.some((e=>!(!1===e.isInvested)&&i(e,D)))}(a))return;const n=t.find("aside .sidebar .hitpoints .hp-small");n.append(`<a class="roll-icon dailies" title="${k("sheet.title")}"><i class="fas fa-mug-saucer"></i></a>`).find(".dailies").on("click",(()=>new DailiesInterface(a).render(!0))),n.find("[data-action=rest]").off("click").on("click",(e=>game.pf2e.actions.restForTheNight({event:e,actors:a})))}))})();
//# sourceMappingURL=main.js.map