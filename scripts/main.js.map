{
  "version": 3,
  "sources": ["../../../../../dev/module-api/foundry/document.js", "../../../../../dev/module-api/utils/array.js", "../../../../../dev/module-api/utils/object.js", "../../../../../dev/module-api/utils/string.js", "../../../../../dev/module-api/foundry/flags.js", "../../../../../dev/module-api/foundry/handlebars.js", "../../../../../dev/module-api/foundry/item.js", "../../../../../dev/module-api/foundry/libwrapper.js", "../../../../../dev/module-api/foundry/localize.js", "../../../../../dev/module-api/foundry/module.js", "../../../../../dev/module-api/foundry/notifications.js", "../../../../../dev/module-api/foundry/settings.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/purry.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/_reduceLazy.js", "../../../../../dev/module-api/node_modules/remeda/dist/es/uniq.js", "../../../../../dev/module-api/pf2e/misc.js", "../../../../../dev/module-api/pf2e/chat.js", "../../../../../dev/module-api/pf2e/dc.js", "../../../../../dev/module-api/pf2e/spell.js", "../../../../../dev/module-api/pf2e/identify.js", "../../../../../dev/module-api/pf2e/inline-roll.js", "../../../../../dev/module-api/pf2e/item.js", "../../../../../dev/module-api/pf2e/predicate.js", "../../../../../dev/module-api/pf2e/spell-consumables.js", "../src/data/spell.js", "../src/data/ace.js", "../src/data/blade.js", "../src/data/ceremonial.js", "../src/data/chain.js", "../src/data/flexibility.js", "../src/data/language.js", "../src/data/skill.js", "../src/data/longevity.js", "../src/data/mind.js", "../src/data/rations.js", "../src/data/resistance.js", "../src/data/root.js", "../src/data/staves.js", "../src/spellcasting.js", "../src/data/savant.js", "../src/data/spellshaping.js", "../src/data/tome.js", "../src/dailies.js", "../src/data/familiar.js", "../src/apps/interface/data.js", "../src/apps/interface/shared.js", "../src/apps/interface/drop.js", "../src/apps/interface/process.js", "../src/apps/interface.js", "../src/api.js", "../src/actor.js", "../src/data/feat.js", "../src/apps/custom/flexibility.js", "../src/apps/custom/mind.js", "../src/apps/custom/savant.js", "../src/apps/custom/tome.js", "../src/apps/custom.js", "../src/chat.js", "../src/rest.js", "../src/main.js"],
  "sourcesContent": ["import { MODULE, socketEmit } from \".\";\r\n\r\n/**\r\n * @param {object} doc\r\n * @param {string[]} path\r\n * @returns {unknown}\r\n */\r\nexport function getInMemory(doc, ...path) {\r\n\treturn getProperty(doc, `modules.${MODULE.id}.${path.join(\".\")}`);\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {Boolean}\r\n */\r\nexport function setInMemory(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\treturn setProperty(doc, `modules.${MODULE.id}.${args.join(\".\")}`, value);\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {unknown}\r\n */\r\nexport function getInMemoryAndSetIfNot(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\tconst current = getInMemory(doc, ...args);\r\n\tif (current != null) return current;\r\n\tconst result = typeof value === \"function\" ? value() : value;\r\n\tsetInMemory(doc, ...args, result);\r\n\treturn result;\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param {string[]} path\r\n * @returns {boolean}\r\n */\r\nexport function deleteInMemory(doc, ...path) {\r\n\tconst split = [\"modules\", MODULE.id, ...path.flatMap((x) => x.split(\".\"))];\r\n\tconst last = split.pop();\r\n\tlet cursor = doc;\r\n\tfor (const key of split) {\r\n\t\tcursor = cursor[key];\r\n\t\tif (!cursor) return true;\r\n\t}\r\n\treturn delete cursor[last];\r\n}\r\n\r\n/**\r\n * @param {object} options\r\n * @param {FoundryDocument} options.doc\r\n * @param {Record<string, unknown>} [options.updates]\r\n * @returns {Promise<void>}\r\n */\r\nexport async function updateDocument({ doc, updates, message }, userId) {\r\n\tconst foundryDoc =\r\n\t\tdoc instanceof foundry.abstract.Document ? doc : await fromUuid(doc);\r\n\r\n\tif (!foundryDoc.isOwner) {\r\n\t\tsocketEmit({\r\n\t\t\ttype: \"permission.update-document\",\r\n\t\t\tdoc: foundryDoc.uuid,\r\n\t\t\tupdates,\r\n\t\t\tmessage,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tfoundryDoc.update(updates);\r\n\r\n\tif (message) {\r\n\t\tmessage.user = userId ?? game.user.id;\r\n\t\tChatMessage.implementation.create(message);\r\n\t}\r\n}\r\n\r\n/** *\r\n * @param {foundry.Document} doc\r\n * @returns {string|undefined}\r\n */\r\nexport function getSourceId(doc) {\r\n\treturn doc.getFlag(\"core\", \"sourceId\");\r\n}\r\n\r\n/**\r\n * @param {foundry.Document} doc\r\n * @param {string|} list\r\n * @returns {boolean}\r\n */\r\nexport function includesSourceId(doc, list) {\r\n\tconst sourceId = getSourceId(doc);\r\n\treturn sourceId ? list.includes(sourceId) : false;\r\n}\r\n\r\n/**\r\n * @param {string|string[]} sourceId\r\n * @returns {(item: object) => boolean}\r\n */\r\nexport function getSourceIdCondition(sourceId) {\r\n\treturn Array.isArray(sourceId)\r\n\t\t? (item) => includesSourceId(item, sourceId)\r\n\t\t: (item) => getSourceId(item) === sourceId;\r\n}\r\n", "/**\r\n * @template T\r\n *\r\n * @param {T[]} arr\r\n * @param {(value: T) => unknown} fn\r\n * @param {string | number} [key]\r\n * @returns {Record<T, unknown>}\r\n */\r\n\r\nexport function arrayToObject(arr, fn, key) {\r\n\tconst obj = {};\r\n\tfor (const entry of arr) {\r\n\t\tconst k = Array.isArray(entry)\r\n\t\t\t? entry[key ?? 0]\r\n\t\t\t: typeof entry === \"object\" && key != null\r\n\t\t\t  ? entry[key]\r\n\t\t\t  : entry;\r\n\t\tobj[k] = fn(entry);\r\n\t}\r\n\treturn obj;\r\n}\r\n\r\n/**\r\n *\r\n * @param {unknown[]} arr1\r\n * @param {unknown[]} arr2\r\n * @returns {boolean}\r\n */\r\nexport function compareArrays(arr1, arr2) {\r\n\tif (arr1.length !== arr2.length) return false;\r\n\r\n\tconst clonedArr2 = arr2.slice();\r\n\r\n\tfor (const arr1Value of arr1) {\r\n\t\tconst index = clonedArr2.findIndex((arr2Value) => arr1Value === arr2Value);\r\n\t\tif (index === -1) return false;\r\n\t\tclonedArr2.splice(index, 1);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\n/**\r\n * @param {number | undefined} index\r\n * @returns {boolean}\r\n */\r\nexport function indexIsValid(index) {\r\n\treturn index !== undefined && index !== -1;\r\n}\r\n\r\n/**\r\n * @param {number} start\r\n * @param {number} end\r\n * @returns {number[]}\r\n */\r\nexport function sequenceArray(start, end) {\r\n\tconst levels = [];\r\n\r\n\tif (start <= end) {\r\n\t\tfor (let i = start; i <= end; i++) levels.push(i);\r\n\t} else {\r\n\t\tfor (let i = start; i >= end; i--) levels.push(i);\r\n\t}\r\n\r\n\treturn levels;\r\n}\r\n", "export const AsyncFunction = (async () => {}).constructor;\r\n\r\n/**\r\n * @param {object} obj\r\n * @param {string} name\r\n * @returns {boolean}\r\n */\r\nexport function isInstanceOf(obj, name) {\r\n\tif (typeof obj !== \"object\") return false;\r\n\r\n\tlet cursor = Reflect.getPrototypeOf(obj);\r\n\twhile (cursor) {\r\n\t\tif (cursor.constructor.name === name) return true;\r\n\t\tcursor = Reflect.getPrototypeOf(cursor);\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n", "/**\r\n * @param {string} separator\r\n * @param  {(string|string[])[]} path\r\n * @returns {string}\r\n */\r\nexport function joinStr(separator, ...path) {\r\n\tconst pathArr = Array.isArray(path[0]) ? path[0] : path;\r\n\treturn pathArr.filter((x) => typeof x === \"string\").join(separator);\r\n}\r\n\r\n/**\r\n * @param {string} str\r\n * @returns {string}\r\n */\r\nexport function capitalize(str) {\r\n\tif (!str) return \"\";\r\n\treturn str[0].toUpperCase() + str.slice(1);\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { joinStr } from \"../utils\";\r\n\r\n/**\r\n * @param  {string[]} path\r\n * @returns {string}\r\n */\r\nexport function flagPath(...path) {\r\n\treturn `flags.${MODULE.id}.${joinStr(\".\", path)}`;\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {string[]} path\r\n * @returns {unknown}\r\n */\r\nexport function getFlag(doc, ...path) {\r\n\treturn doc.getFlag(MODULE.id, path.join(\".\"));\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {string[]} path\r\n * @returns {unknown}\r\n */\r\nexport function getFlagProperty(doc, ...path) {\r\n\treturn getProperty(doc, flagPath(...path));\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {T} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {Promise<T>}\r\n */\r\nexport function setFlag(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\treturn doc.setFlag(MODULE.id, args.join(\".\"), value);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {T} doc\r\n * @param {string[]} path\r\n * @returns {Promise<T>}\r\n */\r\nexport function unsetFlag(doc, ...path) {\r\n\treturn doc.unsetFlag(MODULE.id, path.join(\".\"));\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @returns {unknown}\r\n */\r\nexport function getModuleFlags(doc) {\r\n\treturn getProperty(doc, `flags.${MODULE.id}`);\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {object}\r\n */\r\nexport function updateSourceFlag(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\treturn doc.updateSource({\r\n\t\t[flagPath(...args)]: value,\r\n\t});\r\n}\r\n\r\n/**\r\n * @param {object} updates\r\n * @param  {(string|unknown)[]} args\r\n */\r\nexport function moduleFlagUpdate(updates, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\tupdates[flagPath(...args)] = value;\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { joinStr } from \"../utils\";\r\n\r\n/**\r\n * @param  {(string|object)[]} args\r\n * @returns {Promise<string>}\r\n */\r\nexport function render(...args) {\r\n\tconst data = typeof args.at(-1) === \"object\" ? args.splice(-1)[0] : {};\r\n\tconst path = templatePath(...args);\r\n\treturn renderTemplate(path, data);\r\n}\r\n\r\n/**\r\n * @param  {string[]} path\r\n * @returns {string}\r\n */\r\nexport function templatePath(...path) {\r\n\treturn `modules/${MODULE.id}/templates/${joinStr(\"/\", path)}.hbs`;\r\n}\r\n", "import { getSourceIdCondition } from \"./document\";\r\n\r\n/**\r\n *\r\n * @param {object} actor\r\n * @param {string|string[]} itemTypes\r\n * @returns {object[]}\r\n */\r\nexport function getItems(actor, itemTypes = []) {\r\n\tconst types = typeof itemTypes === \"string\" ? [itemTypes] : itemTypes;\r\n\treturn types.length\r\n\t\t? types.flatMap((type) => actor.itemTypes[type])\r\n\t\t: actor.items;\r\n}\r\n\r\n/**\r\n * @param {object} actor\r\n * @param {string} sourceId\r\n * @param {string|string[]} itemTypes\r\n * @returns {boolean}\r\n */\r\nexport function hasItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).some(getSourceIdCondition(sourceId));\r\n}\r\n\r\n/**\r\n * @param {object} actor\r\n * @param {string} sourceId\r\n * @param {string|string[]} itemTypes\r\n * @returns {object} item\r\n */\r\nexport function getItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).find(getSourceIdCondition(sourceId));\r\n}\r\n", "import { MODULE } from \".\";\r\n\r\n/**\r\n * @param {string} path\r\n * @param {(...args: unknown[]) => unknown} callback\r\n * @param {\"WRAPPER\" | \"OVERRIDE\" | \"MIXED\"} type\r\n * @returns {string}\r\n */\r\nexport function registerWrapper(path, callback, type = \"WRAPPER\") {\r\n\treturn libWrapper.register(MODULE.id, path, callback, type);\r\n}\r\n\r\n/**\r\n * @param {string} id\r\n */\r\nexport function unregisterWrapper(id) {\r\n\tlibWrapper.unregister(MODULE.id, id);\r\n}\r\n", "import { MODULE, error, info, warn } from \".\";\r\nimport { joinStr } from \"../utils\";\r\n\r\n/**\r\n * @param {(string | object)[]} args\r\n * @returns {string}\r\n */\r\nexport function localize(...args) {\r\n\targs.unshift(MODULE.id);\r\n\tconst data = typeof args.at(-1) === \"object\" ? args.splice(-1)[0] : undefined;\r\n\treturn game.i18n[data ? \"format\" : \"localize\"](joinStr(\".\", args), data);\r\n}\r\n\r\n/**\r\n * Check if a module localization exists\r\n * @param {string[]} keys\r\n * @returns {boolean}\r\n */\r\nexport function hasLocalization(...keys) {\r\n\treturn game.i18n.has(`${MODULE.id}.${keys.join(\".\")}`, false);\r\n}\r\n\r\n/**\r\n * Used to localize in handlebars template\r\n * @param  {(string | {hash: object})[]} args\r\n * @returns {string}\r\n */\r\nexport function templateLocalize(...args) {\r\n\tconst data = args.splice(-1)[0].hash;\r\n\treturn localize(...args, data);\r\n}\r\n\r\n/**\r\n * @param  {string[]} path\r\n * @returns {string}\r\n */\r\nexport function localizePath(...path) {\r\n\treturn `${MODULE.id}.${path.join(\".\")}`;\r\n}\r\n\r\n/**\r\n * Convenient localization object with a sub context\r\n * @param {string} subKey\r\n * @returns {typeof localize & {path: typeof localizePath, template: typeof templateLocalize, warn: typeof warn, info: typeof info, error: typeof error, i18n: {i18n: typeof templateLocalize, i18Path: typeof localizePath}}}\r\n */\r\nexport function subLocalize(subKey) {\r\n\tconst fn = (...args) => localize(subKey, ...args);\r\n\r\n\tObject.defineProperties(fn, {\r\n\t\twarn: {\r\n\t\t\tvalue: (str, arg1, arg2) => warn(`${subKey}.${str}`, arg1, arg2),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tinfo: {\r\n\t\t\tvalue: (str, arg1, arg2) => info(`${subKey}.${str}`, arg1, arg2),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\terror: {\r\n\t\t\tvalue: (str, arg1, arg2) => error(`${subKey}.${str}`, arg1, arg2),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\thas: {\r\n\t\t\tvalue: (key) => hasLocalization(subKey, key),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tpath: {\r\n\t\t\tvalue: (key) => localizePath(subKey, key),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\ttemplate: {\r\n\t\t\tvalue: (key, { hash }) => fn(key, hash),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\ti18n: {\r\n\t\t\tget() {\r\n\t\t\t\treturn {\r\n\t\t\t\t\ti18n: this.template,\r\n\t\t\t\t\ti18Path: this.path,\r\n\t\t\t\t};\r\n\t\t\t},\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t});\r\n\r\n\treturn fn;\r\n}\r\n\r\n/**\r\n * @param {string} a\r\n * @param {string} b\r\n * @returns {number}\r\n */\r\nexport function localeCompare(a, b) {\r\n\treturn a.localeCompare(b, game.i18n.lang);\r\n}\r\n", "/**\r\n * @type {string}\r\n */\r\nlet MODULE_ID = null;\r\n\r\nexport const MODULE = {\r\n\tget id() {\r\n\t\tif (!MODULE_ID) {\r\n\t\t\tthrow new Error(\"Module id needs to be registered.\");\r\n\t\t}\r\n\t\treturn MODULE_ID;\r\n\t},\r\n\t/**\r\n\t * @param {string} str\r\n\t */\r\n\terror(str) {\r\n\t\tthrow new Error(`[${this.id}] ${str}`);\r\n\t},\r\n};\r\n\r\n/**\r\n * register the module id\r\n * @param {string} id\r\n */\r\nexport function registerModule(id) {\r\n\tMODULE_ID = id;\r\n}\r\n\r\n/**\r\n * @param {string} [id]\r\n * @returns {object}\r\n */\r\nexport function getModule(id) {\r\n\treturn game.modules.get(id ?? MODULE.id);\r\n}\r\n", "import { localize } from \"./localize\";\r\n\r\n/**\r\n * @param {string} str\r\n * @param {\"warning\" | \"info\" | \"error\" | object | boolean} [arg1]\r\n * @param {object | boolean} [arg2]\r\n * @param {boolean} [arg3]\r\n */\r\nfunction notify(str, arg1, arg2, arg3) {\r\n\tconst type = typeof arg1 === \"string\" ? arg1 : \"info\";\r\n\tconst data =\r\n\t\ttypeof arg1 === \"object\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"object\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : undefined;\r\n\tconst permanent =\r\n\t\ttypeof arg1 === \"boolean\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"boolean\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : arg3 ?? false;\r\n\r\n\tui.notifications.notify(localize(str, data), type, { permanent });\r\n}\r\n\r\n/**\r\n * @typedef { (str: string, arg1?: object | boolean, arg2?: boolean) => void } Notify\r\n */\r\n\r\n/**\r\n * @type {Notify}\r\n */\r\nexport function warn(str, arg1, arg2) {\r\n\tnotify(str, \"warning\", arg1, arg2);\r\n}\r\n\r\n/**\r\n * @type {Notify}\r\n */\r\nexport function info(str, arg1, arg2) {\r\n\tnotify(str, \"info\", arg1, arg2);\r\n}\r\n\r\n/**\r\n * @type {Notify}\r\n */\r\nexport function error(str, arg1, arg2) {\r\n\tnotify(str, \"error\", arg1, arg2);\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { arrayToObject } from \"../utils/array\";\r\n\r\n/**\r\n * @template {number | boolean | string} T\r\n * @param { {key: string, type: new (...args: unknkown[]) => T, default: T, [k: string]: unknown }} options\r\n */\r\nexport function registerSetting(options) {\r\n\toptions.key ??= options.name;\r\n\r\n\tif (Array.isArray(options.choices)) {\r\n\t\toptions.choices = arrayToObject(options.choices, (choice) =>\r\n\t\t\tsettingPath(options.key, \"choices\", choice),\r\n\t\t);\r\n\t}\r\n\r\n\toptions.name = settingPath(options.key, \"name\");\r\n\toptions.hint = settingPath(options.key, \"hint\");\r\n\toptions.scope ??= \"world\";\r\n\toptions.config ??= true;\r\n\r\n\tgame.settings.register(MODULE.id, options.key, options);\r\n}\r\n\r\nexport function registerSettingMenu(options) {\r\n\toptions.key ??= options.name;\r\n\r\n\toptions.name = settingPath(\"menus\", options.key, \"name\");\r\n\toptions.label = settingPath(\"menus\", options.key, \"label\");\r\n\toptions.hint = settingPath(\"menus\", options.key, \"hint\");\r\n\toptions.restricted ??= true;\r\n\toptions.icon ??= \"fas fa-cogs\";\r\n\r\n\tgame.settings.registerMenu(MODULE.id, options.key, options);\r\n}\r\n\r\n/**\r\n * @param {string[]} path\r\n * @returns\r\n */\r\nexport function settingPath(...path) {\r\n\treturn `${MODULE.id}.settings.${path.join(\".\")}`;\r\n}\r\n\r\n/**\r\n * @param {string} setting\r\n * @returns {unknown}\r\n */\r\nexport function getSetting(setting) {\r\n\treturn game.settings.get(MODULE.id, setting);\r\n}\r\n\r\n/**\r\n * @param {string} setting\r\n * @returns {boolean}\r\n */\r\nexport function isChoiceSetting(setting) {\r\n\treturn !!game.settings.settings.get(`${MODULE.id}.${setting}`)?.choices;\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {string} setting\r\n * @param {T} value\r\n * @returns {Promise<T>}\r\n */\r\nexport function setSetting(setting, value) {\r\n\treturn game.settings.set(MODULE.id, setting, value);\r\n}\r\n", "var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n        if (ar || !(i in from)) {\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n            ar[i] = from[i];\n        }\n    }\n    return to.concat(ar || Array.prototype.slice.call(from));\n};\nexport function purry(fn, args, lazy) {\n    var diff = fn.length - args.length;\n    var arrayArgs = Array.from(args);\n    if (diff === 0) {\n        return fn.apply(void 0, arrayArgs);\n    }\n    if (diff === 1) {\n        var ret = function (data) { return fn.apply(void 0, __spreadArray([data], arrayArgs, false)); };\n        if (lazy || fn.lazy) {\n            ret.lazy = lazy || fn.lazy;\n            ret.lazyArgs = args;\n        }\n        return ret;\n    }\n    throw new Error('Wrong number of arguments');\n}\n", "export function _reduceLazy(array, lazy, indexed) {\n    var newArray = [];\n    for (var index = 0; index < array.length; index++) {\n        var item = array[index];\n        var result = indexed ? lazy(item, index, array) : lazy(item);\n        if (result.hasMany === true) {\n            newArray.push.apply(newArray, result.next);\n        }\n        else if (result.hasNext) {\n            newArray.push(result.next);\n        }\n    }\n    return newArray;\n}\n", "import { purry } from './purry';\nimport { _reduceLazy } from './_reduceLazy';\nexport function uniq() {\n    return purry(_uniq, arguments, uniq.lazy);\n}\nfunction _uniq(array) {\n    return _reduceLazy(array, uniq.lazy());\n}\n(function (uniq) {\n    function lazy() {\n        var set = new Set();\n        return function (value) {\n            if (set.has(value)) {\n                return {\n                    done: false,\n                    hasNext: false,\n                };\n            }\n            set.add(value);\n            return {\n                done: false,\n                hasNext: true,\n                next: value,\n            };\n        };\n    }\n    uniq.lazy = lazy;\n})(uniq || (uniq = {}));\n", "/**\r\n * @param {number} value\r\n * @returns {string}\r\n */\r\nexport function ordinalString(value) {\r\n\tconst pluralRules = new Intl.PluralRules(game.i18n.lang, { type: \"ordinal\" });\r\n\tconst suffix = game.i18n.localize(\r\n\t\t`PF2E.OrdinalSuffixes.${pluralRules.select(value)}`,\r\n\t);\r\n\treturn game.i18n.format(\"PF2E.OrdinalNumber\", { value, suffix });\r\n}\r\n\r\n/**\r\n * @param {string} message\r\n * @returns {Error}\r\n */\r\nexport function ErrorPF2e(message) {\r\n\treturn Error(`PF2e System | ${message}`);\r\n}\r\n\r\n/**\r\n * @type {Intl.NumberFormat}\r\n */\r\nlet intlNumberFormat;\r\n/**\r\n * @param {number} value\r\n * @param {object} [options]\r\n * @param {boolean} [options.emptyStringZero]\r\n * @param {boolean} [options.zeroIsNegative]\r\n * @returns {string}\r\n */\r\nexport function signedInteger(\r\n\tvalue,\r\n\t{ emptyStringZero = false, zeroIsNegative = false } = {},\r\n) {\r\n\tif (value === 0 && emptyStringZero) return \"\";\r\n\r\n\tintlNumberFormat ??= new Intl.NumberFormat(game.i18n.lang, {\r\n\t\tmaximumFractionDigits: 0,\r\n\t\tsignDisplay: \"always\",\r\n\t});\r\n\r\n\tconst maybeNegativeZero = zeroIsNegative && value === 0 ? -0 : value;\r\n\r\n\treturn intlNumberFormat.format(maybeNegativeZero);\r\n}\r\n\r\n/**\r\n * @param {object} obj\r\n * @param {unknown} key\r\n * @returns {boolean}\r\n */\r\nexport function objectHasKey(obj, key) {\r\n\treturn (typeof key === \"string\" || typeof key === \"number\") && key in obj;\r\n}\r\n\r\n/**\r\n * @param {string} prefix\r\n * @returns {(...args: (string|Record<string, unknown>)[]) => string}\r\n */\r\nexport function localizer(prefix) {\r\n\treturn (...[suffix, formatArgs]) =>\r\n\t\tformatArgs\r\n\t\t\t? game.i18n.format(`${prefix}.${suffix}`, formatArgs)\r\n\t\t\t: game.i18n.localize(`${prefix}.${suffix}`);\r\n}\r\n\r\nconst actionGlyphMap = {\r\n\t0: \"F\",\r\n\tfree: \"F\",\r\n\t1: \"A\",\r\n\t2: \"D\",\r\n\t3: \"T\",\r\n\t\"1 or 2\": \"A/D\",\r\n\t\"1 to 3\": \"A - T\",\r\n\t\"2 or 3\": \"D/T\",\r\n\treaction: \"R\",\r\n};\r\n\r\n/**\r\n * @param {typeof actionGlyphMap} action\r\n * @returns {string}\r\n */\r\nexport function getActionGlyph(action) {\r\n\tif (!action && action !== 0) return \"\";\r\n\r\n\tconst value =\r\n\t\ttypeof action !== \"object\"\r\n\t\t\t? action\r\n\t\t\t: action.type === \"action\"\r\n\t\t\t  ? action.value\r\n\t\t\t  : action.type;\r\n\tconst sanitized = String(value ?? \"\")\r\n\t\t.toLowerCase()\r\n\t\t.trim();\r\n\r\n\treturn actionGlyphMap[sanitized]?.replace(\"-\", \"\u2013\") ?? \"\";\r\n}\r\n\r\nconst actionImgMap = {\r\n\t0: \"systems/pf2e/icons/actions/FreeAction.webp\",\r\n\tfree: \"systems/pf2e/icons/actions/FreeAction.webp\",\r\n\t1: \"systems/pf2e/icons/actions/OneAction.webp\",\r\n\t2: \"systems/pf2e/icons/actions/TwoActions.webp\",\r\n\t3: \"systems/pf2e/icons/actions/ThreeActions.webp\",\r\n\t\"1 or 2\": \"systems/pf2e/icons/actions/OneTwoActions.webp\",\r\n\t\"1 to 3\": \"systems/pf2e/icons/actions/OneThreeActions.webp\",\r\n\t\"2 or 3\": \"systems/pf2e/icons/actions/TwoThreeActions.webp\",\r\n\treaction: \"systems/pf2e/icons/actions/Reaction.webp\",\r\n\tpassive: \"systems/pf2e/icons/actions/Passive.webp\",\r\n};\r\n\r\n/**\r\n *\r\n * @param {string | {type: string, value: 1|2|3|null} | null} action\r\n * @param {string} [fallback]\r\n * @returns {string|null}\r\n */\r\nexport function getActionIcon(\r\n\taction,\r\n\tfallback = \"systems/pf2e/icons/actions/Empty.webp\",\r\n) {\r\n\tif (action === null) return actionImgMap.passive;\r\n\tconst value =\r\n\t\ttypeof action !== \"object\"\r\n\t\t\t? action\r\n\t\t\t: action.type === \"action\"\r\n\t\t\t  ? action.value\r\n\t\t\t  : action.type;\r\n\tconst sanitized = String(value ?? \"\")\r\n\t\t.toLowerCase()\r\n\t\t.trim();\r\n\treturn actionImgMap[sanitized] ?? fallback;\r\n}\r\n\r\n/**\r\n * @param {string} text\r\n * @param {object} [options]\r\n * @param {boolean|null} [options.camel]\r\n * @returns {string}\r\n */\r\nexport function sluggify(text, options) {\r\n\treturn game.pf2e.system.sluggify(text, options);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {Set<T>} set\r\n * @param {T} value\r\n * @returns {boolean}\r\n */\r\nexport function setHasElement(set, value) {\r\n\treturn set.has(value);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {[T, T]} array\r\n * @param {T} value\r\n * @returns {boolean}\r\n */\r\nexport function tupleHasValue(array, value) {\r\n\treturn array.includes(value);\r\n}\r\n\r\n/**\r\n * @param {unknown} value\r\n * @returns {boolean}\r\n */\r\nexport function isObject(value) {\r\n\treturn typeof value === \"object\" && value !== null;\r\n}\r\n", "import { getHighestName } from \"../foundry\";\r\nimport { isInstanceOf } from \"../utils\";\r\nimport { htmlQuery } from \"./html\";\r\nimport { ErrorPF2e, getActionGlyph } from \"./misc\";\r\nimport { extractEphemeralEffects } from \"./rules\";\r\nimport { traitSlugToObject } from \"./tags\";\r\n\r\n/**\r\n * @typedef {(message: object, tokens: object[], rollIndex: number) => void} OnDamageApplied\r\n *\r\n * @param {object} options\r\n * @param {object} options.message\r\n * @param {number} options.multiplier\r\n * @param {number} options.addend\r\n * @param {boolean} options.promptModifier\r\n * @param {number} options.rollIndex\r\n * @param {object[]} [options.tokens]\r\n * @param {OnDamageApplied} [options.onDamageApplied]\r\n */\r\nexport async function applyDamageFromMessage({\r\n\tmessage,\r\n\tmultiplier = 1,\r\n\taddend = 0,\r\n\tpromptModifier = false,\r\n\trollIndex = 0,\r\n\t// added\r\n\ttokens,\r\n\tonDamageApplied,\r\n}) {\r\n\tif (promptModifier) {\r\n\t\treturn shiftAdjustDamage({\r\n\t\t\tmessage,\r\n\t\t\tmultiplier,\r\n\t\t\trollIndex,\r\n\t\t\t// added\r\n\t\t\ttokens,\r\n\t\t\tonDamageApplied,\r\n\t\t});\r\n\t}\r\n\r\n\t// changed\r\n\ttokens ??= (() => {\r\n\t\tconst html = htmlQuery(\r\n\t\t\tui.chat.element[0],\r\n\t\t\t`li.chat-message[data-message-id=\"${message.id}\"]`,\r\n\t\t);\r\n\t\treturn html?.dataset.actorIsTarget && message.token\r\n\t\t\t? [message.token]\r\n\t\t\t: game.user.getActiveTokens();\r\n\t})();\r\n\tif (tokens.length === 0) {\r\n\t\tui.notifications.error(\"PF2E.ErrorMessage.NoTokenSelected\", {\r\n\t\t\tlocalize: true,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst shieldBlockRequest = CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\tconst roll = message.rolls.at(rollIndex);\r\n\tif (!isInstanceOf(roll, \"DamageRoll\"))\r\n\t\tthrow ErrorPF2e(\"Unexpected error retrieving damage roll\");\r\n\r\n\tconst damage =\r\n\t\tmultiplier < 0\r\n\t\t\t? multiplier * roll.total + addend\r\n\t\t\t: roll.alter(multiplier, addend);\r\n\r\n\t// Get origin roll options and apply damage to a contextual clone: this may influence condition IWR, for example\r\n\tconst messageRollOptions = [...(message.flags.pf2e.context?.options ?? [])];\r\n\tconst originRollOptions = messageRollOptions\r\n\t\t.filter((o) => o.startsWith(\"self:\"))\r\n\t\t.map((o) => o.replace(/^self/, \"origin\"));\r\n\tconst messageItem = message.item;\r\n\tconst effectRollOptions = messageItem?.isOfType(\r\n\t\t\"affliction\",\r\n\t\t\"condition\",\r\n\t\t\"effect\",\r\n\t)\r\n\t\t? messageItem.getRollOptions(\"item\")\r\n\t\t: [];\r\n\r\n\tfor (const token of tokens) {\r\n\t\tif (!token.actor) continue;\r\n\r\n\t\t// If no target was acquired during a roll, set roll options for it during damage application\r\n\t\tif (!messageRollOptions.some((o) => o.startsWith(\"target\"))) {\r\n\t\t\tmessageRollOptions.push(...token.actor.getSelfRollOptions(\"target\"));\r\n\t\t}\r\n\t\tconst domain = multiplier > 0 ? \"damage-received\" : \"healing-received\";\r\n\t\tconst ephemeralEffects =\r\n\t\t\tmultiplier > 0\r\n\t\t\t\t? await extractEphemeralEffects({\r\n\t\t\t\t\t\taffects: \"target\",\r\n\t\t\t\t\t\torigin: message.actor,\r\n\t\t\t\t\t\ttarget: token.actor,\r\n\t\t\t\t\t\titem: message.item,\r\n\t\t\t\t\t\tdomains: [domain],\r\n\t\t\t\t\t\toptions: messageRollOptions,\r\n\t\t\t\t  })\r\n\t\t\t\t: [];\r\n\t\tconst contextClone = token.actor.getContextualClone(\r\n\t\t\toriginRollOptions,\r\n\t\t\tephemeralEffects,\r\n\t\t);\r\n\t\tconst rollOptions = new Set([\r\n\t\t\t...messageRollOptions.filter((o) => !/^(?:self|target):/.test(o)),\r\n\t\t\t...effectRollOptions,\r\n\t\t\t...originRollOptions,\r\n\t\t\t...contextClone.getSelfRollOptions(),\r\n\t\t]);\r\n\r\n\t\tawait contextClone.applyDamage({\r\n\t\t\tdamage,\r\n\t\t\ttoken,\r\n\t\t\titem: message.item,\r\n\t\t\tskipIWR: multiplier <= 0,\r\n\t\t\trollOptions,\r\n\t\t\tshieldBlockRequest,\r\n\t\t\toutcome: message.flags.pf2e.context?.outcome,\r\n\t\t});\r\n\t}\r\n\ttoggleOffShieldBlock(message.id);\r\n\r\n\t// added\r\n\tonDamageApplied?.(message, tokens, rollIndex);\r\n}\r\n\r\n/**\r\n * @param {object} target\r\n * @param {HTMLElement} shieldButton\r\n * @param {HTMLElement} messageEl\r\n */\r\nexport function onClickShieldBlock(target, shieldButton, messageEl) {\r\n\t// changed\r\n\tconst getTokens = () => {\r\n\t\treturn [target];\r\n\t};\r\n\tconst getNonBrokenShields = (tokens) => {\r\n\t\tconst actor = tokens[0]?.actor;\r\n\t\treturn (\r\n\t\t\tactor?.itemTypes.shield.filter(\r\n\t\t\t\t(s) => s.isEquipped && !s.isBroken && !s.isDestroyed,\r\n\t\t\t) ?? []\r\n\t\t);\r\n\t};\r\n\r\n\t// Add a tooltipster instance to the shield button if needed.\r\n\tif (!shieldButton.classList.contains(\"tooltipstered\")) {\r\n\t\t$(shieldButton)\r\n\t\t\t.tooltipster({\r\n\t\t\t\tanimation: \"fade\",\r\n\t\t\t\ttrigger: \"click\",\r\n\t\t\t\tarrow: false,\r\n\t\t\t\tcontent: htmlQuery(messageEl, \"div.hover-content\"),\r\n\t\t\t\tcontentAsHTML: true,\r\n\t\t\t\tcontentCloning: true,\r\n\t\t\t\tdebug: false,\r\n\t\t\t\tinteractive: true,\r\n\t\t\t\tside: [\"top\"],\r\n\t\t\t\ttheme: \"crb-hover\",\r\n\t\t\t\tfunctionBefore: () => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tif (!tokens.length) return false;\r\n\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst hasMultipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// More than one shield and no selection. Show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && !shieldActivated) {\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// More than one shield and one was previously selected. Remove selection and show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && shieldButton.dataset.shieldId) {\r\n\t\t\t\t\t\tshieldButton.attributes.removeNamedItem(\"data-shield-id\");\r\n\t\t\t\t\t\tshieldButton.classList.remove(\"shield-activated\");\r\n\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Normal toggle behaviour. Tooltip is suppressed.\r\n\t\t\t\t\tshieldButton.classList.toggle(\"shield-activated\");\r\n\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle =\r\n\t\t\t\t\t\t!CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t},\r\n\t\t\t\tfunctionFormat: (instance, _helper, contentEl) => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst multipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// If the actor is wielding more than one shield, have the user pick which shield to use for blocking.\r\n\t\t\t\t\tif (multipleShields && !shieldActivated) {\r\n\t\t\t\t\t\t// Populate the list with the shield options\r\n\t\t\t\t\t\tconst listEl = htmlQuery(contentEl, \"ul.shield-options\");\r\n\t\t\t\t\t\tif (!listEl) return $(contentEl);\r\n\r\n\t\t\t\t\t\tconst shieldList = nonBrokenShields.map((shield) => {\r\n\t\t\t\t\t\t\tconst input = document.createElement(\"input\");\r\n\t\t\t\t\t\t\tinput.classList.add(\"data\");\r\n\t\t\t\t\t\t\tinput.type = \"radio\";\r\n\t\t\t\t\t\t\tinput.name = \"shield-id\";\r\n\t\t\t\t\t\t\tinput.value = shield.id;\r\n\t\t\t\t\t\t\tinput.addEventListener(\"click\", () => {\r\n\t\t\t\t\t\t\t\tshieldButton.dataset.shieldId = input.value;\r\n\t\t\t\t\t\t\t\tshieldButton.classList.add(\"shield-activated\");\r\n\t\t\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = true;\r\n\t\t\t\t\t\t\t\tinstance.close();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tconst shieldName = document.createElement(\"span\");\r\n\t\t\t\t\t\t\tshieldName.classList.add(\"label\");\r\n\t\t\t\t\t\t\tshieldName.innerHTML = shield.name;\r\n\r\n\t\t\t\t\t\t\tconst hardness = document.createElement(\"span\");\r\n\t\t\t\t\t\t\thardness.classList.add(\"tag\");\r\n\t\t\t\t\t\t\tconst hardnessLabel = game.i18n.localize(\"PF2E.HardnessLabel\");\r\n\t\t\t\t\t\t\thardness.innerHTML = `${hardnessLabel}: ${shield.hardness}`;\r\n\r\n\t\t\t\t\t\t\tconst itemLi = document.createElement(\"li\");\r\n\t\t\t\t\t\t\titemLi.classList.add(\"item\");\r\n\t\t\t\t\t\t\titemLi.append(input, shieldName, hardness);\r\n\r\n\t\t\t\t\t\t\treturn itemLi;\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tlistEl.replaceChildren(...shieldList);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn $(contentEl);\r\n\t\t\t\t},\r\n\t\t\t})\r\n\t\t\t.tooltipster(\"open\");\r\n\t}\r\n}\r\n\r\n/**\r\n * adapted to toggle multiple buttons\r\n * @param {string} messageId\r\n */\r\nexport function toggleOffShieldBlock(messageId) {\r\n\tfor (const app of [\"#chat-log\", \"#chat-popout\"]) {\r\n\t\tconst selector = `${app} > li.chat-message[data-message-id=\"${messageId}\"] button[data-action$=shield-block]`;\r\n\t\tfor (const button of document.body.querySelectorAll(selector)) {\r\n\t\t\tbutton?.classList.remove(\"shield-activated\");\r\n\t\t}\r\n\t}\r\n\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n}\r\n\r\n/**\r\n * @param {object} options\r\n * @param {object} options.message\r\n * @param {number} options.multiplier\r\n * @param {number} options.rollIndex\r\n * @param {object[]} [options.tokens]\r\n * @param {OnDamageApplied} [options.onDamageApplied]\r\n */\r\nasync function shiftAdjustDamage({\r\n\tmessage,\r\n\tmultiplier,\r\n\trollIndex,\r\n\t// added\r\n\ttokens,\r\n\tonDamageApplied,\r\n}) {\r\n\tconst content = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/damage/adjustment-dialog.hbs\",\r\n\t);\r\n\tconst AdjustmentDialog = class extends Dialog {\r\n\t\tactivateListeners($html) {\r\n\t\t\tsuper.activateListeners($html);\r\n\t\t\t$html[0].querySelector(\"input\")?.focus();\r\n\t\t}\r\n\t};\r\n\tconst isHealing = multiplier < 0;\r\n\tnew AdjustmentDialog({\r\n\t\ttitle: game.i18n.localize(\r\n\t\t\tisHealing\r\n\t\t\t\t? \"PF2E.UI.shiftModifyHealingTitle\"\r\n\t\t\t\t: \"PF2E.UI.shiftModifyDamageTitle\",\r\n\t\t),\r\n\t\tcontent,\r\n\t\tbuttons: {\r\n\t\t\tok: {\r\n\t\t\t\tlabel: game.i18n.localize(\"PF2E.OK\"),\r\n\t\t\t\tcallback: async ($dialog) => {\r\n\t\t\t\t\t// In case of healing, multipler will have negative sign. The user will expect that positive\r\n\t\t\t\t\t// modifier would increase healing value, while negative would decrease.\r\n\t\t\t\t\tconst adjustment =\r\n\t\t\t\t\t\t(Number($dialog[0].querySelector(\"input\")?.value) || 0) *\r\n\t\t\t\t\t\tMath.sign(multiplier);\r\n\t\t\t\t\tapplyDamageFromMessage({\r\n\t\t\t\t\t\tmessage,\r\n\t\t\t\t\t\tmultiplier,\r\n\t\t\t\t\t\taddend: adjustment,\r\n\t\t\t\t\t\tpromptModifier: false,\r\n\t\t\t\t\t\trollIndex,\r\n\t\t\t\t\t\t// added\r\n\t\t\t\t\t\ttokens,\r\n\t\t\t\t\t\tonDamageApplied,\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tcancel: {\r\n\t\t\t\tlabel: \"Cancel\",\r\n\t\t\t},\r\n\t\t},\r\n\t\tdefault: \"ok\",\r\n\t\tclose: () => {\r\n\t\t\ttoggleOffShieldBlock(message.id);\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n\r\n/**\r\n * @param {Item} item\r\n * @param {string} rollMode\r\n * @returns {ChatMessage}\r\n */\r\nexport async function createSelfEffectMessage(item, rollMode = \"roll\") {\r\n\tif (!item.system.selfEffect) {\r\n\t\tthrow ErrorPF2e(\r\n\t\t\t[\r\n\t\t\t\t\"Only actions with self-applied effects can be passed to `ActorPF2e#useAction`.\",\r\n\t\t\t\t\"Support will be expanded at a later time.\",\r\n\t\t\t].join(\" \"),\r\n\t\t);\r\n\t}\r\n\r\n\tconst { actor, actionCost } = item;\r\n\tconst token = actor.getActiveTokens(true, true).shift() ?? null;\r\n\r\n\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\tconst speaker = ChatMessagePF2e.getSpeaker({ actor, token });\r\n\tconst flavor = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/action/flavor.hbs\",\r\n\t\t{\r\n\t\t\taction: { title: item.name, glyph: getActionGlyph(actionCost) },\r\n\t\t\titem,\r\n\t\t\ttraits: item.system.traits.value.map((t) =>\r\n\t\t\t\ttraitSlugToObject(t, CONFIG.PF2E.actionTraits),\r\n\t\t\t),\r\n\t\t},\r\n\t);\r\n\r\n\t// Get a preview slice of the message\r\n\tconst previewLength = 100;\r\n\tconst descriptionPreview = (() => {\r\n\t\tif (item.actor.pack) return null;\r\n\t\tconst tempDiv = document.createElement(\"div\");\r\n\t\tconst documentTypes = [...CONST.DOCUMENT_LINK_TYPES, \"Compendium\", \"UUID\"];\r\n\t\tconst linkPattern = new RegExp(\r\n\t\t\t`@(${documentTypes.join(\r\n\t\t\t\t\"|\",\r\n\t\t\t)})\\\\[([^#\\\\]]+)(?:#([^\\\\]]+))?](?:{([^}]+)})?`,\r\n\t\t\t\"g\",\r\n\t\t);\r\n\t\ttempDiv.innerHTML = item.description.replace(\r\n\t\t\tlinkPattern,\r\n\t\t\t(_match, ...args) => args[3],\r\n\t\t);\r\n\r\n\t\treturn tempDiv.innerText.slice(0, previewLength);\r\n\t})();\r\n\tconst description = {\r\n\t\tfull:\r\n\t\t\tdescriptionPreview && descriptionPreview.length < previewLength\r\n\t\t\t\t? item.description\r\n\t\t\t\t: null,\r\n\t\tpreview: descriptionPreview,\r\n\t};\r\n\tconst content = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/action/self-effect.hbs\",\r\n\t\t{\r\n\t\t\tactor: item.actor,\r\n\t\t\tdescription,\r\n\t\t},\r\n\t);\r\n\tconst flags = { pf2e: { context: { type: \"self-effect\", item: item.id } } };\r\n\tconst messageData = ChatMessagePF2e.applyRollMode(\r\n\t\t{ speaker, flavor, content, flags },\r\n\t\trollMode,\r\n\t);\r\n\r\n\treturn ChatMessagePF2e.create(messageData);\r\n}\r\n\r\n/**\r\n * @param {string} subtitle\r\n * @returns {Promise<string>}\r\n */\r\nexport function createManipulateFlavor(subtitle) {\r\n\treturn renderTemplate(\"systems/pf2e/templates/chat/action/flavor.hbs\", {\r\n\t\taction: {\r\n\t\t\ttitle: \"PF2E.Actions.Interact.Title\",\r\n\t\t\tsubtitle: subtitle,\r\n\t\t\tglyph: getActionGlyph(1),\r\n\t\t},\r\n\t\ttraits: [\r\n\t\t\t{\r\n\t\t\t\tname: \"manipulate\",\r\n\t\t\t\tlabel: CONFIG.PF2E.featTraits.manipulate,\r\n\t\t\t\tdescription: CONFIG.PF2E.traitsDescriptions.manipulate,\r\n\t\t\t},\r\n\t\t],\r\n\t});\r\n}\r\n\r\n/**\r\n * @param {string} message\r\n * @param {string} img\r\n * @returns {Promise<string>}\r\n */\r\nexport function createTradeContent(message, img) {\r\n\treturn renderTemplate(\"systems/pf2e/templates/chat/action/content.hbs\", {\r\n\t\timgPath: img,\r\n\t\tmessage: message.replace(/\\b1 \u00D7 /, \"\"),\r\n\t});\r\n}\r\n\r\n/**\r\n * @param {foundry.Document|string} docOrUuid\r\n * @param {object} [options]\r\n * @param {boolean} [options.async]\r\n * @param {string} [options.label]\r\n * @returns {Promise<string>}\r\n */\r\nexport function createFancyLink(docOrUuid, { async = true, label } = {}) {\r\n\tlet link =\r\n\t\tdocOrUuid instanceof foundry.abstract.Document\r\n\t\t\t? docOrUuid.link\r\n\t\t\t: `@UUID[${docOrUuid}]`;\r\n\tif (label) {\r\n\t\tlink = link.replace(/\\{.+?\\}$/, \"\");\r\n\t\tlink = `${link}{${label}}`;\r\n\t}\r\n\treturn TextEditor.enrichHTML(link, { async });\r\n}\r\n\r\n/**\r\n *\r\n * @param {string} subtitle\r\n * @param {string} content\r\n * @param {Actor} actor\r\n * @param {string} [senderId]\r\n * @returns {Promise<ChatMessage>}\r\n */\r\nexport async function createManipulationMessage(\r\n\tsubtitle,\r\n\tcontent,\r\n\tactor,\r\n\tsenderId,\r\n) {\r\n\treturn ChatMessage.implementation.create({\r\n\t\tuser: senderId ?? game.user.id,\r\n\t\tspeaker: ChatMessage.getSpeaker({\r\n\t\t\tactor,\r\n\t\t\talias: getHighestName(actor),\r\n\t\t}),\r\n\t\tflavor: await createManipulateFlavor(subtitle),\r\n\t\tcontent: content,\r\n\t\ttype: CONST.CHAT_MESSAGE_TYPES.EMOTE,\r\n\t});\r\n}\r\n\r\n/**\r\n *\r\n * @param {string} subtitle\r\n * @param {string} message\r\n * @param {Actor} actor\r\n * @param {Item} item\r\n * @param {string} [senderId]\r\n * @returns {Promise<ChatMessage>}\r\n */\r\nexport async function createTradeMessage(\r\n\tsubtitle,\r\n\tmessage,\r\n\tactor,\r\n\titem,\r\n\tsenderId,\r\n) {\r\n\tconst content = await createTradeContent(message, item.img);\r\n\treturn createManipulationMessage(subtitle, content, actor, senderId);\r\n}\r\n", "export const adjustmentScale = [\r\n\t\"incredibly-easy\",\r\n\t\"very-easy\",\r\n\t\"easy\",\r\n\t\"normal\",\r\n\t\"hard\",\r\n\t\"very-hard\",\r\n\t\"incredibly-hard\",\r\n];\r\n\r\nexport const dcAdjustments = new Map([\r\n\t[\"incredibly-easy\", -10],\r\n\t[\"very-easy\", -5],\r\n\t[\"easy\", -2],\r\n\t[\"normal\", 0],\r\n\t[\"hard\", 2],\r\n\t[\"very-hard\", 5],\r\n\t[\"incredibly-hard\", 10],\r\n]);\r\n\r\nexport const dcByLevel = new Map([\r\n\t[-1, 13],\r\n\t[0, 14],\r\n\t[1, 15],\r\n\t[2, 16],\r\n\t[3, 18],\r\n\t[4, 19],\r\n\t[5, 20],\r\n\t[6, 22],\r\n\t[7, 23],\r\n\t[8, 24],\r\n\t[9, 26],\r\n\t[10, 27],\r\n\t[11, 28],\r\n\t[12, 30],\r\n\t[13, 31],\r\n\t[14, 32],\r\n\t[15, 34],\r\n\t[16, 35],\r\n\t[17, 36],\r\n\t[18, 38],\r\n\t[19, 39],\r\n\t[20, 40],\r\n\t[21, 42],\r\n\t[22, 44],\r\n\t[23, 46],\r\n\t[24, 48],\r\n\t[25, 50],\r\n]);\r\n\r\nexport const simpleDCs = new Map([\r\n\t[\"untrained\", 10],\r\n\t[\"trained\", 15],\r\n\t[\"expert\", 20],\r\n\t[\"master\", 30],\r\n\t[\"legendary\", 40],\r\n]);\r\n\r\nexport const simpleDCsWithoutLevel = new Map([\r\n\t[\"untrained\", 10],\r\n\t[\"trained\", 15],\r\n\t[\"expert\", 20],\r\n\t[\"master\", 25],\r\n\t[\"legendary\", 30],\r\n]);\r\n\r\n/**\r\n * @typedef {\"untrained\" | \"trained\" | \"expert\" | \"master\" | \"legendary\"} Rank\r\n */\r\n\r\n/**\r\n * @typedef {\"common\" | \"uncommon\" | \"rare\" | \"unique\"} Rarity\r\n */\r\n\r\n/**\r\n * @param {number} level\r\n * @returns {number}\r\n */\r\nexport function getDcByLevel(level) {\r\n\tconst clamped = Math.clamped(level, -1, 25);\r\n\treturn dcByLevel.get(clamped);\r\n}\r\n\r\n/**\r\n * @param {number} level\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @param {Rarity} [options.rarity]\r\n * @returns {number}\r\n */\r\nexport function calculateDC(level, { pwol, rarity = \"common\" } = {}) {\r\n\tpwol ??= game.pf2e.settings.variants.pwol.enabled;\r\n\r\n\t// assume level 0 if garbage comes in. We cast level to number because the backing data may actually have it\r\n\t// stored as a string, which we can't catch at compile time\r\n\tconst dc = dcByLevel.get(level) ?? 14;\r\n\tif (pwol) {\r\n\t\t// -1 shouldn't be subtracted since it's just\r\n\t\t// a creature level and not related to PC levels\r\n\t\treturn adjustDCByRarity(dc - Math.max(level, 0), rarity);\r\n\t}\r\n\r\n\treturn adjustDCByRarity(dc, rarity);\r\n}\r\n\r\n/**\r\n *\r\n * @param {Rank} rank\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @returns {number}\r\n */\r\nexport function calculateSimpleDC(rank, { pwol = false } = {}) {\r\n\tif (pwol) {\r\n\t\treturn simpleDCsWithoutLevel.get(rank) ?? 10;\r\n\t}\r\n\r\n\treturn simpleDCs.get(rank) ?? 10;\r\n}\r\n\r\n/**\r\n *\r\n * @param {number} spellLevel\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @returns {number}\r\n */\r\nexport function calculateSpellDC(spellLevel, { pwol = false } = {}) {\r\n\treturn calculateDC(spellLevel * 2 - 1, { pwol });\r\n}\r\n\r\n/**\r\n *\r\n * @param {number} dc\r\n * @param {Rarity} rarity\r\n * @returns {number}\r\n */\r\nexport function adjustDCByRarity(dc, rarity = \"common\") {\r\n\treturn adjustDC(dc, rarityToDCAdjustment(rarity));\r\n}\r\n\r\n/**\r\n *\r\n * @param {number} dc\r\n * @param {Rarity} adjustment\r\n * @returns {number}\r\n */\r\nexport function adjustDC(dc, adjustment = \"normal\") {\r\n\treturn dc + (dcAdjustments.get(adjustment) ?? 0);\r\n}\r\n\r\n/**\r\n * @param {Rarity} rarity\r\n * @returns {\"hard\" | \"normal\" | \"very-hard\" | \"incredibly-hard\"}\r\n */\r\nexport function rarityToDCAdjustment(rarity = \"common\") {\r\n\tswitch (rarity) {\r\n\t\tcase \"uncommon\":\r\n\t\t\treturn \"hard\";\r\n\t\tcase \"rare\":\r\n\t\t\treturn \"very-hard\";\r\n\t\tcase \"unique\":\r\n\t\t\treturn \"incredibly-hard\";\r\n\t\tdefault:\r\n\t\t\treturn \"normal\";\r\n\t}\r\n}\r\n", "export const EFFECT_AREA_SHAPES = [\r\n\t\"burst\",\r\n\t\"cone\",\r\n\t\"cube\",\r\n\t\"cylinder\",\r\n\t\"emanation\",\r\n\t\"line\",\r\n\t\"square\",\r\n];\r\n\r\nexport const MAGIC_TRADITIONS = new Set([\r\n\t\"arcane\",\r\n\t\"divine\",\r\n\t\"occult\",\r\n\t\"primal\",\r\n]);\r\n\r\nexport const traditionSkills = {\r\n\tarcane: \"arcana\",\r\n\tdivine: \"religion\",\r\n\toccult: \"occultism\",\r\n\tprimal: \"nature\",\r\n};\r\n\r\n/**\r\n * @param {string} groupId\r\n * @returns {number|null}\r\n */\r\nexport function spellSlotGroupIdToNumber(groupId) {\r\n\tif (groupId === \"cantrips\") return 0;\r\n\tconst numericValue = Number(groupId ?? NaN);\r\n\treturn numericValue.between(0, 10) ? numericValue : null;\r\n}\r\n\r\n/**\r\n * @param {string} value\r\n * @returns {number|null}\r\n */\r\nexport function coerceToSpellGroupId(value) {\r\n\tif (value === \"cantrips\") return value;\r\n\tconst numericValue = Number(value) || NaN;\r\n\treturn numericValue.between(1, 10) ? numericValue : null;\r\n}\r\n", "import { adjustDCByRarity, calculateDC } from \"./dc\";\r\nimport { setHasElement } from \"./misc\";\r\nimport { MAGIC_TRADITIONS } from \"./spell\";\r\n\r\nexport class IdentifyItemPopup extends FormApplication {\r\n\tstatic get defaultOptions() {\r\n\t\treturn {\r\n\t\t\t...FormApplication.defaultOptions,\r\n\t\t\tid: \"identify-item\",\r\n\t\t\ttitle: game.i18n.localize(\"PF2E.identification.Identify\"),\r\n\t\t\ttemplate: \"systems/pf2e/templates/actors/identify-item.hbs\",\r\n\t\t\twidth: \"auto\",\r\n\t\t\tclasses: [\"identify-popup\"],\r\n\t\t};\r\n\t}\r\n\r\n\tdcs = getItemIdentificationDCs(this.object, {\r\n\t\tpwol: game.pf2e.settings.variants.pwol.enabled,\r\n\t\tnotMatchingTraditionModifier: game.settings.get(\r\n\t\t\t\"pf2e\",\r\n\t\t\t\"identifyMagicNotMatchingTraditionModifier\",\r\n\t\t),\r\n\t});\r\n\r\n\tasync getData() {\r\n\t\tconst item = this.object;\r\n\t\treturn {\r\n\t\t\t...(await super.getData()),\r\n\t\t\tisMagic: item.isMagical,\r\n\t\t\tisAlchemical: item.isAlchemical,\r\n\t\t\tdcs: this.dcs,\r\n\t\t};\r\n\t}\r\n\r\n\tactivateListeners($html) {\r\n\t\tconst html = $html[0];\r\n\r\n\t\tconst updateButton =\r\n\t\t\thtml.querySelector < HTMLButtonElement > \"button.update-identification\";\r\n\t\tupdateButton?.addEventListener(\"click\", () => {\r\n\t\t\tthis.submit({ updateData: { status: updateButton.value } });\r\n\t\t});\r\n\r\n\t\t// Add listener on Post skill checks to chat button that posts item unidentified img and name and skill checks\r\n\t\thtml\r\n\t\t\t.querySelector(\"button.post-skill-checks\")\r\n\t\t\t?.addEventListener(\"click\", async () => {\r\n\t\t\t\tconst item = this.object;\r\n\t\t\t\tconst identifiedName = item.system.identification.identified.name;\r\n\t\t\t\tconst dcs = this.dcs;\r\n\t\t\t\tconst action = item.isMagical\r\n\t\t\t\t\t? \"identify-magic\"\r\n\t\t\t\t\t: item.isAlchemical\r\n\t\t\t\t\t  ? \"identify-alchemy\"\r\n\t\t\t\t\t  : \"recall-knowledge\";\r\n\r\n\t\t\t\tconst content = await renderTemplate(\r\n\t\t\t\t\t\"systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs\",\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tidentifiedName,\r\n\t\t\t\t\t\taction,\r\n\t\t\t\t\t\tskills: R.omit(dcs, [\"dc\"]),\r\n\t\t\t\t\t\tunidentified: item.system.identification.unidentified,\r\n\t\t\t\t\t\tuuid: item.uuid,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tawait ChatMessage.implementation.create({\r\n\t\t\t\t\tuser: game.user.id,\r\n\t\t\t\t\tcontent,\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t}\r\n\r\n\tasync _updateObject(_event, formData) {\r\n\t\tconst status = formData.status;\r\n\t\tif (status === \"identified\") {\r\n\t\t\treturn this.object.setIdentificationStatus(status);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function getItemIdentificationDCs(\r\n\titem,\r\n\t{ pwol = false, notMatchingTraditionModifier },\r\n) {\r\n\tconst baseDC = calculateDC(item.level, { pwol });\r\n\tconst rarity = getDcRarity(item);\r\n\tconst dc = adjustDCByRarity(baseDC, rarity);\r\n\tif (item.isMagical) {\r\n\t\treturn getIdentifyMagicDCs(item, dc, notMatchingTraditionModifier);\r\n\t}\r\n\r\n\treturn { crafting: dc };\r\n}\r\n\r\n/**\r\n *\r\n * @param {Item} item\r\n * @returns {import('./dc').Rarity}\r\n */\r\nfunction getDcRarity(item) {\r\n\treturn item.traits.has(\"cursed\") ? \"unique\" : item.rarity;\r\n}\r\n\r\n/**\r\n *\r\n * @param {PhysicalItemPF2e} item\r\n * @param {number} baseDC\r\n * @param {number} notMatchingTraditionModifier\r\n * @returns {{arcana: number; nature: number; occultism: number; religion: number;}}\r\n */\r\nfunction getIdentifyMagicDCs(item, baseDC, notMatchingTraditionModifier) {\r\n\tconst result = {\r\n\t\toccult: baseDC,\r\n\t\tprimal: baseDC,\r\n\t\tdivine: baseDC,\r\n\t\tarcane: baseDC,\r\n\t};\r\n\tconst traditions = getMagicTraditions(item);\r\n\tfor (const key of MAGIC_TRADITIONS) {\r\n\t\t// once an item has a magic tradition, all skills\r\n\t\t// that don't match the tradition are hard\r\n\t\tif (traditions.size > 0 && !traditions.has(key)) {\r\n\t\t\tresult[key] = baseDC + notMatchingTraditionModifier;\r\n\t\t}\r\n\t}\r\n\treturn {\r\n\t\tarcana: result.arcane,\r\n\t\tnature: result.primal,\r\n\t\treligion: result.divine,\r\n\t\toccultism: result.occult,\r\n\t};\r\n}\r\n\r\n/**\r\n * @param {PhysicalItemPF2e} item\r\n * @returns {MAGIC_TRADITIONS}\r\n */\r\nfunction getMagicTraditions(item) {\r\n\tconst traits = item.system.traits.value;\r\n\treturn new Set(traits.filter((t) => setHasElement(MAGIC_TRADITIONS, t)));\r\n}\r\n", "import * as R from \"remeda\";\r\nimport { getSelectedActors } from \"./actor\";\r\nimport { calculateDC } from \"./dc\";\r\nimport { htmlClosest, htmlQueryAll } from \"./html\";\r\nimport { ErrorPF2e, getActionGlyph, sluggify, tupleHasValue } from \"./misc\";\r\nimport { eventToRollParams } from \"./scripts\";\r\nimport { EFFECT_AREA_SHAPES } from \"./spell\";\r\n\r\nconst SAVE_TYPES = [\"fortitude\", \"reflex\", \"will\"];\r\nconst inlineSelector = [\"action\", \"check\", \"effect-area\"]\r\n\t.map((keyword) => `[data-pf2-${keyword}]`)\r\n\t.join(\",\");\r\n\r\nexport const InlineRollLinks = {\r\n\tinjectRepostElement: (links, foundryDoc) => {\r\n\t\tfor (const link of links) {\r\n\t\t\tif (!foundryDoc || foundryDoc.isOwner) link.classList.add(\"with-repost\");\r\n\r\n\t\t\tconst repostButtons = htmlQueryAll(link, \"i[data-pf2-repost]\");\r\n\t\t\tif (repostButtons.length > 0) {\r\n\t\t\t\tif (foundryDoc && !foundryDoc.isOwner) {\r\n\t\t\t\t\tfor (const button of repostButtons) {\r\n\t\t\t\t\t\tbutton.remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlink.classList.remove(\"with-repost\");\r\n\t\t\t\t}\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (foundryDoc && !foundryDoc.isOwner) continue;\r\n\r\n\t\t\tconst newButton = document.createElement(\"i\");\r\n\t\t\tconst icon =\r\n\t\t\t\tlink.parentElement?.dataset?.pf2Checkgroup !== undefined\r\n\t\t\t\t\t? \"fa-comment-alt-dots\"\r\n\t\t\t\t\t: \"fa-comment-alt\";\r\n\t\t\tnewButton.classList.add(\"fa-solid\", icon);\r\n\t\t\tnewButton.dataset.pf2Repost = \"\";\r\n\t\t\tnewButton.title = game.i18n.localize(\"PF2E.Repost\");\r\n\t\t\tlink.appendChild(newButton);\r\n\r\n\t\t\tnewButton.addEventListener(\"click\", (event) => {\r\n\t\t\t\tevent.stopPropagation();\r\n\t\t\t\tconst target = event.target;\r\n\t\t\t\tif (!(target instanceof HTMLElement)) return;\r\n\t\t\t\tconst parent = target?.parentElement;\r\n\t\t\t\tif (!parent) return;\r\n\r\n\t\t\t\tconst document = resolveDocument(target, foundryDoc);\r\n\t\t\t\tInlineRollLinks.repostAction(parent, document);\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n\r\n\tlisten: (html, foundryDoc = resolveDocument(html)) => {\r\n\t\tconst links = htmlQueryAll(html, inlineSelector).filter((l) =>\r\n\t\t\t[\"A\", \"SPAN\"].includes(l.nodeName),\r\n\t\t);\r\n\t\tInlineRollLinks.injectRepostElement(links, foundryDoc);\r\n\r\n\t\tInlineRollLinks.flavorDamageRolls(\r\n\t\t\thtml,\r\n\t\t\tfoundryDoc instanceof Actor ? foundryDoc : null,\r\n\t\t);\r\n\r\n\t\tfor (const link of links.filter((l) => l.dataset.pf2Action)) {\r\n\t\t\tconst { pf2Action, pf2Glyph, pf2Variant, pf2Dc, pf2ShowDc, pf2Skill } =\r\n\t\t\t\tlink.dataset;\r\n\t\t\tlink.addEventListener(\"click\", (event) => {\r\n\t\t\t\tconst slug = sluggify(pf2Action ?? \"\");\r\n\t\t\t\tconst visibility = pf2ShowDc ?? \"all\";\r\n\t\t\t\tconst difficultyClass = Number.isNumeric(pf2Dc)\r\n\t\t\t\t\t? { scope: \"check\", value: Number(pf2Dc) || 0, visibility }\r\n\t\t\t\t\t: pf2Dc;\r\n\t\t\t\tif (slug && game.pf2e.actions.has(slug)) {\r\n\t\t\t\t\tgame.pf2e.actions\r\n\t\t\t\t\t\t.get(slug)\r\n\t\t\t\t\t\t?.use({\r\n\t\t\t\t\t\t\tevent,\r\n\t\t\t\t\t\t\tvariant: pf2Variant,\r\n\t\t\t\t\t\t\tdifficultyClass,\r\n\t\t\t\t\t\t\tstatistic: pf2Skill,\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\t.catch((reason) => ui.notifications.warn(reason));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst action =\r\n\t\t\t\t\t\tgame.pf2e.actions[\r\n\t\t\t\t\t\t\tpf2Action ? sluggify(pf2Action, { camel: \"dromedary\" }) : \"\"\r\n\t\t\t\t\t\t];\r\n\t\t\t\t\tif (pf2Action && action) {\r\n\t\t\t\t\t\taction({\r\n\t\t\t\t\t\t\tevent,\r\n\t\t\t\t\t\t\tglyph: pf2Glyph,\r\n\t\t\t\t\t\t\tvariant: pf2Variant,\r\n\t\t\t\t\t\t\tdifficultyClass,\r\n\t\t\t\t\t\t\tskill: pf2Skill,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\t\t`PF2e System | Skip executing unknown action '${pf2Action}'`,\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfor (const link of links.filter(\r\n\t\t\t(l) => l.dataset.pf2Check && !l.dataset.invalid,\r\n\t\t)) {\r\n\t\t\tconst {\r\n\t\t\t\tpf2Check,\r\n\t\t\t\tpf2Dc,\r\n\t\t\t\tpf2Traits,\r\n\t\t\t\tpf2Label,\r\n\t\t\t\tpf2Defense,\r\n\t\t\t\tpf2Adjustment,\r\n\t\t\t\tpf2Roller,\r\n\t\t\t\tpf2RollOptions,\r\n\t\t\t} = link.dataset;\r\n\t\t\tconst overrideTraits = \"overrideTraits\" in link.dataset;\r\n\t\t\tconst targetOwner = \"targetOwner\" in link.dataset;\r\n\r\n\t\t\tif (!pf2Check) return;\r\n\r\n\t\t\tlink.addEventListener(\"click\", async (event) => {\r\n\t\t\t\tconst parent = resolveActor(foundryDoc, link);\r\n\t\t\t\t// const actors = [parent];\r\n\t\t\t\tconst actors = (() => {\r\n\t\t\t\t\tswitch (pf2Roller) {\r\n\t\t\t\t\t\tcase \"self\":\r\n\t\t\t\t\t\t\treturn parent?.canUserModify(game.user, \"update\") ? [parent] : [];\r\n\t\t\t\t\t\tcase \"party\":\r\n\t\t\t\t\t\t\tif (parent?.isOfType(\"party\")) return [parent];\r\n\t\t\t\t\t\t\treturn R.compact([game.actors.party]);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Use the DOM document as a fallback if it's an actor and the check isn't a saving throw\r\n\t\t\t\t\tconst sheetActor = (() => {\r\n\t\t\t\t\t\tconst maybeActor =\r\n\t\t\t\t\t\t\tfoundryDoc instanceof Actor\r\n\t\t\t\t\t\t\t\t? foundryDoc\r\n\t\t\t\t\t\t\t\t: foundryDoc instanceof Item && foundryDoc.actor\r\n\t\t\t\t\t\t\t\t  ? foundryDoc.actor\r\n\t\t\t\t\t\t\t\t  : null;\r\n\t\t\t\t\t\treturn maybeActor?.isOwner && !maybeActor.isOfType(\"loot\", \"party\")\r\n\t\t\t\t\t\t\t? maybeActor\r\n\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t})();\r\n\t\t\t\t\tconst rollingActors = [\r\n\t\t\t\t\t\tsheetActor ??\r\n\t\t\t\t\t\t\tgetSelectedActors({ exclude: [\"loot\"], assignedFallback: true }),\r\n\t\t\t\t\t].flat();\r\n\r\n\t\t\t\t\tconst isSave = tupleHasValue(SAVE_TYPES, pf2Check);\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tparent?.isOfType(\"party\") ||\r\n\t\t\t\t\t\t(rollingActors.length === 0 && parent && !isSave)\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\treturn [parent];\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn rollingActors;\r\n\t\t\t\t})();\r\n\r\n\t\t\t\tif (actors.length === 0) {\r\n\t\t\t\t\tui.notifications.error(\"PF2E.ErrorMessage.NoTokenSelected\", {\r\n\t\t\t\t\t\tlocalize: true,\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst extraRollOptions = [\r\n\t\t\t\t\t...(pf2Traits?.split(\",\").map((o) => o.trim()) ?? []),\r\n\t\t\t\t\t...(pf2RollOptions?.split(\",\").map((o) => o.trim()) ?? []),\r\n\t\t\t\t];\r\n\t\t\t\tconst eventRollParams = eventToRollParams(event, { type: \"check\" });\r\n\t\t\t\tconst checkSlug = link.dataset.slug\r\n\t\t\t\t\t? sluggify(link.dataset.slug)\r\n\t\t\t\t\t: null;\r\n\r\n\t\t\t\tswitch (pf2Check) {\r\n\t\t\t\t\tcase \"flat\": {\r\n\t\t\t\t\t\tfor (const actor of actors) {\r\n\t\t\t\t\t\t\tconst flatCheck = new actor.saves.reflex.constructor(actor, {\r\n\t\t\t\t\t\t\t\tlabel: \"\",\r\n\t\t\t\t\t\t\t\tslug: \"flat\",\r\n\t\t\t\t\t\t\t\tmodifiers: [],\r\n\t\t\t\t\t\t\t\tcheck: { type: \"flat-check\" },\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tconst dc = Number.isInteger(Number(pf2Dc))\r\n\t\t\t\t\t\t\t\t? { label: pf2Label, value: Number(pf2Dc) }\r\n\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\t\tflatCheck.roll({\r\n\t\t\t\t\t\t\t\t...eventRollParams,\r\n\t\t\t\t\t\t\t\tslug: checkSlug,\r\n\t\t\t\t\t\t\t\textraRollOptions,\r\n\t\t\t\t\t\t\t\tdc,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdefault: {\r\n\t\t\t\t\t\tconst isSavingThrow = tupleHasValue(SAVE_TYPES, pf2Check);\r\n\r\n\t\t\t\t\t\t// Get actual traits for display in chat cards\r\n\t\t\t\t\t\tconst traits = isSavingThrow\r\n\t\t\t\t\t\t\t? []\r\n\t\t\t\t\t\t\t: extraRollOptions.filter((t) => t in CONFIG.PF2E.actionTraits) ??\r\n\t\t\t\t\t\t\t  [];\r\n\r\n\t\t\t\t\t\tfor (const actor of actors) {\r\n\t\t\t\t\t\t\tconst statistic = (() => {\r\n\t\t\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\t\t\tpf2Check in CONFIG.PF2E.magicTraditions &&\r\n\t\t\t\t\t\t\t\t\tactor.isOfType(\"creature\")\r\n\t\t\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\t\t\tconst bestSpellcasting =\r\n\t\t\t\t\t\t\t\t\t\tactor.spellcasting\r\n\t\t\t\t\t\t\t\t\t\t\t.filter((c) => c.tradition === pf2Check)\r\n\t\t\t\t\t\t\t\t\t\t\t.flatMap((s) => s.statistic ?? [])\r\n\t\t\t\t\t\t\t\t\t\t\t.sort((a, b) => b.check.mod - a.check.mod)\r\n\t\t\t\t\t\t\t\t\t\t\t.shift() ?? null;\r\n\t\t\t\t\t\t\t\t\tif (bestSpellcasting) return bestSpellcasting;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\treturn actor.getStatistic(pf2Check);\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\tif (!statistic) {\r\n\t\t\t\t\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\t\t\t\tErrorPF2e(`Skip rolling unknown statistic ${pf2Check}`)\r\n\t\t\t\t\t\t\t\t\t\t.message,\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tconst targetActor = pf2Defense\r\n\t\t\t\t\t\t\t\t? targetOwner\r\n\t\t\t\t\t\t\t\t\t? parent\r\n\t\t\t\t\t\t\t\t\t: game.user.targets.first()?.actor\r\n\t\t\t\t\t\t\t\t: null;\r\n\r\n\t\t\t\t\t\t\tconst dcValue = (() => {\r\n\t\t\t\t\t\t\t\tconst adjustment = Number(pf2Adjustment) || 0;\r\n\t\t\t\t\t\t\t\tif (pf2Dc === \"@self.level\") {\r\n\t\t\t\t\t\t\t\t\treturn calculateDC(actor.level) + adjustment;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\treturn Number(pf2Dc ?? \"NaN\") + adjustment;\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\tconst dc = (() => {\r\n\t\t\t\t\t\t\t\tif (Number.isInteger(dcValue)) {\r\n\t\t\t\t\t\t\t\t\treturn { label: pf2Label, value: dcValue };\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\tif (pf2Defense) {\r\n\t\t\t\t\t\t\t\t\tconst defenseStat = targetActor?.getStatistic(pf2Defense);\r\n\t\t\t\t\t\t\t\t\treturn defenseStat\r\n\t\t\t\t\t\t\t\t\t\t? {\r\n\t\t\t\t\t\t\t\t\t\t\t\tstatistic: defenseStat.dc,\r\n\t\t\t\t\t\t\t\t\t\t\t\tscope: \"check\",\r\n\t\t\t\t\t\t\t\t\t\t\t\tvalue: defenseStat.dc.value,\r\n\t\t\t\t\t\t\t\t\t\t  }\r\n\t\t\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\t// Retrieve the item if:\r\n\t\t\t\t\t\t\t// (2) The item is an action or,\r\n\t\t\t\t\t\t\t// (1) The check is a saving throw and the item is not a weapon.\r\n\t\t\t\t\t\t\t// Exclude weapons so that roll notes on strikes from incapacitation abilities continue to work.\r\n\t\t\t\t\t\t\tconst item = (() => {\r\n\t\t\t\t\t\t\t\tconst itemFromDoc =\r\n\t\t\t\t\t\t\t\t\tfoundryDoc instanceof Item\r\n\t\t\t\t\t\t\t\t\t\t? foundryDoc\r\n\t\t\t\t\t\t\t\t\t\t: foundryDoc instanceof ChatMessage\r\n\t\t\t\t\t\t\t\t\t\t  ? foundryDoc.item\r\n\t\t\t\t\t\t\t\t\t\t  : null;\r\n\r\n\t\t\t\t\t\t\t\treturn itemFromDoc?.isOfType(\r\n\t\t\t\t\t\t\t\t\t\"action\",\r\n\t\t\t\t\t\t\t\t\t\"feat\",\r\n\t\t\t\t\t\t\t\t\t\"campaignFeature\",\r\n\t\t\t\t\t\t\t\t) ||\r\n\t\t\t\t\t\t\t\t\t(isSavingThrow && !itemFromDoc?.isOfType(\"weapon\"))\r\n\t\t\t\t\t\t\t\t\t? itemFromDoc\r\n\t\t\t\t\t\t\t\t\t: null;\r\n\t\t\t\t\t\t\t})();\r\n\r\n\t\t\t\t\t\t\tconst args = {\r\n\t\t\t\t\t\t\t\t...eventRollParams,\r\n\t\t\t\t\t\t\t\textraRollOptions,\r\n\t\t\t\t\t\t\t\torigin:\r\n\t\t\t\t\t\t\t\t\tisSavingThrow && parent instanceof Actor ? parent : null,\r\n\t\t\t\t\t\t\t\tdc,\r\n\t\t\t\t\t\t\t\ttarget: !isSavingThrow && dc?.statistic ? targetActor : null,\r\n\t\t\t\t\t\t\t\titem,\r\n\t\t\t\t\t\t\t\ttraits,\r\n\t\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\t\t// Use a special header for checks against defenses\r\n\t\t\t\t\t\t\tconst itemIsEncounterAction =\r\n\t\t\t\t\t\t\t\t!overrideTraits &&\r\n\t\t\t\t\t\t\t\t!!(item?.isOfType(\"action\", \"feat\") && item.actionCost) &&\r\n\t\t\t\t\t\t\t\t![\"flat-check\", \"saving-throw\"].includes(statistic.check.type);\r\n\t\t\t\t\t\t\tif (itemIsEncounterAction) {\r\n\t\t\t\t\t\t\t\tconst subtitleLocKey =\r\n\t\t\t\t\t\t\t\t\tpf2Check in CONFIG.PF2E.magicTraditions\r\n\t\t\t\t\t\t\t\t\t\t? \"PF2E.ActionsCheck.spell\"\r\n\t\t\t\t\t\t\t\t\t\t: statistic.check.type === \"attack-roll\"\r\n\t\t\t\t\t\t\t\t\t\t  ? \"PF2E.ActionsCheck.x-attack-roll\"\r\n\t\t\t\t\t\t\t\t\t\t  : \"PF2E.ActionsCheck.x\";\r\n\t\t\t\t\t\t\t\targs.label = await renderTemplate(\r\n\t\t\t\t\t\t\t\t\t\"systems/pf2e/templates/chat/action/header.hbs\",\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\tglyph: getActionGlyph(item.actionCost),\r\n\t\t\t\t\t\t\t\t\t\tsubtitle: game.i18n.format(subtitleLocKey, {\r\n\t\t\t\t\t\t\t\t\t\t\ttype: statistic.label,\r\n\t\t\t\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t\t\t\t\ttitle: item.name,\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\textraRollOptions.push(...createActionOptions(item));\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tstatistic.roll(args);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst templateConversion = {\r\n\t\t\tburst: \"circle\",\r\n\t\t\tcone: \"cone\",\r\n\t\t\tcube: \"rect\",\r\n\t\t\temanation: \"circle\",\r\n\t\t\tline: \"ray\",\r\n\t\t\trect: \"rect\",\r\n\t\t\tsquare: \"rect\",\r\n\t\t};\r\n\r\n\t\tfor (const link of links.filter((l) =>\r\n\t\t\tl.hasAttribute(\"data-pf2-effect-area\"),\r\n\t\t)) {\r\n\t\t\tconst {\r\n\t\t\t\tpf2EffectArea,\r\n\t\t\t\tpf2Distance,\r\n\t\t\t\tpf2TemplateData,\r\n\t\t\t\tpf2Traits,\r\n\t\t\t\tpf2Width,\r\n\t\t\t} = link.dataset;\r\n\t\t\tlink.addEventListener(\"click\", () => {\r\n\t\t\t\tif (!canvas.ready) return;\r\n\r\n\t\t\t\tif (typeof pf2EffectArea !== \"string\") {\r\n\t\t\t\t\tconsole.warn(`PF2e System | Could not create template'`);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst data = JSON.parse(pf2TemplateData ?? \"{}\");\r\n\t\t\t\tdata.distance ||= Number(pf2Distance);\r\n\t\t\t\tdata.fillColor ||= game.user.color;\r\n\t\t\t\tdata.t = templateConversion[pf2EffectArea];\r\n\r\n\t\t\t\tswitch (data.t) {\r\n\t\t\t\t\tcase \"ray\":\r\n\t\t\t\t\t\tdata.width =\r\n\t\t\t\t\t\t\tNumber(pf2Width) ||\r\n\t\t\t\t\t\t\tCONFIG.MeasuredTemplate.defaults.width *\r\n\t\t\t\t\t\t\t\tcanvas.dimensions.distance;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"cone\":\r\n\t\t\t\t\t\tdata.angle ||= CONFIG.MeasuredTemplate.defaults.angle;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase \"rect\": {\r\n\t\t\t\t\t\tconst distance = data.distance ?? 0;\r\n\t\t\t\t\t\tdata.distance = Math.hypot(distance, distance);\r\n\t\t\t\t\t\tdata.width = distance;\r\n\t\t\t\t\t\tdata.direction = 45;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst flags = {\r\n\t\t\t\t\tpf2e: {},\r\n\t\t\t\t};\r\n\r\n\t\t\t\tconst normalSize = (Math.ceil(data.distance) / 5) * 5 || 5;\r\n\t\t\t\tif (\r\n\t\t\t\t\ttupleHasValue(EFFECT_AREA_SHAPES, pf2EffectArea) &&\r\n\t\t\t\t\tdata.distance === normalSize\r\n\t\t\t\t) {\r\n\t\t\t\t\tflags.pf2e.areaShape = pf2EffectArea;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst messageId =\r\n\t\t\t\t\tfoundryDoc instanceof ChatMessage\r\n\t\t\t\t\t\t? foundryDoc.id\r\n\t\t\t\t\t\t: htmlClosest(html, \"[data-message-id]\")?.dataset.messageId ?? null;\r\n\t\t\t\tif (messageId) {\r\n\t\t\t\t\tflags.pf2e.messageId = messageId;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst actor = resolveActor(foundryDoc, link);\r\n\t\t\t\tif (actor || pf2Traits) {\r\n\t\t\t\t\tconst origin = {};\r\n\t\t\t\t\tif (actor) {\r\n\t\t\t\t\t\torigin.actor = actor.uuid;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (pf2Traits) {\r\n\t\t\t\t\t\torigin.traits = pf2Traits.split(\",\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tflags.pf2e.origin = origin;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!R.isEmpty(flags.pf2e)) {\r\n\t\t\t\t\tdata.flags = flags;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcanvas.templates.createPreview(data);\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfor (const link of html.querySelectorAll(\"a[data-damage-roll]\")) {\r\n\t\t\tlink.dataset.itemUuid = foundryDoc.uuid;\r\n\t\t}\r\n\t},\r\n\r\n\tmakeRepostHtml: (target, defaultVisibility) => {\r\n\t\tconst flavor = game.i18n.localize(target.dataset.pf2RepostFlavor ?? \"\");\r\n\t\tconst showDC = target.dataset.pf2ShowDc ?? defaultVisibility;\r\n\t\treturn `<span data-visibility=\"${showDC}\">${flavor}</span> ${target.outerHTML}`.trim();\r\n\t},\r\n\r\n\trepostAction: async (target, foundryDoc = null) => {\r\n\t\tif (\r\n\t\t\t![\"pf2Action\", \"pf2Check\", \"pf2EffectArea\"].some(\r\n\t\t\t\t(d) => d in target.dataset,\r\n\t\t\t)\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst actor = resolveActor(foundryDoc, target);\r\n\t\tconst defaultVisibility = (actor ?? foundryDoc)?.hasPlayerOwner\r\n\t\t\t? \"all\"\r\n\t\t\t: \"gm\";\r\n\t\tconst content = (() => {\r\n\t\t\tif (target.parentElement?.dataset?.pf2Checkgroup !== undefined) {\r\n\t\t\t\tconst content = htmlQueryAll(target.parentElement, inlineSelector)\r\n\t\t\t\t\t.map((target) =>\r\n\t\t\t\t\t\tInlineRollLinks.makeRepostHtml(target, defaultVisibility),\r\n\t\t\t\t\t)\r\n\t\t\t\t\t.join(\"<br>\");\r\n\r\n\t\t\t\treturn `<div data-pf2-checkgroup>${content}</div>`;\r\n\t\t\t}\r\n\r\n\t\t\treturn InlineRollLinks.makeRepostHtml(target, defaultVisibility);\r\n\t\t})();\r\n\r\n\t\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\t\tconst speaker = actor\r\n\t\t\t? ChatMessagePF2e.getSpeaker({\r\n\t\t\t\t\tactor,\r\n\t\t\t\t\ttoken: actor.getActiveTokens(true, true).shift(),\r\n\t\t\t  })\r\n\t\t\t: ChatMessagePF2e.getSpeaker();\r\n\r\n\t\t// If the originating document is a journal entry, include its UUID as a flag. If a chat message, copy over\r\n\t\t// the origin flag.\r\n\t\tconst message = game.messages.get(\r\n\t\t\thtmlClosest(target, \"[data-message-id]\")?.dataset.messageId ?? \"\",\r\n\t\t);\r\n\t\tconst flags =\r\n\t\t\tfoundryDoc instanceof JournalEntry\r\n\t\t\t\t? { pf2e: { journalEntry: foundryDoc.uuid } }\r\n\t\t\t\t: message?.flags.pf2e.origin\r\n\t\t\t\t  ? { pf2e: { origin: fu.deepClone(message.flags.pf2e.origin) } }\r\n\t\t\t\t  : {};\r\n\r\n\t\treturn ChatMessagePF2e.create({ speaker, content, flags });\r\n\t},\r\n\r\n\t/** Give inline damage-roll links from items flavor text of the item name */\r\n\tflavorDamageRolls(html, actor = null) {\r\n\t\tfor (const rollLink of htmlQueryAll(\r\n\t\t\thtml,\r\n\t\t\t\"a.inline-roll[data-damage-roll]\",\r\n\t\t)) {\r\n\t\t\tconst itemId = htmlClosest(rollLink, \"[data-item-id]\")?.dataset.itemId;\r\n\t\t\tconst item = actor?.items.get(itemId ?? \"\");\r\n\t\t\tif (item) rollLink.dataset.flavor ||= item.name;\r\n\t\t}\r\n\t},\r\n};\r\n\r\n/** If the provided document exists returns it, otherwise attempt to derive it from the sheet */\r\nfunction resolveDocument(html, foundryDoc) {\r\n\tif (foundryDoc) return foundryDoc;\r\n\r\n\tconst sheet =\r\n\t\tui.windows[Number(html.closest(\".app.sheet\")?.dataset.appid)] ?? null;\r\n\r\n\tconst document = sheet?.document;\r\n\treturn document instanceof Actor || document instanceof JournalEntry\r\n\t\t? document\r\n\t\t: null;\r\n}\r\n\r\n/** Retrieve an actor via a passed document or item UUID in the dataset of a link */\r\nfunction resolveActor(foundryDoc, anchor) {\r\n\tif (foundryDoc instanceof Actor) return foundryDoc;\r\n\tif (foundryDoc instanceof Item || foundryDoc instanceof ChatMessage)\r\n\t\treturn foundryDoc.actor;\r\n\r\n\t// Retrieve item/actor from anywhere via UUID\r\n\tconst itemUuid = anchor.dataset.itemUuid;\r\n\tconst itemByUUID =\r\n\t\titemUuid && !itemUuid.startsWith(\"Compendium.\")\r\n\t\t\t? fromUuidSync(itemUuid)\r\n\t\t\t: null;\r\n\treturn itemByUUID instanceof Item ? itemByUUID.actor : null;\r\n}\r\n\r\n/** Create roll options with information about the action being used */\r\nfunction createActionOptions(item, extra = []) {\r\n\tif (!item?.isOfType(\"action\", \"feat\") || !item.actionCost) return [];\r\n\r\n\tconst slug = item.slug ?? sluggify(item.name);\r\n\tconst traits = R.uniq(\r\n\t\t[\r\n\t\t\titem.system.traits.value,\r\n\t\t\textra.filter((t) => t in CONFIG.PF2E.actionTraits),\r\n\t\t].flat(),\r\n\t);\r\n\tconst actionCost = item.actionCost.value;\r\n\r\n\treturn R.compact([\r\n\t\t`action:${slug}`,\r\n\t\t`action:cost:${actionCost}`,\r\n\t\t`self:action:slug:${slug}`,\r\n\t\t`self:action:cost:${actionCost}`,\r\n\t\t...traits.map((t) => `self:action:trait:${t}`),\r\n\t]);\r\n}\r\n", "import { createHTMLElement, htmlClosest } from \"./html\";\r\nimport { ErrorPF2e, localizer, setHasElement, sluggify } from \"./misc\";\r\nimport { eventToRollMode } from \"./scripts\";\r\n\r\nexport const HANDWRAPS_SLUG = \"handwraps-of-mighty-blows\";\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function canBeInvested(item) {\r\n\treturn item.traits.has(\"invested\");\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function hasWornSlot(item) {\r\n\treturn item.system.equipped.inSlot != null;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nfunction isWornAs(item) {\r\n\treturn item.system.usage.type === \"worn\" && item.system.equipped.inSlot;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isInvestedOrWornAs(item) {\r\n\treturn item.isInvested || isWornAs(item);\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isHeld(item) {\r\n\treturn item.system.usage.type === \"held\";\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isTwoHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-two-hands\";\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isOneHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-one-hand\";\r\n}\r\n\r\n/**\r\n * @tempate T\r\n * @param {object} item\r\n * @param {T} value\r\n * @returns {T|undefined}\r\n */\r\nfunction inSlotValue(item, value) {\r\n\tconst usage = item.system.usage;\r\n\treturn usage.type === \"worn\" && usage.where ? value : undefined;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @param {boolean} [invest]\r\n * @returns {boolean|undefined}\r\n */\r\nfunction toggleInvestedValue(item, invest) {\r\n\tconst value = invest ?? !item.system.equipped.invested;\r\n\treturn item.traits.has(\"invested\") ? value : undefined;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @param {object} options\r\n * @param {string} [options.carryType]\r\n * @param {number} [options.handsHeld]\r\n * @param {boolean} [options.inSlot]\r\n * @param {boolean} [options.invested]\r\n * @param {string|null} [options.containerId]\r\n * @returns {object}\r\n */\r\nexport function itemCarryUpdate(\r\n\titem,\r\n\t{ carryType = \"worn\", handsHeld = 0, inSlot, invested, containerId },\r\n) {\r\n\tconst update = {\r\n\t\t_id: item.id,\r\n\t\tsystem: {\r\n\t\t\tequipped: {\r\n\t\t\t\tcarryType: carryType,\r\n\t\t\t\thandsHeld: handsHeld,\r\n\t\t\t\tinSlot: inSlotValue(item, inSlot),\r\n\t\t\t\tinvested: toggleInvestedValue(item, invested),\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\r\n\tif (containerId !== undefined) {\r\n\t\tupdate.system.containerId = containerId;\r\n\t}\r\n\r\n\treturn update;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isHandwrapsOfMightyBlows(item) {\r\n\treturn (\r\n\t\titem.isOfType(\"weapon\") &&\r\n\t\titem.slug === HANDWRAPS_SLUG &&\r\n\t\titem.category === \"unarmed\"\r\n\t);\r\n}\r\n\r\n/**\r\n * @param {Item} item\r\n * @param {number} [quantity]\r\n * @returns {Coins}\r\n */\r\nexport function calculateItemPrice(item, quantity = 1, ratio = 1) {\r\n\tconst coins = game.pf2e.Coins.fromPrice(item.price, quantity);\r\n\tif (ratio === 1) return coins;\r\n\treturn coins.scale(ratio);\r\n}\r\n\r\n/**\r\n * @param {Actor} target\r\n * @param {Item} item\r\n * @param {number} quantity\r\n * @param {string} [containerId]\r\n * @param {boolean} [newStack]\r\n * @returns {Promise<Item>}\r\n */\r\nexport async function transferItemToActor(\r\n\ttarget,\r\n\titem,\r\n\tquantity,\r\n\tcontainerId,\r\n\tnewStack,\r\n) {\r\n\tconst itemQuantity = Math.min(quantity, item.quantity);\r\n\tconst newQuantity = item.quantity - itemQuantity;\r\n\r\n\tif (newQuantity < 1) {\r\n\t\tawait item.delete();\r\n\t} else {\r\n\t\tawait item.update({ \"system.quantity\": newQuantity });\r\n\t}\r\n\r\n\tconst newItemData = item.toObject();\r\n\tnewItemData.system.quantity = itemQuantity;\r\n\tnewItemData.system.equipped.carryType = \"worn\";\r\n\tif (\"invested\" in newItemData.system.equipped) {\r\n\t\tnewItemData.system.equipped.invested = item.traits.has(\"invested\")\r\n\t\t\t? false\r\n\t\t\t: null;\r\n\t}\r\n\r\n\treturn target.addToInventory(newItemData, containerId, newStack);\r\n}\r\n\r\nexport class MoveLootPopup extends FormApplication {\r\n\t/**\r\n\t * @param {Actor} object\r\n\t * @param {object} options\r\n\t * @param {{default: number, max: number}} options.quantity\r\n\t * @param {boolean} options.newStack\r\n\t * @param {boolean} options.lockStack\r\n\t * @param {boolean} options.isPurchase\r\n\t * @param {(quantity: number, newStack: boolean) => void} callback\r\n\t */\r\n\tconstructor(object, options, callback) {\r\n\t\tsuper(object, options);\r\n\t\tthis.onSubmitCallback = callback;\r\n\t}\r\n\r\n\tasync getData() {\r\n\t\tconst [prompt, buttonLabel] = this.options.isPurchase\r\n\t\t\t? [\"PF2E.loot.PurchaseLootMessage\", \"PF2E.loot.PurchaseLoot\"]\r\n\t\t\t: [\"PF2E.loot.MoveLootMessage\", \"PF2E.loot.MoveLoot\"];\r\n\r\n\t\treturn {\r\n\t\t\t...(await super.getData()),\r\n\t\t\tquantity: {\r\n\t\t\t\tdefault: this.options.quantity.default,\r\n\t\t\t\tmax: this.options.quantity.max,\r\n\t\t\t},\r\n\t\t\tnewStack: this.options.newStack,\r\n\t\t\tlockStack: this.options.lockStack,\r\n\t\t\tprompt,\r\n\t\t\tbuttonLabel,\r\n\t\t};\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn {\r\n\t\t\t...FormApplication.defaultOptions,\r\n\t\t\tid: \"MoveLootPopup\",\r\n\t\t\tclasses: [],\r\n\t\t\ttitle: game.i18n.localize(\"PF2E.loot.MoveLootPopupTitle\"),\r\n\t\t\ttemplate: \"systems/pf2e/templates/popups/loot/move-loot-popup.hbs\",\r\n\t\t\twidth: \"auto\",\r\n\t\t\tquantity: {\r\n\t\t\t\tdefault: 1,\r\n\t\t\t\tmax: 1,\r\n\t\t\t},\r\n\t\t\tnewStack: false,\r\n\t\t\tlockStack: false,\r\n\t\t\tisPurchase: false,\r\n\t\t};\r\n\t}\r\n\r\n\tasync _updateObject(_event, formData) {\r\n\t\tthis.onSubmitCallback(formData.quantity, formData.newStack);\r\n\t}\r\n}\r\n\r\nexport async function detachSubitem(subitem, skipConfirm) {\r\n\tconst parentItem = subitem.parentItem;\r\n\tif (!parentItem) throw ErrorPF2e(\"Subitem has no parent item\");\r\n\r\n\tconst localize = localizer(\"PF2E.Item.Physical.Attach.Detach\");\r\n\tconst confirmed =\r\n\t\tskipConfirm ||\r\n\t\t(await Dialog.confirm({\r\n\t\t\ttitle: localize(\"Label\"),\r\n\t\t\tcontent: createHTMLElement(\"p\", {\r\n\t\t\t\tchildren: [localize(\"Prompt\", { attachable: subitem.name })],\r\n\t\t\t}).outerHTML,\r\n\t\t}));\r\n\tif (!confirmed) return;\r\n\r\n\tconst deletePromise = subitem.delete();\r\n\tconst createPromise = (async () => {\r\n\t\t// Find a stack match, cloning the subitem as worn so the search won't fail due to it being equipped\r\n\t\tconst stack = subitem.isOfType(\"consumable\")\r\n\t\t\t? parentItem.actor?.inventory.findStackableItem(\r\n\t\t\t\t\tsubitem.clone({ \"system.equipped.carryType\": \"worn\" }),\r\n\t\t\t  )\r\n\t\t\t: null;\r\n\t\tconst keepId =\r\n\t\t\t!!parentItem.actor && !parentItem.actor.items.has(subitem.id);\r\n\t\treturn (\r\n\t\t\tstack?.update({ \"system.quantity\": stack.quantity + 1 }) ??\r\n\t\t\tItem.implementation.create(\r\n\t\t\t\tmergeObject(subitem.toObject(), {\r\n\t\t\t\t\t\"system.containerId\": parentItem.system.containerId,\r\n\t\t\t\t}),\r\n\t\t\t\t{ parent: parentItem.actor, keepId },\r\n\t\t\t)\r\n\t\t);\r\n\t})();\r\n\r\n\tawait Promise.all([deletePromise, createPromise]);\r\n}\r\n\r\nexport async function unownedItemToMessage(event, item, actor, options = {}) {\r\n\tconst ChatMessagePF2e = ChatMessage.implementation;\r\n\r\n\t// Basic template rendering data\r\n\tconst type = sluggify(item.type);\r\n\tconst template = `systems/pf2e/templates/chat/${type}-card.hbs`;\r\n\tconst token = actor.token;\r\n\tconst nearestItem = htmlClosest(event?.target, \".item\");\r\n\tconst rollOptions = options.data ?? { ...(nearestItem?.dataset ?? {}) };\r\n\tconst templateData = {\r\n\t\tactor: actor,\r\n\t\ttokenId: token ? `${token.parent?.id}.${token.id}` : null,\r\n\t\titem: item,\r\n\t\tdata: await item.getChatData(undefined, rollOptions),\r\n\t};\r\n\r\n\t// Basic chat message data\r\n\tconst originalEvent =\r\n\t\tevent instanceof MouseEvent ? event : event?.originalEvent;\r\n\tconst rollMode = options.rollMode ?? eventToRollMode(originalEvent);\r\n\tconst chatData = ChatMessagePF2e.applyRollMode(\r\n\t\t{\r\n\t\t\ttype: CONST.CHAT_MESSAGE_TYPES.OTHER,\r\n\t\t\tspeaker: ChatMessagePF2e.getSpeaker({\r\n\t\t\t\tactor: actor,\r\n\t\t\t\ttoken: actor.getActiveTokens(false, true).at(0),\r\n\t\t\t}),\r\n\t\t\tcontent: await renderTemplate(template, templateData),\r\n\t\t\tflags: { pf2e: { origin: item.getOriginData() } },\r\n\t\t},\r\n\t\trollMode,\r\n\t);\r\n\r\n\t// Create the chat message\r\n\treturn options.create ?? true\r\n\t\t? ChatMessagePF2e.create(chatData, { rollMode, renderSheet: false })\r\n\t\t: new ChatMessagePF2e(chatData, { rollMode });\r\n}\r\n\r\n/**\r\n * @param {ItemOrSource} item\r\n * @param  {...any: string[]} types\r\n * @returns {boolean}\r\n */\r\nexport function itemIsOfType(item, ...types) {\r\n\treturn (\r\n\t\ttypeof item.name === \"string\" &&\r\n\t\ttypes.some((t) =>\r\n\t\t\tt === \"physical\"\r\n\t\t\t\t? setHasElement(PHYSICAL_ITEM_TYPES, item.type)\r\n\t\t\t\t: item.type === t,\r\n\t\t)\r\n\t);\r\n}\r\n", "import { isObject } from \"./misc\";\r\n\r\n/**\r\n * Encapsulates logic to determine if a modifier should be active or not for a specific roll based\r\n * on a list of string values. This will often be based on traits, but that is not required - sneak\r\n * attack could be an option that is not a trait.\r\n * @category PF2\r\n */\r\nexport class PredicatePF2e extends Array {\r\n\tconstructor(...statements) {\r\n\t\tsuper(...(Array.isArray(statements[0]) ? statements[0] : statements));\r\n\t\tthis.isValid = PredicatePF2e.isValid(this);\r\n\t\tObject.defineProperty(this, \"isValid\", { enumerable: false });\r\n\t}\r\n\r\n\t/** Structurally validate the predicates */\r\n\tstatic isValid(statements) {\r\n\t\treturn Array.isArray(statements);\r\n\t}\r\n\r\n\t/** Is this an array of predicatation statements? */\r\n\tstatic isArray(statements) {\r\n\t\treturn Array.isArray(statements) && statements.every((s) => isStatement(s));\r\n\t}\r\n\r\n\t/** Test if the given predicate passes for the given list of options. */\r\n\tstatic test(predicate = [], options = []) {\r\n\t\treturn predicate instanceof PredicatePF2e\r\n\t\t\t? predicate.test(options)\r\n\t\t\t: new PredicatePF2e(...predicate).test(options);\r\n\t}\r\n\r\n\t/** Test this predicate against a domain of discourse */\r\n\ttest(options) {\r\n\t\tif (this.length === 0) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\tif (!this.isValid) {\r\n\t\t\tconsole.warn(\"PF2e System | The provided predicate set is malformed.\");\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tconst domain = options instanceof Set ? options : new Set(options);\r\n\t\treturn this.every((s) => this.#isTrue(s, domain));\r\n\t}\r\n\r\n\ttoObject() {\r\n\t\treturn deepClone([...this]);\r\n\t}\r\n\r\n\tclone() {\r\n\t\treturn new PredicatePF2e(this.toObject());\r\n\t}\r\n\r\n\t/** Is the provided statement true? */\r\n\t#isTrue(statement, domain) {\r\n\t\treturn (\r\n\t\t\t(typeof statement === \"string\" && domain.has(statement)) ||\r\n\t\t\t(isBinaryOp(statement) && this.#testBinaryOp(statement, domain)) ||\r\n\t\t\t(isCompound(statement) && this.#testCompound(statement, domain))\r\n\t\t);\r\n\t}\r\n\r\n\t#testBinaryOp(statement, domain) {\r\n\t\tif (\"eq\" in statement) {\r\n\t\t\treturn domain.has(`${statement.eq[0]}:${statement.eq[1]}`);\r\n\t\t}\r\n\r\n\t\tconst operator = Object.keys(statement)[0];\r\n\r\n\t\t// Allow for tests of partial statements against numeric values\r\n\t\t// E.g., `{ \"gt\": [\"actor:level\", 5] }` would match against \"actor:level:6\" and \"actor:level:7\"\r\n\t\tconst [left, right] = Object.values(statement)[0];\r\n\t\tconst domainArray = Array.from(domain);\r\n\t\tconst getValues = (operand) => {\r\n\t\t\tconst maybeNumber = Number(operand);\r\n\t\t\tif (!Number.isNaN(maybeNumber)) return [maybeNumber];\r\n\t\t\tconst pattern = new RegExp(String.raw`^${operand}:([^:]+)$`);\r\n\t\t\tconst values = domainArray\r\n\t\t\t\t.map((s) => Number(pattern.exec(s)?.[1] || NaN))\r\n\t\t\t\t.filter((v) => !Number.isNaN(v));\r\n\t\t\treturn values.length > 0 ? values : [NaN];\r\n\t\t};\r\n\t\tconst leftValues = getValues(left);\r\n\t\tconst rightValues = getValues(right);\r\n\r\n\t\tswitch (operator) {\r\n\t\t\tcase \"gt\":\r\n\t\t\t\treturn leftValues.some((l) => rightValues.every((r) => l > r));\r\n\t\t\tcase \"gte\":\r\n\t\t\t\treturn leftValues.some((l) => rightValues.every((r) => l >= r));\r\n\t\t\tcase \"lt\":\r\n\t\t\t\treturn leftValues.some((l) => rightValues.every((r) => l < r));\r\n\t\t\tcase \"lte\":\r\n\t\t\t\treturn leftValues.some((l) => rightValues.every((r) => l <= r));\r\n\t\t\tdefault:\r\n\t\t\t\tconsole.warn(\"PF2e System | Malformed binary operation encountered\");\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\t/** Is the provided compound statement true? */\r\n\t#testCompound(statement, domain) {\r\n\t\treturn (\r\n\t\t\t(\"and\" in statement &&\r\n\t\t\t\tstatement.and.every((subProp) => this.#isTrue(subProp, domain))) ||\r\n\t\t\t(\"nand\" in statement &&\r\n\t\t\t\t!statement.nand.every((subProp) => this.#isTrue(subProp, domain))) ||\r\n\t\t\t(\"or\" in statement &&\r\n\t\t\t\tstatement.or.some((subProp) => this.#isTrue(subProp, domain))) ||\r\n\t\t\t(\"xor\" in statement &&\r\n\t\t\t\tstatement.xor.filter((subProp) => this.#isTrue(subProp, domain))\r\n\t\t\t\t\t.length === 1) ||\r\n\t\t\t(\"nor\" in statement &&\r\n\t\t\t\t!statement.nor.some((subProp) => this.#isTrue(subProp, domain))) ||\r\n\t\t\t(\"not\" in statement && !this.#isTrue(statement.not, domain)) ||\r\n\t\t\t(\"if\" in statement &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tthis.#isTrue(statement.if, domain) &&\r\n\t\t\t\t\t!this.#isTrue(statement.then, domain)\r\n\t\t\t\t))\r\n\t\t);\r\n\t}\r\n}\r\n\r\nfunction isStatement(statement) {\r\n\treturn statement instanceof Object\r\n\t\t? isCompound(statement) || isBinaryOp(statement)\r\n\t\t: typeof statement === \"string\"\r\n\t\t  ? isAtomic(statement)\r\n\t\t  : false;\r\n}\r\n\r\nfunction isAtomic(statement) {\r\n\treturn (\r\n\t\t(typeof statement === \"string\" && statement.length > 0) ||\r\n\t\tisBinaryOp(statement)\r\n\t);\r\n}\r\n\r\nconst binaryOperators = new Set([\"eq\", \"gt\", \"gte\", \"lt\", \"lte\"]);\r\n\r\nfunction isBinaryOp(statement) {\r\n\tif (!isObject(statement)) return false;\r\n\tconst entries = Object.entries(statement);\r\n\tif (entries.length > 1) return false;\r\n\tconst [operator, operands] = entries[0];\r\n\treturn (\r\n\t\tbinaryOperators.has(operator) &&\r\n\t\tArray.isArray(operands) &&\r\n\t\toperands.length === 2 &&\r\n\t\ttypeof operands[0] === \"string\" &&\r\n\t\t[\"string\", \"number\"].includes(typeof operands[1])\r\n\t);\r\n}\r\n\r\nfunction isCompound(statement) {\r\n\treturn (\r\n\t\tisObject(statement) &&\r\n\t\t(isAnd(statement) ||\r\n\t\t\tisOr(statement) ||\r\n\t\t\tisNand(statement) ||\r\n\t\t\tisXor(statement) ||\r\n\t\t\tisNor(statement) ||\r\n\t\t\tisNot(statement) ||\r\n\t\t\tisIf(statement))\r\n\t);\r\n}\r\n\r\nfunction isAnd(statement) {\r\n\treturn (\r\n\t\tObject.keys(statement).length === 1 &&\r\n\t\tArray.isArray(statement.and) &&\r\n\t\tstatement.and.every((subProp) => isStatement(subProp))\r\n\t);\r\n}\r\n\r\nfunction isNand(statement) {\r\n\treturn (\r\n\t\tObject.keys(statement).length === 1 &&\r\n\t\tArray.isArray(statement.nand) &&\r\n\t\tstatement.nand.every((subProp) => isStatement(subProp))\r\n\t);\r\n}\r\n\r\nfunction isOr(statement) {\r\n\treturn (\r\n\t\tObject.keys(statement).length === 1 &&\r\n\t\tArray.isArray(statement.or) &&\r\n\t\tstatement.or.every((subProp) => isStatement(subProp))\r\n\t);\r\n}\r\n\r\nfunction isXor(statement) {\r\n\treturn (\r\n\t\tObject.keys(statement).length === 1 &&\r\n\t\tArray.isArray(statement.xor) &&\r\n\t\tstatement.xor.every((subProp) => isStatement(subProp))\r\n\t);\r\n}\r\n\r\nfunction isNor(statement) {\r\n\treturn (\r\n\t\tObject.keys(statement).length === 1 &&\r\n\t\tArray.isArray(statement.nor) &&\r\n\t\tstatement.nor.every((subProp) => isStatement(subProp))\r\n\t);\r\n}\r\n\r\nfunction isNot(statement) {\r\n\treturn (\r\n\t\tObject.keys(statement).length === 1 &&\r\n\t\t!!statement.not &&\r\n\t\tisStatement(statement.not)\r\n\t);\r\n}\r\n\r\nfunction isIf(statement) {\r\n\treturn (\r\n\t\tObject.keys(statement).length === 2 &&\r\n\t\tisStatement(statement.if) &&\r\n\t\tisStatement(statement.then)\r\n\t);\r\n}\r\n", "import * as R from \"remeda\";\r\nimport { calculateDC } from \"./dc\";\r\nimport { ErrorPF2e, setHasElement } from \"./misc\";\r\nimport { MAGIC_TRADITIONS, traditionSkills } from \"./spell\";\r\nimport { isInstanceOf } from \"../utils\";\r\n\r\n/**\r\n * @typedef {\"scroll\" | \"wand\" | \"cantripDeck5\"} SpellConsumableItemType\r\n */\r\n\r\nconst CANTRIP_DECK_ID = \"tLa4bewBhyqzi6Ow\";\r\n\r\nconst scrollCompendiumIds = {\r\n\t1: \"RjuupS9xyXDLgyIr\",\r\n\t2: \"Y7UD64foDbDMV9sx\",\r\n\t3: \"ZmefGBXGJF3CFDbn\",\r\n\t4: \"QSQZJ5BC3DeHv153\",\r\n\t5: \"tjLvRWklAylFhBHQ\",\r\n\t6: \"4sGIy77COooxhQuC\",\r\n\t7: \"fomEZZ4MxVVK3uVu\",\r\n\t8: \"iPki3yuoucnj7bIt\",\r\n\t9: \"cFHomF3tty8Wi1e5\",\r\n\t10: \"o1XIHJ4MJyroAHfF\",\r\n};\r\n\r\nconst SPELL_CONSUMABLE_ITEM_TYPE = new Set([\"cantripDeck5\", \"scroll\", \"wand\"]);\r\nconst SPELL_CONSUMABLE_NAME_TEMPLATES = {\r\n\tcantripDeck5: \"PF2E.Item.Physical.FromSpell.CantripDeck5\",\r\n\tscroll: \"PF2E.Item.Physical.FromSpell.Scroll\",\r\n\twand: \"PF2E.Item.Physical.FromSpell.Wand\",\r\n};\r\n\r\nconst wandCompendiumIds = {\r\n\t1: \"UJWiN0K3jqVjxvKk\",\r\n\t2: \"vJZ49cgi8szuQXAD\",\r\n\t3: \"wrDmWkGxmwzYtfiA\",\r\n\t4: \"Sn7v9SsbEDMUIwrO\",\r\n\t5: \"5BF7zMnrPYzyigCs\",\r\n\t6: \"kiXh4SUWKr166ZeM\",\r\n\t7: \"nmXPj9zuMRQBNT60\",\r\n\t8: \"Qs8RgNH6thRPv2jt\",\r\n\t9: \"Fgv722039TVM5JTc\",\r\n};\r\n\r\n/**\r\n * @param {Item} item\r\n * @param {object} [options]\r\n * @param {boolean} [options.pwol]\r\n * @returns {number}\r\n */\r\nexport function calculateTrickMagicItemCheckDC(\r\n\titem,\r\n\toptions = { pwol: false },\r\n) {\r\n\tconst level = Number(item.level);\r\n\tconst saveDC = calculateDC(level, options);\r\n\r\n\tconst traditions = item.system.spell?.system.traits.traditions ?? [];\r\n\tconst skills = [...item.system.traits.value, ...traditions]\r\n\t\t.filter((t) => setHasElement(MAGIC_TRADITIONS, t))\r\n\t\t.map((tradition) => [traditionSkills[tradition], saveDC]);\r\n\r\n\treturn Object.fromEntries(skills);\r\n}\r\n\r\n/**\r\n * @param {SpellPF2e} spell\r\n * @param {object} options\r\n * @param {SpellConsumableItemType} options.type\r\n * @param {number} [options.heightenedLevel]\r\n * @param {boolean} [options.mystified]\r\n * @param {boolean} [options.temp]\r\n * @param {string} [options.itemImg]\r\n * @param {string} [options.itemName]\r\n * @returns {Promise<ConsumableSource>}\r\n */\r\nexport async function createConsumableFromSpell(\r\n\tspell,\r\n\t{\r\n\t\ttype,\r\n\t\theightenedLevel = spell.baseRank,\r\n\t\tmystified = false,\r\n\t\ttemp = false,\r\n\t\titemImg,\r\n\t\titemName = type,\r\n\t},\r\n) {\r\n\tconst pack = game.packs.find((p) => p.collection === \"pf2e.equipment-srd\");\r\n\tconst itemId = getIdForSpellConsumable(type, heightenedLevel);\r\n\tconst consumable = await pack?.getDocument(itemId ?? \"\");\r\n\tif (!isInstanceOf(consumable, \"ConsumablePF2e\")) {\r\n\t\tthrow ErrorPF2e(\"Failed to retrieve consumable item\");\r\n\t}\r\n\r\n\tconst consumableSource = { ...consumable.toObject(), _id: null }; // Clear _id\r\n\r\n\tconst { traits } = consumableSource.system;\r\n\ttraits.value = R.uniq([...traits.value, ...spell.traits]);\r\n\ttraits.rarity = spell.rarity;\r\n\tif (\r\n\t\ttraits.value.includes(\"magical\") &&\r\n\t\ttraits.value.some((t) => setHasElement(MAGIC_TRADITIONS, t))\r\n\t) {\r\n\t\ttraits.value.splice(traits.value.indexOf(\"magical\"), 1);\r\n\t}\r\n\ttraits.value.sort();\r\n\r\n\tconsumableSource.name = getNameForSpellConsumable(\r\n\t\titemName,\r\n\t\tspell.name,\r\n\t\theightenedLevel,\r\n\t);\r\n\tconst description = consumableSource.system.description.value;\r\n\r\n\tconsumableSource.system.description.value = (() => {\r\n\t\tconst paragraphElement = document.createElement(\"p\");\r\n\t\tparagraphElement.append(\r\n\t\t\tspell.sourceId\r\n\t\t\t\t? `@UUID[${spell.sourceId}]{${spell.name}}`\r\n\t\t\t\t: spell.description,\r\n\t\t);\r\n\r\n\t\tconst containerElement = document.createElement(\"div\");\r\n\t\tconst hrElement = document.createElement(\"hr\");\r\n\t\tcontainerElement.append(paragraphElement, hrElement);\r\n\t\thrElement.insertAdjacentHTML(\"afterend\", description);\r\n\r\n\t\treturn containerElement.innerHTML;\r\n\t})();\r\n\r\n\t// Cantrip deck casts at level 1\r\n\tif (type !== \"cantripDeck5\") {\r\n\t\tconsumableSource.system.spell = spell\r\n\t\t\t.clone(\r\n\t\t\t\t{\r\n\t\t\t\t\t_id: randomID(),\r\n\t\t\t\t\t\"system.location.heightenedLevel\": heightenedLevel,\r\n\t\t\t\t},\r\n\t\t\t\t{ keepId: true },\r\n\t\t\t)\r\n\t\t\t.toObject();\r\n\t}\r\n\r\n\tif (mystified) {\r\n\t\tconsumableSource.system.identification.status = \"unidentified\";\r\n\t}\r\n\r\n\tif (typeof itemImg === \"string\") {\r\n\t\tconsumableSource.img = itemImg;\r\n\t}\r\n\r\n\tif (temp) {\r\n\t\tconsumableSource.system.temporary = true;\r\n\t}\r\n\r\n\treturn consumableSource;\r\n}\r\n\r\n/**\r\n *\r\n * @param {SpellConsumableItemType} type\r\n * @param {number} heightenedLevel\r\n * @returns {string | null}\r\n */\r\nexport function getIdForSpellConsumable(type, heightenedLevel) {\r\n\tswitch (type) {\r\n\t\tcase \"cantripDeck5\":\r\n\t\t\treturn CANTRIP_DECK_ID;\r\n\t\tcase \"scroll\":\r\n\t\t\treturn scrollCompendiumIds[heightenedLevel] ?? null;\r\n\t\tdefault:\r\n\t\t\treturn wandCompendiumIds[heightenedLevel] ?? null;\r\n\t}\r\n}\r\n\r\n/**\r\n *\r\n * @param {SpellConsumableItemType} type\r\n * @param {string} spellName\r\n * @param {number} heightenedLevel\r\n * @returns {string}\r\n */\r\nexport function getNameForSpellConsumable(type, spellName, heightenedLevel) {\r\n\tconst templateId =\r\n\t\tSPELL_CONSUMABLE_NAME_TEMPLATES[type] ||\r\n\t\t`${type} of {name} (Level {level})`;\r\n\treturn game.i18n.format(templateId, {\r\n\t\tname: spellName,\r\n\t\tlevel: heightenedLevel,\r\n\t});\r\n}\r\n", "export function createSpellDaily(key, uuid, filter, level, label) {\r\n\tconst daily = {\r\n\t\tkey,\r\n\t\tlabel,\r\n\t\titem: {\r\n\t\t\tuuid,\r\n\t\t},\r\n\t\trows: [\r\n\t\t\t{\r\n\t\t\t\ttype: \"drop\",\r\n\t\t\t\tslug: \"spell\",\r\n\t\t\t\tfilter: {\r\n\t\t\t\t\ttype: \"spell\",\r\n\t\t\t\t\tsearch: filter ?? {},\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t],\r\n\t\tprocess: async ({ addSpell, utils, fields, messages }) => {\r\n\t\t\tconst uuid = fields.spell.uuid;\r\n\t\t\tconst source = await utils.createSpellSource(uuid);\r\n\t\t\tconst spellLevel = level ?? source.system.level.value;\r\n\t\t\tconst label = `${source.name} (Level ${spellLevel})`;\r\n\t\t\taddSpell(source, level);\r\n\t\t\tmessages.add(\"spells\", { uuid, label });\r\n\t\t},\r\n\t};\r\n\treturn daily;\r\n}\r\n", "import { localizePath } from \"module-api\";\r\nimport { createSpellDaily } from \"./spell\";\r\n\r\nexport function tricksterAce() {\r\n\tconst daily = createSpellDaily(\r\n\t\t\"ace\",\r\n\t\t\"Compendium.pf2e.feats-srd.Item.POrE3ZgBRdBL9MsW\",\r\n\t\t{\r\n\t\t\tcategory: [],\r\n\t\t\tlevel: 4,\r\n\t\t},\r\n\t\t4,\r\n\t);\r\n\r\n\tconst row = daily.rows[0];\r\n\trow.filter.drop = (item) => {\r\n\t\tconst castTime = item.system.time.value;\r\n\t\tif (\r\n\t\t\tcastTime.includes(\"hour\") ||\r\n\t\t\t(castTime.includes(\"min\") && parseInt(castTime) > 10)\r\n\t\t) {\r\n\t\t\treturn {\r\n\t\t\t\terror: localizePath(\"interface.error.drop.wrongSpellTime\"),\r\n\t\t\t\tdata: { time: \"10 min\" },\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn true;\r\n\t};\r\n\r\n\treturn daily;\r\n}\r\n", "import { localize } from \"module-api\";\r\n\r\nexport const bladeAlly = {\r\n\tkey: \"blade\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.classfeatures.Item.EtltLdiy9kNfHU0c\", // Blade Ally\r\n\t},\r\n\tchildren: [\r\n\t\t{\r\n\t\t\tslug: \"good\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.nxZYP3KGfTSkaW6J\", // The Tenets of Good\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"evil\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.JiY2ZB4FkK8RJm4T\", // The Tenets of Evil\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"liberator\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.FCoMFUsth4xB4veC\", // Liberator\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"paladin\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.peEXunfbSD8WcMFk\", // Paladin\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"antipaladin\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.EQ6DVIQHAUXUhY6Y\", // Antipaladin\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"tyrant\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.HiIvez0TqESbleB5\", // Tyrant\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"spirit\",\r\n\t\t\tuuid: \"Compendium.pf2e.feats-srd.Item.h5ksUZlrVGBjq6p4\", // Radiant Blade Spirit\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"master\",\r\n\t\t\tuuid: \"Compendium.pf2e.feats-srd.Item.jYEMVfrXJLpXS6aC\", // Radiant Blade Master\r\n\t\t},\r\n\t],\r\n\trows: [\r\n\t\t{\r\n\t\t\ttype: \"select\",\r\n\t\t\tslug: \"weapon\",\r\n\t\t\tlabel: () => localize(\"label.blade.weapon\"),\r\n\t\t\toptions: ({ actor }) => {\r\n\t\t\t\treturn actor.itemTypes.weapon\r\n\t\t\t\t\t.filter((weapon) => !weapon.isAlchemical)\r\n\t\t\t\t\t.map((weapon) => ({ value: weapon.id, label: weapon.name }));\r\n\t\t\t},\r\n\t\t},\r\n\t\t{\r\n\t\t\ttype: \"select\",\r\n\t\t\tslug: \"rune\",\r\n\t\t\tlabel: () => localize(\"label.blade.rune\"),\r\n\t\t\toptions: ({ children }) => {\r\n\t\t\t\tconst runes = [\"returning\", \"shifting\"];\r\n\r\n\t\t\t\tconst {\r\n\t\t\t\t\tantipaladin,\r\n\t\t\t\t\tevil,\r\n\t\t\t\t\tgood,\r\n\t\t\t\t\tliberator,\r\n\t\t\t\t\tmaster,\r\n\t\t\t\t\tpaladin,\r\n\t\t\t\t\tspirit,\r\n\t\t\t\t\ttyrant,\r\n\t\t\t\t} = children;\r\n\r\n\t\t\t\tif (spirit) {\r\n\t\t\t\t\trunes.push(\"flaming\");\r\n\t\t\t\t\tif (good) runes.push(\"holy\");\r\n\t\t\t\t\tif (evil) runes.push(\"unholy\");\r\n\t\t\t\t\tif (liberator || antipaladin) runes.push(\"anarchic\");\r\n\t\t\t\t\tif (paladin || tyrant) runes.push(\"axiomatic\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (good) runes.push(\"disrupting\", \"ghost-touch\");\r\n\t\t\t\tif (master) runes.push(\"greater-disrupting\", \"keen\");\r\n\t\t\t\tif (evil) runes.push(\"fearsome\");\r\n\r\n\t\t\t\treturn runes.map((value) => ({\r\n\t\t\t\t\tvalue,\r\n\t\t\t\t\tlabel: localizeRune(value),\r\n\t\t\t\t}));\r\n\t\t\t},\r\n\t\t\tcondition: ({ actor }) =>\r\n\t\t\t\tactor.itemTypes.weapon.filter((weapon) => !weapon.isAlchemical).length,\r\n\t\t},\r\n\t],\r\n\tprocess: async ({ actor, fields, addRule, messages }) => {\r\n\t\tconst weaponId = fields.weapon.value;\r\n\t\tconst rune = fields.rune.value;\r\n\r\n\t\tconst weapon = actor.items.get(weaponId);\r\n\t\tif (!weapon) return;\r\n\r\n\t\taddRule(\r\n\t\t\t{\r\n\t\t\t\tdefinition: [`item:id:${weaponId}`],\r\n\t\t\t\tkey: \"AdjustStrike\",\r\n\t\t\t\tmode: \"add\",\r\n\t\t\t\tproperty: \"property-runes\",\r\n\t\t\t\tvalue: rune,\r\n\t\t\t},\r\n\t\t\tweapon,\r\n\t\t);\r\n\r\n\t\taddRule(\r\n\t\t\t{\r\n\t\t\t\tkey: \"CriticalSpecialization\",\r\n\t\t\t\tpredicate: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tor: [`item:category:${weapon.category}`, `item:id:${weaponId}`],\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t},\r\n\t\t\tweapon,\r\n\t\t);\r\n\r\n\t\tconst name =\r\n\t\t\tweapon.name !== weapon._source.name\r\n\t\t\t\t? `... ${weapon._source.name}`\r\n\t\t\t\t: weapon.name;\r\n\r\n\t\tmessages.addGroup(\"blade\");\r\n\t\tmessages.add(\"blade\", {\r\n\t\t\tuuid: weapon.uuid,\r\n\t\t\tlabel: name,\r\n\t\t\tselected: localizeRune(rune),\r\n\t\t});\r\n\t},\r\n};\r\n\r\nfunction localizeRune(value) {\r\n\tconst slugged = value.replace(/-\\w/, (match) => match[1].toUpperCase());\r\n\treturn game.i18n.localize(`PF2E.WeaponPropertyRune.${slugged}.Name`);\r\n}\r\n", "const ICON = \"systems/pf2e/icons/equipment/weapons/wish-knife.webp\";\r\n\r\nexport const ceremonialKnife = {\r\n\tkey: \"ceremonial\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.feats-srd.Item.78pkCdFaY8hI07Lj\",\r\n\t\tcondition: ({ actor }) =>\r\n\t\t\tactor.itemTypes.weapon.some((weapon) => weapon.group === \"knife\"),\r\n\t},\r\n\trows: [\r\n\t\t{\r\n\t\t\ttype: \"drop\",\r\n\t\t\tslug: \"spell\",\r\n\t\t\tlabel: ({ utils, actor }) => utils.spellRankLabel(calculateRank(actor)),\r\n\t\t\tfilter: {\r\n\t\t\t\ttype: \"spell\",\r\n\t\t\t\tsearch: ({ actor }) => ({\r\n\t\t\t\t\tcategory: [\"spell\"],\r\n\t\t\t\t\tlevel: calculateRank(actor),\r\n\t\t\t\t}),\r\n\t\t\t},\r\n\t\t},\r\n\t],\r\n\tprocess: async ({ actor, fields, utils, item, addItem, messages }) => {\r\n\t\tconst uuid = fields.spell.uuid;\r\n\t\tconst level = calculateRank(actor);\r\n\t\tconst source = await utils.createWandSource({\r\n\t\t\tuuid,\r\n\t\t\tlevel,\r\n\t\t\titemName: item.name,\r\n\t\t\titemImg: ICON,\r\n\t\t});\r\n\r\n\t\taddItem(source);\r\n\r\n\t\tmessages.addGroup(\"ceremonial\");\r\n\t\tmessages.add(\"ceremonial\", { uuid, label: source.name });\r\n\t},\r\n};\r\n\r\nfunction calculateRank(actor) {\r\n\treturn Math.ceil((actor.level - 5) / 2);\r\n}\r\n", "const rows = [\r\n\t\"first\",\r\n\t\"second\",\r\n\t\"third\",\r\n\t\"fourth\",\r\n\t\"fifth\",\r\n\t\"sixth\",\r\n\t\"seventh\",\r\n];\r\n\r\nexport function createScrollChain(key, uuids, label) {\r\n\tconst daily = {\r\n\t\tkey,\r\n\t\tlabel,\r\n\t\titem: {\r\n\t\t\tuuid: uuids[0],\r\n\t\t},\r\n\t\tchildren: [\r\n\t\t\t{\r\n\t\t\t\tslug: \"expert\",\r\n\t\t\t\tuuid: uuids[1],\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tslug: \"master\",\r\n\t\t\t\tuuid: uuids[2],\r\n\t\t\t},\r\n\t\t],\r\n\t\trows: [\r\n\t\t\tcreateRow(\"first\", 1),\r\n\t\t\tcreateRow(\"second\", 2, 8),\r\n\t\t\tcreateRow(\"third\", 3, undefined, \"expert\"),\r\n\t\t\tcreateRow(\"fourth\", 4, 14, \"expert\"),\r\n\t\t\tcreateRow(\"fifth\", 5, 16, \"expert\"),\r\n\t\t\tcreateRow(\"sixth\", 6, undefined, \"master\"),\r\n\t\t\tcreateRow(\"seventh\", 7, 20, \"master\"),\r\n\t\t],\r\n\t\tprocess: async ({ utils, fields, addItem, messages }) => {\r\n\t\t\tfor (const field of Object.values(fields)) {\r\n\t\t\t\tconst uuid = field.uuid;\r\n\t\t\t\tconst level = rows.indexOf(field.row) + 1;\r\n\t\t\t\tconst source = await utils.createSpellScrollSource({ uuid, level });\r\n\t\t\t\taddItem(source);\r\n\t\t\t\tmessages.add(\"scrolls\", { uuid, label: source.name });\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n\treturn daily;\r\n}\r\n\r\nfunction createRow(slug, level, minActorLevel, child) {\r\n\tconst row = {\r\n\t\ttype: \"drop\",\r\n\t\tslug,\r\n\t\tlabel: ({ utils }) => utils.spellRankLabel(level),\r\n\t\tfilter: {\r\n\t\t\ttype: \"spell\",\r\n\t\t\tsearch: {\r\n\t\t\t\tcategory: [\"spell\"],\r\n\t\t\t\tlevel,\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\tif (minActorLevel)\r\n\t\trow.condition = ({ actor }) => actor.level >= minActorLevel;\r\n\tif (child) row.childPredicate = [child];\r\n\treturn row;\r\n}\r\n", "export const combatFlexibility = {\r\n\tkey: \"flexibility\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8\", // Combat Flexibility\r\n\t},\r\n\tchildren: [\r\n\t\t{\r\n\t\t\tslug: \"improved\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX\", // Improved Flexibility\r\n\t\t},\r\n\t],\r\n\trows: [\r\n\t\tcreateRow(\"flexibility\", 8), //\r\n\t\tcreateRow(\"improved\", 14, \"improved\"),\r\n\t],\r\n\tprocess: async ({ utils, fields, addFeat, messages, children }) => {\r\n\t\tconst uuid = fields.flexibility.uuid;\r\n\t\tconst source = await utils.createFeatSource(uuid);\r\n\t\taddFeat(source);\r\n\t\tmessages.add(\"feats\", { uuid });\r\n\r\n\t\tif (children.improved) {\r\n\t\t\tconst uuid = fields.improved.uuid;\r\n\t\t\tconst source = await utils.createFeatSource(uuid);\r\n\t\t\taddFeat(source, children.improved);\r\n\t\t\tmessages.add(\"feats\", { uuid });\r\n\t\t}\r\n\t},\r\n};\r\n\r\nfunction createRow(slug, level, child) {\r\n\tconst row = {\r\n\t\ttype: \"drop\",\r\n\t\tlabel: `PF2E.Level${level}`,\r\n\t\tslug,\r\n\t\tfilter: {\r\n\t\t\ttype: \"feat\",\r\n\t\t\tsearch: {\r\n\t\t\t\tcategory: [\"class\"],\r\n\t\t\t\ttraits: [\"fighter\"],\r\n\t\t\t\tlevel,\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\tif (child) row.childPredicate = [child];\r\n\treturn row;\r\n}\r\n", "export function createLanguageDaily(key, uuid, label) {\r\n\treturn {\r\n\t\tkey,\r\n\t\tlabel,\r\n\t\titem: {\r\n\t\t\tuuid,\r\n\t\t},\r\n\t\trows: [\r\n\t\t\t{\r\n\t\t\t\ttype: \"select\",\r\n\t\t\t\tslug: \"language\",\r\n\t\t\t\toptions: ({ actor, utils }) => {\r\n\t\t\t\t\tconst actorLanguages = actor.system.details.languages.value;\r\n\t\t\t\t\treturn utils.languageNames\r\n\t\t\t\t\t\t.filter((x) => !actorLanguages.includes(x))\r\n\t\t\t\t\t\t.sort();\r\n\t\t\t\t},\r\n\t\t\t\tlabelizer: ({ utils }) => utils.languageLabel,\r\n\t\t\t},\r\n\t\t],\r\n\t\tprocess: ({ addRule, utils, fields, messages }) => {\r\n\t\t\tconst value = fields.language.value;\r\n\t\t\tconst source = utils.createLanguageRuleElement({ language: value });\r\n\t\t\taddRule(source);\r\n\t\t\tmessages.add(\"languages\", {\r\n\t\t\t\tuuid,\r\n\t\t\t\tselected: utils.languageLabel(value),\r\n\t\t\t\tlabel,\r\n\t\t\t});\r\n\t\t},\r\n\t};\r\n}\r\n", "export function createTrainedSkillDaily(key, uuid, label) {\r\n\tconst daily = {\r\n\t\tkey,\r\n\t\tlabel,\r\n\t\titem: {\r\n\t\t\tuuid,\r\n\t\t},\r\n\t\trows: [createComboSkillRow(\"skill\", 0)],\r\n\t\tprocess: (api) => {\r\n\t\t\tprocessComboSkill(api, { uuid, label });\r\n\t\t},\r\n\t};\r\n\treturn daily;\r\n}\r\n\r\nexport function processComboSkill(\r\n\t{ fields, addItem, addRule, utils, messages, removeRule },\r\n\t{ field = \"skill\", uuid, label, rank = 1, parent },\r\n) {\r\n\tremoveRule(\r\n\t\t(rule) =>\r\n\t\t\trule.key === \"ActiveEffectLike\" &&\r\n\t\t\trule.mode === \"upgrade\" &&\r\n\t\t\trule.phase === \"beforeDerived\" &&\r\n\t\t\trule.path?.startsWith(\"system.skills.\"),\r\n\t\tparent,\r\n\t);\r\n\r\n\tremoveRule(\r\n\t\t(rule) =>\r\n\t\t\trule.key === \"RollOption\" &&\r\n\t\t\trule.toggleable &&\r\n\t\t\trule.alwaysActive &&\r\n\t\t\trule.phase === \"beforeDerived\" &&\r\n\t\t\trule.suboptions.some((suboption) => suboption.label === \"PF2E.SkillAcr\"),\r\n\t\tparent,\r\n\t);\r\n\r\n\tlet value = fields[field].value;\r\n\r\n\tif (fields[field].input === \"true\") {\r\n\t\tconst source = utils.createLoreSource({ name: value, rank });\r\n\t\taddItem(source);\r\n\t} else {\r\n\t\tconst source = utils.createSkillRuleElement({ skill: value, value: rank });\r\n\t\tvalue = utils.skillLabel(value);\r\n\t\taddRule(source, parent);\r\n\t}\r\n\r\n\tmessages.add(\"skills\", { uuid, selected: value, label });\r\n}\r\n\r\nexport function createComboSkillRow(slug, rank, extras = {}) {\r\n\treturn {\r\n\t\ttype: \"combo\",\r\n\t\tslug,\r\n\t\toptions: ({ actor, utils }) => {\r\n\t\t\tconst actorSkills = actor.skills;\r\n\t\t\treturn utils.skillNames.filter((x) => actorSkills[x].rank === rank);\r\n\t\t},\r\n\t\tlabelizer: ({ utils }) => utils.skillLabel,\r\n\t\t...extras,\r\n\t};\r\n}\r\n\r\nexport function createTrainedLoreDaily(key, uuid, label) {\r\n\tconst daily = {\r\n\t\tkey,\r\n\t\tlabel,\r\n\t\titem: {\r\n\t\t\tuuid,\r\n\t\t},\r\n\t\trows: [\r\n\t\t\t{\r\n\t\t\t\ttype: \"input\",\r\n\t\t\t\tslug: \"skill\",\r\n\t\t\t},\r\n\t\t],\r\n\t\tprocess: ({ addItem, utils, fields, messages }) => {\r\n\t\t\tconst value = fields.skill.value;\r\n\t\t\tconst source = utils.createLoreSource({ name: value, rank: 1 });\r\n\t\t\taddItem(source);\r\n\t\t\tmessages.add(\"skills\", { uuid, selected: value, label });\r\n\t\t},\r\n\t};\r\n\treturn daily;\r\n}\r\n", "import { createComboSkillRow, processComboSkill } from \"./skill\";\r\n\r\nexport const longevities = {\r\n\tkey: \"longevities\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.feats-srd.Item.WoLh16gyDp8y9WOZ\", // Ancestral Longevity\r\n\t},\r\n\tchildren: [\r\n\t\t{\r\n\t\t\tslug: \"expert\",\r\n\t\t\tuuid: \"Compendium.pf2e.feats-srd.Item.vfuHVSuExvtyajkW\", // Expert Longevity\r\n\t\t},\r\n\t],\r\n\trows: [\r\n\t\tcreateComboSkillRow(\"ancestral\", 0, {\r\n\t\t\tlabel: ({ item }) => item.name,\r\n\t\t}),\r\n\t\tcreateComboSkillRow(\"expert\", 1, {\r\n\t\t\tlabel: ({ children }) => children.expert?.name,\r\n\t\t\tchildPredicate: [\"expert\"],\r\n\t\t}),\r\n\t],\r\n\tprocess: async (api) => {\r\n\t\tconst feats = [\r\n\t\t\t{ field: \"ancestral\", rank: 1, item: api.item },\r\n\t\t\t{ field: \"expert\", rank: 2, item: api.children.expert },\r\n\t\t];\r\n\r\n\t\tfor (const { field, rank, item } of feats) {\r\n\t\t\tif (!api.fields[field]) continue;\r\n\t\t\tprocessComboSkill(api, {\r\n\t\t\t\tlabel: item.name,\r\n\t\t\t\tuuid: item.uuid,\r\n\t\t\t\tfield,\r\n\t\t\t\trank,\r\n\t\t\t\tparent: item,\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n};\r\n", "import {\r\n\tMODULE,\r\n\tgetFlag,\r\n\tgetItemWithSourceId,\r\n\tlocalize,\r\n\tsubLocalize,\r\n} from \"module-api\";\r\n\r\nconst MIND_WEAPON_UUID =\r\n\t\"Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P\";\r\nconst MALLEABLE_MENTAL_FORGE_UUID =\r\n\t\"Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky\";\r\n\r\nconst WEAPON_BASE_TYPES = {\r\n\t0: { die: \"d4\", traits: [\"finesse\", \"agile\"], usage: \"held-in-one-hand\" },\r\n\t1: { die: \"d6\", traits: [\"finesse\"], usage: \"held-in-one-hand\" },\r\n\t2: { die: \"d8\", traits: [], usage: \"held-in-one-hand\" },\r\n\t3: { die: \"d10\", traits: [\"reach\"], usage: \"held-in-two-hands\" },\r\n};\r\n\r\nconst WEAPON_GROUPS = {\r\n\tslashing: \"sword\",\r\n\tpiercing: \"spear\",\r\n\tbludgeoning: \"club\",\r\n};\r\n\r\nconst WEAPON_TRAITS = [\"grapple\", \"nonlethal\", \"shove\", \"trip\", \"modular\"];\r\n\r\nconst WEAPON_DAMAGE_TYPES = Object.keys(WEAPON_GROUPS);\r\n\r\nconst WEAPON_RUNES = [\r\n\t\"corrosive\",\r\n\t\"disrupting\",\r\n\t\"flaming\",\r\n\t\"frost\",\r\n\t\"shock\",\r\n\t\"thundering\",\r\n];\r\n\r\nconst WEAPON_GREATER_RUNES = [\r\n\t// \"anarchic\",\r\n\t// \"axiomatic\",\r\n\t\"greaterCorrosive\",\r\n\t\"greaterDisrupting\",\r\n\t\"greaterFlaming\",\r\n\t\"greaterFrost\",\r\n\t\"greaterShock\",\r\n\t\"greaterThundering\",\r\n\t\"holy\",\r\n\t\"unholy\",\r\n];\r\n\r\nexport const mindSmith = {\r\n\tkey: \"mindsmith\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY\", // Mind Smith Dedication\r\n\t},\r\n\tchildren: [\r\n\t\t{\r\n\t\t\tslug: \"weapon\",\r\n\t\t\tuuid: MIND_WEAPON_UUID, // Mind Weapon\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"mental\",\r\n\t\t\tuuid: MALLEABLE_MENTAL_FORGE_UUID, // Malleable Mental Forge\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"runic\",\r\n\t\t\tuuid: \"Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp\", // Runic Mind Smithing\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"advanced\",\r\n\t\t\tuuid: \"Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD\", // Advanced Runic Mind Smithing\r\n\t\t},\r\n\t],\r\n\trows: [\r\n\t\t{\r\n\t\t\ttype: \"alert\",\r\n\t\t\tslug: \"alert\",\r\n\t\t\tmessage: () => localize(\"interface.alert.weapon\"),\r\n\t\t\tfix,\r\n\t\t\tchildPredicate: [{ not: \"weapon\" }],\r\n\t\t},\r\n\t\t{\r\n\t\t\ttype: \"select\",\r\n\t\t\tslug: \"smith\",\r\n\t\t\tlabel: () => localize(\"label.mindsmith\"),\r\n\t\t\toptions: WEAPON_DAMAGE_TYPES,\r\n\t\t\tlabelizer: ({ utils }) => utils.damageLabel,\r\n\t\t\tchildPredicate: [\"weapon\"],\r\n\t\t},\r\n\t\t...[1, 2].map((nb) => ({\r\n\t\t\ttype: \"select\",\r\n\t\t\tslug: `mental${nb}`,\r\n\t\t\tlabel: () => localize(\"label.mentalforge\", { nb }),\r\n\t\t\toptions: WEAPON_TRAITS,\r\n\t\t\tlabelizer: ({ utils }) => utils.weaponTraitLabel,\r\n\t\t\tunique: \"mental\",\r\n\t\t\tchildPredicate: [\"weapon\", \"mental\"],\r\n\t\t})),\r\n\t\t{\r\n\t\t\ttype: \"select\",\r\n\t\t\tslug: \"runic\",\r\n\t\t\tlabel: () => localize(\"label.runicmind\"),\r\n\t\t\toptions: WEAPON_RUNES,\r\n\t\t\tlabelizer: ({ utils }) => utils.weaponPropertyRunesLabel,\r\n\t\t\tchildPredicate: [\"weapon\", \"runic\", { not: \"advanced\" }],\r\n\t\t\tcondition: ({ children, utils }) =>\r\n\t\t\t\tutils.hasFreePropertySlot(children.weapon),\r\n\t\t},\r\n\t\t{\r\n\t\t\ttype: \"select\",\r\n\t\t\tslug: \"advanced\",\r\n\t\t\tlabel: () => localize(\"label.runicmind\"),\r\n\t\t\toptions: WEAPON_GREATER_RUNES,\r\n\t\t\tlabelizer: ({ utils }) => utils.weaponPropertyRunesLabel,\r\n\t\t\tchildPredicate: [\"weapon\", \"advanced\"],\r\n\t\t\tcondition: ({ children, utils }) =>\r\n\t\t\t\tutils.hasFreePropertySlot(children.weapon),\r\n\t\t},\r\n\t],\r\n\tprocess: ({ children, updateItem, fields, messages, item, utils }) => {\r\n\t\tconst weapon = children.weapon;\r\n\t\tif (!weapon) return;\r\n\r\n\t\tmessages.addGroup(\"mindsmith\");\r\n\r\n\t\tconst selected = fields.smith.value;\r\n\t\tupdateItem({\r\n\t\t\t_id: weapon.id,\r\n\t\t\t\"system.damage.damageType\": selected,\r\n\t\t\t\"system.group\": WEAPON_GROUPS[selected],\r\n\t\t});\r\n\t\tmessages.add(\"mindsmith\", {\r\n\t\t\tselected: utils.damageLabel(selected),\r\n\t\t\tuuid: item.uuid,\r\n\t\t\tlabel: \"mindsmith\",\r\n\t\t});\r\n\r\n\t\tif (children.mental) {\r\n\t\t\tconst traits = deepClone(weapon._source.system.traits?.value ?? []);\r\n\r\n\t\t\tfor (const nb of [1, 2]) {\r\n\t\t\t\tconst selected = fields[`mental${nb}`].value;\r\n\t\t\t\tif (!traits.includes(selected)) traits.push(selected);\r\n\t\t\t\tupdateItem({ _id: weapon.id, \"system.traits.value\": traits });\r\n\t\t\t\tmessages.add(\"mindsmith\", {\r\n\t\t\t\t\tselected: utils.weaponTraitLabel(selected),\r\n\t\t\t\t\tuuid: children.mental.uuid,\r\n\t\t\t\t\tlabel: localize(\"label.mentalforge\", { nb }),\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\t(children.advanced || children.runic) &&\r\n\t\t\tutils.hasFreePropertySlot(weapon)\r\n\t\t) {\r\n\t\t\tconst child = children.advanced ?? children.runic;\r\n\t\t\tconst freeSlot = utils.getFreePropertyRuneSlot(weapon);\r\n\t\t\tconst field = fields.advanced ?? fields.runic;\r\n\t\t\tconst selected = field.value;\r\n\r\n\t\t\tif (freeSlot && !weapon.system.runes.property.includes(selected)) {\r\n\t\t\t\tupdateItem({\r\n\t\t\t\t\t_id: weapon.id,\r\n\t\t\t\t\t[`system.${freeSlot}.value`]: selected,\r\n\t\t\t\t\t[`flags.${MODULE.id}.runeSlot`]: freeSlot,\r\n\t\t\t\t});\r\n\t\t\t\tmessages.add(\"mindsmith\", {\r\n\t\t\t\t\tselected: utils.weaponPropertyRunesLabel(selected),\r\n\t\t\t\t\tuuid: child.uuid,\r\n\t\t\t\t\tlabel: \"runicmind\",\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\trest: ({ item, sourceId, updateItem, actor }) => {\r\n\t\tif (sourceId !== MIND_WEAPON_UUID) return;\r\n\r\n\t\tconst mental = getItemWithSourceId(actor, MALLEABLE_MENTAL_FORGE_UUID);\r\n\t\tif (mental) {\r\n\t\t\tlet traits = item._source.system.traits?.value ?? [];\r\n\t\t\ttraits = traits.filter((trait) => !WEAPON_TRAITS.includes(trait));\r\n\t\t\tupdateItem({ _id: item.id, \"system.traits.value\": traits });\r\n\t\t}\r\n\r\n\t\tconst runeSlot = getFlag(item, \"runeSlot\");\r\n\t\tif (runeSlot) {\r\n\t\t\tupdateItem({\r\n\t\t\t\t_id: item.id,\r\n\t\t\t\t[`system.${runeSlot}.value`]: null,\r\n\t\t\t\t[`flags.${MODULE.id}.-=runeSlot`]: true,\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n};\r\n\r\nasync function fix({ actor }) {\r\n\tconst localize = subLocalize(\"dialog.weapon\");\r\n\r\n\tlet content = localize(\"flavor\");\r\n\r\n\tfor (const key of [\"0\", \"1\", \"2\", \"3\"]) {\r\n\t\tconst label = localize(`option.${key}`);\r\n\t\tcontent += `<label><input type=\"radio\" name=\"type\" value=\"${key}\">${label}</label>`;\r\n\t}\r\n\r\n\tconst weapon = await Dialog.wait(\r\n\t\t{\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\tcontent,\r\n\t\t\tbuttons: {\r\n\t\t\t\tyes: {\r\n\t\t\t\t\ticon: '<i class=\"fas fa-save\"></i>',\r\n\t\t\t\t\tlabel: localize(\"accept\"),\r\n\t\t\t\t\tcallback: onWeaponSelected,\r\n\t\t\t\t},\r\n\t\t\t\tno: {\r\n\t\t\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\t\t\tcallback: () => null,\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tclose: () => null,\r\n\t\t},\r\n\t\t{},\r\n\t\t{ id: \"pf2e-dailies-weapon\", width: 600 },\r\n\t);\r\n\r\n\tif (weapon) {\r\n\t\tawait actor.createEmbeddedDocuments(\"Item\", [weapon]);\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n\r\nasync function onWeaponSelected(html) {\r\n\tconst localize = subLocalize(\"dialog.weapon\");\r\n\r\n\tconst selection = html.find(\"[name=type]:checked\").val();\r\n\tif (!selection) {\r\n\t\tlocalize.warn(\"error.noSelection\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst weapon = (await fromUuid(MIND_WEAPON_UUID))?.toObject();\r\n\tif (!weapon) {\r\n\t\tlocalize.warn(\"error.missing\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst stats = WEAPON_BASE_TYPES[selection];\r\n\r\n\tsetProperty(weapon, \"system.damage.die\", stats.die);\r\n\tsetProperty(weapon, \"system.traits.value\", stats.traits.slice());\r\n\tsetProperty(weapon, \"system.usage.value\", stats.usage);\r\n\r\n\treturn weapon;\r\n}\r\n", "import { createFancyLink, getItemWithSourceId, localize } from \"module-api\";\r\n\r\nconst RATION_UUID = \"Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB\";\r\n\r\nfunction getRations(actor) {\r\n\treturn getItemWithSourceId(actor, RATION_UUID, \"consumable\");\r\n}\r\n\r\nexport const rations = {\r\n\tkey: \"rations\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB\",\r\n\t},\r\n\trows: [\r\n\t\t{\r\n\t\t\ttype: \"select\",\r\n\t\t\tslug: \"rations\",\r\n\t\t\tsave: false,\r\n\t\t\torder: 200,\r\n\t\t\toptions: ({ actor }) => {\r\n\t\t\t\tconst rations = getRations(actor);\r\n\t\t\t\tconst { value, max } = rations.uses;\r\n\t\t\t\tconst quantity = rations.quantity;\r\n\t\t\t\tconst remaining = (quantity - 1) * max + value;\r\n\t\t\t\tconst last = remaining <= 1;\r\n\r\n\t\t\t\treturn [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvalue: \"false\",\r\n\t\t\t\t\t\tlabel: localize(\"interface.rations.no\"),\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvalue: \"true\",\r\n\t\t\t\t\t\tlabel: last\r\n\t\t\t\t\t\t\t? localize(\"interface.rations.last\")\r\n\t\t\t\t\t\t\t: localize(\"interface.rations.yes\", { nb: remaining }),\r\n\t\t\t\t\t},\r\n\t\t\t\t];\r\n\t\t\t},\r\n\t\t},\r\n\t],\r\n\tprocess: async ({ fields, updateItem, messages, actor }) => {\r\n\t\tif (fields.rations.value !== \"true\") return;\r\n\r\n\t\tconst rations = getRations(actor);\r\n\t\tif (!rations?.uses.value) return;\r\n\r\n\t\tconst quantity = rations.quantity;\r\n\t\tconst { value, max } = rations.uses;\r\n\r\n\t\tif (value <= 1) {\r\n\t\t\tif (quantity <= 1) {\r\n\t\t\t\trations.delete();\r\n\t\t\t} else {\r\n\t\t\t\tupdateItem({\r\n\t\t\t\t\t_id: rations.id,\r\n\t\t\t\t\t\"system.quantity\": Math.max(rations.quantity - 1, 0),\r\n\t\t\t\t\t\"system.uses.value\": max,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tupdateItem({\r\n\t\t\t\t_id: rations.id,\r\n\t\t\t\t\"system.uses.value\": Math.max(value - 1, 0),\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst remaining = (quantity - 1) * max + value;\r\n\t\tconst name =\r\n\t\t\tremaining <= 1\r\n\t\t\t\t? await createFancyLink(RATION_UUID, { label: rations.name })\r\n\t\t\t\t: await createFancyLink(rations);\r\n\r\n\t\tconst message =\r\n\t\t\tremaining <= 1\r\n\t\t\t\t? localize(\"message.rations.last\", { name })\r\n\t\t\t\t: remaining <= 3\r\n\t\t\t\t  ? localize(\"message.rations.almost\", { name, nb: remaining - 1 })\r\n\t\t\t\t  : localize(\"message.rations.used\", { name, nb: remaining - 1 });\r\n\r\n\t\tmessages.addRaw(message, 200);\r\n\t},\r\n};\r\n", "export function createResistancelDaily(\r\n\tkey,\r\n\tuuid,\r\n\tresistances,\r\n\tresistance,\r\n\tlabel,\r\n\trandom,\r\n) {\r\n\tconst daily = {\r\n\t\tkey,\r\n\t\tlabel,\r\n\t\titem: {\r\n\t\t\tuuid,\r\n\t\t},\r\n\t\trows: [\r\n\t\t\t{\r\n\t\t\t\ttype: random ? \"random\" : \"select\",\r\n\t\t\t\tslug: \"resistance\",\r\n\t\t\t\toptions: resistances,\r\n\t\t\t\tlabelizer: ({ utils }) => utils.resistanceLabel,\r\n\t\t\t},\r\n\t\t],\r\n\t\tprocess: async ({ utils, fields, actor, addRule, messages }) => {\r\n\t\t\tconst type = random\r\n\t\t\t\t? await utils.randomOption(resistances)\r\n\t\t\t\t: fields.resistance.value;\r\n\t\t\tconst value =\r\n\t\t\t\ttypeof resistance === \"number\"\r\n\t\t\t\t\t? resistance\r\n\t\t\t\t\t: resistance === \"half\"\r\n\t\t\t\t\t  ? utils.halfLevelValue(actor)\r\n\t\t\t\t\t  : actor.level;\r\n\t\t\tconst rule = utils.createResistanceRuleElement({ type, value });\r\n\t\t\taddRule(rule);\r\n\t\t\tmessages.add(\"resistances\", {\r\n\t\t\t\tuuid,\r\n\t\t\t\tselected: utils.resistanceLabel(type, value),\r\n\t\t\t\tlabel,\r\n\t\t\t\trandom,\r\n\t\t\t});\r\n\t\t},\r\n\t};\r\n\treturn daily;\r\n}\r\n", "const effectUUID = \"Compendium.pf2e.feat-effects.Item.jO7wMhnjT7yoAtQg\";\r\n\r\nexport const rootMagic = {\r\n\tkey: \"root\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.feats-srd.Item.22P7IFyhrF7Fbw8B\",\r\n\t},\r\n\trows: [\r\n\t\t{\r\n\t\t\ttype: \"select\",\r\n\t\t\tslug: \"target\",\r\n\t\t\toptions: ({ actor, utils }) => {\r\n\t\t\t\tconst actors = utils.getPlayersActors(actor);\r\n\t\t\t\treturn actors.map((a) => ({ value: a.id, label: a.name }));\r\n\t\t\t},\r\n\t\t},\r\n\t],\r\n\tprocess: ({ fields, messages }) => {\r\n\t\tconst actorId = fields.target.value;\r\n\t\tconst actor = game.actors.get(actorId);\r\n\t\tif (!actor) return;\r\n\t\tmessages.addGroup(\"root\");\r\n\t\tmessages.add(\"root\", { uuid: effectUUID, selected: actor.name });\r\n\t},\r\n};\r\n", "import { getFlag, getItemWithSourceId, setFlag } from \"module-api\";\r\nimport {\r\n\tgetValidSpellcastingList,\r\n\tgetSpellcastingEntryMaxSlotRank,\r\n\tgetBestSpellcastingEntry,\r\n} from \"../spellcasting\";\r\n\r\nexport const DEFAULT_REGEX_RANKS = [\r\n\t\"cantrips?\",\r\n\t\"1st\",\r\n\t\"2nd\",\r\n\t\"3rd\",\r\n\t\"4th\",\r\n\t\"5th\",\r\n\t\"6th\",\r\n\t\"7th\",\r\n\t\"8th\",\r\n\t\"9th\",\r\n\t\"10th\",\r\n].join(\"|\");\r\n\r\nconst KINETIC_ACTIVATION = \"Compendium.pf2e.feats-srd.Item.NV9H39kbkbjhAK6X\";\r\n\r\nexport function isPF2eStavesActive() {\r\n\treturn game.modules.get(\"pf2e-staves\")?.active;\r\n}\r\n\r\nexport function getSpellcastingEntryStaffFlags(entry) {\r\n\tif (!entry) return;\r\n\r\n\tconst data =\r\n\t\tgetFlag(entry, \"staff\") ?? getProperty(entry, \"flags.pf2e-staves\");\r\n\tif (!data) return;\r\n\r\n\t// biome-ignore lint/performance/noDelete: not master of the returned data object\r\n\tdelete data.prevDescription;\r\n\treturn deepClone(data);\r\n}\r\n\r\nexport function getSpellcastingEntryStaffData(entry) {\r\n\tconst staffData = getSpellcastingEntryStaffFlags(entry);\r\n\tif (!staffData) return;\r\n\r\n\tstaffData.overcharge ??= 0;\r\n\tstaffData.max = getMaxSlotRankForStaves(entry.actor) + staffData.overcharge;\r\n\r\n\tconst spontaneousCharges = (() => {\r\n\t\tconst actor = entry.actor;\r\n\t\tif (\r\n\t\t\t!staffData.charges ||\r\n\t\t\tstaffData.overcharge ||\r\n\t\t\tstaffData.makeshift ||\r\n\t\t\t!actor\r\n\t\t)\r\n\t\t\treturn {};\r\n\r\n\t\treturn actor.spellcasting\r\n\t\t\t.filter((entry) => entry.isSpontaneous)\r\n\t\t\t.reduce((charges, entry) => {\r\n\t\t\t\tfor (let i = 1; i <= 10; i++) {\r\n\t\t\t\t\tconst slot = entry.system.slots[`slot${i}`];\r\n\t\t\t\t\tif (slot.max && slot.value) charges[i] = true;\r\n\t\t\t\t}\r\n\t\t\t\treturn charges;\r\n\t\t\t}, {});\r\n\t})();\r\n\r\n\tstaffData.canPayCost = (cost) => {\r\n\t\treturn (\r\n\t\t\t!!staffData.charges &&\r\n\t\t\t(cost <= staffData.charges || spontaneousCharges[cost])\r\n\t\t);\r\n\t};\r\n\r\n\treturn staffData;\r\n}\r\n\r\nexport async function updateEntryCharges(entry, value) {\r\n\tconst staffData = getSpellcastingEntryStaffData(entry);\r\n\tif (!staffData) return;\r\n\r\n\tconst updatedValue = Math.clamped(value, 0, staffData.max);\r\n\r\n\tif (updatedValue !== staffData.charges) {\r\n\t\tstaffData.charges = updatedValue;\r\n\t\treturn setFlag(entry, \"staff\", staffData);\r\n\t}\r\n}\r\n\r\nexport function getStaves(actor) {\r\n\treturn [\r\n\t\t{ type: \"weapon\", trait: \"magical\" },\r\n\t\t{ type: \"equipment\", trait: \"coda\" },\r\n\t].flatMap(({ type, trait }) =>\r\n\t\tactor.itemTypes[type].filter((item) => {\r\n\t\t\tconst traits = item.system.traits?.value;\r\n\t\t\treturn traits?.includes(\"staff\") && traits.includes(trait);\r\n\t\t}),\r\n\t);\r\n}\r\n\r\nexport function getMaxSlotRankForStaves(actor) {\r\n\tlet maxCharges = 0;\r\n\tconst actorCharges = Math.ceil(actor.level / 2);\r\n\r\n\tconst entries = getValidSpellcastingList(actor);\r\n\tfor (const entry of entries) {\r\n\t\tconst entryMaxCharges = getSpellcastingEntryMaxSlotRank(entry);\r\n\t\tif (entryMaxCharges > maxCharges) maxCharges = entryMaxCharges;\r\n\t}\r\n\r\n\tconst activation = getItemWithSourceId(actor, KINETIC_ACTIVATION, \"feat\");\r\n\tif (activation) {\r\n\t\tif (actorCharges > maxCharges) maxCharges = actorCharges;\r\n\t}\r\n\r\n\treturn Math.min(actorCharges, maxCharges);\r\n}\r\n\r\nexport function getBestSpellcastingEntryForStaves(actor) {\r\n\tconst bestEntry = getBestSpellcastingEntry(actor);\r\n\r\n\tconst activation = getItemWithSourceId(actor, KINETIC_ACTIVATION, \"feat\");\r\n\tif (activation) {\r\n\t\tconst bestMod = bestEntry?.mod ?? 0;\r\n\t\tconst classDC =\r\n\t\t\tactor.classDCs.kineticist ?? actor.classDCs.find((c) => c.mod >= bestMod);\r\n\t\tconst classMod = classDC.mod;\r\n\r\n\t\tif (classMod >= bestMod) {\r\n\t\t\treturn {\r\n\t\t\t\tability: { value: classDC.attribute },\r\n\t\t\t\ttradition: { value: \"primal\" },\r\n\t\t\t\tproficiency: { value: classDC.rank, slug: classDC.slug },\r\n\t\t\t\tmod: classMod,\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\treturn bestEntry;\r\n}\r\n\r\nexport function getPreparedSpellcastingEntriesForStaves(actor) {\r\n\tconst entryGroups = {};\r\n\r\n\tfor (const entry of actor.spellcasting.filter((entry) => entry.isPrepared)) {\r\n\t\tconst entryId = entry.id;\r\n\t\tconst isFlexible = entry.isFlexible;\r\n\r\n\t\tfor (let rank = 1; rank <= 10; rank++) {\r\n\t\t\tconst data = entry.system.slots[`slot${rank}`];\r\n\t\t\tif (data.max < 1) continue;\r\n\r\n\t\t\tif (isFlexible) {\r\n\t\t\t\tif (data.value < 1) continue;\r\n\r\n\t\t\t\tentryGroups[entryId] ??= {\r\n\t\t\t\t\tid: entryId,\r\n\t\t\t\t\tname: entry.name,\r\n\t\t\t\t\tslots: [],\r\n\t\t\t\t};\r\n\r\n\t\t\t\tentryGroups[entryId].slots.push({\r\n\t\t\t\t\trank,\r\n\t\t\t\t\tvalue: data.value,\r\n\t\t\t\t\tmax: data.max,\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tfor (const [index, { id, prepared, expended }] of Object.entries(\r\n\t\t\t\t\tdata.prepared,\r\n\t\t\t\t)) {\r\n\t\t\t\t\tif (prepared === false || expended) continue;\r\n\r\n\t\t\t\t\tconst spell = entry.spells.get(id);\r\n\r\n\t\t\t\t\tentryGroups[entryId] ??= {\r\n\t\t\t\t\t\tid: entryId,\r\n\t\t\t\t\t\tname: entry.name,\r\n\t\t\t\t\t\tspells: [],\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tentryGroups[entryId].spells.push({\r\n\t\t\t\t\t\tname: spell?.name ?? \"Empty Slot\",\r\n\t\t\t\t\t\trank,\r\n\t\t\t\t\t\tindex,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tentryGroups[entryId]?.spells?.sort((a, b) => a.rank - b.rank);\r\n\t}\r\n\r\n\treturn Object.values(entryGroups);\r\n}\r\n", "import { MODULE, getFlag, localize, render, warn } from \"module-api\";\r\nimport { utils } from \"./api\";\r\nimport { getSpellcastingEntryStaffFlags } from \"./data/staves\";\r\n\r\nexport async function onSpellcastingEntryCast(wrapped, ...args) {\r\n\tconst [spell, { rank }] = args;\r\n\tif (spell.isCantrip) return wrapped(...args);\r\n\r\n\tconst staffFlags = getSpellcastingEntryStaffFlags(this);\r\n\tif (!staffFlags) return wrapped(...args);\r\n\r\n\tconst actor = this.actor;\r\n\tconst staff = actor.items.get(staffFlags.staveID);\r\n\tif (!staff?.isEquipped) {\r\n\t\twarn(\"staves.noStaff\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst castRank = spell.computeCastRank(rank);\r\n\r\n\tif (!rank || rank === \"0\") {\r\n\t\treturn spell.toMessage(undefined, { data: { castRank } });\r\n\t}\r\n\r\n\tif (\r\n\t\tstaffFlags.charges < 1 ||\r\n\t\t(staffFlags.charges < castRank && staffFlags.overcharge)\r\n\t) {\r\n\t\twarn(\"staves.noCharge\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst updates = [];\r\n\r\n\tif (!staffFlags.overcharge) {\r\n\t\tconst spontaneousEntries = actor.spellcasting.filter(\r\n\t\t\t(entry) =>\r\n\t\t\t\tentry.isSpontaneous && entry.system.slots[`slot${castRank}`].value,\r\n\t\t);\r\n\r\n\t\tlet useSpontaneous = false;\r\n\r\n\t\tconst entryRankValue = (entry) =>\r\n\t\t\tentry.system.slots[`slot${castRank}`].value;\r\n\r\n\t\tif (spontaneousEntries.length === 1) {\r\n\t\t\tconst entry = spontaneousEntries[0];\r\n\r\n\t\t\tconst content = localize(\"staves.spontaneous.one\", {\r\n\t\t\t\trank: utils.spellRankLabel(castRank),\r\n\t\t\t\tentry: entry.name,\r\n\t\t\t\tremaining: entryRankValue(entry),\r\n\t\t\t});\r\n\r\n\t\t\tuseSpontaneous = await Dialog.confirm({\r\n\t\t\t\ttitle: localize(\"staves.spontaneous.title\"),\r\n\t\t\t\tdefaultYes: false,\r\n\t\t\t\tcontent: `<div class=\"pf2e-dailies-spontaneous\">${content}</div>`,\r\n\t\t\t});\r\n\r\n\t\t\tif (useSpontaneous) useSpontaneous = 0;\r\n\t\t} else if (spontaneousEntries.length > 1) {\r\n\t\t\tconst entries = spontaneousEntries.map((entry, index) => ({\r\n\t\t\t\tindex,\r\n\t\t\t\tname: entry.name,\r\n\t\t\t\tremaining: entryRankValue(entry),\r\n\t\t\t}));\r\n\r\n\t\t\tconst content = await render(\"staves-spontaneous\", {\r\n\t\t\t\tentries,\r\n\t\t\t\tcastRank: utils.spellRankLabel(castRank),\r\n\t\t\t\ti18n: (key, { hash }) => localize(`staves.spontaneous.${key}`, hash),\r\n\t\t\t});\r\n\r\n\t\t\tuseSpontaneous = await Dialog.wait({\r\n\t\t\t\ttitle: localize(\"staves.spontaneous.title\"),\r\n\t\t\t\tcontent,\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tyes: {\r\n\t\t\t\t\t\ticon: '<i class=\"fas fa-check\"></i>',\r\n\t\t\t\t\t\tlabel: game.i18n.localize(\"Yes\"),\r\n\t\t\t\t\t\tcallback: (html) => {\r\n\t\t\t\t\t\t\tconst value = html.find(\"input[name=entry]:checked\").val();\r\n\t\t\t\t\t\t\treturn Number(value);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t\tno: {\r\n\t\t\t\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\t\t\t\tlabel: game.i18n.localize(\"No\"),\r\n\t\t\t\t\t\tcallback: () => false,\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\tclose: () => null,\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (useSpontaneous === null) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (typeof useSpontaneous === \"number\") {\r\n\t\t\tconst entry = spontaneousEntries[useSpontaneous];\r\n\t\t\tconst current = entry.system.slots[`slot${castRank}`].value;\r\n\r\n\t\t\tupdates.push({\r\n\t\t\t\t_id: entry.id,\r\n\t\t\t\t[`system.slots.slot${castRank}.value`]: current - 1,\r\n\t\t\t});\r\n\r\n\t\t\tstaffFlags.charges -= 1;\r\n\t\t}\r\n\t}\r\n\r\n\tif (!updates.length) {\r\n\t\tif (staffFlags.charges < castRank) {\r\n\t\t\twarn(\"staves.noCharge\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tstaffFlags.charges -= castRank;\r\n\t}\r\n\r\n\tupdates.push({ _id: this.id, [`flags.${MODULE.id}.staff`]: staffFlags });\r\n\r\n\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\tawait spell.toMessage(undefined, { data: { castRank } });\r\n}\r\n\r\nexport function getValidSpellcastingList(\r\n\tactor,\r\n\t{ itemOnly, innate, focus } = {},\r\n) {\r\n\treturn actor.spellcasting.regular.filter((entry) => {\r\n\t\tif (entry.flags?.[\"pf2e-staves\"] || getFlag(entry, \"staff\")) return false;\r\n\r\n\t\tif (!innate && entry.isInnate) return false;\r\n\t\tif (!focus && entry.isFocusPool) return false;\r\n\r\n\t\tif (entry.system.prepared.value === \"items\") {\r\n\t\t\tif (!itemOnly) return false;\r\n\t\t\tif (\r\n\t\t\t\titemOnly === \"scroll\" &&\r\n\t\t\t\tentry.system.prepared.validItems !== \"scroll\"\r\n\t\t\t)\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t});\r\n}\r\n\r\nexport function getSpellcastingEntryMaxSlotRank(entry) {\r\n\tlet maxSlot = 0;\r\n\r\n\tif (entry.system.prepared.value === \"items\") {\r\n\t\tconst levelMaxSlot = Math.ceil(entry.actor.level / 2);\r\n\t\tif (levelMaxSlot > maxSlot) maxSlot = levelMaxSlot;\r\n\t} else {\r\n\t\tfor (let i = 0; i <= 10; i++) {\r\n\t\t\tconst slot = entry.system.slots[`slot${i}`];\r\n\t\t\tif (slot.max) maxSlot = Math.max(maxSlot, i);\r\n\t\t}\r\n\t}\r\n\r\n\treturn maxSlot;\r\n}\r\n\r\nexport function getNotExpendedPreparedSpellSlot(spell, rank) {\r\n\tconst entry = spell.spellcasting;\r\n\tconst entries = Object.entries(\r\n\t\tentry.system.slots[`slot${rank ?? spell.rank}`].prepared,\r\n\t);\r\n\tconst prepared = entries.find(\r\n\t\t([_, { id, expended }]) => id === spell.id && expended !== true,\r\n\t);\r\n\tif (!prepared) return;\r\n\r\n\treturn {\r\n\t\tslotIndex: prepared[0],\r\n\t\tentry,\r\n\t};\r\n}\r\n\r\nexport function getBestSpellcastingEntry(actor) {\r\n\tconst entries = getValidSpellcastingList(actor);\r\n\r\n\tlet bestMod = 0;\r\n\tlet bestEntries = [];\r\n\r\n\tfor (const entry of entries) {\r\n\t\tconst mod = entry.statistic.mod;\r\n\t\tif (mod > bestMod) {\r\n\t\t\tbestEntries = [entry];\r\n\t\t\tbestMod = mod;\r\n\t\t} else if (mod === bestMod) {\r\n\t\t\tbestEntries.push(entry);\r\n\t\t}\r\n\t}\r\n\r\n\tif (bestEntries.length === 0) return;\r\n\r\n\tconst returnedEntry = (entry) => {\r\n\t\tconst { ability, tradition, proficiency } = entry.system;\r\n\t\treturn { ability, tradition, proficiency, mod: bestMod };\r\n\t};\r\n\r\n\tif (bestEntries.length === 1) return returnedEntry(bestEntries[0]);\r\n\r\n\tconst classAttr = actor.classDC.attribute;\r\n\tconst classAttrEntries = bestEntries.filter(\r\n\t\t(entry) => entry.attribute === classAttr,\r\n\t);\r\n\r\n\tif (classAttrEntries === 1) return returnedEntry(classAttrEntries[0]);\r\n\r\n\tlet bestCount = 0;\r\n\tlet bestEntry;\r\n\r\n\tfor (const entry of bestEntries) {\r\n\t\tconst entryCount = getPreparedCount(entry);\r\n\t\tif (entryCount > bestCount) {\r\n\t\t\tbestCount = entryCount;\r\n\t\t\tbestEntry = entry;\r\n\t\t}\r\n\t}\r\n\r\n\treturn returnedEntry(bestEntry ?? bestEntries[0]);\r\n}\r\n\r\nfunction getPreparedCount(entry) {\r\n\tif (entry.isSpontaneous) return entry.spells.size;\r\n\r\n\tif (entry.isPrepared) {\r\n\t\tconst slots = Object.values(entry.system.slots);\r\n\t\tconst prepared = slots.flatMap((slot) => Object.values(slot.prepared));\r\n\t\treturn prepared.filter((spell) => spell.id).length;\r\n\t}\r\n\r\n\treturn 0;\r\n}\r\n\r\nexport function getSpellcastingEntriesSortBounds(actor) {\r\n\tlet min = 0;\r\n\tlet max = 0;\r\n\r\n\tfor (const entry of actor.spellcasting) {\r\n\t\tif (entry.sort > max) max = entry.sort;\r\n\t\telse if (entry.sort < min) min = entry.sort;\r\n\t}\r\n\r\n\treturn { min, max };\r\n}\r\n", "import {\r\n\tgetSpellcastingEntryMaxSlotRank,\r\n\tgetValidSpellcastingList,\r\n} from \"../spellcasting\";\r\n\r\nexport const scrollSavant = {\r\n\tkey: \"savant\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ\", // Scroll Adept\r\n\t},\r\n\tprepare: ({ actor }) => {\r\n\t\tconst { maxSlot, maxTradition } = getSpellcastingTraditionDetails(\r\n\t\t\tactor,\r\n\t\t\t\"arcane\",\r\n\t\t);\r\n\r\n\t\tconst custom = {\r\n\t\t\tfirst: { level: maxSlot - 2, condition: true },\r\n\t\t\tsecond: { level: maxSlot - 3, condition: true },\r\n\t\t\tthird: {\r\n\t\t\t\tlevel: maxSlot - 4,\r\n\t\t\t\tcondition: maxTradition >= 3 && maxSlot >= 5,\r\n\t\t\t},\r\n\t\t\tfourth: {\r\n\t\t\t\tlevel: maxSlot - 5,\r\n\t\t\t\tcondition: maxTradition >= 4 && maxSlot >= 6,\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\treturn custom;\r\n\t},\r\n\trows: [\"first\", \"second\", \"third\", \"fourth\"].map((rowName) => {\r\n\t\tconst row = {\r\n\t\t\ttype: \"drop\",\r\n\t\t\tslug: rowName,\r\n\t\t\tlabel: ({ custom, utils }) => utils.spellRankLabel(custom[rowName].level),\r\n\t\t\tfilter: {\r\n\t\t\t\ttype: \"spell\",\r\n\t\t\t\tsearch: ({ custom }) => ({\r\n\t\t\t\t\tcategory: [\"spell\"],\r\n\t\t\t\t\ttraditions: [\"arcane\"],\r\n\t\t\t\t\tlevel: custom[rowName].level,\r\n\t\t\t\t}),\r\n\t\t\t},\r\n\t\t\tcondition: ({ custom }) => custom[rowName].condition,\r\n\t\t};\r\n\t\treturn row;\r\n\t}),\r\n\tprocess: async ({ utils, fields, custom, addItem, messages }) => {\r\n\t\tfor (const field of Object.values(fields)) {\r\n\t\t\tconst uuid = field.uuid;\r\n\t\t\tconst source = await utils.createSpellScrollSource({\r\n\t\t\t\tuuid,\r\n\t\t\t\tlevel: custom[field.row].level,\r\n\t\t\t});\r\n\t\t\taddItem(source);\r\n\t\t\tmessages.add(\"scrolls\", { uuid, label: source.name });\r\n\t\t}\r\n\t},\r\n};\r\n\r\nfunction getSpellcastingTraditionDetails(actor, tradition) {\r\n\tlet maxSlot = 1;\r\n\tlet maxTradition = 0;\r\n\r\n\tconst entries = getValidSpellcastingList(actor);\r\n\tfor (const entry of entries) {\r\n\t\tconst entryMaxSlot = getSpellcastingEntryMaxSlotRank(entry);\r\n\t\tif (entryMaxSlot > maxSlot) maxSlot = entryMaxSlot;\r\n\r\n\t\tif (entry.tradition === tradition)\r\n\t\t\tmaxTradition = Math.max(maxTradition, entry.rank);\r\n\t}\r\n\r\n\treturn { maxSlot: Math.min(maxSlot, 10), maxTradition };\r\n}\r\n", "export const spellshaping = {\r\n\tkey: \"metamagical\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.classfeatures.Item.89zWKD2CN7nRu2xp\", // Experimental Spellshaping\r\n\t\tcondition: ({ actor }) => actor.level >= 4,\r\n\t},\r\n\trows: [\r\n\t\t{\r\n\t\t\ttype: \"drop\",\r\n\t\t\tslug: \"feat\",\r\n\t\t\tfilter: {\r\n\t\t\t\ttype: \"feat\",\r\n\t\t\t\tsearch: {\r\n\t\t\t\t\tcategory: [\"class\"],\r\n\t\t\t\t\ttraits: { selected: [\"spellshape\", \"wizard\"], conjunction: \"and\" },\r\n\t\t\t\t\tlevel: \"half\",\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t},\r\n\t],\r\n\tprocess: async ({ utils, fields, addFeat, messages }) => {\r\n\t\tconst uuid = fields.feat.uuid;\r\n\t\tconst source = await utils.createFeatSource(uuid);\r\n\t\taddFeat(source);\r\n\t\tmessages.add(\"feats\", { uuid });\r\n\t},\r\n};\r\n", "export const thaumaturgeTome = {\r\n\tkey: \"tome\",\r\n\titem: {\r\n\t\tuuid: \"Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e\", // Tome\r\n\t},\r\n\tchildren: [\r\n\t\t{\r\n\t\t\tslug: \"adept\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO\", // Implement Adept\r\n\t\t\tcondition: createChildCondition(\"adept\"),\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"second\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5\", // Second Adept\r\n\t\t\tcondition: createChildCondition(\"adept\"),\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"intense\",\r\n\t\t\tuuid: \"Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC\", // Intense Implement\r\n\t\t},\r\n\t\t{\r\n\t\t\tslug: \"paragon\",\r\n\t\t\tuuid: \"Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI\", // Implement Paragon\r\n\t\t\tcondition: createChildCondition(\"paragon\"),\r\n\t\t},\r\n\t],\r\n\tprepare: ({ utils, actor, children }) => {\r\n\t\tconst skillNames = utils.skillNames;\r\n\t\tconst actorLevel = actor.level;\r\n\t\tconst actorSkills = actor.skills;\r\n\r\n\t\tconst custom = {\r\n\t\t\tfirst: { options: [], rank: 1 },\r\n\t\t\tsecond: { options: [], rank: 1 },\r\n\t\t};\r\n\r\n\t\t// Implement Paragon\r\n\t\tif (children.paragon) {\r\n\t\t\tconst skills = skillNames.filter((x) => actorSkills[x].rank < 4);\r\n\t\t\tcustom.first = { rank: 4, options: skills };\r\n\t\t\tcustom.second = { rank: 4, options: skills };\r\n\t\t}\r\n\t\t// Intense Implement or Second Adept or Implement Adept\r\n\t\telse if (children.intense || children.adept || children.second) {\r\n\t\t\tconst masters = skillNames.filter((x) => actorSkills[x].rank < 3);\r\n\r\n\t\t\tif (actorLevel >= 9) {\r\n\t\t\t\tcustom.first = { rank: 3, options: masters };\r\n\t\t\t\tcustom.second = { rank: 3, options: masters };\r\n\t\t\t} else {\r\n\t\t\t\tconst experts = skillNames.filter((x) => actorSkills[x].rank < 2);\r\n\t\t\t\tcustom.first = { rank: 2, options: experts };\r\n\t\t\t\tcustom.second = { rank: 3, options: masters };\r\n\t\t\t}\r\n\t\t}\r\n\t\t// Tome\r\n\t\telse {\r\n\t\t\tif (actorLevel >= 5) {\r\n\t\t\t\tconst experts = skillNames.filter((x) => actorSkills[x].rank < 2);\r\n\t\t\t\tcustom.first = { rank: 2, options: experts };\r\n\t\t\t\tcustom.second = { rank: 2, options: experts };\r\n\t\t\t} else if (actorLevel >= 3) {\r\n\t\t\t\tconst trained = skillNames.filter((x) => actorSkills[x].rank < 1);\r\n\t\t\t\tconst experts = skillNames.filter((x) => actorSkills[x].rank < 2);\r\n\t\t\t\tcustom.first = { rank: 1, options: trained };\r\n\t\t\t\tcustom.second = { rank: 2, options: experts };\r\n\t\t\t} else {\r\n\t\t\t\tconst trained = skillNames.filter((x) => actorSkills[x].rank < 1);\r\n\t\t\t\tcustom.first = { rank: 1, options: trained };\r\n\t\t\t\tcustom.second = { rank: 1, options: trained };\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn custom;\r\n\t},\r\n\trows: [\"first\", \"second\"].map((rowName) => {\r\n\t\tconst row = {\r\n\t\t\ttype: \"combo\",\r\n\t\t\tslug: rowName,\r\n\t\t\tlabel: ({ custom, utils }) =>\r\n\t\t\t\tutils.proficiencyLabel(custom[rowName].rank),\r\n\t\t\toptions: ({ custom }) => custom[rowName].options,\r\n\t\t\tlabelizer: ({ utils }) => utils.skillLabel,\r\n\t\t};\r\n\t\treturn row;\r\n\t}),\r\n\tprocess: ({ custom, fields, utils, messages, addItem, addRule }) => {\r\n\t\tmessages.addGroup(\"tome\", 65);\r\n\r\n\t\tfor (const rowName of [\"first\", \"second\"]) {\r\n\t\t\tconst rank = custom[rowName].rank;\r\n\t\t\tlet value = fields[rowName].value;\r\n\r\n\t\t\tif (fields[rowName].input === \"true\") {\r\n\t\t\t\tconst source = utils.createLoreSource({ name: value, rank });\r\n\t\t\t\taddItem(source);\r\n\t\t\t} else {\r\n\t\t\t\tconst source = utils.createSkillRuleElement({\r\n\t\t\t\t\tskill: value,\r\n\t\t\t\t\tvalue: rank,\r\n\t\t\t\t});\r\n\t\t\t\tvalue = utils.skillLabel(value);\r\n\t\t\t\taddRule(source);\r\n\t\t\t}\r\n\r\n\t\t\tmessages.add(\"tome\", {\r\n\t\t\t\tlabel: utils.proficiencyLabel(rank),\r\n\t\t\t\tselected: value,\r\n\t\t\t});\r\n\t\t}\r\n\t},\r\n};\r\n\r\nfunction createChildCondition(option) {\r\n\treturn ({ item, utils, actor }) => {\r\n\t\tconst itemId = utils.getChoiSetRuleSelection(item);\r\n\t\treturn actor.items.get(itemId)?.slug === \"tome\";\r\n\t};\r\n}\r\n", "import {\r\n\tAsyncFunction,\r\n\terror,\r\n\tgetSetting,\r\n\tgetSourceId,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { utils } from \"./api\";\r\nimport { tricksterAce } from \"./data/ace\";\r\nimport { bladeAlly } from \"./data/blade\";\r\nimport { ceremonialKnife } from \"./data/ceremonial\";\r\nimport { createScrollChain } from \"./data/chain\";\r\nimport { combatFlexibility } from \"./data/flexibility\";\r\nimport { createLanguageDaily } from \"./data/language\";\r\nimport { longevities } from \"./data/longevity\";\r\nimport { mindSmith } from \"./data/mind\";\r\nimport { rations } from \"./data/rations\";\r\nimport { createResistancelDaily } from \"./data/resistance\";\r\nimport { rootMagic } from \"./data/root\";\r\nimport { scrollSavant } from \"./data/savant\";\r\nimport { createTrainedLoreDaily, createTrainedSkillDaily } from \"./data/skill\";\r\nimport { spellshaping } from \"./data/spellshaping\";\r\nimport { thaumaturgeTome } from \"./data/tome\";\r\n\r\nconst DEPRECATED_CUSTOM_DAILIES = [\"root-magic\"];\r\n\r\nexport const UNIQUE_DAILY_KEYS = [\"familiar\", \"staves\"];\r\n\r\nexport const BUILTINS_DAILIES = [\r\n\tthaumaturgeTome,\r\n\tlongevities,\r\n\tcreateTrainedSkillDaily(\r\n\t\t\"ageless\",\r\n\t\t\"Compendium.pf2e.feats-srd.Item.wylnETwIz32Au46y\",\r\n\t), // Ageless Spirit\r\n\tcreateTrainedSkillDaily(\r\n\t\t\"memories\",\r\n\t\t\"Compendium.pf2e.feats-srd.Item.ptEOt3lqjxUnAW62\",\r\n\t), // Ancient Memories\r\n\tcreateTrainedSkillDaily(\r\n\t\t\"studies\",\r\n\t\t\"Compendium.pf2e.feats-srd.Item.9bgl6qYWKHzqWZj0\",\r\n\t), // Flexible Studies\r\n\tcreateTrainedLoreDaily(\r\n\t\t\"study\",\r\n\t\t\"Compendium.pf2e.feats-srd.Item.aLJsBBZzlUK3G8MW\",\r\n\t), // Quick Study\r\n\tcreateLanguageDaily(\r\n\t\t\"linguistics\",\r\n\t\t\"Compendium.pf2e.feats-srd.Item.eCWQU16hRLfN1KaX\",\r\n\t), // Ancestral Linguistics\r\n\tcreateLanguageDaily(\r\n\t\t\"borts\",\r\n\t\t\"Compendium.pf2e.equipment-srd.Item.iS7hAQMAaThHYE8g\",\r\n\t), // Bort's Blessing\r\n\tcreateResistancelDaily(\r\n\t\t\"elementalist\",\r\n\t\t\"Compendium.pf2e.feats-srd.Item.tx9pkrpmtqe4FnvS\",\r\n\t\t[\"air\", \"earth\", \"fire\", \"water\"],\r\n\t\t\"half\",\r\n\t\t\"elementalist\",\r\n\t), // Elementalist Dedication\r\n\tcreateResistancelDaily(\r\n\t\t\"ganzi\",\r\n\t\t\"Compendium.pf2e.heritages.Item.3reGfXH0S82hM7Gp\",\r\n\t\t[\"acid\", \"electricity\", \"sonic\"],\r\n\t\t\"half\",\r\n\t\t\"ganzi\",\r\n\t\ttrue,\r\n\t), // Ganzi\r\n\tspellshaping,\r\n\tcombatFlexibility,\r\n\tscrollSavant,\r\n\tcreateScrollChain(\"esoterica\", [\r\n\t\t\"Compendium.pf2e.feats-srd.Item.OqObuRB8oVSAEKFR\", // Scroll Esoterica\r\n\t\t\"Compendium.pf2e.feats-srd.Item.nWd7m0yRcIEVUy7O\", // Elaborate Scroll Esoterica\r\n\t\t\"Compendium.pf2e.feats-srd.Item.LHjPTV5vP3MOsPPJ\", // Grand Scroll Esoterica\r\n\t]),\r\n\tcreateScrollChain(\"trickster\", [\r\n\t\t\"Compendium.pf2e.feats-srd.Item.ROAUR1GhC19Pjk9C\", // Basic Scroll Cache\r\n\t\t\"Compendium.pf2e.feats-srd.Item.UrOj9TROtn8nuxPf\", // Expert Scroll Cache\r\n\t\t\"Compendium.pf2e.feats-srd.Item.lIg5Gzz7W70jfbk1\", // Master Scroll Cache\r\n\t]),\r\n\ttricksterAce(),\r\n\tmindSmith,\r\n\tbladeAlly,\r\n\trootMagic,\r\n\tceremonialKnife,\r\n\trations,\r\n];\r\n\r\nexport let DAILY_FILTERS = [];\r\n\r\nlet BUILTINS_UUIDS;\r\nconst UUIDS = new Map();\r\n\r\nexport function prepareDailies(dailies, prefix) {\r\n\tconst uuids = new Map();\r\n\r\n\tfor (const original of dailies) {\r\n\t\tconst daily = deepClone(original);\r\n\r\n\t\ttry {\r\n\t\t\tconst keyWithPrefix = `${prefix}.${daily.key}`;\r\n\t\t\tif (DAILY_FILTERS.includes(keyWithPrefix)) continue;\r\n\r\n\t\t\tuuids.set(daily.item.uuid, { daily, condition: daily.item.condition });\r\n\r\n\t\t\tdaily.key = keyWithPrefix;\r\n\r\n\t\t\tif (daily.children) {\r\n\t\t\t\tfor (let i = 0; i < daily.children.length; i++) {\r\n\t\t\t\t\tconst { uuid, condition } = daily.children[i];\r\n\t\t\t\t\tuuids.set(uuid, { daily, index: i, condition });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\terror(\"error.unexpected\");\r\n\t\t\tconsole.error(err);\r\n\t\t\tconsole.error(\r\n\t\t\t\t`The error occured during data gathering of ${prefix}.${daily.key}`,\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\treturn uuids;\r\n}\r\n\r\nfunction prepareBaseDailies() {\r\n\tBUILTINS_UUIDS = prepareDailies(BUILTINS_DAILIES, \"dailies\");\r\n}\r\n\r\nexport let CUSTOM_DAILIES = [];\r\n\r\nexport async function parseCustomDailies() {\r\n\tUUIDS.clear();\r\n\r\n\tCUSTOM_DAILIES = [];\r\n\r\n\tconst customs = getSetting(\"customDailies\");\r\n\tfor (const { key, code } of customs) {\r\n\t\ttry {\r\n\t\t\tconst fn = new AsyncFunction(code);\r\n\t\t\tconst daily = await fn();\r\n\t\t\tif (!checkCustomDaily(daily, true)) continue;\r\n\t\t\tCUSTOM_DAILIES.push(daily);\r\n\t\t} catch (err) {\r\n\t\t\terror(\"error.unexpected\");\r\n\t\t\tconsole.error(err);\r\n\t\t\tconsole.error(\r\n\t\t\t\t`The error occured during call of custom function for ${key}`,\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tfor (const [uuid, daily] of BUILTINS_UUIDS.entries()) {\r\n\t\tUUIDS.set(uuid, daily);\r\n\t}\r\n\r\n\tconst CUSTOM_UUIDS = prepareDailies(CUSTOM_DAILIES, \"custom\");\r\n\tfor (const [uuid, daily] of CUSTOM_UUIDS.entries()) {\r\n\t\tUUIDS.set(uuid, daily);\r\n\t}\r\n}\r\n\r\nfunction prepareDailyFilters() {\r\n\tconst filters = getSetting(\"filters\").trim();\r\n\tif (!filters) {\r\n\t\tDAILY_FILTERS = [];\r\n\t}\r\n\r\n\ttry {\r\n\t\tDAILY_FILTERS = filters\r\n\t\t\t.split(\",\")\r\n\t\t\t.map((s) => s.trim())\r\n\t\t\t.filter(Boolean);\r\n\t} catch (err) {\r\n\t\terror(\"error.unexpected\");\r\n\t\tconsole.error(err);\r\n\t\tconsole.error(\"The error occured while trying to parse the daily filters\");\r\n\t}\r\n}\r\n\r\nexport async function prepareAllDailies() {\r\n\tprepareDailyFilters();\r\n\tprepareBaseDailies();\r\n\tawait parseCustomDailies();\r\n}\r\n\r\nexport function checkCustomDaily(daily, warning = false) {\r\n\tif (!DEPRECATED_CUSTOM_DAILIES.includes(daily.key)) return true;\r\n\tif (warning && game.user.isGM)\r\n\t\twarn(\r\n\t\t\t\"deprecated.custom.key\",\r\n\t\t\t{ name: daily.label.trim() || daily.key },\r\n\t\t\ttrue,\r\n\t\t);\r\n\treturn false;\r\n}\r\n\r\nexport function getDailies(actor) {\r\n\tconst dailies = {};\r\n\r\n\tfor (const item of actor.items) {\r\n\t\tconst sourceId = getSourceId(item);\r\n\t\tif (!sourceId || (item.isOfType(\"physical\") && item.isInvested === false))\r\n\t\t\tcontinue;\r\n\r\n\t\tconst entry = UUIDS.get(sourceId);\r\n\t\tif (!entry) continue;\r\n\r\n\t\tconst { daily, index, condition } = entry;\r\n\t\ttry {\r\n\t\t\tif (typeof condition === \"function\" && !condition({ actor, item, utils }))\r\n\t\t\t\tcontinue;\r\n\r\n\t\t\tdailies[daily.key] ??= deepClone(daily);\r\n\r\n\t\t\tif (index === undefined) dailies[daily.key].item = item;\r\n\t\t\telse dailies[daily.key].children[index].item = item;\r\n\t\t} catch (err) {\r\n\t\t\terror(\"error.unexpected\");\r\n\t\t\tconsole.error(err);\r\n\t\t\tconsole.error(`The error occured during data gathering of ${daily.key}`);\r\n\t\t}\r\n\t}\r\n\r\n\treturn Object.values(dailies).filter(\r\n\t\t(daily) => daily.item && daily.item instanceof Item,\r\n\t);\r\n}\r\n\r\nexport function getDailyFromSourceId(sourceId) {\r\n\treturn UUIDS.get(sourceId)?.daily;\r\n}\r\n", "export function getFamiliarPack() {\r\n\treturn game.packs.get(\"pf2e.familiar-abilities\");\r\n}\r\n\r\nexport function familiarUUID(id) {\r\n\treturn `Compendium.pf2e.familiar-abilities.Item.${id}`;\r\n}\r\n", "import {\r\n\tPredicatePF2e,\r\n\tcapitalize,\r\n\tgetFlag,\r\n\thasLocalization,\r\n\tlocalize,\r\n} from \"module-api\";\r\nimport { utils } from \"../../api\";\r\n\r\nconst templateOrders = {\r\n\tselect: 100,\r\n\tcombo: 80,\r\n\trandom: 60,\r\n\talert: 40,\r\n\tinput: 20,\r\n\tdrop: 0,\r\n};\r\n\r\nexport async function getTemplate({\r\n\tchildren = [],\r\n\tkey,\r\n\titem,\r\n\tprepare,\r\n\tlabel,\r\n\trows = [],\r\n}) {\r\n\tconst actor = this.actor;\r\n\r\n\tthis.saved[key] = getFlag(actor, key) ?? {};\r\n\r\n\tthis.rows[key] = {};\r\n\r\n\tthis.children[key] = children.reduce((children, { slug, item }) => {\r\n\t\tchildren[slug] = item;\r\n\t\treturn children;\r\n\t}, {});\r\n\r\n\tconst prepareArgs = {\r\n\t\tactor,\r\n\t\titem,\r\n\t\tchildren: this.children[key],\r\n\t\tutils,\r\n\t};\r\n\r\n\tthis.custom[key] = (await prepare?.(prepareArgs)) || {};\r\n\tconst custom = this.custom[key];\r\n\r\n\tthis.dailyArgs[key] = {\r\n\t\t...prepareArgs,\r\n\t\tcustom,\r\n\t};\r\n\tconst dailyArgs = this.dailyArgs[key];\r\n\r\n\tlet groupLabel = await getProcessedValue(label, dailyArgs);\r\n\tconst labeled = groupLabel\r\n\t\t? `label.${groupLabel}`\r\n\t\t: key.startsWith(\"dailies.\")\r\n\t\t  ? `label.${key.slice(8)}`\r\n\t\t  : undefined;\r\n\tif (labeled && hasLocalization(labeled)) groupLabel = localize(labeled);\r\n\r\n\tthis.predicate[key] = children\r\n\t\t.filter((child) => child.item)\r\n\t\t.map((child) => child.slug);\r\n\r\n\tconst template = {\r\n\t\tlabel: groupLabel ? game.i18n.localize(groupLabel) : item.name,\r\n\t\trows: [],\r\n\t};\r\n\r\n\tfor (const row of rows) {\r\n\t\tthis.rows[key][row.slug] = row;\r\n\r\n\t\tconst {\r\n\t\t\ttype,\r\n\t\t\tslug,\r\n\t\t\tchildPredicate = [],\r\n\t\t\tcondition,\r\n\t\t\tlabel,\r\n\t\t\tsave,\r\n\t\t\tunique,\r\n\t\t\torder,\r\n\t\t} = row;\r\n\r\n\t\tif (\r\n\t\t\tchildPredicate.length &&\r\n\t\t\t!PredicatePF2e.test(childPredicate, this.predicate[key])\r\n\t\t)\r\n\t\t\tcontinue;\r\n\t\tif (condition && !(await condition(dailyArgs))) continue;\r\n\r\n\t\tconst savedRow =\r\n\t\t\tsave === false || type === \"random\" ? undefined : this.saved[key][slug];\r\n\t\tconst rowLabel = await getProcessedValue(label, dailyArgs);\r\n\t\tconst value =\r\n\t\t\tsavedRow === undefined\r\n\t\t\t\t? \"\"\r\n\t\t\t\t: typeof savedRow !== \"object\"\r\n\t\t\t\t  ? savedRow\r\n\t\t\t\t  : \"name\" in savedRow\r\n\t\t\t\t\t  ? savedRow.name\r\n\t\t\t\t\t  : savedRow.selected;\r\n\r\n\t\tconst rowTemplate = {\r\n\t\t\tlabel: rowLabel ? game.i18n.localize(rowLabel) : \"\",\r\n\t\t\tvalue,\r\n\t\t\torder: order ?? templateOrders[type],\r\n\t\t\tdata: {\r\n\t\t\t\ttype,\r\n\t\t\t\tdaily: key,\r\n\t\t\t\trow: slug,\r\n\t\t\t\t...(unique ? { unique } : \"\"),\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tif (isComboRow(row) || isSelectRow(row) || isRandomRow(row)) {\r\n\t\t\tconst tmp = (await getProcessedValue(row.options, dailyArgs)) ?? [];\r\n\t\t\tif (type !== \"combo\" && !tmp.length) continue;\r\n\r\n\t\t\tconst labelize =\r\n\t\t\t\t(typeof row.labelizer === \"function\" && row.labelizer(dailyArgs)) ||\r\n\t\t\t\t((value) => capitalize(value));\r\n\t\t\trowTemplate.options = tmp.map((value) =>\r\n\t\t\t\ttypeof value === \"string\" ? { value, label: labelize(value) } : value,\r\n\t\t\t);\r\n\r\n\t\t\tif (isComboRow(row)) {\r\n\t\t\t\trowTemplate.selected = rowTemplate.value;\r\n\t\t\t\trowTemplate.data.input = savedRow?.input ?? true;\r\n\r\n\t\t\t\tif (!rowTemplate.data.input && tmp.includes(rowTemplate.selected)) {\r\n\t\t\t\t\trowTemplate.value = labelize(rowTemplate.selected);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (isDropRow(row)) {\r\n\t\t\trowTemplate.data.uuid = savedRow?.uuid ?? \"\";\r\n\t\t} else if (isAlerRow(row)) {\r\n\t\t\trowTemplate.value =\r\n\t\t\t\ttypeof row.message === \"function\"\r\n\t\t\t\t\t? await row.message(dailyArgs)\r\n\t\t\t\t\t: row.message;\r\n\t\t}\r\n\r\n\t\ttemplate.rows.push(rowTemplate);\r\n\t}\r\n\r\n\treturn template;\r\n}\r\n\r\nasync function getProcessedValue(obj, args) {\r\n\tif (typeof obj === \"function\") return await obj(args);\r\n\treturn obj;\r\n}\r\n\r\nfunction isComboRow(row) {\r\n\treturn row.type === \"combo\";\r\n}\r\n\r\nfunction isSelectRow(row) {\r\n\treturn row.type === \"select\";\r\n}\r\n\r\nfunction isRandomRow(row) {\r\n\treturn row.type === \"random\";\r\n}\r\n\r\nfunction isDropRow(row) {\r\n\treturn row.type === \"drop\";\r\n}\r\n\r\nfunction isAlerRow(row) {\r\n\treturn row.type === \"alert\";\r\n}\r\n", "import { sequenceArray } from \"module-api\";\r\n\r\nexport function getSimplifiableValue(actor, value, fallback) {\r\n\tif (value === undefined) return fallback;\r\n\tif (typeof value === \"number\") return value;\r\n\tif (value === \"level\") return actor.level;\r\n\tif (value === \"half\") return Math.max(1, Math.floor(actor.level / 2));\r\n\tconst numbered = Number(value);\r\n\treturn Number.isNaN(numbered) ? fallback : numbered;\r\n}\r\n\r\nexport async function parseFilter(filter) {\r\n\treturn {\r\n\t\ttype: filter.type,\r\n\t\tsearch: await (filter.type === \"feat\"\r\n\t\t\t? parseFeatFilter(this.actor, filter.search)\r\n\t\t\t: parseSpellFilter(this.actor, filter.search)),\r\n\t\tdrop: filter.drop,\r\n\t};\r\n}\r\n\r\nfunction checkFilter(selected, checkbox) {\r\n\tif (!selected?.length) return;\r\n\r\n\tcheckbox.selected = selected;\r\n\tcheckbox.isExpanded = true;\r\n\r\n\tfor (const x of selected) {\r\n\t\tcheckbox.options[x].selected = true;\r\n\t}\r\n}\r\n\r\nfunction setTraits(searchTraits, dataTraits) {\r\n\tconst traits = getFilterTraits(searchTraits);\r\n\tif (traits?.selected.length) {\r\n\t\tdataTraits.conjunction = traits.conjunction;\r\n\t\tdataTraits.selected = traits.selected;\r\n\t}\r\n}\r\n\r\nexport function getFilterTraits(traits) {\r\n\tif (!traits) return;\r\n\r\n\tconst selected = Array.isArray(traits) ? traits : traits.selected;\r\n\tif (!selected?.length) return;\r\n\r\n\treturn {\r\n\t\tselected: selected.map((x) => (typeof x === \"string\" ? { value: x } : x)),\r\n\t\tconjunction: (!Array.isArray(traits) && traits.conjunction) || \"and\",\r\n\t};\r\n}\r\n\r\nasync function parseSpellFilter(actor, search) {\r\n\tconst data = await game.pf2e.compendiumBrowser.tabs.spell.getFilterData();\r\n\r\n\tcheckFilter(search.category, data.checkboxes.category);\r\n\tcheckFilter(search.school, data.checkboxes.school);\r\n\tcheckFilter(search.traditions, data.checkboxes.traditions);\r\n\tcheckFilter(search.rarity, data.checkboxes.rarity);\r\n\tcheckFilter(search.source, data.checkboxes.source);\r\n\r\n\tsetTraits(search.traits, data.multiselects.traits);\r\n\r\n\tconst level = getSpellFilterLevel(actor, search.level);\r\n\tif (level?.length) checkFilter(level, data.checkboxes.rank);\r\n\r\n\treturn data;\r\n}\r\n\r\nasync function parseFeatFilter(actor, search) {\r\n\tconst data = await game.pf2e.compendiumBrowser.tabs.feat.getFilterData();\r\n\r\n\tcheckFilter(search.category, data.checkboxes.category);\r\n\tcheckFilter(search.skills, data.checkboxes.skills);\r\n\tcheckFilter(search.rarity, data.checkboxes.rarity);\r\n\tcheckFilter(search.source, data.checkboxes.source);\r\n\r\n\tsetTraits(search.traits, data.multiselects.traits);\r\n\r\n\tconst level = getFeatFilterLevel(actor, search.level);\r\n\tif (level) {\r\n\t\tdata.sliders.level.values.min = level.min;\r\n\t\tdata.sliders.level.values.max = level.max;\r\n\t\tdata.sliders.level.isExpanded = true;\r\n\t}\r\n\r\n\treturn data;\r\n}\r\n\r\nexport function getSpellFilterLevel(actor, level) {\r\n\tif (Array.isArray(level)) return level;\r\n\r\n\tconst simplified = getSimplifiableValue(actor, level);\r\n\tif (simplified) return sequenceArray(1, simplified);\r\n}\r\n\r\nexport function getFeatFilterLevel(actor, level) {\r\n\tif (level === undefined) return;\r\n\r\n\tif (typeof level === \"object\") {\r\n\t\treturn {\r\n\t\t\tmin: getSimplifiableValue(actor, level.min, 0),\r\n\t\t\tmax: getSimplifiableValue(actor, level.min, 20),\r\n\t\t};\r\n\t}\r\n\r\n\treturn { min: 0, max: getSimplifiableValue(actor, level, 20) };\r\n}\r\n", "import { sluggify, subLocalize } from \"module-api\";\r\nimport { utils } from \"../../api\";\r\nimport {\r\n\tgetFeatFilterLevel,\r\n\tgetFilterTraits,\r\n\tgetSpellFilterLevel,\r\n} from \"./shared\";\r\n\r\nconst localize = subLocalize(\"interface.error.drop\");\r\n\r\nexport async function onDropFeat(item, target, filter) {\r\n\tif (!item.isOfType(\"feat\")) return localize(\"notFeat\");\r\n\r\n\tconst { search, drop } = filter;\r\n\r\n\tif (search.category?.length && !search.category.includes(item.category)) {\r\n\t\treturn localize.warn(\"wrongType\", {\r\n\t\t\ttypes: localizeAll(\"featCategories\", search.category),\r\n\t\t});\r\n\t}\r\n\r\n\tif (search.traits) {\r\n\t\tconst traits = getFilterTraits(search.traits);\r\n\r\n\t\tif (traits?.selected.length) {\r\n\t\t\tconst testFn = traits.conjunction === \"or\" ? \"some\" : \"every\";\r\n\t\t\tconst test = traits.selected[testFn](\r\n\t\t\t\t(trait) =>\r\n\t\t\t\t\tNumber(trait.not ?? false) - Number(item.traits.has(trait.value)),\r\n\t\t\t);\r\n\t\t\tif (!test) return localize.warn(\"wrongTraits\");\r\n\t\t}\r\n\t}\r\n\r\n\tif (search.skills?.length) {\r\n\t\tconst translatedSkills = utils.getTranslatedSkills(true);\r\n\t\tconst prerequisites = item.system.prerequisites.value.map((prerequisite) =>\r\n\t\t\tprerequisite.value.toLocaleLowerCase(),\r\n\t\t);\r\n\t\tconst test = search.skills.some((skill) =>\r\n\t\t\tprerequisites.some(\r\n\t\t\t\t(prerequisite) =>\r\n\t\t\t\t\tprerequisite.includes(skill) ||\r\n\t\t\t\t\tprerequisite.includes(translatedSkills[skill]),\r\n\t\t\t),\r\n\t\t);\r\n\t\tif (!test)\r\n\t\t\treturn localize.warn(\"wrongSkill\", {\r\n\t\t\t\tskills: localizeAll(\"skillList\", search.skills),\r\n\t\t\t});\r\n\t}\r\n\r\n\tif (\r\n\t\tsearch.rarity?.length &&\r\n\t\t!search.rarity.includes(item.system.traits.rarity)\r\n\t) {\r\n\t\treturn localize.warn(\"wrongRarity\", {\r\n\t\t\trarities: localizeAll(\"rarityTraits\", search.rarity),\r\n\t\t});\r\n\t}\r\n\r\n\tif (\r\n\t\tsearch.source?.length &&\r\n\t\t!search.source.includes(sluggify(item.system.source.value))\r\n\t) {\r\n\t\treturn localize.warn(\"wrongSource\", { sources: search.source.join(\", \") });\r\n\t}\r\n\r\n\tconst level = getFeatFilterLevel(this.actor, search.level);\r\n\tif (level) {\r\n\t\tconst itemLevel = item.level;\r\n\t\tif (itemLevel < level.min)\r\n\t\t\treturn localize.warn(\"wrongLevelLow\", { level: `min: ${level.min}` });\r\n\t\tif (itemLevel > level.max)\r\n\t\t\treturn localize.warn(\"wrongLevelHigh\", { level: `max: ${level.max}` });\r\n\t}\r\n\r\n\tif (drop) {\r\n\t\tconst args = this.dailyArgs[target.dataset.daily];\r\n\t\tif (args) {\r\n\t\t\tconst result = await drop(item, args);\r\n\t\t\tif (typeof result === \"object\") {\r\n\t\t\t\tif (result.data) return game.i18n.format(result.error, result.data);\r\n\t\t\t\treturn game.i18n.localize(result.error);\r\n\t\t\t}\r\n\r\n\t\t\tif (result === false) {\r\n\t\t\t\treturn localize.warn(\"wrongCustom\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDropItem(item, target);\r\n}\r\n\r\nexport async function onDropSpell(item, target, filter) {\r\n\tif (!item.isOfType(\"spell\")) return localize(\"notSpell\");\r\n\r\n\tconst { search, drop } = filter;\r\n\r\n\tif (search.category?.length) {\r\n\t\tconst categories = search.category\r\n\t\t\t.map((x) =>\r\n\t\t\t\tgame.i18n.localize(\r\n\t\t\t\t\tx === \"cantrip\"\r\n\t\t\t\t\t\t? \"PF2E.SpellCantripLabel\"\r\n\t\t\t\t\t\t: CONFIG.PF2E.preparationType[x],\r\n\t\t\t\t),\r\n\t\t\t)\r\n\t\t\t.join(\", \");\r\n\r\n\t\tif (\r\n\t\t\t(item.isCantrip && !search.category.includes(\"cantrip\")) ||\r\n\t\t\t(item.isFocusSpell && !search.category.includes(\"focus\")) ||\r\n\t\t\t(item.isRitual && !search.category.includes(\"ritual\")) ||\r\n\t\t\t(!item.isCantrip &&\r\n\t\t\t\t!item.isFocusSpell &&\r\n\t\t\t\t!item.isRitual &&\r\n\t\t\t\t!search.category.includes(\"spell\"))\r\n\t\t) {\r\n\t\t\treturn localize.warn(\"wrongCategory\", { categories });\r\n\t\t}\r\n\t}\r\n\r\n\tif (search.traits) {\r\n\t\tconst traits = getFilterTraits(search.traits);\r\n\r\n\t\tif (traits?.selected.length) {\r\n\t\t\tconst testFn = traits.conjunction === \"or\" ? \"some\" : \"every\";\r\n\t\t\tconst test = traits.selected[testFn](\r\n\t\t\t\t(trait) =>\r\n\t\t\t\t\tNumber(trait.not ?? false) - Number(item.traits.has(trait.value)),\r\n\t\t\t);\r\n\t\t\tif (!test) return localize.warn(\"wrongTraits\");\r\n\t\t}\r\n\t}\r\n\r\n\tif (search.traditions?.length) {\r\n\t\tif (\r\n\t\t\t!search.traditions.some((tradition) => item.traditions.has(tradition))\r\n\t\t) {\r\n\t\t\treturn localize.warn(\"wrongTradition\", {\r\n\t\t\t\ttraditions: localizeAll(\"magicTraditions\", search.traditions),\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tconst level = getSpellFilterLevel(this.actor, search.level);\r\n\tif (level?.length && !level.includes(item.level)) {\r\n\t\treturn localize.warn(\"wrongLevel\", { levels: level.join(\", \") });\r\n\t}\r\n\r\n\tif (search.school?.length && !search.school.includes(item.school)) {\r\n\t\treturn localize.warn(\"wrongSchool\", {\r\n\t\t\tschools: localizeAll(\"magicSchools\", search.school),\r\n\t\t});\r\n\t}\r\n\r\n\tif (\r\n\t\tsearch.rarity?.length &&\r\n\t\t!search.rarity.includes(item.system.traits.rarity)\r\n\t) {\r\n\t\treturn localize.warn(\"wrongRarity\", {\r\n\t\t\trarities: localizeAll(\"rarityTraits\", search.rarity),\r\n\t\t});\r\n\t}\r\n\r\n\tif (\r\n\t\tsearch.source?.length &&\r\n\t\t!search.source.includes(sluggify(item.system.source.value))\r\n\t) {\r\n\t\treturn localize.warn(\"wrongSource\", { sources: search.source.join(\", \") });\r\n\t}\r\n\r\n\tif (drop) {\r\n\t\tconst args = this.dailyArgs[target.dataset.daily];\r\n\t\tif (args) {\r\n\t\t\tconst result = await drop(item, args);\r\n\t\t\tif (typeof result === \"object\") {\r\n\t\t\t\tif (result.data) {\r\n\t\t\t\t\treturn ui.notifications.warn(\r\n\t\t\t\t\t\tgame.i18n.format(result.error, result.data),\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\treturn ui.notifications.warn(game.i18n.localize(result.error));\r\n\t\t\t}\r\n\r\n\t\t\tif (result === false) {\r\n\t\t\t\treturn localize.warn(\"wrongCustom\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDropItem(item, target);\r\n}\r\n\r\nfunction localizeAll(config, list) {\r\n\tconst localized = list.map((key) =>\r\n\t\tgame.i18n.localize(CONFIG.PF2E[config][key]),\r\n\t);\r\n\treturn localized.join(\", \");\r\n}\r\n\r\nexport function onDropItem(item, target) {\r\n\ttarget.value = item.name;\r\n\ttarget.dataset.uuid = item.uuid;\r\n\ttarget.nextElementSibling.nextElementSibling.classList.remove(\"disabled\");\r\n}\r\n", "import {\r\n\tMODULE,\r\n\tcreateFancyLink,\r\n\terror,\r\n\tgetFlag,\r\n\tgetSetting,\r\n\thasLocalization,\r\n\tlocalize,\r\n\tsluggify,\r\n\tsubLocalize,\r\n} from \"module-api\";\r\nimport { createUpdateCollection, utils } from \"../../api\";\r\nimport { familiarUUID, getFamiliarPack } from \"../../data/familiar\";\r\nimport {\r\n\tDEFAULT_REGEX_RANKS,\r\n\tgetBestSpellcastingEntryForStaves,\r\n\tgetMaxSlotRankForStaves,\r\n} from \"../../data/staves\";\r\nimport { getSpellcastingEntriesSortBounds } from \"../../spellcasting\";\r\n\r\nexport async function processData() {\r\n\tconst actor = this.actor;\r\n\tconst dailies = this.dailies;\r\n\tconst fields = getFields.call(this);\r\n\tconst addItems = [];\r\n\tconst addRules = new Map();\r\n\tconst [updateItems, updateItem] = createUpdateCollection();\r\n\tconst flags = {};\r\n\tconst msg = subLocalize(\"message\");\r\n\r\n\tlet addedSpells = false;\r\n\tlet chatContent = \"\";\r\n\r\n\tconst getRules = (item) => {\r\n\t\tconst id = item.id;\r\n\t\tconst existing = addRules.get(id);\r\n\t\tif (existing) return existing;\r\n\r\n\t\tconst rules = deepClone(item._source.system.rules);\r\n\r\n\t\tfor (let i = rules.length - 1; i >= 0; i--) {\r\n\t\t\tif (MODULE.id in rules[i]) rules.splice(i, 1);\r\n\t\t}\r\n\r\n\t\taddRules.set(id, rules);\r\n\t\treturn rules;\r\n\t};\r\n\r\n\tconst messages = {\r\n\t\tlanguages: { order: 80, messages: [] },\r\n\t\tskills: { order: 70, messages: [] },\r\n\t\tresistances: { order: 60, messages: [] },\r\n\t\tfeats: { order: 50, messages: [] },\r\n\t\tspells: { order: 40, messages: [] },\r\n\t\tscrolls: { order: 30, messages: [] },\r\n\t};\r\n\r\n\tconst rawMessages = [];\r\n\r\n\tconst messageObj = {\r\n\t\tadd: (group, options) => {\r\n\t\t\tmessages[group] ??= { order: 0, messages: [] };\r\n\t\t\tmessages[group].messages.push(options);\r\n\t\t},\r\n\t\taddGroup: (group, order, label) => {\r\n\t\t\tmessages[group] ??= { label, order: order ?? 1, messages: [] };\r\n\t\t},\r\n\t\taddRaw: (message, order = 1) => {\r\n\t\t\trawMessages.push({ order, message });\r\n\t\t},\r\n\t};\r\n\r\n\tif (actor.familiar && fields[\"dailies.familiar\"]) {\r\n\t\tconst familiar = actor.familiar;\r\n\t\tconst pack = getFamiliarPack();\r\n\t\tconst abilities = [];\r\n\r\n\t\t// we remove old abilities\r\n\t\tconst ids = familiar.itemTypes.action.map((item) => item.id);\r\n\t\tif (ids.length) familiar.deleteEmbeddedDocuments(\"Item\", ids);\r\n\r\n\t\tmessageObj.addGroup(\"familiar\", 20);\r\n\r\n\t\tfor (const field of Object.values(fields[\"dailies.familiar\"])) {\r\n\t\t\tconst value = field.value;\r\n\t\t\tconst isCustom = value.includes(\".\");\r\n\t\t\tconst item = await (isCustom ? fromUuid(value) : pack.getDocument(value));\r\n\t\t\tif (!item || !item.isOfType(\"action\")) continue;\r\n\r\n\t\t\tconst source = item.toObject();\r\n\t\t\tif (source) {\r\n\t\t\t\tabilities.push(source);\r\n\t\t\t\tmessageObj.add(\"familiar\", {\r\n\t\t\t\t\tuuid: isCustom ? value : familiarUUID(value),\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (abilities.length) familiar.createEmbeddedDocuments(\"Item\", abilities);\r\n\t}\r\n\r\n\tif (fields[\"dailies.staff\"]) {\r\n\t\tconst staffField = fields[\"dailies.staff\"];\r\n\t\tconst staffID = staffField.staffID.value;\r\n\t\tconst staff = actor.items.get(staffID);\r\n\t\tconst makeshift = staffField.staffID.makeshift === \"true\";\r\n\t\tconst maxStaffCharges = getMaxSlotRankForStaves(actor);\r\n\r\n\t\tif (staff && (maxStaffCharges || makeshift)) {\r\n\t\t\tconst uuids = [];\r\n\t\t\tconst ranks = getSetting(\"staff-regex\").trim() || DEFAULT_REGEX_RANKS;\r\n\t\t\tconst ranksRegex = new RegExp(\r\n\t\t\t\t`<strong>\\\\s*(?<rank>(?:${ranks}))\\\\s*<\\/strong>.+?(?<uuids>@(?:UUID|Compendium)\\[[a-zA-Z0-9-.]+\\].+?)\\n`,\r\n\t\t\t\t\"gi\",\r\n\t\t\t);\r\n\r\n\t\t\tlet rankMatch = ranksRegex.exec(staff.description);\r\n\t\t\twhile (rankMatch !== null) {\r\n\t\t\t\tconst rankStr = rankMatch.groups.rank.trim().replace(/\\D+/, \"\") || \"0\";\r\n\t\t\t\tconst rank = Math.clamped(parseInt(rankStr), 0, 10);\r\n\t\t\t\tconst uuidRegex =\r\n\t\t\t\t\t/@(?<protocole>UUID|Compendium)\\[(?<uuid>[a-zA-Z0-9-.]+)\\]/g;\r\n\r\n\t\t\t\tlet uuidMatch = uuidRegex.exec(rankMatch.groups.uuids);\r\n\t\t\t\twhile (uuidMatch !== null) {\r\n\t\t\t\t\tlet uuid = uuidMatch.groups.uuid;\r\n\t\t\t\t\tif (uuidMatch.groups.protocole === \"Compendium\") {\r\n\t\t\t\t\t\tif (!uuid.startsWith(\"Compendium.\")) uuid = `Compendium.${uuid}`;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (fromUuidSync(uuid)) {\r\n\t\t\t\t\t\tuuids.push({ rank, uuid });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tuuidMatch = uuidRegex.exec(rankMatch.groups.uuids);\r\n\t\t\t\t}\r\n\r\n\t\t\t\trankMatch = ranksRegex.exec(staff.description);\r\n\t\t\t}\r\n\r\n\t\t\tif (uuids.length) {\r\n\t\t\t\tlet overcharge = 0;\r\n\r\n\t\t\t\tconst expendedSpells = [];\r\n\t\t\t\tconst expendedSlots = makeshift ? [1, 2, 3] : [1];\r\n\t\t\t\tconst flexibleLabel = localize(\"interface.staves.flexible\");\r\n\t\t\t\tconst emptyLabel = localize(\"interface.staves.empty\");\r\n\t\t\t\tconst slotsUpdates = {};\r\n\r\n\t\t\t\tfor (const i of expendedSlots) {\r\n\t\t\t\t\tconst expendField = staffField[`expend${i}`];\r\n\t\t\t\t\tconst data = expendField?.optionData;\r\n\t\t\t\t\tif (!data) continue;\r\n\r\n\t\t\t\t\tconst entryId = data.entry;\r\n\t\t\t\t\tconst entry = actor.items.get(entryId);\r\n\t\t\t\t\tif (!entry) continue;\r\n\r\n\t\t\t\t\tconst rank = Number(data.rank);\r\n\t\t\t\t\tconst slot = entry._source.system.slots[`slot${rank}`];\r\n\r\n\t\t\t\t\tif (data.type === \"spell\") {\r\n\t\t\t\t\t\tconst prepared = deepClone(slot.prepared);\r\n\t\t\t\t\t\tconst preparedSlot = prepared[data.index];\r\n\t\t\t\t\t\tif (slot.max < 1 || preparedSlot.expended) return;\r\n\r\n\t\t\t\t\t\tovercharge += rank;\r\n\r\n\t\t\t\t\t\tpreparedSlot.expended = true;\r\n\r\n\t\t\t\t\t\tupdateItem({\r\n\t\t\t\t\t\t\t_id: entryId,\r\n\t\t\t\t\t\t\t[`system.slots.slot${rank}.prepared`]: prepared,\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tconst spell = actor.items.get(preparedSlot.id);\r\n\t\t\t\t\t\texpendedSpells.push({\r\n\t\t\t\t\t\t\tuuid: spell?.uuid,\r\n\t\t\t\t\t\t\tname: spell?.name ?? emptyLabel,\r\n\t\t\t\t\t\t\trank,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif (slot.max < 1 || slot.value < 1) continue;\r\n\r\n\t\t\t\t\t\tslotsUpdates[entryId] ??= {};\r\n\t\t\t\t\t\tslotsUpdates[entryId][rank] ??= slot.value;\r\n\r\n\t\t\t\t\t\tconst currentValue = slotsUpdates[entryId][rank];\r\n\r\n\t\t\t\t\t\tif (currentValue < 1) continue;\r\n\r\n\t\t\t\t\t\tovercharge += rank;\r\n\r\n\t\t\t\t\t\tupdateItem({\r\n\t\t\t\t\t\t\t_id: entryId,\r\n\t\t\t\t\t\t\t[`system.slots.slot${rank}.value`]: currentValue - 1,\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tslotsUpdates[entryId][rank] -= 1;\r\n\r\n\t\t\t\t\t\texpendedSpells.push({\r\n\t\t\t\t\t\t\tname: flexibleLabel,\r\n\t\t\t\t\t\t\trank,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst bestEntry = getBestSpellcastingEntryForStaves(actor);\r\n\r\n\t\t\t\tif (bestEntry) {\r\n\t\t\t\t\tconst { ability, tradition, proficiency } = bestEntry;\r\n\r\n\t\t\t\t\tconst sort = (() => {\r\n\t\t\t\t\t\tconst { min, max } = getSpellcastingEntriesSortBounds(actor);\r\n\t\t\t\t\t\treturn getSetting(\"staff-sort\") === \"bottom\"\r\n\t\t\t\t\t\t\t? max + 10000\r\n\t\t\t\t\t\t\t: min - 10000;\r\n\t\t\t\t\t})();\r\n\r\n\t\t\t\t\tconst entrySource = {\r\n\t\t\t\t\t\ttype: \"spellcastingEntry\",\r\n\t\t\t\t\t\tname: staff.name,\r\n\t\t\t\t\t\tsort,\r\n\t\t\t\t\t\tsystem: {\r\n\t\t\t\t\t\t\tability,\r\n\t\t\t\t\t\t\tprepared: { value: \"charge\" },\r\n\t\t\t\t\t\t\tshowSlotlessLevels: { value: false },\r\n\t\t\t\t\t\t\tshowUnpreparedSpells: { value: false },\r\n\t\t\t\t\t\t\tproficiency,\r\n\t\t\t\t\t\t\ttradition,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tflags: {\r\n\t\t\t\t\t\t\t[MODULE.id]: {\r\n\t\t\t\t\t\t\t\ttype: \"staff\",\r\n\t\t\t\t\t\t\t\tstaff: {\r\n\t\t\t\t\t\t\t\t\tcharges: maxStaffCharges + overcharge,\r\n\t\t\t\t\t\t\t\t\tstaveID: staffID,\r\n\t\t\t\t\t\t\t\t\tovercharge,\r\n\t\t\t\t\t\t\t\t\tmakeshift,\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\taddItems.push(entrySource);\r\n\r\n\t\t\t\t\tawait Promise.all(\r\n\t\t\t\t\t\tuuids.map(async ({ rank, uuid }) => {\r\n\t\t\t\t\t\t\tconst source = await utils.createSpellSource(uuid);\r\n\t\t\t\t\t\t\tsetProperty(source, `flags.${MODULE.id}.entry`, {\r\n\t\t\t\t\t\t\t\tlevel: rank,\r\n\t\t\t\t\t\t\t\ttype: \"staff\",\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\taddItems.push(source);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tmessageObj.addGroup(\r\n\t\t\t\t\t\t\"staff\",\r\n\t\t\t\t\t\t45,\r\n\t\t\t\t\t\tlocalize(\r\n\t\t\t\t\t\t\t`staves.message.${overcharge ? \"withExpend\" : \"noExpend\"}`,\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tmakeshift: makeshift ? localize(\"staves.makeshift\") : \"\",\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t),\r\n\t\t\t\t\t);\r\n\t\t\t\t\tmessageObj.add(\"staff\", { uuid: staff.uuid });\r\n\t\t\t\t\tfor (const { uuid, name, rank } of expendedSpells) {\r\n\t\t\t\t\t\tconst rankLabel = utils.spellRankLabel(rank);\r\n\t\t\t\t\t\tconst label = `${name} (${rankLabel})`;\r\n\r\n\t\t\t\t\t\tmessageObj.add(\"staff\", {\r\n\t\t\t\t\t\t\tuuid,\r\n\t\t\t\t\t\t\tlabel: uuid\r\n\t\t\t\t\t\t\t\t? label\r\n\t\t\t\t\t\t\t\t: `<span class=\"fake-link\">\r\n\t\t\t\t\t\t\t\t\t<i class='fa-solid fa-sparkles'></i>\r\n\t\t\t\t\t\t\t\t\t${label}\r\n\t\t\t\t\t\t\t\t</span>`,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfor (const { item, key, process } of dailies) {\r\n\t\tif (!fields[key]) continue;\r\n\r\n\t\tconst dailyArgs = this.dailyArgs[key];\r\n\r\n\t\ttry {\r\n\t\t\tawait process({\r\n\t\t\t\t...dailyArgs,\r\n\t\t\t\tfields: fields[key],\r\n\t\t\t\tmessages: messageObj,\r\n\t\t\t\taddItem: (source) => addItems.push(source),\r\n\t\t\t\tupdateItem,\r\n\t\t\t\tremoveRule: (signature, parent) => {\r\n\t\t\t\t\tconst rules = getRules(parent ?? item);\r\n\t\t\t\t\tfor (let i = rules.length - 1; i >= 0; i--) {\r\n\t\t\t\t\t\tconst rule = rules[i];\r\n\t\t\t\t\t\tif (signature(rule)) {\r\n\t\t\t\t\t\t\trules.splice(i, 1);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\taddRule: (source, parent) => {\r\n\t\t\t\t\tsource[MODULE.id] = true;\r\n\t\t\t\t\tgetRules(parent ?? item).push(source);\r\n\t\t\t\t},\r\n\t\t\t\taddFeat: (source, parent) => {\r\n\t\t\t\t\tconst parentItem = parent ?? item;\r\n\t\t\t\t\tif (parentItem.isOfType(\"feat\")) {\r\n\t\t\t\t\t\tconst parentId = parentItem.id;\r\n\t\t\t\t\t\tsetProperty(source, \"flags.pf2e.grantedBy\", {\r\n\t\t\t\t\t\t\tid: parentId,\r\n\t\t\t\t\t\t\tonDelete: \"cascade\",\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tsetProperty(source, `flags.${MODULE.id}.grantedBy`, parentId);\r\n\t\t\t\t\t}\r\n\t\t\t\t\taddItems.push(source);\r\n\t\t\t\t},\r\n\t\t\t\taddSpell: (source, level) => {\r\n\t\t\t\t\tsetProperty(source, `flags.${MODULE.id}.entry`, {\r\n\t\t\t\t\t\tlevel: level,\r\n\t\t\t\t\t\ttype: \"fallback\",\r\n\t\t\t\t\t});\r\n\t\t\t\t\taddItems.push(source);\r\n\t\t\t\t\taddedSpells = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t} catch (err) {\r\n\t\t\terror(\"error.unexpected\");\r\n\t\t\tconsole.error(err);\r\n\t\t\tconsole.error(`The error occured during processing of ${key}`);\r\n\t\t}\r\n\t}\r\n\r\n\tfor (const [key, rowFields] of Object.entries(fields)) {\r\n\t\tconst rows = this.rows[key];\r\n\t\tif (!rows) continue;\r\n\r\n\t\tfor (const { row, type, input, value, uuid } of Object.values(rowFields)) {\r\n\t\t\tif (type === \"random\" || rows[row]?.save === false) continue;\r\n\r\n\t\t\tflags[key] ??= {};\r\n\t\t\tconst flag = flags[key];\r\n\r\n\t\t\tif (type === \"combo\") {\r\n\t\t\t\tflag[row] = { input: input === \"true\", selected: value };\r\n\t\t\t} else if (type === \"drop\") {\r\n\t\t\t\tflag[row] = { uuid: uuid, name: value };\r\n\t\t\t} else {\r\n\t\t\t\tflag[row] = value;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfor (const [id, rules] of addRules) {\r\n\t\tupdateItem({ _id: id, \"system.rules\": rules });\r\n\t}\r\n\r\n\tif (addedSpells) {\r\n\t\tconst entrySource = {\r\n\t\t\ttype: \"spellcastingEntry\",\r\n\t\t\tname: localize(\"spellEntry.name\"),\r\n\t\t\tsystem: {\r\n\t\t\t\tprepared: { value: \"innate\" },\r\n\t\t\t\tshowSlotlessLevels: { value: false },\r\n\t\t\t\tshowUnpreparedSpells: { value: false },\r\n\t\t\t\tproficiency: {\r\n\t\t\t\t\tvalue: 1,\r\n\t\t\t\t\tslug: actor.classDC?.slug || actor.class?.slug || undefined,\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tflags: {\r\n\t\t\t\t[MODULE.id]: {\r\n\t\t\t\t\ttype: \"fallback\",\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t};\r\n\t\taddItems.push(entrySource);\r\n\t}\r\n\r\n\tfor (const source of addItems) {\r\n\t\tconst alreadyTemp = getProperty(source, \"system.temporary\") === true;\r\n\t\tif (!alreadyTemp) setProperty(source, `flags.${MODULE.id}.temporary`, true);\r\n\t}\r\n\r\n\tif (addItems.length) {\r\n\t\tconst items = await actor.createEmbeddedDocuments(\"Item\", addItems);\r\n\r\n\t\tfor (const item of items) {\r\n\t\t\tif (item.isOfType(\"feat\")) {\r\n\t\t\t\t// we add itemGrants flag to the parent feat to have the cascade effect in the tab\r\n\t\t\t\tconst parentId = getFlag(item, \"grantedBy\");\r\n\t\t\t\tif (parentId) {\r\n\t\t\t\t\tconst slug = sluggify(item.name, { camel: \"dromedary\" });\r\n\t\t\t\t\tconst path = `flags.pf2e.itemGrants.${slug}`;\r\n\t\t\t\t\tupdateItem({\r\n\t\t\t\t\t\t_id: parentId,\r\n\t\t\t\t\t\t[path]: { id: item.id, onDelete: \"detach\" },\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else if (item.isOfType(\"spellcastingEntry\")) {\r\n\t\t\t\t// we add all the newly created spells with 'addSpell' to this spellcasting entry\r\n\t\t\t\tconst entryType = getFlag(item, \"type\");\r\n\t\t\t\tconst spells = items.filter(\r\n\t\t\t\t\t(item) =>\r\n\t\t\t\t\t\titem.isOfType(\"spell\") &&\r\n\t\t\t\t\t\tgetFlag(item, \"entry\")?.type === entryType,\r\n\t\t\t\t);\r\n\t\t\t\tfor (const spell of spells) {\r\n\t\t\t\t\tconst { level } = getFlag(spell, \"entry\");\r\n\t\t\t\t\tconst data = { _id: spell.id, \"system.location.value\": item.id };\r\n\t\t\t\t\tif (level !== undefined)\r\n\t\t\t\t\t\tdata[\"system.location.heightenedLevel\"] = level;\r\n\t\t\t\t\tupdateItem(data);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tawait actor.update({\r\n\t\t[`flags.${MODULE.id}`]: { ...expandObject(flags), rested: false },\r\n\t});\r\n\r\n\tif (updateItems.size)\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updateItems.contents);\r\n\r\n\trawMessages.sort((a, b) => b.order - a.order);\r\n\tfor (const { message } of rawMessages) {\r\n\t\tchatContent += `${message}<hr />`;\r\n\t}\r\n\r\n\tchatContent += await parseMessages(messages, chatContent);\r\n\tchatContent = chatContent\r\n\t\t? `${msg(\"changes\")}<hr />${chatContent}`\r\n\t\t: msg(\"noChanges\");\r\n\r\n\tChatMessage.create({\r\n\t\tcontent: `<div class=\"pf2e-dailies-summary\">${chatContent}</div>`,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor }),\r\n\t});\r\n}\r\n\r\nasync function parseMessages(messages) {\r\n\tconst msg = subLocalize(\"message\");\r\n\r\n\tconst messageList = Object.entries(messages).map(([type, options]) => {\r\n\t\toptions.label ??= msg.has(type) ? msg(type) : msg(\"gained\", { type });\r\n\t\treturn options;\r\n\t});\r\n\tmessageList.sort((a, b) => b.order - a.order);\r\n\r\n\tlet message = \"\";\r\n\r\n\tfor (const { label, messages } of messageList) {\r\n\t\tif (!messages.length) continue;\r\n\r\n\t\tif (message) message += \"<hr />\";\r\n\r\n\t\tif (label) message += `<p><strong>${label}</strong></p>`;\r\n\r\n\t\tfor (let { uuid, selected, label, random } of messages) {\r\n\t\t\tconst key = `label.${label}`;\r\n\t\t\tlabel = label && hasLocalization(key) ? localize(key) : label || \"\";\r\n\r\n\t\t\tmessage += \"<p>\";\r\n\t\t\tmessage += uuid\r\n\t\t\t\t? `${await createFancyLink(uuid, { label })}`\r\n\t\t\t\t: ` ${label}`;\r\n\t\t\tif (selected) {\r\n\t\t\t\tmessage += `<i class=\"fa-solid fa-caret-right\"></i>${selected}`;\r\n\t\t\t}\r\n\t\t\tif (random) {\r\n\t\t\t\tmessage += '<i class=\"fa-solid fa-dice-d20\"></i>';\r\n\t\t\t}\r\n\t\t\tmessage += \"</p>\";\r\n\t\t}\r\n\t}\r\n\r\n\treturn message;\r\n}\r\n\r\nfunction getFields() {\r\n\tconst elements = this.element\r\n\t\t.find(\".window-content .content\")\r\n\t\t.find(\"input:not(.alert), select[data-type]\")\r\n\t\t.toArray();\r\n\r\n\tconst fields = {};\r\n\r\n\tfor (const element of elements) {\r\n\t\tconst field = {\r\n\t\t\t...element.dataset,\r\n\t\t\tvalue: element.value,\r\n\t\t};\r\n\r\n\t\tif (field.type === \"combo\" && field.input === \"false\") {\r\n\t\t\tconst select = element.previousElementSibling;\r\n\t\t\tfield.value = select.value;\r\n\t\t\tfield.optionData = select.selectedOptions[0].dataset;\r\n\t\t}\r\n\r\n\t\tif (field.type === \"select\") {\r\n\t\t\tfield.optionData = element.selectedOptions[0].dataset;\r\n\t\t}\r\n\r\n\t\tfields[field.daily] ??= {};\r\n\t\tfields[field.daily][field.row] = field;\r\n\t}\r\n\r\n\treturn fields;\r\n}\r\n", "import { utils } from \"../api\";\r\nimport { DAILY_FILTERS, getDailies } from \"../dailies\";\r\nimport { getFamiliarPack } from \"../data/familiar\";\r\nimport {\r\n\tgetMaxSlotRankForStaves,\r\n\tgetStaves,\r\n\tisPF2eStavesActive,\r\n} from \"../data/staves\";\r\nimport { getPreparedSpellcastingEntriesForStaves } from \"../data/staves\";\r\nimport { getTemplate } from \"./interface/data\";\r\nimport { onDropFeat, onDropItem, onDropSpell } from \"./interface/drop\";\r\nimport { processData } from \"./interface/process\";\r\nimport { parseFilter } from \"./interface/shared\";\r\nimport {\r\n\tgetFlag,\r\n\tgetItemWithSourceId,\r\n\tgetSetting,\r\n\tsetFlag,\r\n\tsubLocalize,\r\n\ttemplatePath,\r\n} from \"module-api\";\r\n\r\nconst localize = subLocalize(\"interface\");\r\n\r\nconst STAFF_NEXUS = \"Compendium.pf2e.classfeatures.Item.Klb35AwlkNrq1gpB\";\r\n\r\nexport class DailiesInterface extends Application {\r\n\tconstructor(actor, options, message) {\r\n\t\tsuper(options);\r\n\t\tthis._actor = actor;\r\n\t\tthis._dailies = [];\r\n\t\tthis._dailyArgs = {};\r\n\t\tthis._saved = {};\r\n\t\tthis._children = {};\r\n\t\tthis._custom = {};\r\n\t\tthis._predicate = {};\r\n\t\tthis._rows = {};\r\n\t\tthis._message = message;\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn mergeObject(Application.defaultOptions, {\r\n\t\t\tid: \"pf2e-dailies-interface\",\r\n\t\t\ttemplate: templatePath(\"interface\"),\r\n\t\t\theight: \"auto\",\r\n\t\t\twidth: 400,\r\n\t\t\tsubmitOnClose: false,\r\n\t\t\tsubmitOnChange: false,\r\n\t\t\tdragDrop: [\r\n\t\t\t\t{\r\n\t\t\t\t\tdropSelector: '[data-droppable=\"true\"]',\r\n\t\t\t\t},\r\n\t\t\t],\r\n\t\t});\r\n\t}\r\n\r\n\tget actor() {\r\n\t\treturn this._actor;\r\n\t}\r\n\r\n\tget dailies() {\r\n\t\treturn this._dailies;\r\n\t}\r\n\r\n\tget dailyArgs() {\r\n\t\treturn this._dailyArgs;\r\n\t}\r\n\r\n\tget saved() {\r\n\t\treturn this._saved;\r\n\t}\r\n\r\n\tget children() {\r\n\t\treturn this._children;\r\n\t}\r\n\r\n\tget custom() {\r\n\t\treturn this._custom;\r\n\t}\r\n\r\n\tget predicate() {\r\n\t\treturn this._predicate;\r\n\t}\r\n\r\n\tget rows() {\r\n\t\treturn this._rows;\r\n\t}\r\n\r\n\tasync getData(options) {\r\n\t\tconst templates = [];\r\n\t\tconst actor = this._actor;\r\n\t\tthis._dailies = getDailies(actor);\r\n\r\n\t\tif (actor.familiar && !DAILY_FILTERS.includes(\"dailies.familiar\")) {\r\n\t\t\tconst type = \"dailies.familiar\";\r\n\t\t\tconst localize = subLocalize(\"label\");\r\n\t\t\tconst nbAbilities = actor.attributes.familiarAbilities.value;\r\n\t\t\tconst pack = getFamiliarPack();\r\n\t\t\tconst flags = getFlag(actor, type) ?? {};\r\n\r\n\t\t\tconst template = {\r\n\t\t\t\tlabel: localize(\"familiar\"),\r\n\t\t\t\trows: [],\r\n\t\t\t};\r\n\r\n\t\t\tconst options = pack.index.map(({ _id, name }) => ({\r\n\t\t\t\tvalue: _id,\r\n\t\t\t\tlabel: name,\r\n\t\t\t}));\r\n\r\n\t\t\tconst customUUIDS = getSetting(\"familiar\").split(\",\");\r\n\t\t\tfor (let uuid of customUUIDS) {\r\n\t\t\t\tuuid = uuid.trim();\r\n\t\t\t\tconst item = await fromUuid(uuid);\r\n\t\t\t\tif (item?.isOfType(\"action\"))\r\n\t\t\t\t\toptions.push({ value: uuid, label: item.name });\r\n\t\t\t}\r\n\r\n\t\t\toptions.sort((a, b) => a.label.localeCompare(b.label));\r\n\r\n\t\t\tfor (let index = 0; index < nbAbilities; index++) {\r\n\t\t\t\ttemplate.rows.push({\r\n\t\t\t\t\tlabel: localize(\"ability\", { nb: index + 1 }),\r\n\t\t\t\t\tvalue: flags[`${index}`] ?? \"\",\r\n\t\t\t\t\torder: 100,\r\n\t\t\t\t\toptions,\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\ttype: \"select\",\r\n\t\t\t\t\t\tdaily: type,\r\n\t\t\t\t\t\trow: index.toString(),\r\n\t\t\t\t\t\tunique: \"ability\",\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (template.rows.length) {\r\n\t\t\t\tthis._rows[type] = template.rows.reduce((rows, { data }) => {\r\n\t\t\t\t\trows[data.row] = { save: true };\r\n\t\t\t\t\treturn rows;\r\n\t\t\t\t}, {});\r\n\t\t\t\ttemplates.push(template);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!DAILY_FILTERS.includes(\"dailies.staves\") && !isPF2eStavesActive()) {\r\n\t\t\tconst staves = getStaves(actor);\r\n\r\n\t\t\tif (staves.length) {\r\n\t\t\t\tconst maxStaffCharges = getMaxSlotRankForStaves(actor);\r\n\r\n\t\t\t\tif (maxStaffCharges) {\r\n\t\t\t\t\tconst type = \"dailies.staff\";\r\n\t\t\t\t\tconst flags = getFlag(actor, type) ?? {};\r\n\t\t\t\t\tconst options = staves.map((staff) => ({\r\n\t\t\t\t\t\tvalue: staff.id,\r\n\t\t\t\t\t\tlabel: staff.name,\r\n\t\t\t\t\t}));\r\n\t\t\t\t\toptions.sort((a, b) => a.label.localeCompare(b.label));\r\n\r\n\t\t\t\t\tconst staffIdRow = {\r\n\t\t\t\t\t\tlabel: localize(\"staves.staff\"),\r\n\t\t\t\t\t\tvalue: flags.staffID ?? \"\",\r\n\t\t\t\t\t\torder: 100,\r\n\t\t\t\t\t\toptions,\r\n\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\ttype: \"select\",\r\n\t\t\t\t\t\t\tdaily: type,\r\n\t\t\t\t\t\t\trow: \"staffID\",\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tconst template = {\r\n\t\t\t\t\t\tlabel: localize(\"staves.prepare\"),\r\n\t\t\t\t\t\trows: [staffIdRow],\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tthis._rows[type] = {\r\n\t\t\t\t\t\tstaffID: { save: true },\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tconst preparedEntries =\r\n\t\t\t\t\t\tgetPreparedSpellcastingEntriesForStaves(actor);\r\n\t\t\t\t\tif (preparedEntries.length) {\r\n\t\t\t\t\t\tconst options = [{ value: \"\", label: \"\" }];\r\n\t\t\t\t\t\tconst flexibleLabel = localize(\"staves.flexible\");\r\n\t\t\t\t\t\tconst emptyLabel = localize(\"staves.emty\");\r\n\r\n\t\t\t\t\t\tfor (const entry of preparedEntries) {\r\n\t\t\t\t\t\t\tconst entryId = entry.id;\r\n\r\n\t\t\t\t\t\t\toptions.push({ groupStart: true, label: entry.name });\r\n\r\n\t\t\t\t\t\t\tfor (const spell of entry.spells ?? []) {\r\n\t\t\t\t\t\t\t\tconst name = spell.name ?? emptyLabel;\r\n\t\t\t\t\t\t\t\tconst unique = `${spell.rank}.${spell.index}`;\r\n\t\t\t\t\t\t\t\toptions.push({\r\n\t\t\t\t\t\t\t\t\tvalue: unique,\r\n\t\t\t\t\t\t\t\t\tlabel: `${name} (${utils.spellRankLabel(spell.rank)})`,\r\n\t\t\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\t\t\ttype: \"spell\",\r\n\t\t\t\t\t\t\t\t\t\trank: spell.rank,\r\n\t\t\t\t\t\t\t\t\t\tindex: spell.index,\r\n\t\t\t\t\t\t\t\t\t\tunique: unique,\r\n\t\t\t\t\t\t\t\t\t\tentry: entryId,\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tfor (const slot of entry.slots ?? []) {\r\n\t\t\t\t\t\t\t\tconst rankLabel = utils.spellRankLabel(slot.rank);\r\n\r\n\t\t\t\t\t\t\t\tconst data = {\r\n\t\t\t\t\t\t\t\t\ttype: \"slot\",\r\n\t\t\t\t\t\t\t\t\trank: slot.rank,\r\n\t\t\t\t\t\t\t\t\tentry: entryId,\r\n\t\t\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\t\t\tif (slot.value > 1) {\r\n\t\t\t\t\t\t\t\t\tdata.skipUnique = true;\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tdata.unique = `${entryId}.${slot.rank}`;\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\toptions.push({\r\n\t\t\t\t\t\t\t\t\tvalue: slot.rank,\r\n\t\t\t\t\t\t\t\t\tlabel: `${flexibleLabel} ${slot.value}/${slot.max} (${rankLabel})`,\r\n\t\t\t\t\t\t\t\t\tdata,\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\toptions.push({ groupEnd: true });\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tconst staffNexus = getItemWithSourceId(actor, STAFF_NEXUS, \"feat\");\r\n\t\t\t\t\t\tconst nbExpends =\r\n\t\t\t\t\t\t\tstaffNexus && actor.level >= 8 ? (actor.level >= 16 ? 3 : 2) : 1;\r\n\r\n\t\t\t\t\t\tif (staffNexus) {\r\n\t\t\t\t\t\t\tstaffIdRow.data.makeshift = true;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tfor (let i = 1; i <= nbExpends; i++) {\r\n\t\t\t\t\t\t\ttemplate.rows.push({\r\n\t\t\t\t\t\t\t\tlabel: localize(\"staves.expend\"),\r\n\t\t\t\t\t\t\t\tvalue: \"\",\r\n\t\t\t\t\t\t\t\torder: 100,\r\n\t\t\t\t\t\t\t\toptions,\r\n\t\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\t\ttype: \"select\",\r\n\t\t\t\t\t\t\t\t\tdaily: type,\r\n\t\t\t\t\t\t\t\t\trow: `expend${i}`,\r\n\t\t\t\t\t\t\t\t\tunique: \"expend\",\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tthis._rows[type][`expend${i}`] = { save: false };\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\ttemplates.push(template);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const daily of this._dailies) {\r\n\t\t\ttry {\r\n\t\t\t\tconst template = await getTemplate.call(this, daily);\r\n\t\t\t\ttemplates.push(template);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tlocalize.error(\"error.unexpected\");\r\n\t\t\t\tconsole.error(error);\r\n\t\t\t\tconsole.error(`The error occured during templating of ${daily.key}`);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst rows = [];\r\n\t\tconst groups = [];\r\n\t\tfor (const template of templates) {\r\n\t\t\tif (template.rows.length > 1) groups.push(template);\r\n\t\t\telse if (template.rows.length) rows.push(template);\r\n\t\t}\r\n\r\n\t\trows.sort((a, b) => b.rows[0].order - a.rows[0].order);\r\n\t\tgroups.sort((a, b) => a.rows.length - b.rows.length);\r\n\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\ti18n: localize.template,\r\n\t\t\tdump: ({ value, placeholder, data }) => {\r\n\t\t\t\tlet msg = \"\";\r\n\t\t\t\tif (value) msg += ` value=\"${value}\"`;\r\n\t\t\t\tif (placeholder) msg += ` placeholder=\"${placeholder}\"`;\r\n\t\t\t\tif (typeof data === \"object\") {\r\n\t\t\t\t\tfor (const [key, value] of Object.entries(data)) {\r\n\t\t\t\t\t\tconst formattedKey = key.replace(/[A-Z]/g, (c) => `-${c}`);\r\n\t\t\t\t\t\tmsg += ` data-${formattedKey}=\"${value}\"`;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (msg) msg += \" \";\r\n\t\t\t\treturn msg;\r\n\t\t\t},\r\n\t\t\trows,\r\n\t\t\tgroups,\r\n\t\t\thasDailies: rows.length || groups.length,\r\n\t\t});\r\n\t}\r\n\r\n\trender(force, options) {\r\n\t\tif (this._randomInterval) clearInterval(this._randomInterval);\r\n\r\n\t\tif (this.element.find(\"select.random\")) {\r\n\t\t\tthis._randomInterval = setInterval(() => {\r\n\t\t\t\tconst randoms = this.element.find(\"select.random\");\r\n\t\t\t\trandoms.each((_, select) => {\r\n\t\t\t\t\tselect.selectedIndex =\r\n\t\t\t\t\t\t(select.selectedIndex + 1) % select.options.length;\r\n\t\t\t\t});\r\n\t\t\t}, 2000);\r\n\t\t}\r\n\r\n\t\treturn super.render(force, options);\r\n\t}\r\n\r\n\tclose(options) {\r\n\t\tif (this._randomInterval) clearInterval(this._randomInterval);\r\n\t\treturn super.close(options);\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tsuper.activateListeners(html);\r\n\r\n\t\thtml.find(\"[data-action=clear]\").on(\"click\", this.#onClear.bind(this));\r\n\t\thtml.find(\"[data-action=accept]\").on(\"click\", this.#onAccept.bind(this));\r\n\t\thtml.find(\"[data-action=cancel]\").on(\"click\", this.#onCancel.bind(this));\r\n\r\n\t\thtml\r\n\t\t\t.find(\".combo select\")\r\n\t\t\t.on(\"change\", this.#onComboSelectChange.bind(this));\r\n\t\thtml.find(\".combo input\").on(\"change\", this.#onComboInputChange.bind(this));\r\n\r\n\t\thtml.find(\"[data-action=search]\").on(\"click\", this.#onSearch.bind(this));\r\n\r\n\t\thtml.find(\"[data-action=alert]\").on(\"click\", this.#onAlert.bind(this));\r\n\r\n\t\tconst uniqueSelects = html.find(\"select[data-unique]\");\r\n\t\tuniqueSelects.on(\"change\", (event) =>\r\n\t\t\tthis.#cleanUniqueSelects(event.currentTarget, true),\r\n\t\t);\r\n\t\t{\r\n\t\t\tconst processedUniques = [];\r\n\r\n\t\t\tfor (const select of uniqueSelects) {\r\n\t\t\t\tconst { unique, daily } = select.dataset;\r\n\t\t\t\tconst uniqueTag = `${daily}.${unique}`;\r\n\t\t\t\tif (processedUniques.includes(uniqueTag)) continue;\r\n\r\n\t\t\t\tprocessedUniques.push(uniqueTag);\r\n\t\t\t\tthis.#cleanUniqueSelects(select, false);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t_canDragDrop(selector) {\r\n\t\treturn true;\r\n\t}\r\n\r\n\tasync _onDrop(event) {\r\n\t\tconst localize = subLocalize(\"interface.error.drop\");\r\n\t\tlet target = event.target;\r\n\t\tif (target instanceof HTMLLabelElement) target = target.nextElementSibling;\r\n\r\n\t\ttry {\r\n\t\t\tconst dataString = event.dataTransfer?.getData(\"text/plain\");\r\n\t\t\tconst data = JSON.parse(dataString);\r\n\r\n\t\t\tif (!data || data.type !== \"Item\" || typeof data.uuid !== \"string\")\r\n\t\t\t\treturn localize.warn(\"wrongDataType\");\r\n\r\n\t\t\tconst item = await fromUuid(data.uuid);\r\n\t\t\tif (!item) return localize.warn(\"wrongDataType\");\r\n\r\n\t\t\tconst filter = await this.#getfilterFromElement(target);\r\n\t\t\tif (!filter) return onDropItem(item, target);\r\n\r\n\t\t\tif (filter.type === \"feat\") onDropFeat.call(this, item, target, filter);\r\n\t\t\telse if (filter.type === \"spell\")\r\n\t\t\t\tonDropSpell.call(this, item, target, filter);\r\n\t\t\telse onDropItem(item, target);\r\n\t\t} catch (error) {\r\n\t\t\tlocalize.error(\"error.unexpected\");\r\n\t\t\tconsole.error(error);\r\n\t\t\tconsole.error(\"The error occured during _onDrop\");\r\n\t\t}\r\n\t}\r\n\r\n\tasync #onAlert(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.#lock();\r\n\r\n\t\tconst data = event.currentTarget.dataset;\r\n\t\tconst row = this.rows[data.daily][data.row];\r\n\t\tconst args = this.dailyArgs[data.daily];\r\n\r\n\t\tlet fixed;\r\n\t\ttry {\r\n\t\t\tfixed = await row.fix(args);\r\n\t\t} catch (error) {\r\n\t\t\tlocalize.error(\"error.unexpected\");\r\n\t\t\tconsole.error(error);\r\n\t\t\tconsole.error(`The error occured during an alert fix of '${data.daily}'`);\r\n\t\t}\r\n\r\n\t\tthis.#unlock();\r\n\t\tif (fixed) this.render();\r\n\t}\r\n\r\n\tasync #onSearch(event) {\r\n\t\tevent.preventDefault();\r\n\t\tconst filter = await this.#getfilterFromElement(event.currentTarget, true);\r\n\t\tif (filter) game.pf2e.compendiumBrowser.openTab(filter.type, filter.search);\r\n\t\telse game.pf2e.compendiumBrowser.render(true);\r\n\t}\r\n\r\n\tasync #getfilterFromElement(element, parsed) {\r\n\t\tconst { daily, row } = element.dataset;\r\n\t\tconst filter = this.rows[daily]?.[row]?.filter;\r\n\t\tconst args = this.dailyArgs[daily];\r\n\r\n\t\tif (!args || !filter) return;\r\n\r\n\t\tif (typeof filter.search === \"function\")\r\n\t\t\tfilter.search = await filter.search(args);\r\n\r\n\t\tif (!parsed) return filter;\r\n\r\n\t\treturn parseFilter.call(this, filter);\r\n\t}\r\n\r\n\t#onComboSelectChange(event) {\r\n\t\tconst select = event.currentTarget;\r\n\t\tconst input = select.nextElementSibling;\r\n\t\tinput.dataset.input = \"false\";\r\n\t\tinput.value = select.options[select.selectedIndex].text;\r\n\t}\r\n\r\n\t#onComboInputChange(event) {\r\n\t\tconst input = event.currentTarget;\r\n\t\tconst select = input.previousElementSibling;\r\n\t\tconst value = input.value.toLowerCase();\r\n\t\tconst options = Array.from(select.options).map((x) => x.value);\r\n\r\n\t\tconst index = options.indexOf(value);\r\n\t\tif (index !== -1) {\r\n\t\t\tselect.value = value;\r\n\t\t\tinput.value = select.options[index].text;\r\n\t\t\tinput.dataset.input = \"false\";\r\n\t\t} else {\r\n\t\t\tselect.value = \"\";\r\n\t\t\tinput.dataset.input = \"true\";\r\n\t\t}\r\n\t}\r\n\r\n\t#lock() {\r\n\t\tthis.element.addClass(\"disabled\");\r\n\t}\r\n\r\n\t#unlock() {\r\n\t\tthis.element.removeClass(\"disabled\");\r\n\t}\r\n\r\n\t#validate() {\r\n\t\tconst warns = [];\r\n\t\tconst html = this.element;\r\n\r\n\t\tconst emptyInputs = html.find(\"input\").filter((_, input) => !input.value);\r\n\t\tconst alertInputs = html.find(\"input.alert\");\r\n\r\n\t\tif (emptyInputs.length) warns.push(\"error.empty\");\r\n\t\tif (alertInputs.length) warns.push(\"error.unattended\");\r\n\r\n\t\thtml.find(\"label\").removeClass(\"empty\");\r\n\r\n\t\tfor (const input of emptyInputs) {\r\n\t\t\tconst parent = input.parentElement;\r\n\t\t\tconst target = parent.classList.contains(\"combo\") ? parent : input;\r\n\t\t\ttarget.previousElementSibling.classList.add(\"empty\");\r\n\t\t}\r\n\r\n\t\tfor (const warning of warns) {\r\n\t\t\tlocalize.warn(warning);\r\n\t\t}\r\n\r\n\t\treturn !warns.length;\r\n\t}\r\n\r\n\tasync #onAccept(event) {\r\n\t\tevent.preventDefault();\r\n\t\tif (!this.#validate()) return;\r\n\r\n\t\tthis.#lock();\r\n\r\n\t\tawait processData.call(this);\r\n\r\n\t\tif (this._message) {\r\n\t\t\tsetFlag(this._message, \"prepared\", true);\r\n\t\t}\r\n\r\n\t\tthis.close();\r\n\t}\r\n\r\n\t#onClear(event) {\r\n\t\tevent.preventDefault();\r\n\t\tconst target = $(event.currentTarget);\r\n\t\tconst input = target.prevAll(\"input\").first();\r\n\t\tinput.val(\"\");\r\n\t\tinput.attr(\"value\", \"\");\r\n\t\tinput.attr(\"data-uuid\", \"\");\r\n\t\ttarget.addClass(\"disabled\");\r\n\t}\r\n\r\n\t#onCancel(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.close();\r\n\t}\r\n\r\n\t#cleanUniqueSelects(select, isTarget) {\r\n\t\tconst uniqueTag = select.dataset.unique;\r\n\t\tconst children = isTarget\r\n\t\t\t? [select, ...getSiblings(select, `select[data-unique=\"${uniqueTag}\"]`)]\r\n\t\t\t: select.parentElement.querySelectorAll(\r\n\t\t\t\t\t`:scope > select[data-unique=\"${uniqueTag}\"]`,\r\n\t\t\t  );\r\n\r\n\t\tconst uniqueOptions = new Set();\r\n\r\n\t\tfor (const child of children) {\r\n\t\t\tlet childIndex = child.selectedIndex;\r\n\t\t\tconst childOptions = child.options;\r\n\r\n\t\t\tconst optionUniqueValue = () => {\r\n\t\t\t\tconst option = childOptions[childIndex];\r\n\t\t\t\treturn option.dataset.skipUnique\r\n\t\t\t\t\t? undefined\r\n\t\t\t\t\t: option.dataset.unique ?? option.value;\r\n\t\t\t};\r\n\r\n\t\t\tconst optionExists = () => {\r\n\t\t\t\tconst value = optionUniqueValue();\r\n\t\t\t\treturn value && uniqueOptions.has(value);\r\n\t\t\t};\r\n\r\n\t\t\twhile (optionExists() && childIndex > 0) {\r\n\t\t\t\tchildIndex -= 1;\r\n\t\t\t}\r\n\r\n\t\t\tconst maxIndex = child.options.length - 1;\r\n\t\t\twhile (optionExists() && childIndex < maxIndex) {\r\n\t\t\t\tchildIndex += 1;\r\n\t\t\t}\r\n\r\n\t\t\tif (optionExists()) continue;\r\n\r\n\t\t\tconst finalValue = optionUniqueValue();\r\n\t\t\tif (finalValue) uniqueOptions.add(finalValue);\r\n\r\n\t\t\tif (child.selectedIndex !== childIndex) {\r\n\t\t\t\tchild.selectedIndex = childIndex;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const child of children) {\r\n\t\t\tconst childIndex = child.selectedIndex;\r\n\t\t\tconst childOptions = child.options;\r\n\r\n\t\t\tfor (let index = 0; index < childOptions.length; index++) {\r\n\t\t\t\tif (index === childIndex) continue;\r\n\r\n\t\t\t\tconst option = childOptions[index];\r\n\t\t\t\toption.disabled = uniqueOptions.has(\r\n\t\t\t\t\toption.dataset.unique ?? option.value,\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction getSiblings(el, selector) {\r\n\tconst siblings = [];\r\n\r\n\tconst parent = el.parentElement;\r\n\tif (!parent) return siblings;\r\n\r\n\tconst children = selector\r\n\t\t? parent.querySelectorAll(`:scope > ${selector}`)\r\n\t\t: parent.children;\r\n\tfor (const child of children) {\r\n\t\tif (child === el) continue;\r\n\t\tsiblings.push(child);\r\n\t}\r\n\r\n\treturn siblings;\r\n}\r\n", "import {\r\n\tcapitalize,\r\n\tcreateConsumableFromSpell,\r\n\tgetSetting,\r\n\tlocalize,\r\n\tordinalString,\r\n\tsequenceArray,\r\n} from \"module-api\";\r\nimport { canPrepDailies } from \"./actor\";\r\nimport { DailiesInterface } from \"./apps/interface\";\r\n\r\nconst halfLevelString = \"max(1,floor(@actor.level/2))\";\r\n\r\nconst RUNE_PROPERTY_KEYS = [\r\n\t\"propertyRune1\",\r\n\t\"propertyRune2\",\r\n\t\"propertyRune3\",\r\n\t\"propertyRune4\",\r\n];\r\n\r\nlet SKILLNAMES;\r\nlet LANGUAGES;\r\n\r\nexport const utils = {\r\n\t// Skills\r\n\tget skillNames() {\r\n\t\tSKILLNAMES ??= Object.keys(CONFIG.PF2E.skillList).filter(\r\n\t\t\t(skill) => skill !== \"lore\",\r\n\t\t);\r\n\t\treturn SKILLNAMES.slice();\r\n\t},\r\n\tskillLabel: (skill) => {\r\n\t\treturn game.i18n.localize(CONFIG.PF2E.skillList[skill]);\r\n\t},\r\n\tcreateSkillRuleElement: ({ skill, value, mode = \"upgrade\", predicate }) => {\r\n\t\tconst rule = {\r\n\t\t\tkey: \"ActiveEffectLike\",\r\n\t\t\tmode,\r\n\t\t\tpath: `system.skills.${skill}.rank`,\r\n\t\t\tvalue,\r\n\t\t};\r\n\t\tif (predicate?.length) rule.predicate = predicate;\r\n\t\treturn rule;\r\n\t},\r\n\tcreateLoreSource: ({ name, rank }) => {\r\n\t\tconst data = {\r\n\t\t\ttype: \"lore\",\r\n\t\t\timg: \"systems/pf2e/icons/default-icons/lore.svg\",\r\n\t\t\tname,\r\n\t\t\tsystem: { proficient: { value: rank } },\r\n\t\t};\r\n\t\treturn data;\r\n\t},\r\n\tgetTranslatedSkills: (lowercase = false) => {\r\n\t\treturn Object.entries(CONFIG.PF2E.skillList).reduce(\r\n\t\t\t(result, [key, value]) => {\r\n\t\t\t\tconst localized = game.i18n.localize(value);\r\n\t\t\t\tresult[key] = lowercase\r\n\t\t\t\t\t? localized.toLocaleLowerCase(game.i18n.lang)\r\n\t\t\t\t\t: localized;\r\n\t\t\t\treturn result;\r\n\t\t\t},\r\n\t\t\t{},\r\n\t\t);\r\n\t},\r\n\t// Languages\r\n\tget languageNames() {\r\n\t\tLANGUAGES ??= Object.keys(CONFIG.PF2E.languages);\r\n\t\treturn LANGUAGES.slice();\r\n\t},\r\n\tlanguageLabel: (language) => {\r\n\t\treturn game.i18n.localize(CONFIG.PF2E.languages[language]);\r\n\t},\r\n\tcreateLanguageRuleElement: ({ language, mode = \"add\", predicate }) => {\r\n\t\tconst rule = {\r\n\t\t\tkey: \"ActiveEffectLike\",\r\n\t\t\tmode,\r\n\t\t\tpath: \"system.build.languages.granted\",\r\n\t\t\tvalue: {\r\n\t\t\t\tslug: language,\r\n\t\t\t\tsource: \"{item|name}\",\r\n\t\t\t},\r\n\t\t};\r\n\t\tif (predicate?.length) rule.predicate = predicate;\r\n\t\treturn rule;\r\n\t},\r\n\t// resistances\r\n\tresistanceLabel: (resistance, value) => {\r\n\t\tlet str = game.i18n.localize(`PF2E.Trait${capitalize(resistance)}`);\r\n\t\tif (value) str += ` ${value}`;\r\n\t\treturn str;\r\n\t},\r\n\tcreateResistanceRuleElement: ({ type, value, predicate }) => {\r\n\t\tif (value === \"half\") value = halfLevelString;\r\n\t\tconst rule = {\r\n\t\t\tkey: \"Resistance\",\r\n\t\t\ttype,\r\n\t\t\tvalue,\r\n\t\t};\r\n\t\tif (predicate?.length) rule.predicate = predicate;\r\n\t\treturn rule;\r\n\t},\r\n\t// feats\r\n\tcreateFeatSource: async (uuid) => {\r\n\t\tconst source = (await fromUuid(uuid))?.toObject();\r\n\t\tif (!source)\r\n\t\t\tthrow new Error(\r\n\t\t\t\t`An error occured while trying to create a feat source with uuid: ${uuid}`,\r\n\t\t\t);\r\n\t\treturn source;\r\n\t},\r\n\t// spells\r\n\tcreateSpellScrollSource: async (options) => {\r\n\t\treturn createSpellConsumableSource(\"scroll\", options);\r\n\t},\r\n\tcreateWandSource: async (options) => {\r\n\t\treturn createSpellConsumableSource(\"wand\", options);\r\n\t},\r\n\tcreateSpellSource: async (uuid) => {\r\n\t\tconst source = (await fromUuid(uuid))?.toObject();\r\n\t\tif (!source)\r\n\t\t\tthrow new Error(\r\n\t\t\t\t`An error occured while trying to create a spell source with uuid: ${uuid}`,\r\n\t\t\t);\r\n\t\treturn source;\r\n\t},\r\n\tspellRankLabel: (rank) => {\r\n\t\treturn game.i18n.format(\"PF2E.Item.Spell.Rank.Ordinal\", {\r\n\t\t\trank: ordinalString(rank),\r\n\t\t});\r\n\t},\r\n\t// Rule Elements\r\n\tget halfLevelString() {\r\n\t\treturn halfLevelString;\r\n\t},\r\n\tgetChoiSetRuleSelection: (item, option) => {\r\n\t\tconst rules = item._source.system.rules;\r\n\t\tconst rule = rules.find(\r\n\t\t\t(rule) =>\r\n\t\t\t\trule.key === \"ChoiceSet\" && (!option || rule.rollOption === option),\r\n\t\t);\r\n\t\treturn rule?.selection;\r\n\t},\r\n\t//\r\n\tproficiencyLabel: (rank) => {\r\n\t\treturn game.i18n.localize(CONFIG.PF2E.proficiencyLevels[rank]);\r\n\t},\r\n\trandomOption: async (options) => {\r\n\t\tconst roll = (\r\n\t\t\tawait new Roll(`1d${options.length}`).evaluate({ async: true })\r\n\t\t).total;\r\n\t\tconst result = options[roll - 1];\r\n\t\tif (typeof result === \"string\") return result;\r\n\t\treturn result.value;\r\n\t},\r\n\thalfLevelValue: (actor) => Math.max(1, Math.floor(actor.level / 2)),\r\n\tsequenceArray,\r\n\t// equipment\r\n\tdamageLabel: (damage) => {\r\n\t\treturn game.i18n.localize(CONFIG.PF2E.damageTypes[damage]);\r\n\t},\r\n\tweaponTraitLabel: (trait) => {\r\n\t\treturn game.i18n.localize(CONFIG.PF2E.weaponTraits[trait]);\r\n\t},\r\n\tweaponPropertyRunesLabel: (rune) => {\r\n\t\tconst key = `PF2E.WeaponPropertyRune.${rune}.Name`;\r\n\t\treturn game.i18n.localize(key);\r\n\t},\r\n\thasFreePropertySlot: (item) => {\r\n\t\tconst potency = item.system.runes.potency;\r\n\t\treturn potency > 0 && item.system.runes.property.length < potency;\r\n\t},\r\n\tgetFreePropertyRuneSlot: (item) => {\r\n\t\tconst potency = item.system.potencyRune.value;\r\n\t\tif (potency === null) return null;\r\n\r\n\t\tfor (let i = 0; i < potency; i++) {\r\n\t\t\tconst property = RUNE_PROPERTY_KEYS[i];\r\n\t\t\tif (!item.system[property].value) return property;\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t},\r\n\t// actor\r\n\tgetPlayersActors: (member, ...types) => {\r\n\t\tconst actorTypes = types.length ? types : [\"creature\"];\r\n\t\tconst memberIsActor = member instanceof Actor;\r\n\r\n\t\tlet actors = game.actors;\r\n\r\n\t\tif (memberIsActor && member.parties.size && getSetting(\"members\")) {\r\n\t\t\tactors = Array.from(member.parties ?? []).flatMap((p) => p.members);\r\n\t\t\tactors = Array.from(new Set(actors));\r\n\t\t} else {\r\n\t\t\tactors = actors.filter((a) => a.hasPlayerOwner);\r\n\t\t}\r\n\r\n\t\treturn actors.filter(\r\n\t\t\t(a) => a.isOfType(...actorTypes) && (!memberIsActor || a !== member),\r\n\t\t);\r\n\t},\r\n};\r\n\r\nasync function createSpellConsumableSource(\r\n\ttype,\r\n\t{ uuid, level, itemName, itemImg },\r\n) {\r\n\tconst spell = await fromUuid(uuid);\r\n\tif (!spell) {\r\n\t\tthrow new Error(\r\n\t\t\t`An error occured while trying to create a spell scroll source with uuid: ${uuid}`,\r\n\t\t);\r\n\t}\r\n\treturn createConsumableFromSpell(spell, {\r\n\t\ttype,\r\n\t\theightenedLevel: level,\r\n\t\ttemp: true,\r\n\t\titemName,\r\n\t\titemImg,\r\n\t});\r\n}\r\n\r\nexport function openDailiesInterface(character, message) {\r\n\tlet actor = character;\r\n\r\n\tif (!actor || !actor.isOfType(\"character\") || !actor.isOwner) {\r\n\t\tconst controlled = canvas.tokens.controlled;\r\n\t\tactor = controlled.find(\r\n\t\t\t(token) => token.actor?.isOfType(\"character\") && token.actor.isOwner,\r\n\t\t)?.actor;\r\n\t\tif (!actor) actor = game.user.character;\r\n\t}\r\n\r\n\tif (!actor || !actor.isOfType(\"character\") || !actor.isOwner)\r\n\t\treturn warn(\"error.noCharacterSelected\");\r\n\r\n\tif (!canPrepDailies(actor)) return warn(\"error.unrested\");\r\n\r\n\tnew DailiesInterface(\r\n\t\tactor,\r\n\t\t{\r\n\t\t\ttitle: localize(\"interface.title\", { name: actor.name }),\r\n\t\t},\r\n\t\tmessage,\r\n\t).render(true);\r\n}\r\n\r\nexport function createUpdateCollection() {\r\n\tconst collection = new Collection();\r\n\treturn [\r\n\t\tcollection,\r\n\t\t(data) => {\r\n\t\t\tconst id = data._id;\r\n\t\t\tif (!id) return;\r\n\t\t\tconst update = collection.get(id) ?? {};\r\n\t\t\tcollection.set(id, mergeObject(update, data));\r\n\t\t},\r\n\t];\r\n}\r\n", "import { getFlag, itemIsOfType, localize } from \"module-api\";\r\nimport { openDailiesInterface } from \"./api\";\r\nimport {\r\n\tgetSpellcastingEntryStaffData,\r\n\tisPF2eStavesActive,\r\n\tupdateEntryCharges,\r\n} from \"./data/staves\";\r\n\r\nexport async function performDailyCrafting() {\r\n\tconst entries = (await this.getCraftingEntries()).filter(\r\n\t\t(e) => e.isDailyPrep,\r\n\t);\r\n\tconst alchemicalEntries = entries.filter((e) => e.isAlchemical);\r\n\tconst reagentCost = alchemicalEntries.reduce(\r\n\t\t(sum, entry) => sum + entry.reagentCost,\r\n\t\t0,\r\n\t);\r\n\tconst reagentValue =\r\n\t\t(this.system.resources.crafting.infusedReagents.value || 0) - reagentCost;\r\n\tif (reagentValue < 0) {\r\n\t\tui.notifications.warn(\r\n\t\t\tgame.i18n.localize(\"PF2E.CraftingTab.Alerts.MissingReagents\"),\r\n\t\t);\r\n\t\treturn;\r\n\t}\r\n\r\n\tawait this.update({\r\n\t\t\"system.resources.crafting.infusedReagents.value\": reagentValue,\r\n\t});\r\n\tconst key =\r\n\t\treagentCost === 0\r\n\t\t\t? \"ZeroConsumed\"\r\n\t\t\t: reagentCost === 1\r\n\t\t\t  ? \"OneConsumed\"\r\n\t\t\t  : \"NConsumed\";\r\n\tui.notifications.info(\r\n\t\tgame.i18n.format(`PF2E.Actor.Character.Crafting.Daily.Complete.${key}`, {\r\n\t\t\tquantity: reagentCost,\r\n\t\t}),\r\n\t);\r\n\r\n\t// // Remove infused/temp items\r\n\t// for (const item of this.inventory) {\r\n\t// \tif (item.system.temporary) await item.delete();\r\n\t// }\r\n\r\n\tfor (const entry of entries) {\r\n\t\tfor (const formula of entry.preparedCraftingFormulas) {\r\n\t\t\tconst itemSource = formula.item.toObject();\r\n\t\t\titemSource.system.quantity = formula.quantity;\r\n\t\t\titemSource.system.temporary = true;\r\n\t\t\titemSource.system.size = this.ancestry?.size === \"tiny\" ? \"tiny\" : \"med\";\r\n\r\n\t\t\tif (\r\n\t\t\t\tentry.isAlchemical &&\r\n\t\t\t\titemIsOfType(itemSource, \"consumable\", \"equipment\", \"weapon\")\r\n\t\t\t) {\r\n\t\t\t\titemSource.system.traits.value.push(\"infused\");\r\n\t\t\t}\r\n\t\t\tawait this.addToInventory(itemSource);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function renderCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!actor.isOwner) return;\r\n\r\n\tconst canPrep = canPrepDailies(actor);\r\n\tconst disabledClass = canPrep ? \"\" : \" disabled\";\r\n\tconst tooltip = localize(canPrep ? \"sheet.title\" : \"sheet.unrested\");\r\n\tconst icon = `<a class=\"roll-icon dailies${disabledClass}\" data-tooltip=\"${tooltip}\">\r\n\t<i class=\"fas fa-mug-saucer\"></i>\r\n</a>`;\r\n\r\n\tconst el = html.find(\"aside .sidebar .hitpoints .hp-small\");\r\n\tel.append(icon);\r\n\r\n\tif (canPrep) {\r\n\t\tel.find(\".dailies\").on(\"click\", () => openDailiesInterface(actor));\r\n\t}\r\n\r\n\tif (!isPF2eStavesActive()) renderStavesEntries(html, actor);\r\n}\r\n\r\nfunction renderStavesEntries(html, actor) {\r\n\tconst tab = html.find(\r\n\t\t\".sheet-body .sheet-content [data-tab=spellcasting] [data-tab=known-spells] .spellcastingEntry-list\",\r\n\t);\r\n\tconst entries = tab.find(\"[data-container-type=spellcastingEntry]\");\r\n\r\n\tfor (const el of entries) {\r\n\t\tconst entryId = el.dataset.containerId;\r\n\t\tconst entry = actor.spellcasting.get(entryId);\r\n\t\tconst staffData = getSpellcastingEntryStaffData(entry);\r\n\t\tif (!staffData) continue;\r\n\r\n\t\tconst label = localize(\"staves.label\");\r\n\t\tconst charges = $(\r\n\t\t\t`<div class=\"pf2e-dailies-charges\"><label>${label}</label></div>`,\r\n\t\t);\r\n\r\n\t\tconst input = $(\r\n\t\t\t`<input type=\"number\" min=\"0\" max=\"${staffData.max}\" value=\"${staffData.charges}\">`,\r\n\t\t);\r\n\t\tinput.on(\"change\", (event) => onStaffChargesChange(event, actor));\r\n\r\n\t\tconst reset = $('<a><i class=\"fas fa-redo\"></i></a>');\r\n\t\treset.on(\"click\", (event) => onStaffChargesReset(event, actor));\r\n\r\n\t\tcharges.append(input);\r\n\t\tcharges.append(reset);\r\n\r\n\t\tel.querySelector(\".spell-ability-data .statistic-values\").after(charges[0]);\r\n\r\n\t\tconst spells = el.querySelectorAll(\r\n\t\t\t'.spell-list .spell:not([data-group-id=\"cantrips\"]',\r\n\t\t);\r\n\t\tfor (const spell of spells) {\r\n\t\t\tconst cost = spell.dataset.castRank;\r\n\t\t\tif (staffData.canPayCost(cost)) continue;\r\n\t\t\tspell.dataset.slotExpended = \"\";\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction getEntryDataFromEvent(event, actor) {\r\n\tconst { itemId } = event.currentTarget.closest(\".spellcasting-entry\").dataset;\r\n\treturn actor.spellcasting.get(itemId);\r\n}\r\n\r\nasync function onStaffChargesReset(event, actor) {\r\n\tconst entry = getEntryDataFromEvent(event, actor);\r\n\tupdateEntryCharges(entry, 9999);\r\n}\r\n\r\nasync function onStaffChargesChange(event, actor) {\r\n\tconst entry = getEntryDataFromEvent(event, actor);\r\n\tupdateEntryCharges(entry, event.currentTarget.valueAsNumber);\r\n}\r\n\r\nexport function canPrepDailies(actor) {\r\n\treturn getFlag(actor, \"rested\") !== false;\r\n}\r\n", "export function createFeatDaily(key, uuid, filter, label) {\r\n\tconst daily = {\r\n\t\tkey,\r\n\t\tlabel,\r\n\t\titem: {\r\n\t\t\tuuid,\r\n\t\t},\r\n\t\trows: [\r\n\t\t\t{\r\n\t\t\t\ttype: \"drop\",\r\n\t\t\t\tslug: \"feat\",\r\n\t\t\t\tfilter: {\r\n\t\t\t\t\ttype: \"feat\",\r\n\t\t\t\t\tsearch: filter ?? {},\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t],\r\n\t\tprocess: async ({ utils, fields, addFeat, messages }) => {\r\n\t\t\tconst uuid = fields.feat.uuid;\r\n\t\t\tconst source = await utils.createFeatSource(uuid);\r\n\t\t\taddFeat(source);\r\n\t\t\tmessages.add(\"feats\", { uuid });\r\n\t\t},\r\n\t};\r\n\treturn daily;\r\n}\r\n", "export const flexibility = [\r\n\t\"/** @typedef {'flexibility' | 'improved'} FlexibilityRow */\",\r\n\t\"/** @typedef {'improved'} FlexibilityChild */\",\r\n\t\"/** @typedef {[FlexibilityRow, {}, FlexibilityChild]} FlexibilityGenerics */\",\r\n\t\"\",\r\n\t\"/**\",\r\n\t\" * @param {FlexibilityRow} slug\",\r\n\t\" * @param {number} level\",\r\n\t\" * @param {FlexibilityChild} [child]\",\r\n\t\" */\",\r\n\t\"function createRow(slug, level, child) {\",\r\n\t\"    /** @type {DailyRowDrop<FlexibilityGenerics>} */\",\r\n\t\"    const row = {\",\r\n\t\"        type: 'drop',\",\r\n\t\"        label: `PF2E.Level${level}`,\",\r\n\t\"        slug,\",\r\n\t\"        filter: {\",\r\n\t\"            type: 'feat',\",\r\n\t\"            search: {\",\r\n\t\"                category: ['class'],\",\r\n\t\"                traits: {\",\r\n\t\"                    values: ['fighter'],\",\r\n\t\"                },\",\r\n\t\"                level,\",\r\n\t\"            },\",\r\n\t\"        },\",\r\n\t\"    }\",\r\n\t\"    if (child) row.childPredicate = [child]\",\r\n\t\"    return row\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"/** @type {Daily<FlexibilityGenerics>} */\",\r\n\t\"const combatFlexibility = {\",\r\n\t\"    key: 'flexibility',\",\r\n\t\"    item: {\",\r\n\t\"        uuid: 'Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8', // Combat Flexibility\",\r\n\t\"    },\",\r\n\t\"    children: [\",\r\n\t\"        {\",\r\n\t\"            slug: 'improved',\",\r\n\t\"            uuid: 'Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX', // Improved Flexibility\",\r\n\t\"        },\",\r\n\t\"    ],\",\r\n\t\"    rows: [\",\r\n\t\"        createRow('flexibility', 8), //\",\r\n\t\"        createRow('improved', 14, 'improved'),\",\r\n\t\"    ],\",\r\n\t\"    process: async ({ utils, fields, addFeat, messages, children }) => {\",\r\n\t\"        const uuid = fields.flexibility.uuid\",\r\n\t\"        const source = await utils.createFeatSource(uuid)\",\r\n\t\"        addFeat(source)\",\r\n\t\"        messages.add('feats', { uuid })\",\r\n\t\"\",\r\n\t\"        if (children.improved) {\",\r\n\t\"            const uuid = fields.improved.uuid\",\r\n\t\"            const source = await utils.createFeatSource(uuid)\",\r\n\t\"            addFeat(source, children.improved)\",\r\n\t\"            messages.add('feats', { uuid })\",\r\n\t\"        }\",\r\n\t\"    },\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"return combatFlexibility\",\r\n].join(\"\\n\");\r\n", "export const mind = [\r\n\t\"/** @typedef {'alert' | 'smith' | 'mental' | 'runic' | 'advanced'} MindRow */\",\r\n\t\"/** @typedef {'weapon' | 'mental' | 'runic' | 'advanced'} MindChild */\",\r\n\t\"/** @typedef {[MindRow, {}, MindChild]} MindGenerics */\",\r\n\t\"\",\r\n\t\"const MIND_WEAPON_UUID = 'Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P'\",\r\n\t\"\",\r\n\t\"const WEAPON_BASE_TYPES = {\",\r\n\t\"    0: { die: 'd4', traits: ['finesse', 'agile'], usage: 'held-in-one-hand' },\",\r\n\t\"    1: { die: 'd6', traits: ['finesse'], usage: 'held-in-one-hand' },\",\r\n\t\"    2: { die: 'd8', traits: [], usage: 'held-in-one-hand' },\",\r\n\t\"    3: { die: 'd10', traits: ['reach'], usage: 'held-in-two-hands' },\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"const WEAPON_GROUPS = /** @type {Record<WeaponDamage, string>} */ {\",\r\n\t\"    slashing: 'sword',\",\r\n\t\"    piercing: 'spear',\",\r\n\t\"    bludgeoning: 'club',\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"const WEAPON_TRAITS = ['grapple', 'nonlethal', 'shove', 'trip', 'modular']\",\r\n\t\"\",\r\n\t\"const WEAPON_DAMAGE_TYPES = Object.keys(WEAPON_GROUPS)\",\r\n\t\"\",\r\n\t\"const WEAPON_RUNES = ['corrosive', 'disrupting', 'flaming', 'frost', 'shock', 'thundering']\",\r\n\t\"\",\r\n\t\"const WEAPON_GREATER_RUNES = [\",\r\n\t\"    'anarchic',\",\r\n\t\"    'axiomatic',\",\r\n\t\"    'greaterCorrosive',\",\r\n\t\"    'greaterDisrupting',\",\r\n\t\"    'greaterFlaming',\",\r\n\t\"    'greaterFrost',\",\r\n\t\"    'greaterShock',\",\r\n\t\"    'greaterThundering',\",\r\n\t\"    'holy',\",\r\n\t\"    'unholy',\",\r\n\t\"]\",\r\n\t\"\",\r\n\t\"/** @type {Daily<MindGenerics>} */\",\r\n\t\"const mindSmith = {\",\r\n\t\"    key: 'mindsmith',\",\r\n\t\"    item: {\",\r\n\t\"        uuid: 'Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY', // Mind Smith Dedication\",\r\n\t\"    },\",\r\n\t\"    children: [\",\r\n\t\"        {\",\r\n\t\"            slug: 'weapon',\",\r\n\t\"            uuid: MIND_WEAPON_UUID, // Mind Weapon\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            slug: 'mental',\",\r\n\t\"            uuid: 'Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky', // Malleable Mental Forge\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            slug: 'runic',\",\r\n\t\"            uuid: 'Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp', // Runic Mind Smithing\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            slug: 'advanced',\",\r\n\t\"            uuid: 'Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD', // Advanced Runic Mind Smithing\",\r\n\t\"        },\",\r\n\t\"    ],\",\r\n\t\"    rows: [\",\r\n\t\"        {\",\r\n\t\"            type: 'alert',\",\r\n\t\"            slug: 'alert',\",\r\n\t\"            message: 'Missing Mind Weapon',\",\r\n\t\"            fix,\",\r\n\t\"            childPredicate: [{ not: 'weapon' }],\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            type: 'select',\",\r\n\t\"            slug: 'smith',\",\r\n\t\"            label: 'Mind Smith',\",\r\n\t\"            options: WEAPON_DAMAGE_TYPES,\",\r\n\t\"            labelizer: ({ utils }) => utils.damageLabel,\",\r\n\t\"            childPredicate: ['weapon'],\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            type: 'select',\",\r\n\t\"            slug: 'mental',\",\r\n\t\"            label: 'Mental Forge',\",\r\n\t\"            options: WEAPON_TRAITS,\",\r\n\t\"            labelizer: ({ utils }) => utils.weaponTraitLabel,\",\r\n\t\"            childPredicate: ['weapon', 'mental'],\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            type: 'select',\",\r\n\t\"            slug: 'runic',\",\r\n\t\"            label: 'Runic Smithing',\",\r\n\t\"            options: WEAPON_RUNES,\",\r\n\t\"            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,\",\r\n\t\"            childPredicate: ['weapon', 'runic', { not: 'advanced' }],\",\r\n\t\"            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            type: 'select',\",\r\n\t\"            slug: 'advanced',\",\r\n\t\"            label: 'Runic Smithing',\",\r\n\t\"            options: WEAPON_GREATER_RUNES,\",\r\n\t\"            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,\",\r\n\t\"            childPredicate: ['weapon', 'advanced'],\",\r\n\t\"            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),\",\r\n\t\"        },\",\r\n\t\"    ],\",\r\n\t\"    process: ({ children, updateItem, fields, messages, item, utils }) => {\",\r\n\t\"        const weapon = children.weapon\",\r\n\t\"        if (!weapon) return\",\r\n\t\"\",\r\n\t\"        messages.addGroup('mindsmith')\",\r\n\t\"\",\r\n\t\"        const selected = /** @type {WeaponDamage} */ fields.smith.value\",\r\n\t\"        updateItem({ _id: weapon.id, 'system.damage.damageType': selected, 'system.group': WEAPON_GROUPS[selected] })\",\r\n\t\"        messages.add('mindsmith', { selected: utils.damageLabel(selected), uuid: item.uuid, label: 'mindsmith' })\",\r\n\t\"\",\r\n\t\"        if (children.mental) {\",\r\n\t\"            const selected = fields.mental.value\",\r\n\t\"            const traits = deepClone(weapon._source.system.traits?.value ?? [])\",\r\n\t\"            if (!traits.includes(selected)) traits.push(selected)\",\r\n\t\"            updateItem({ _id: weapon.id, 'system.traits.value': traits })\",\r\n\t\"            messages.add('mindsmith', {\",\r\n\t\"                selected: utils.weaponTraitLabel(selected),\",\r\n\t\"                uuid: children.mental.uuid,\",\r\n\t\"                label: 'mentalforge',\",\r\n\t\"            })\",\r\n\t\"        }\",\r\n\t\"\",\r\n\t\"        if ((children.advanced || children.runic) && utils.hasFreePropertySlot(weapon)) {\",\r\n\t\"            const child = children.advanced ?? children.runic\",\r\n\t\"            const freeSlot = utils.getFreePropertyRuneSlot(weapon)\",\r\n\t\"            const field = fields.advanced ?? fields.runic\",\r\n\t\"            const selected = field.value\",\r\n\t\"\",\r\n\t\"            if (!weapon.system.runes.property.includes(selected)) {\",\r\n\t\"                updateItem({ _id: weapon.id, [`system.${freeSlot}.value`]: selected, [`flags.world.runeSlot`]: freeSlot })\",\r\n\t\"                messages.add('mindsmith', {\",\r\n\t\"                    selected: utils.weaponPropertyRunesLabel(selected),\",\r\n\t\"                    uuid: child.uuid,\",\r\n\t\"                    label: 'runicmind',\",\r\n\t\"                })\",\r\n\t\"            }\",\r\n\t\"        }\",\r\n\t\"    },\",\r\n\t\"    rest: ({ item, sourceId, updateItem }) => {\",\r\n\t\"        if (sourceId !== MIND_WEAPON_UUID) return\",\r\n\t\"\",\r\n\t\"        let traits = item._source.system.traits?.value ?? []\",\r\n\t\"        traits = traits.filter(trait => !WEAPON_TRAITS.includes(trait))\",\r\n\t\"        updateItem({ _id: item.id, 'system.traits.value': traits })\",\r\n\t\"\",\r\n\t\"        const runeSlot = item.getFlag('world', 'runeSlot')\",\r\n\t\"        if (runeSlot) {\",\r\n\t\"            updateItem({ _id: item.id, [`system.${runeSlot}.value`]: null, [`flags.world.-=runeSlot`]: true })\",\r\n\t\"        }\",\r\n\t\"    },\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"const OPTIONS = {\",\r\n\t\"    0: 'A one-handed weapon that deals <strong>1d4</strong> damage and has the <strong>agile</strong> and <strong>finesse</strong> traits',\",\r\n\t\"    1: 'A one-handed weapon that deals <strong>1d6</strong> damage and has the <strong>finesse</strong> trait',\",\r\n\t\"    2: 'A one-handed weapon that deals <strong>1d8</strong> damage',\",\r\n\t\"    3: 'A two-handed weapon that deals <strong>1d10</strong> damage and has the <strong>reach</strong> trait',\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"/** * @param {DailyValueArgs<MindGenerics>} args */\",\r\n\t\"async function fix({ actor }) {\",\r\n\t\"    let content =\",\r\n\t\"        `<p>This character doesn't have a mind weapon in their inventory.</p><p>Please select one of the following options to create one.</p>`\",\r\n\t\"\",\r\n\t\"    for (const [key, label] of Object.entries(OPTIONS)) {\",\r\n\t\"        content += `<label><input type='radio' name='type' value='${key}'>${label}</label>`\",\r\n\t\"    }\",\r\n\t\"\",\r\n\t\"    const weapon = await Dialog.wait(\",\r\n\t\"        {\",\r\n\t\"            title: 'Mind Weapon',\",\r\n\t\"            content,\",\r\n\t\"            buttons: {\",\r\n\t\"                yes: {\",\r\n\t\"                    icon: `<i class='fas fa-save'></i>`,\",\r\n\t\"                    label: 'Accept',\",\r\n\t\"                    callback: onWeaponSelected,\",\r\n\t\"                },\",\r\n\t\"                no: {\",\r\n\t\"                    icon: `<i class='fas fa-times'></i>`,\",\r\n\t\"                    label: 'Cancel',\",\r\n\t\"                    callback: () => null,\",\r\n\t\"                },\",\r\n\t\"            },\",\r\n\t\"            close: () => null,\",\r\n\t\"        },\",\r\n\t\"        {},\",\r\n\t\"        { id: 'pf2e-dailies-weapon', width: 600 }\",\r\n\t\"    )\",\r\n\t\"\",\r\n\t\"    if (weapon) {\",\r\n\t\"        await actor.createEmbeddedDocuments('Item', [weapon])\",\r\n\t\"        return true\",\r\n\t\"    }\",\r\n\t\"\",\r\n\t\"    return false\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"/** @params {JQuery} html */\",\r\n\t\"async function onWeaponSelected(html) {\",\r\n\t\"    const selection = html.find('[name=type]:checked').val()\",\r\n\t\"    if (!selection) {\",\r\n\t\"        ui.notifications.warn('You must select one weapon base type.')\",\r\n\t\"        return\",\r\n\t\"    }\",\r\n\t\"\",\r\n\t\"    const weapon = (await fromUuid(MIND_WEAPON_UUID))?.toObject()\",\r\n\t\"    if (!weapon) {\",\r\n\t\"        ui.notifications.warn(`The weapon couldn't be found in the compendium.`)\",\r\n\t\"        return\",\r\n\t\"    }\",\r\n\t\"\",\r\n\t\"    const stats = WEAPON_BASE_TYPES[selection]\",\r\n\t\"\",\r\n\t\"    setProperty(weapon, 'system.damage.die', stats.die)\",\r\n\t\"    setProperty(weapon, 'system.traits.value', stats.traits.slice())\",\r\n\t\"    setProperty(weapon, 'system.usage.value', stats.usage)\",\r\n\t\"\",\r\n\t\"    return weapon\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"return mindSmith\",\r\n].join(\"\\n\");\r\n", "export const savant = [\r\n\t\"/** @typedef {'first' | 'second' | 'third' | 'fourth'} SavantRow */\",\r\n\t\"/** @typedef {Record<SavantRow, { level: number; condition: boolean }>} SavantCustom */\",\r\n\t\"/** @typedef {[SavantRow, SavantCustom, '']} SavantGenerics */\",\r\n\t\"\",\r\n\t\"const ROWS = /** @type {const} */ (['first', 'second', 'third', 'fourth'])\",\r\n\t\"\",\r\n\t\"/**\",\r\n\t\" * @param {CharacterPF2e} actor\",\r\n\t\" * @param {MagicTradition} tradition\",\r\n\t\" */\",\r\n\t\"function getSpellcastingTraditionDetails(actor, tradition) {\",\r\n\t\"    let maxSlot = 1\",\r\n\t\"    let maxTradition = 0\",\r\n\t\"\",\r\n\t\"    for (const entry of actor.spellcasting.regular) {\",\r\n\t\"        if ('pf2e-staves' in entry.flags) continue // we skip staff entries\",\r\n\t\"\",\r\n\t\"        const slots = entry.system.slots\",\r\n\t\"        for (const key in slots) {\",\r\n\t\"            const slot = slots[key]\",\r\n\t\"            if (slot.max) maxSlot = Math.max(maxSlot, Number(key.slice(4)))\",\r\n\t\"        }\",\r\n\t\"\",\r\n\t\"        if (entry.tradition === tradition) maxTradition = Math.max(maxTradition, entry.rank)\",\r\n\t\"    }\",\r\n\t\"\",\r\n\t\"    return { maxSlot: Math.min(maxSlot, 10), maxTradition }\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"/** @type {Daily<SavantGenerics>} */\",\r\n\t\"const scrollSavant = {\",\r\n\t\"    key: 'savant',\",\r\n\t\"    item: {\",\r\n\t\"        uuid: 'Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ', // Scroll Savant\",\r\n\t\"    },\",\r\n\t\"    prepare: ({ actor }) => {\",\r\n\t\"        const { maxSlot, maxTradition } = getSpellcastingTraditionDetails(actor, 'arcane')\",\r\n\t\"        return {\",\r\n\t\"            first: { level: maxSlot - 2, condition: true },\",\r\n\t\"            second: { level: maxSlot - 3, condition: true },\",\r\n\t\"            third: { level: maxSlot - 4, condition: maxTradition >= 3 && maxSlot >= 5 },\",\r\n\t\"            fourth: { level: maxSlot - 5, condition: maxTradition >= 4 && maxSlot >= 6 },\",\r\n\t\"        }\",\r\n\t\"    },\",\r\n\t\"    rows: ROWS.map(rowName => {\",\r\n\t\"        /** @type {DailyRowDrop<SavantGenerics>} */\",\r\n\t\"        const row = {\",\r\n\t\"            type: 'drop',\",\r\n\t\"            slug: rowName,\",\r\n\t\"            label: ({ custom }) => `PF2E.SpellLevel${custom[rowName].level}`,\",\r\n\t\"            filter: {\",\r\n\t\"                type: 'spell',\",\r\n\t\"                search: ({ custom }) => ({\",\r\n\t\"                    category: ['spell'],\",\r\n\t\"                    traditions: ['arcane'],\",\r\n\t\"                    level: custom[rowName].level,\",\r\n\t\"                }),\",\r\n\t\"            },\",\r\n\t\"            condition: ({ custom }) => custom[rowName].condition,\",\r\n\t\"        }\",\r\n\t\"        return row\",\r\n\t\"    }),\",\r\n\t\"    process: async ({ utils, fields, custom, addItem, messages }) => {\",\r\n\t\"        for (const field of Object.values(fields)) {\",\r\n\t\"            const uuid = field.uuid\",\r\n\t\"            const source = await utils.createSpellScrollSource({ uuid, level: custom[field.row].level })\",\r\n\t\"            addItem(source)\",\r\n\t\"            messages.add('scrolls', { uuid, label: source.name })\",\r\n\t\"        }\",\r\n\t\"    },\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"return scrollSavant\",\r\n].join(\"\\n\");\r\n", "export const tome = [\r\n\t\"/** @typedef {typeof ROWS[number]} TomeRow */\",\r\n\t\"/** @typedef {'adept' | 'second' | 'intense' | 'paragon'} TomeChild */\",\r\n\t\"/** @typedef {Record<TomeRow, { rank: OneToFour; options: string[] }>} TomeCustom */\",\r\n\t\"/** @typedef {[TomeRow, TomeCustom, TomeChild]} TomeGenerics */\",\r\n\t\"\",\r\n\t\"const ROWS = /** @type {const} */ (['first', 'second'])\",\r\n\t\"\",\r\n\t\"/** @param {'adept' | 'paragon'} option */\",\r\n\t\"function createChildCondition(option) {\",\r\n\t\"    /** @type { BaseDailyConditionFunction<TomeGenerics>} */\",\r\n\t\"    const condition = ({ item, utils }) => {\",\r\n\t\"        return utils.getChoiSetRuleSelection(item, option) === 'tome'\",\r\n\t\"    }\",\r\n\t\"    return condition\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"/** @type {Daily<TomeGenerics>} */\",\r\n\t\"const thaumaturgeTome = {\",\r\n\t\"    key: 'tome',\",\r\n\t\"    item: {\",\r\n\t\"        uuid: 'Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e', // Tome\",\r\n\t\"    },\",\r\n\t\"    children: [\",\r\n\t\"        {\",\r\n\t\"            slug: 'adept',\",\r\n\t\"            uuid: 'Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO', // Implement Adept\",\r\n\t\"            condition: createChildCondition('adept'),\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            slug: 'second',\",\r\n\t\"            uuid: 'Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5', // Second Adept\",\r\n\t\"            condition: createChildCondition('adept'),\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            slug: 'intense',\",\r\n\t\"            uuid: 'Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC', // Intense Implement\",\r\n\t\"        },\",\r\n\t\"        {\",\r\n\t\"            slug: 'paragon',\",\r\n\t\"            uuid: 'Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI', // Implement Paragon\",\r\n\t\"            condition: createChildCondition('paragon'),\",\r\n\t\"        },\",\r\n\t\"    ],\",\r\n\t\"    prepare: ({ utils, actor, children }) => {\",\r\n\t\"        const skillNames = utils.skillNames\",\r\n\t\"        const actorLevel = actor.level\",\r\n\t\"        const actorSkills = /** @type {Record<SkillLongForm, { rank: ZeroToFour }>} */ (actor.skills)\",\r\n\t\"\",\r\n\t\"        /** @type {TomeCustom} */\",\r\n\t\"        const custom = {\",\r\n\t\"            first: { options: [], rank: 1 },\",\r\n\t\"            second: { options: [], rank: 1 },\",\r\n\t\"        }\",\r\n\t\"\",\r\n\t\"        // Implement Paragon\",\r\n\t\"        if (children.paragon) {\",\r\n\t\"            const skills = skillNames.filter(x => actorSkills[x].rank < 4)\",\r\n\t\"            custom.first = { rank: 4, options: skills }\",\r\n\t\"            custom.second = { rank: 4, options: skills }\",\r\n\t\"        }\",\r\n\t\"        // Intense Implement or Second Adept or Implement Adept\",\r\n\t\"        else if (children.intense || children.adept || children.second) {\",\r\n\t\"            const masters = skillNames.filter(x => actorSkills[x].rank < 3)\",\r\n\t\"\",\r\n\t\"            if (actorLevel >= 9) {\",\r\n\t\"                custom.first = { rank: 3, options: masters }\",\r\n\t\"                custom.second = { rank: 3, options: masters }\",\r\n\t\"            } else {\",\r\n\t\"                const experts = skillNames.filter(x => actorSkills[x].rank < 2)\",\r\n\t\"                custom.first = { rank: 2, options: experts }\",\r\n\t\"                custom.second = { rank: 3, options: masters }\",\r\n\t\"            }\",\r\n\t\"        }\",\r\n\t\"        // Tome\",\r\n\t\"        else {\",\r\n\t\"            if (actorLevel >= 5) {\",\r\n\t\"                const experts = skillNames.filter(x => actorSkills[x].rank < 2)\",\r\n\t\"                custom.first = { rank: 2, options: experts }\",\r\n\t\"                custom.second = { rank: 2, options: experts }\",\r\n\t\"            } else if (actorLevel >= 3) {\",\r\n\t\"                const trained = skillNames.filter(x => actorSkills[x].rank < 1)\",\r\n\t\"                const experts = skillNames.filter(x => actorSkills[x].rank < 2)\",\r\n\t\"                custom.first = { rank: 1, options: trained }\",\r\n\t\"                custom.second = { rank: 2, options: experts }\",\r\n\t\"            } else {\",\r\n\t\"                const trained = skillNames.filter(x => actorSkills[x].rank < 1)\",\r\n\t\"                custom.first = { rank: 1, options: trained }\",\r\n\t\"                custom.second = { rank: 1, options: trained }\",\r\n\t\"            }\",\r\n\t\"        }\",\r\n\t\"\",\r\n\t\"        return custom\",\r\n\t\"    },\",\r\n\t\"    rows: ROWS.map(rowName => {\",\r\n\t\"        /** @type {DailyRowCombo<TomeGenerics>} */\",\r\n\t\"        const row = {\",\r\n\t\"            type: 'combo',\",\r\n\t\"            slug: rowName,\",\r\n\t\"            label: ({ custom, utils }) => utils.proficiencyLabel(custom[rowName].rank),\",\r\n\t\"            options: ({ custom }) => custom[rowName].options,\",\r\n\t\"            labelizer: ({ utils }) => utils.skillLabel,\",\r\n\t\"        }\",\r\n\t\"        return row\",\r\n\t\"    }),\",\r\n\t\"    process: ({ custom, fields, utils, messages, addItem, addRule }) => {\",\r\n\t\"        messages.addGroup('tome', 65)\",\r\n\t\"\",\r\n\t\"        for (const rowName of ROWS) {\",\r\n\t\"            const rank = custom[rowName].rank\",\r\n\t\"            let value = fields[rowName].value\",\r\n\t\"\",\r\n\t\"            if (fields[rowName].input === 'true') {\",\r\n\t\"                const source = utils.createLoreSource({ name: value, rank })\",\r\n\t\"                addItem(source)\",\r\n\t\"            } else {\",\r\n\t\"                const source = utils.createSkillRuleElement({ skill: value, value: rank })\",\r\n\t\"                value = utils.skillLabel(value)\",\r\n\t\"                addRule(source)\",\r\n\t\"            }\",\r\n\t\"\",\r\n\t\"            messages.add('tome', { label: utils.proficiencyLabel(rank), selected: value })\",\r\n\t\"        }\",\r\n\t\"    },\",\r\n\t\"}\",\r\n\t\"\",\r\n\t\"return thaumaturgeTome\",\r\n].join(\"\\n\");\r\n", "import {\r\n\tAsyncFunction,\r\n\terror,\r\n\tgetSetting,\r\n\tsetSetting,\r\n\tsubLocalize,\r\n\ttemplatePath,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { createFeatDaily } from \"../data/feat\";\r\nimport { createLanguageDaily } from \"../data/language\";\r\nimport { createResistancelDaily } from \"../data/resistance\";\r\nimport { createTrainedLoreDaily, createTrainedSkillDaily } from \"../data/skill\";\r\nimport { createSpellDaily } from \"../data/spell\";\r\nimport { EXT_VERSION } from \"../main\";\r\nimport { flexibility } from \"./custom/flexibility\";\r\nimport { mind } from \"./custom/mind\";\r\nimport { savant } from \"./custom/savant\";\r\nimport { tome } from \"./custom/tome\";\r\n\r\nconst localize = subLocalize(\"customs\");\r\n\r\nconst TEMPLATES = [\r\n\t\"default\",\r\n\t\"trainedSkill\",\r\n\t\"trainedLore\",\r\n\t\"language\",\r\n\t\"resistance\",\r\n\t\"feat\",\r\n\t\"spell\",\r\n];\r\nconst EXAMPLES = [\"flexibility\", \"savant\", \"tome\", \"mind\"];\r\n\r\nexport class DailyCustoms extends FormApplication {\r\n\tstatic get defaultOptions() {\r\n\t\treturn mergeObject(FormApplication.defaultOptions, {\r\n\t\t\tid: \"pf2e-dailies-customs\",\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\ttemplate: templatePath(\"customs\"),\r\n\t\t\tsubmitOnChange: false,\r\n\t\t\tsubmitOnClose: false,\r\n\t\t\tcloseOnSubmit: false,\r\n\t\t\tscrollY: [\".left .list\"],\r\n\t\t});\r\n\t}\r\n\r\n\tasync _updateObject(event, formData) {}\r\n\r\n\tasync getData(options) {\r\n\t\tconst customs = getSetting(\"customDailies\");\r\n\t\tconst code = customs.find(\r\n\t\t\t(custom) => custom.key === this._selectedDaily,\r\n\t\t)?.code;\r\n\t\tconst template = this._selectedTemplate;\r\n\t\tconst extension = game.modules.get(\"pf2e-dailies-ext\");\r\n\t\tconst newVersion =\r\n\t\t\textension?.active && isNewerVersion(EXT_VERSION, extension.version)\r\n\t\t\t\t? { version: EXT_VERSION }\r\n\t\t\t\t: \"\";\r\n\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\ti18n: localize.template,\r\n\t\t\ttemplate,\r\n\t\t\ttemplates: TEMPLATES,\r\n\t\t\tdaily: this._selectedDaily,\r\n\t\t\tcode,\r\n\t\t\tcustoms,\r\n\t\t\texamples: EXAMPLES,\r\n\t\t\tisExample: EXAMPLES.includes(template),\r\n\t\t\tmonaco: extension?.active,\r\n\t\t\tnewVersion,\r\n\t\t});\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tsuper.activateListeners(html);\r\n\r\n\t\tthis._monaco?.dispose();\r\n\r\n\t\tconst monaco = game.modules.get(\"pf2e-dailies-ext\")?.api;\r\n\t\tconst area = html.find(\".code\")[0];\r\n\t\tif (monaco && area) {\r\n\t\t\tconst element = html.find(\".monaco .placeholder\")[0];\r\n\t\t\tthis._monaco = monaco.createEditor(element, area.value);\r\n\t\t\tthis._monaco.onDidChangeModelContent(\r\n\t\t\t\tdebounce(() => {\r\n\t\t\t\t\tarea.value = this._monaco.getValue();\r\n\t\t\t\t}, 200),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tthis._monaco = null;\r\n\t\t}\r\n\r\n\t\thtml\r\n\t\t\t.find(\"[data-action=select-template]\")\r\n\t\t\t.on(\"change\", this.#onSelectTemplate.bind(this));\r\n\t\thtml\r\n\t\t\t.find(\"[data-action=create-template]\")\r\n\t\t\t.on(\"click\", this.#onCreateTemplate.bind(this));\r\n\t\thtml\r\n\t\t\t.find(\"[data-action=create-daily]\")\r\n\t\t\t.on(\"click\", this.#onCreateDaily.bind(this));\r\n\r\n\t\thtml.find(\".row[data-key]\").on(\"click\", this.#onSelectDaily.bind(this));\r\n\t\thtml\r\n\t\t\t.find(\"[data-action=delete-daily]\")\r\n\t\t\t.on(\"click\", this.#onDeleteDaily.bind(this));\r\n\r\n\t\thtml\r\n\t\t\t.find(\"[data-action=save-code]\")\r\n\t\t\t.on(\"click\", this.#onSaveCode.bind(this));\r\n\t}\r\n\r\n\tget code() {\r\n\t\tconst element = this.form.querySelector(\".window-content .code\");\r\n\t\treturn element?.value;\r\n\t}\r\n\r\n\tasync #onSaveCode(event) {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst code = this.code;\r\n\t\tconst selected = this._selectedDaily;\r\n\r\n\t\tif (!selected || !code) return;\r\n\r\n\t\tconst customs = getSetting(\"customDailies\");\r\n\t\tconst stipped = customs.filter((custom) => custom.key !== selected);\r\n\r\n\t\ttry {\r\n\t\t\tconst fn = new AsyncFunction(code);\r\n\t\t\tconst daily = await fn();\r\n\t\t\tconst key = daily.key;\r\n\r\n\t\t\tif (typeof key !== \"string\") return warn(\"invalidKey\");\r\n\t\t\tif (stipped.find((custom) => custom.key === key))\r\n\t\t\t\treturn warn(\"duplicate\");\r\n\r\n\t\t\tconst index = customs.findIndex((custom) => custom.key === selected);\r\n\t\t\tif (index < 0) return;\r\n\r\n\t\t\tcustoms.splice(index, 1, { key, code });\r\n\t\t\tawait setSetting(\"customDailies\", customs);\r\n\r\n\t\t\tlocalize.info(\"saved\", { daily: key });\r\n\t\t\tthis._selectedDaily = key;\r\n\t\t\tthis.render();\r\n\t\t} catch (err) {\r\n\t\t\terror(\"error.unexpected\");\r\n\t\t\tconsole.error(err);\r\n\t\t\tconsole.error(\r\n\t\t\t\t`The error occured while testing the custom daily ${selected}`,\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tasync #onDeleteDaily(event) {\r\n\t\tevent.preventDefault();\r\n\t\tevent.stopPropagation();\r\n\r\n\t\tconst remove = await Dialog.confirm({\r\n\t\t\ttitle: localize(\"delete.title\"),\r\n\t\t\tcontent: localize(\"delete.content\"),\r\n\t\t});\r\n\r\n\t\tif (!remove) return;\r\n\r\n\t\tconst key = event.currentTarget.dataset.key;\r\n\t\tconst customs = getSetting(\"customDailies\").filter(\r\n\t\t\t(custom) => custom.key !== key,\r\n\t\t);\r\n\r\n\t\tawait setSetting(\"customDailies\", customs);\r\n\t\tlocalize.info(\"deleted\", { daily: key });\r\n\t\tthis.#onCreateDaily();\r\n\t}\r\n\r\n\t#onCreateDaily() {\r\n\t\tthis._selectedDaily = \"\";\r\n\t\tthis._selectedTemplate = \"default\";\r\n\t\tthis.render();\r\n\t}\r\n\r\n\t#onSelectDaily(event) {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tthis._selectedDaily = event.currentTarget.dataset.key;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tasync #onCreateTemplate(event) {\r\n\t\tevent.preventDefault();\r\n\t\tconst template = this._selectedTemplate;\r\n\r\n\t\tconst customs = getSetting(\"customDailies\");\r\n\t\tconst formData = new FormData(this.form);\r\n\t\tconst data = Object.fromEntries(formData);\r\n\t\tconst isExample = EXAMPLES.includes(template);\r\n\t\tlet { key, uuid, label } = data;\r\n\r\n\t\tif (isExample) {\r\n\t\t\tkey = template;\r\n\t\t} else if (!key || !uuid) {\r\n\t\t\treturn localize.warn(\"template.noEmpty\");\r\n\t\t}\r\n\r\n\t\tif (customs.find((custom) => custom.key === key))\r\n\t\t\treturn warn(\"error.duplicate\");\r\n\r\n\t\tlet code;\r\n\r\n\t\tif (template === \"trainedSkill\") {\r\n\t\t\tconst daily = createTrainedSkillDaily(key, uuid, label);\r\n\t\t\tcode = this.#stringifyDaily(daily, { key, uuid, label }, \"SkillGenerics\");\r\n\t\t} else if (template === \"trainedLore\") {\r\n\t\t\tconst daily = createTrainedLoreDaily(key, uuid, label);\r\n\t\t\tcode = this.#stringifyDaily(daily, { key, uuid, label }, \"SkillGenerics\");\r\n\t\t} else if (template === \"language\") {\r\n\t\t\tconst daily = createLanguageDaily(key, uuid, label);\r\n\t\t\tcode = this.#stringifyDaily(\r\n\t\t\t\tdaily,\r\n\t\t\t\t{ key, uuid, label },\r\n\t\t\t\t\"LanguageGenerics\",\r\n\t\t\t);\r\n\t\t} else if (template === \"resistance\") {\r\n\t\t\tconst resistance = simplyfiable(data.resistance);\r\n\t\t\tconst resistances = splitList(data.resistances);\r\n\r\n\t\t\tif (resistance === \"\" || !resistances.length)\r\n\t\t\t\treturn localize.warn(\"template.noEmpty\");\r\n\t\t\tif (typeof resistance === \"number\" && resistance < 1)\r\n\t\t\t\treturn localize.warn(\"template.badResistance\");\r\n\r\n\t\t\tconst daily = createResistancelDaily(\r\n\t\t\t\tkey,\r\n\t\t\t\tuuid,\r\n\t\t\t\tresistances,\r\n\t\t\t\tresistance,\r\n\t\t\t\tlabel,\r\n\t\t\t);\r\n\t\t\tcode = this.#stringifyDaily(\r\n\t\t\t\tdaily,\r\n\t\t\t\t{ key, uuid, label, resistance, resistances },\r\n\t\t\t\t\"ResistanceGenerics\",\r\n\t\t\t);\r\n\t\t} else if (template === \"feat\") {\r\n\t\t\tconst traits = splitList(data.traits);\r\n\t\t\tconst filter = {\r\n\t\t\t\tcategory: splitList(data.category),\r\n\t\t\t\tlevel: simplyfiable(data.level) || { min: 0, max: 20 },\r\n\t\t\t};\r\n\t\t\tif (traits.length) filter.traits = traits;\r\n\t\t\tconst daily = createFeatDaily(key, uuid, filter, label);\r\n\t\t\tcode = this.#stringifyDaily(daily, { key, uuid, label }, \"FeatGenerics\");\r\n\t\t} else if (template === \"spell\") {\r\n\t\t\tconst level = Number(data.level) || undefined;\r\n\t\t\tconst traits = splitList(data.traits);\r\n\t\t\tlet levels = data.levels.split(\",\").map((x) => x.trim());\r\n\t\t\tif (levels.length === 1) {\r\n\t\t\t\tlevels = simplyfiable(levels[0]);\r\n\t\t\t} else {\r\n\t\t\t\tlevels = levels\r\n\t\t\t\t\t.filter((x) => x)\r\n\t\t\t\t\t.map((x) => Number(x))\r\n\t\t\t\t\t.filter((x) => !Number.isNaN(x));\r\n\t\t\t}\r\n\t\t\tconst filter = {\r\n\t\t\t\tcategory: splitList(data.category),\r\n\t\t\t\ttraditions: splitList(data.traditions),\r\n\t\t\t\tlevel: levels || [],\r\n\t\t\t};\r\n\t\t\tif (traits.length) filter.traits = traits;\r\n\t\t\tconst daily = createSpellDaily(key, uuid, filter, level, label);\r\n\t\t\tcode = this.#stringifyDaily(\r\n\t\t\t\tdaily,\r\n\t\t\t\t{ key, uuid, label, level },\r\n\t\t\t\t\"SpellGenerics\",\r\n\t\t\t);\r\n\t\t} else if (template === \"tome\") {\r\n\t\t\tcode = tome;\r\n\t\t} else if (template === \"flexibility\") {\r\n\t\t\tcode = flexibility;\r\n\t\t} else if (template === \"savant\") {\r\n\t\t\tcode = savant;\r\n\t\t} else if (template === \"mind\") {\r\n\t\t\tcode = mind;\r\n\t\t} else {\r\n\t\t\tconst daily = { key, label, item: { uuid }, rows: [], process: () => {} };\r\n\t\t\tcode = this.#stringifyDaily(daily, { key, uuid, label });\r\n\t\t}\r\n\r\n\t\tcustoms.push({ key, code });\r\n\t\tawait setSetting(\"customDailies\", customs);\r\n\r\n\t\tthis._selectedDaily = key;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\t#stringifyDaily(daily, args, type) {\r\n\t\tconst placeholder = \"____PLACEHOLDER____\";\r\n\t\tconst fns = [];\r\n\r\n\t\tlet str = JSON.stringify(\r\n\t\t\tdaily,\r\n\t\t\t(_, value) => {\r\n\t\t\t\tif (typeof value === \"function\") {\r\n\t\t\t\t\tfns.push(value);\r\n\t\t\t\t\treturn placeholder;\r\n\t\t\t\t}\r\n\t\t\t\treturn value;\r\n\t\t\t},\r\n\t\t\t4,\r\n\t\t);\r\n\r\n\t\tstr = str.replace(new RegExp(`\"${placeholder}\"`, \"g\"), () => {\r\n\t\t\tconst fn = fns.shift()?.toString();\r\n\t\t\treturn fn?.replace(/( {5,})/g, (match) => match.slice(4)) ?? \"\";\r\n\t\t});\r\n\r\n\t\tlet strArgs = \"\";\r\n\t\tfor (const [key, value] of Object.entries(args)) {\r\n\t\t\tif (typeof value === \"string\") strArgs += `const ${key} = '${value}';\\n`;\r\n\t\t\telse if (typeof value === \"object\")\r\n\t\t\t\tstrArgs += `const ${key} = ${JSON.stringify(value)};\\n`;\r\n\t\t\telse strArgs += `const ${key} = ${value};\\n`;\r\n\t\t}\r\n\r\n\t\tconst typing = type ? `Daily<${type}>` : \"Daily\";\r\n\t\treturn `${strArgs}\\n/** @type {${typing}} */\\nconst daily = ${str};\\n\\nreturn daily;`;\r\n\t}\r\n\r\n\t#onSelectTemplate(event) {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tthis._selectedDaily = \"\";\r\n\t\tthis._selectedTemplate = event.currentTarget.value;\r\n\r\n\t\tthis.render();\r\n\t}\r\n}\r\n\r\nfunction splitList(list) {\r\n\treturn list\r\n\t\t.split(\",\")\r\n\t\t.map((x) => x.trim())\r\n\t\t.filter((x) => x);\r\n}\r\n\r\nfunction simplyfiable(value) {\r\n\tif (typeof value === \"number\") return value;\r\n\r\n\tconst trimmed = value.trim();\r\n\tif (trimmed === \"level\" || trimmed === \"half\") return trimmed;\r\n\r\n\tconst numbered = Number(trimmed);\r\n\treturn Number.isNaN(numbered) ? \"\" : numbered;\r\n}\r\n", "import { getFlag, localize, updateSourceFlag } from \"module-api\";\r\nimport { canPrepDailies } from \"./actor\";\r\nimport { openDailiesInterface } from \"./api\";\r\n\r\nexport function preCreateChatMessage(message, data, context) {\r\n\tif (context.restForTheNight) {\r\n\t\tupdateSourceFlag(message, \"restForTheNight\", true);\r\n\t}\r\n}\r\n\r\nexport function renderChatMessage(message, html) {\r\n\tif (getFlag(message, \"restForTheNight\")) {\r\n\t\trenderRestMessage(message, html);\r\n\t}\r\n}\r\n\r\nfunction renderRestMessage(message, html) {\r\n\tconst actor = message.actor;\r\n\tif (!actor.isOwner) return;\r\n\r\n\tconst canPrep = canPrepDailies(actor);\r\n\tconst prepared = getFlag(message, \"prepared\");\r\n\tconst label = localize(\r\n\t\t`message.dailiesRequest.${\r\n\t\t\t!canPrep && prepared === undefined\r\n\t\t\t\t? \"cleaning\"\r\n\t\t\t\t: canPrep\r\n\t\t\t\t  ? \"button\"\r\n\t\t\t\t  : \"prepared\"\r\n\t\t}`,\r\n\t);\r\n\tconst btn = $(`<button type=\"button\">${label}</button>`);\r\n\r\n\thtml.find(\".message-content\").append(btn);\r\n\r\n\tif (canPrep) {\r\n\t\tbtn.on(\"click\", () => openDailiesInterface(actor, message));\r\n\t} else {\r\n\t\tbtn.prop(\"disabled\", true);\r\n\t}\r\n}\r\n", "import { createUpdateCollection } from \"./api\";\r\nimport { getDailyFromSourceId } from \"./dailies\";\r\nimport { isPF2eStavesActive } from \"./data/staves\";\r\nimport { MODULE, getFlag, getSourceId, setFlag, sluggify } from \"module-api\";\r\n\r\nexport async function restForTheNightAll(wrapped, ...args) {\r\n\tconst messages = await wrapped(...args);\r\n\tawait Promise.all(\r\n\t\tmessages.map(async (message) => {\r\n\t\t\tconst actor = message.actor;\r\n\t\t\tif (!actor?.isOwner) return;\r\n\r\n\t\t\tawait onRestForTheNight(actor);\r\n\t\t\tawait setFlag(actor, \"rested\", true);\r\n\t\t\tawait setFlag(message, \"prepared\", false);\r\n\t\t}),\r\n\t);\r\n\treturn messages;\r\n}\r\n\r\nasync function onRestForTheNight(actor) {\r\n\tconst removeItems = [];\r\n\tconst [updateItems, updateItem] = createUpdateCollection();\r\n\tconst pf2eStavesActive = isPF2eStavesActive();\r\n\r\n\tfor (const item of actor.items) {\r\n\t\tif (getFlag(item, \"temporary\")) {\r\n\t\t\tremoveItems.push(item.id);\r\n\r\n\t\t\t// we remove the itemGrants flag from the parent feat\r\n\t\t\tif (item.isOfType(\"feat\")) {\r\n\t\t\t\tconst parentId = getFlag(item, \"grantedBy\");\r\n\t\t\t\tif (parentId) {\r\n\t\t\t\t\tconst slug = sluggify(item.name, { camel: \"dromedary\" });\r\n\t\t\t\t\tconst path = `flags.pf2e.itemGrants.-=${slug}`;\r\n\t\t\t\t\tupdateItem({ _id: parentId, [path]: true });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// we don't need to do more work because the item is being deleted\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// we remove the spellcasting entries from pf2e staves\r\n\t\tif (\r\n\t\t\t!pf2eStavesActive &&\r\n\t\t\titem.isOfType(\"spellcastingEntry\") &&\r\n\t\t\titem.system.prepared.value === \"charge\"\r\n\t\t) {\r\n\t\t\tremoveItems.push(item.id);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst sourceId = getSourceId(item);\r\n\r\n\t\t// We run the daily rest function if it exists\r\n\t\tif (sourceId) {\r\n\t\t\tconst daily = getDailyFromSourceId(sourceId);\r\n\t\t\tif (daily?.rest) {\r\n\t\t\t\tawait daily.rest({ item, sourceId, updateItem, actor });\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// we clean temporary rule elements\r\n\t\tconst rules = deepClone(item._source.system.rules);\r\n\t\tlet modifiedRules = false;\r\n\t\tfor (let i = rules.length - 1; i >= 0; i--) {\r\n\t\t\tif (MODULE.id in rules[i]) {\r\n\t\t\t\trules.splice(i, 1);\r\n\t\t\t\tmodifiedRules = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (modifiedRules) updateItem({ _id: item.id, \"system.rules\": rules });\r\n\t}\r\n\r\n\tif (updateItems.size) {\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updateItems.contents);\r\n\t}\r\n\r\n\tif (removeItems.length) {\r\n\t\tawait actor.deleteEmbeddedDocuments(\"Item\", removeItems);\r\n\t}\r\n}\r\n", "import {\r\n\tgetModule,\r\n\tregisterModule,\r\n\tregisterSetting,\r\n\tregisterSettingMenu,\r\n\tregisterWrapper,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { performDailyCrafting, renderCharacterSheetPF2e } from \"./actor\";\r\nimport { openDailiesInterface, utils } from \"./api\";\r\nimport { DailyCustoms } from \"./apps/custom\";\r\nimport { preCreateChatMessage, renderChatMessage } from \"./chat\";\r\nimport {\r\n\tBUILTINS_DAILIES,\r\n\tCUSTOM_DAILIES,\r\n\tUNIQUE_DAILY_KEYS,\r\n\tcheckCustomDaily,\r\n\tparseCustomDailies,\r\n\tprepareAllDailies,\r\n\tprepareDailies,\r\n} from \"./dailies\";\r\nimport {\r\n\tDEFAULT_REGEX_RANKS,\r\n\tgetSpellcastingEntryStaffData,\r\n\tgetSpellcastingEntryStaffFlags,\r\n\tisPF2eStavesActive,\r\n\tupdateEntryCharges,\r\n} from \"./data/staves\";\r\nimport { restForTheNightAll } from \"./rest\";\r\nimport { onSpellcastingEntryCast } from \"./spellcasting\";\r\n\r\nregisterModule(\"pf2e-dailies\");\r\n\r\nexport const EXT_VERSION = \"1.3.0\";\r\n\r\nconst SPELLCASTING_ENTRY_CAST =\r\n\t\"CONFIG.PF2E.Item.documentClasses.spellcastingEntry.prototype.cast\";\r\nconst DAILY_CRAFTING =\r\n\t\"CONFIG.PF2E.Actor.documentClasses.character.prototype.performDailyCrafting\";\r\nconst REST_FOR_THE_NIGHT = \"game.pf2e.actions.restForTheNight\";\r\n\r\nHooks.once(\"setup\", () => {\r\n\tregisterSetting({\r\n\t\tname: \"customDailies\",\r\n\t\ttype: Array,\r\n\t\tdefault: [],\r\n\t\tconfig: false,\r\n\t\tonChange: parseCustomDailies,\r\n\t});\r\n\r\n\tregisterSetting({\r\n\t\tname: \"familiar\",\r\n\t\ttype: String,\r\n\t\tdefault: \"\",\r\n\t});\r\n\r\n\tregisterSetting({\r\n\t\tname: \"staff-regex\",\r\n\t\ttype: String,\r\n\t\tdefault: DEFAULT_REGEX_RANKS,\r\n\t});\r\n\r\n\tregisterSetting({\r\n\t\tname: \"members\",\r\n\t\ttype: Boolean,\r\n\t\tdefault: true,\r\n\t\tscope: \"client\",\r\n\t});\r\n\r\n\tregisterSetting({\r\n\t\tname: \"staff-sort\",\r\n\t\ttype: String,\r\n\t\tdefault: \"top\",\r\n\t\tchoices: [\"top\", \"bottom\"],\r\n\t\tscope: \"client\",\r\n\t});\r\n\r\n\tregisterSetting({\r\n\t\tname: \"filters\",\r\n\t\ttype: String,\r\n\t\tdefault: \"\",\r\n\t\tscope: \"client\",\r\n\t\tonChange: prepareAllDailies,\r\n\t});\r\n\r\n\tregisterSettingMenu({\r\n\t\tname: \"customs\",\r\n\t\ttype: DailyCustoms,\r\n\t});\r\n\r\n\tgetModule().api = {\r\n\t\topenDailiesInterface: (actor) => openDailiesInterface(actor),\r\n\t\tgetBuiltinDailies: () => deepClone(BUILTINS_DAILIES),\r\n\t\tgetCustomDailies: () => deepClone(CUSTOM_DAILIES),\r\n\t\tgetBuiltinDailyKeys: () =>\r\n\t\t\t[\r\n\t\t\t\tUNIQUE_DAILY_KEYS.map((k) => `dailies.${k}`),\r\n\t\t\t\tBUILTINS_DAILIES.map((d) => `dailies.${d.key}`),\r\n\t\t\t].flat(),\r\n\t\tgetBuiltinDailyKey: (uuid) => {\r\n\t\t\tconst daily = BUILTINS_DAILIES.find(\r\n\t\t\t\t(d) => d.item.uuid === uuid || d.children?.some((c) => c.uuid === uuid),\r\n\t\t\t);\r\n\t\t\tif (!daily) return;\r\n\t\t\treturn `dailies.${daily.key}`;\r\n\t\t},\r\n\t\tprepareDailies,\r\n\t\tcheckCustomDaily,\r\n\t\tgetUtils: () => deepClone(utils),\r\n\t\tgetSpellcastingEntryStaffFlags,\r\n\t\tgetSpellcastingEntryStaffData,\r\n\t\tupdateEntryCharges,\r\n\t};\r\n\r\n\tif (!isPF2eStavesActive()) {\r\n\t\tCONFIG.PF2E.preparationType.charge = \"Charge\";\r\n\t\tregisterWrapper(SPELLCASTING_ENTRY_CAST, onSpellcastingEntryCast, \"MIXED\");\r\n\t}\r\n});\r\n\r\nHooks.once(\"ready\", async () => {\r\n\tif (isPF2eStavesActive()) {\r\n\t\twarn(\"staves.conflict\", true);\r\n\t}\r\n\r\n\tawait prepareAllDailies();\r\n\r\n\tif (!game.modules.get(\"lib-wrapper\")?.active && game.user.isGM) {\r\n\t\twarn(\"error.noLibwrapper\", true);\r\n\t\treturn;\r\n\t}\r\n\r\n\tregisterWrapper(DAILY_CRAFTING, performDailyCrafting, \"OVERRIDE\");\r\n\r\n\tregisterWrapper(REST_FOR_THE_NIGHT, restForTheNightAll);\r\n});\r\n\r\nHooks.on(\"renderCharacterSheetPF2e\", renderCharacterSheetPF2e);\r\n\r\nHooks.on(\"preCreateChatMessage\", preCreateChatMessage);\r\nHooks.on(\"renderChatMessage\", renderChatMessage);\r\n"],
  "mappings": "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CA,+CACA,4DACA,0BACA,0CACA,GACA,mCACA,gDACA,gEACA,iDACA,8CACA,YACA,SACA,IACA,GACA,0BACD,EAAE,KAAK;AAAA,CAAI,EC/DJ,IAAMC,GAAO,CACnB,gFACA,yEACA,0DACA,GACA,qFACA,GACA,8BACA,iFACA,wEACA,+DACA,wEACA,IACA,GACA,sEACA,yBACA,yBACA,2BACA,IACA,GACA,6EACA,GACA,yDACA,GACA,8FACA,GACA,iCACA,kBACA,mBACA,0BACA,2BACA,wBACA,sBACA,sBACA,2BACA,cACA,gBACA,IACA,GACA,qCACA,sBACA,wBACA,cACA,4FACA,SACA,kBACA,YACA,8BACA,qDACA,aACA,YACA,8BACA,iGACA,aACA,YACA,6BACA,8FACA,aACA,YACA,gCACA,uGACA,aACA,SACA,cACA,YACA,6BACA,6BACA,8CACA,mBACA,mDACA,aACA,YACA,8BACA,6BACA,mCACA,4CACA,2DACA,0CACA,aACA,YACA,8BACA,8BACA,qCACA,sCACA,gEACA,oDACA,aACA,YACA,8BACA,6BACA,uCACA,qCACA,wEACA,wEACA,8FACA,aACA,YACA,8BACA,gCACA,uCACA,6CACA,wEACA,sDACA,8FACA,aACA,SACA,8EACA,yCACA,8BACA,GACA,yCACA,GACA,0EACA,wHACA,oHACA,GACA,iCACA,mDACA,kFACA,oEACA,4EACA,0CACA,8DACA,8CACA,wCACA,iBACA,YACA,GACA,4FACA,gEACA,qEACA,4DACA,2CACA,GACA,sEACA,6HACA,8CACA,0EACA,wCACA,0CACA,qBACA,gBACA,YACA,SACA,kDACA,oDACA,GACA,+DACA,0EACA,sEACA,GACA,6DACA,0BACA,iHACA,YACA,SACA,IACA,GACA,oBACA,8IACA,kHACA,uEACA,iHACA,IACA,GACA,sDACA,kCACA,oBACA,iJACA,GACA,4DACA,8FACA,QACA,GACA,wCACA,YACA,oCACA,uBACA,yBACA,yBACA,2DACA,uCACA,kDACA,qBACA,wBACA,4DACA,uCACA,4CACA,qBACA,iBACA,iCACA,aACA,cACA,oDACA,QACA,GACA,oBACA,gEACA,sBACA,QACA,GACA,mBACA,IACA,GACA,+BACA,0CACA,+DACA,wBACA,yEACA,iBACA,QACA,GACA,oEACA,qBACA,mFACA,iBACA,QACA,GACA,iDACA,GACA,0DACA,uEACA,6DACA,GACA,oBACA,IACA,GACA,kBACD,EAAE,KAAK;AAAA,CAAI,ECpOJ,IAAMC,GAAS,CACrB,sEACA,0FACA,iEACA,GACA,6EACA,GACA,MACA,kCACA,uCACA,MACA,+DACA,sBACA,2BACA,GACA,wDACA,8EACA,GACA,2CACA,qCACA,sCACA,8EACA,YACA,GACA,+FACA,QACA,GACA,8DACA,IACA,GACA,uCACA,yBACA,qBACA,cACA,oFACA,SACA,gCACA,6FACA,mBACA,8DACA,+DACA,2FACA,4FACA,YACA,SACA,kCACA,sDACA,wBACA,4BACA,6BACA,gFACA,wBACA,iCACA,6CACA,2CACA,8CACA,oDACA,sBACA,iBACA,oEACA,YACA,qBACA,UACA,yEACA,uDACA,sCACA,2GACA,8BACA,oEACA,YACA,SACA,IACA,GACA,qBACD,EAAE,KAAK;AAAA,CAAI,EC1EJ,IAAMC,GAAO,CACnB,gDACA,yEACA,uFACA,kEACA,GACA,0DACA,GACA,6CACA,0CACA,+DACA,+CACA,wEACA,QACA,uBACA,IACA,GACA,qCACA,4BACA,mBACA,cACA,+EACA,SACA,kBACA,YACA,6BACA,8FACA,wDACA,aACA,YACA,8BACA,2FACA,wDACA,aACA,YACA,+BACA,4FACA,aACA,YACA,+BACA,gGACA,0DACA,aACA,SACA,iDACA,8CACA,yCACA,wGACA,GACA,oCACA,2BACA,+CACA,gDACA,YACA,GACA,+BACA,kCACA,6EACA,0DACA,2DACA,YACA,kEACA,4EACA,8EACA,GACA,qCACA,+DACA,gEACA,uBACA,kFACA,+DACA,gEACA,gBACA,YACA,kBACA,iBACA,qCACA,kFACA,+DACA,gEACA,4CACA,kFACA,kFACA,+DACA,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",
  "names": ["getSourceId", "doc", "__name", "includesSourceId", "list", "sourceId", "getSourceIdCondition", "item", "arrayToObject", "arr", "fn", "key", "obj", "entry", "k", "__name", "sequenceArray", "start", "end", "levels", "i", "__name", "AsyncFunction", "isInstanceOf", "obj", "name", "cursor", "__name", "joinStr", "separator", "path", "x", "__name", "capitalize", "str", "flagPath", "path", "MODULE", "joinStr", "__name", "getFlag", "doc", "setFlag", "doc", "args", "value", "MODULE", "__name", "updateSourceFlag", "doc", "args", "value", "flagPath", "__name", "render", "args", "data", "path", "templatePath", "__name", "MODULE", "joinStr", "getItems", "actor", "itemTypes", "types", "type", "__name", "getItemWithSourceId", "actor", "sourceId", "itemTypes", "getItems", "getSourceIdCondition", "__name", "registerWrapper", "path", "callback", "type", "MODULE", "__name", "localize", "args", "MODULE", "data", "joinStr", "__name", "hasLocalization", "keys", "localizePath", "path", "MODULE", "__name", "subLocalize", "subKey", "fn", "args", "localize", "str", "arg1", "arg2", "warn", "info", "error", "key", "hasLocalization", "hash", "MODULE_ID", "MODULE", "str", "registerModule", "id", "__name", "getModule", "notify", "str", "arg1", "arg2", "arg3", "type", "data", "permanent", "localize", "__name", "warn", "info", "error", "registerSetting", "options", "arrayToObject", "choice", "settingPath", "MODULE", "__name", "registerSettingMenu", "path", "getSetting", "setting", "setSetting", "setting", "value", "MODULE", "__name", "__spreadArray", "to", "from", "pack", "i", "l", "ar", "purry", "fn", "args", "lazy", "diff", "arrayArgs", "ret", "__name", "data", "_reduceLazy", "array", "lazy", "indexed", "newArray", "index", "item", "result", "__name", "uniq", "purry", "_uniq", "__name", "array", "_reduceLazy", "lazy", "set", "value", "ordinalString", "value", "pluralRules", "suffix", "__name", "ErrorPF2e", "message", "sluggify", "text", "options", "__name", "setHasElement", "set", "value", "isObject", "value", "__name", "createFancyLink", "docOrUuid", "async", "label", "link", "__name", "dcAdjustments", "dcByLevel", "calculateDC", "level", "pwol", "rarity", "dc", "dcByLevel", "adjustDCByRarity", "__name", "adjustDCByRarity", "dc", "rarity", "adjustDC", "rarityToDCAdjustment", "__name", "adjustment", "dcAdjustments", "MAGIC_TRADITIONS", "IdentifyItemPopup", "__name", "getItemIdentificationDCs", "item", "$html", "html", "updateButton", "identifiedName", "dcs", "action", "content", "_event", "formData", "status", "pwol", "notMatchingTraditionModifier", "baseDC", "calculateDC", "rarity", "getDcRarity", "dc", "adjustDCByRarity", "getIdentifyMagicDCs", "result", "traditions", "getMagicTraditions", "key", "MAGIC_TRADITIONS", "traits", "t", "setHasElement", "inlineSelector", "keyword", "MoveLootPopup", "__name", "object", "options", "callback", "prompt", "buttonLabel", "_event", "formData", "itemIsOfType", "item", "types", "t", "setHasElement", "__name", "PredicatePF2e", "_PredicatePF2e", "__name", "statements", "s", "isStatement", "predicate", "options", "domain", "#isTrue", "statement", "isBinaryOp", "#testBinaryOp", "isCompound", "#testCompound", "operator", "left", "right", "domainArray", "getValues", "operand", "maybeNumber", "pattern", "values", "v", "leftValues", "rightValues", "l", "r", "subProp", "isAtomic", "binaryOperators", "isObject", "entries", "operands", "isAnd", "isOr", "isNand", "isXor", "isNor", "isNot", "isIf", "CANTRIP_DECK_ID", "scrollCompendiumIds", "SPELL_CONSUMABLE_NAME_TEMPLATES", "wandCompendiumIds", "createConsumableFromSpell", "spell", "type", "heightenedLevel", "mystified", "temp", "itemImg", "itemName", "pack", "p", "itemId", "getIdForSpellConsumable", "consumable", "isInstanceOf", "ErrorPF2e", "consumableSource", "traits", "uniq", "t", "setHasElement", "MAGIC_TRADITIONS", "getNameForSpellConsumable", "description", "paragraphElement", "containerElement", "hrElement", "__name", "CANTRIP_DECK_ID", "scrollCompendiumIds", "wandCompendiumIds", "spellName", "templateId", "SPELL_CONSUMABLE_NAME_TEMPLATES", "createSpellDaily", "key", "uuid", "filter", "level", "label", "addSpell", "utils", "fields", "messages", "source", "spellLevel", "__name", "tricksterAce", "daily", "createSpellDaily", "row", "item", "castTime", "localizePath", "__name", "bladeAlly", "localize", "actor", "weapon", "children", "runes", "antipaladin", "evil", "good", "liberator", "master", "paladin", "spirit", "tyrant", "value", "localizeRune", "fields", "addRule", "messages", "weaponId", "rune", "name", "slugged", "match", "__name", "ICON", "ceremonialKnife", "actor", "weapon", "utils", "calculateRank", "fields", "item", "addItem", "messages", "uuid", "level", "source", "__name", "rows", "createScrollChain", "key", "uuids", "label", "createRow", "utils", "fields", "addItem", "messages", "field", "uuid", "level", "source", "__name", "slug", "minActorLevel", "child", "row", "actor", "combatFlexibility", "createRow", "utils", "fields", "addFeat", "messages", "children", "uuid", "source", "slug", "level", "child", "row", "__name", "createLanguageDaily", "key", "uuid", "label", "actor", "utils", "actorLanguages", "x", "addRule", "fields", "messages", "value", "source", "__name", "createTrainedSkillDaily", "key", "uuid", "label", "createComboSkillRow", "api", "processComboSkill", "__name", "fields", "addItem", "addRule", "utils", "messages", "removeRule", "field", "rank", "parent", "rule", "suboption", "value", "source", "slug", "extras", "actor", "actorSkills", "x", "createTrainedLoreDaily", "longevities", "createComboSkillRow", "item", "children", "api", "feats", "field", "rank", "processComboSkill", "MIND_WEAPON_UUID", "MALLEABLE_MENTAL_FORGE_UUID", "WEAPON_BASE_TYPES", "WEAPON_GROUPS", "WEAPON_TRAITS", "WEAPON_DAMAGE_TYPES", "WEAPON_RUNES", "WEAPON_GREATER_RUNES", "mindSmith", "localize", "fix", "utils", "nb", "children", "updateItem", "fields", "messages", "item", "weapon", "selected", "traits", "child", "freeSlot", "MODULE", "sourceId", "actor", "getItemWithSourceId", "trait", "runeSlot", "getFlag", "subLocalize", "content", "key", "label", "onWeaponSelected", "__name", "html", "selection", "stats", "RATION_UUID", "getRations", "actor", "getItemWithSourceId", "__name", "rations", "value", "max", "remaining", "last", "localize", "fields", "updateItem", "messages", "quantity", "name", "createFancyLink", "message", "createResistancelDaily", "key", "uuid", "resistances", "resistance", "label", "random", "utils", "fields", "actor", "addRule", "messages", "type", "value", "rule", "__name", "effectUUID", "rootMagic", "actor", "utils", "a", "fields", "messages", "actorId", "DEFAULT_REGEX_RANKS", "KINETIC_ACTIVATION", "isPF2eStavesActive", "__name", "getSpellcastingEntryStaffFlags", "entry", "data", "getFlag", "getSpellcastingEntryStaffData", "staffData", "getMaxSlotRankForStaves", "spontaneousCharges", "actor", "charges", "slot", "cost", "updateEntryCharges", "value", "updatedValue", "setFlag", "getStaves", "type", "trait", "item", "traits", "maxCharges", "actorCharges", "entries", "getValidSpellcastingList", "entryMaxCharges", "getSpellcastingEntryMaxSlotRank", "getItemWithSourceId", "getBestSpellcastingEntryForStaves", "bestEntry", "getBestSpellcastingEntry", "bestMod", "classDC", "c", "classMod", "getPreparedSpellcastingEntriesForStaves", "entryGroups", "entryId", "isFlexible", "rank", "index", "id", "prepared", "expended", "spell", "a", "b", "onSpellcastingEntryCast", "wrapped", "args", "spell", "rank", "staffFlags", "getSpellcastingEntryStaffFlags", "actor", "warn", "castRank", "updates", "spontaneousEntries", "entry", "useSpontaneous", "entryRankValue", "__name", "content", "localize", "utils", "entries", "index", "render", "key", "hash", "html", "value", "current", "MODULE", "getValidSpellcastingList", "itemOnly", "innate", "focus", "getFlag", "getSpellcastingEntryMaxSlotRank", "maxSlot", "levelMaxSlot", "i", "getBestSpellcastingEntry", "actor", "entries", "getValidSpellcastingList", "bestMod", "bestEntries", "entry", "mod", "returnedEntry", "__name", "ability", "tradition", "proficiency", "classAttr", "classAttrEntries", "bestCount", "bestEntry", "entryCount", "getPreparedCount", "slot", "spell", "getSpellcastingEntriesSortBounds", "min", "max", "scrollSavant", "actor", "maxSlot", "maxTradition", "getSpellcastingTraditionDetails", "rowName", "custom", "utils", "fields", "addItem", "messages", "field", "uuid", "source", "tradition", "entries", "getValidSpellcastingList", "entry", "entryMaxSlot", "getSpellcastingEntryMaxSlotRank", "__name", "spellshaping", "actor", "utils", "fields", "addFeat", "messages", "uuid", "source", "thaumaturgeTome", "createChildCondition", "utils", "actor", "children", "skillNames", "actorLevel", "actorSkills", "custom", "skills", "x", "masters", "experts", "trained", "rowName", "fields", "messages", "addItem", "addRule", "rank", "value", "source", "option", "item", "itemId", "__name", "DEPRECATED_CUSTOM_DAILIES", "UNIQUE_DAILY_KEYS", "BUILTINS_DAILIES", "thaumaturgeTome", "longevities", "createTrainedSkillDaily", "createTrainedLoreDaily", "createLanguageDaily", "createResistancelDaily", "spellshaping", "combatFlexibility", "scrollSavant", "createScrollChain", "tricksterAce", "mindSmith", "bladeAlly", "rootMagic", "ceremonialKnife", "rations", "DAILY_FILTERS", "BUILTINS_UUIDS", "UUIDS", "prepareDailies", "dailies", "prefix", "uuids", "original", "daily", "keyWithPrefix", "uuid", "condition", "err", "error", "__name", "prepareBaseDailies", "CUSTOM_DAILIES", "parseCustomDailies", "customs", "getSetting", "key", "code", "AsyncFunction", "checkCustomDaily", "CUSTOM_UUIDS", "prepareDailyFilters", "filters", "s", "prepareAllDailies", "warning", "warn", "getDailies", "actor", "item", "sourceId", "getSourceId", "entry", "index", "utils", "getDailyFromSourceId", "getFamiliarPack", "__name", "familiarUUID", "id", "templateOrders", "getTemplate", "children", "key", "item", "prepare", "label", "rows", "actor", "getFlag", "slug", "prepareArgs", "utils", "custom", "dailyArgs", "groupLabel", "getProcessedValue", "labeled", "hasLocalization", "localize", "child", "template", "row", "type", "childPredicate", "condition", "save", "unique", "order", "PredicatePF2e", "savedRow", "rowLabel", "value", "rowTemplate", "isComboRow", "isSelectRow", "isRandomRow", "tmp", "labelize", "capitalize", "isDropRow", "isAlerRow", "__name", "obj", "args", "getSimplifiableValue", "actor", "value", "fallback", "numbered", "__name", "parseFilter", "filter", "parseFeatFilter", "parseSpellFilter", "checkFilter", "selected", "checkbox", "x", "setTraits", "searchTraits", "dataTraits", "traits", "getFilterTraits", "search", "data", "level", "getSpellFilterLevel", "getFeatFilterLevel", "simplified", "sequenceArray", "localize", "subLocalize", "onDropFeat", "item", "target", "filter", "search", "drop", "localizeAll", "traits", "getFilterTraits", "testFn", "trait", "translatedSkills", "utils", "prerequisites", "prerequisite", "skill", "sluggify", "level", "getFeatFilterLevel", "itemLevel", "args", "result", "onDropItem", "__name", "onDropSpell", "categories", "x", "tradition", "getSpellFilterLevel", "config", "list", "key", "processData", "actor", "dailies", "fields", "getFields", "addItems", "addRules", "updateItems", "updateItem", "createUpdateCollection", "flags", "msg", "subLocalize", "addedSpells", "chatContent", "getRules", "__name", "item", "id", "existing", "rules", "i", "MODULE", "messages", "rawMessages", "messageObj", "group", "options", "order", "label", "message", "familiar", "pack", "getFamiliarPack", "abilities", "ids", "field", "value", "isCustom", "source", "familiarUUID", "staffField", "staffID", "staff", "makeshift", "maxStaffCharges", "getMaxSlotRankForStaves", "uuids", "ranks", "getSetting", "DEFAULT_REGEX_RANKS", "ranksRegex", "rankMatch", "rankStr", "rank", "uuidRegex", "uuidMatch", "uuid", "overcharge", "expendedSpells", "expendedSlots", "flexibleLabel", "localize", "emptyLabel", "slotsUpdates", "data", "entryId", "entry", "slot", "prepared", "preparedSlot", "spell", "currentValue", "bestEntry", "getBestSpellcastingEntryForStaves", "ability", "tradition", "proficiency", "sort", "min", "max", "getSpellcastingEntriesSortBounds", "entrySource", "utils", "name", "rankLabel", "key", "process", "dailyArgs", "signature", "parent", "rule", "parentItem", "parentId", "level", "err", "error", "rowFields", "rows", "row", "type", "input", "flag", "items", "getFlag", "path", "sluggify", "entryType", "spells", "a", "parseMessages", "messageList", "b", "selected", "random", "hasLocalization", "createFancyLink", "elements", "element", "select", "localize", "subLocalize", "STAFF_NEXUS", "DailiesInterface", "__name", "actor", "options", "message", "templatePath", "templates", "getDailies", "DAILY_FILTERS", "type", "nbAbilities", "pack", "getFamiliarPack", "flags", "getFlag", "template", "_id", "name", "customUUIDS", "getSetting", "uuid", "item", "a", "b", "index", "rows", "data", "isPF2eStavesActive", "staves", "getStaves", "getMaxSlotRankForStaves", "staff", "staffIdRow", "preparedEntries", "getPreparedSpellcastingEntriesForStaves", "flexibleLabel", "emptyLabel", "entry", "entryId", "spell", "unique", "utils", "slot", "rankLabel", "staffNexus", "getItemWithSourceId", "nbExpends", "i", "daily", "getTemplate", "error", "groups", "value", "placeholder", "msg", "key", "formattedKey", "c", "force", "_", "select", "html", "#onClear", "#onAccept", "#onCancel", "#onComboSelectChange", "#onComboInputChange", "#onSearch", "#onAlert", "uniqueSelects", "event", "#cleanUniqueSelects", "processedUniques", "uniqueTag", "selector", "target", "dataString", "filter", "#getfilterFromElement", "onDropItem", "onDropFeat", "onDropSpell", "#lock", "row", "args", "fixed", "#unlock", "element", "parsed", "parseFilter", "input", "x", "#validate", "warns", "emptyInputs", "alertInputs", "parent", "warning", "processData", "setFlag", "isTarget", "children", "getSiblings", "uniqueOptions", "child", "childIndex", "childOptions", "optionUniqueValue", "option", "optionExists", "maxIndex", "finalValue", "el", "siblings", "halfLevelString", "RUNE_PROPERTY_KEYS", "SKILLNAMES", "LANGUAGES", "utils", "skill", "value", "mode", "predicate", "rule", "name", "rank", "lowercase", "result", "key", "localized", "language", "resistance", "str", "capitalize", "type", "uuid", "source", "options", "createSpellConsumableSource", "ordinalString", "item", "option", "roll", "actor", "sequenceArray", "damage", "trait", "rune", "potency", "i", "property", "member", "types", "actorTypes", "memberIsActor", "actors", "getSetting", "p", "a", "level", "itemName", "itemImg", "spell", "createConsumableFromSpell", "__name", "openDailiesInterface", "character", "message", "token", "canPrepDailies", "DailiesInterface", "localize", "createUpdateCollection", "collection", "data", "id", "update", "performDailyCrafting", "entries", "e", "reagentCost", "sum", "entry", "reagentValue", "key", "formula", "itemSource", "itemIsOfType", "__name", "renderCharacterSheetPF2e", "sheet", "html", "actor", "canPrep", "canPrepDailies", "disabledClass", "tooltip", "localize", "icon", "el", "openDailiesInterface", "isPF2eStavesActive", "renderStavesEntries", "entryId", "staffData", "getSpellcastingEntryStaffData", "label", "charges", "input", "event", "onStaffChargesChange", "reset", "onStaffChargesReset", "spells", "spell", "cost", "getEntryDataFromEvent", "itemId", "updateEntryCharges", "getFlag", "createFeatDaily", "key", "uuid", "filter", "label", "utils", "fields", "addFeat", "messages", "source", "__name", "flexibility", "mind", "savant", "tome", "localize", "subLocalize", "TEMPLATES", "EXAMPLES", "DailyCustoms", "__name", "templatePath", "event", "formData", "options", "customs", "getSetting", "code", "custom", "template", "extension", "newVersion", "EXT_VERSION", "html", "monaco", "area", "element", "#onSelectTemplate", "#onCreateTemplate", "#onCreateDaily", "#onSelectDaily", "#onDeleteDaily", "#onSaveCode", "selected", "stipped", "key", "AsyncFunction", "warn", "index", "setSetting", "err", "error", "data", "isExample", "uuid", "label", "daily", "createTrainedSkillDaily", "#stringifyDaily", "createTrainedLoreDaily", "createLanguageDaily", "resistance", "simplyfiable", "resistances", "splitList", "createResistancelDaily", "traits", "filter", "createFeatDaily", "level", "levels", "x", "createSpellDaily", "tome", "flexibility", "savant", "mind", "args", "type", "placeholder", "fns", "str", "_", "value", "match", "strArgs", "typing", "list", "trimmed", "numbered", "preCreateChatMessage", "message", "data", "context", "updateSourceFlag", "__name", "renderChatMessage", "html", "getFlag", "renderRestMessage", "actor", "canPrep", "canPrepDailies", "prepared", "label", "localize", "btn", "openDailiesInterface", "restForTheNightAll", "wrapped", "args", "messages", "message", "actor", "onRestForTheNight", "setFlag", "__name", "removeItems", "updateItems", "updateItem", "createUpdateCollection", "pf2eStavesActive", "isPF2eStavesActive", "item", "getFlag", "parentId", "path", "sluggify", "sourceId", "getSourceId", "daily", "getDailyFromSourceId", "rules", "modifiedRules", "i", "MODULE", "registerModule", "EXT_VERSION", "SPELLCASTING_ENTRY_CAST", "DAILY_CRAFTING", "REST_FOR_THE_NIGHT", "registerSetting", "parseCustomDailies", "DEFAULT_REGEX_RANKS", "prepareAllDailies", "registerSettingMenu", "DailyCustoms", "getModule", "actor", "openDailiesInterface", "BUILTINS_DAILIES", "CUSTOM_DAILIES", "UNIQUE_DAILY_KEYS", "k", "d", "uuid", "daily", "c", "prepareDailies", "checkCustomDaily", "utils", "getSpellcastingEntryStaffFlags", "getSpellcastingEntryStaffData", "updateEntryCharges", "isPF2eStavesActive", "registerWrapper", "onSpellcastingEntryCast", "warn", "performDailyCrafting", "restForTheNightAll", "renderCharacterSheetPF2e", "preCreateChatMessage", "renderChatMessage"]
}
